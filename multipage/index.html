<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>jobmejob • Home</title>
  <meta name="description" content="Free: job search + CV tailoring. Paid: auto-apply that runs applications for you." />

  <!-- Shared styles -->
  <link rel="stylesheet" href="./shared.css" />

  <style>
    /* Page-specific layout only */
    .hero{
      padding:18px;
      border-radius:22px;
      background:
        radial-gradient(1000px 420px at 15% -10%, rgba(34,197,94,.20), transparent 55%),
        radial-gradient(900px 420px at 95% 10%, rgba(22,163,74,.14), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.84));
      border:1px solid rgba(17,19,24,.10);
      box-shadow: 0 18px 40px rgba(17,19,24,.10);
    }

    .heroTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .heroTitle{
      font-size:46px;
      line-height:1.04;
      letter-spacing:-1px;
      font-weight:980;
      margin:0;
    }
    .heroSub{
      margin:8px 0 0;
      color:rgba(17,19,24,.62);
      font-weight:700;
      max-width: 70ch;
    }

    .heroGrid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      margin-top:16px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .heroTitle{font-size:38px}
      .heroGrid{grid-template-columns:1fr}
    }

    .panel{
      background:rgba(255,255,255,.78);
      border:1px solid rgba(17,19,24,.10);
      border-radius:18px;
      padding:14px;
    }

    .panelHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .panelHead h2{
      margin:0;
      font-size:14px;
      letter-spacing:.02em;
      text-transform:uppercase;
      color:rgba(17,19,24,.70);
    }

    .ctaRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:10px;
    }

    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      padding:10px 0;
      border-top:1px solid rgba(17,19,24,.08);
    }
    .kv:first-of-type{border-top:0;padding-top:0}
    .kv .k{color:rgba(17,19,24,.60);font-weight:750;font-size:13px}
    .kv .v{font-weight:900;font-size:13px;color:rgba(17,19,24,.90);text-align:right}

    .featureGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:14px;
      margin-top:14px;
    }
    @media (max-width:980px){
      .featureGrid{grid-template-columns:1fr}
    }
    .featureCard{
      background:rgba(255,255,255,.78);
      border:1px solid rgba(17,19,24,.10);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 16px 34px rgba(17,19,24,.08);
    }
    .featureHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .featureTitle{
      font-weight:950;
      margin:0;
      font-size:16px;
    }
    .featureDesc{
      margin:8px 0 0;
      color:rgba(17,19,24,.62);
      font-weight:650;
      line-height:1.45;
    }

    .howCard{ margin-top:14px; }
    .stepList{ display:grid; gap:10px; margin-top:10px; }
    .step{
      display:flex;
      gap:12px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(17,19,24,.10);
      background:rgba(17,19,24,.03);
    }
    .num{
      width:28px;height:28px;border-radius:10px;
      display:grid;place-items:center;
      font-weight:950;
      background:rgba(34,197,94,.12);
      border:1px solid rgba(34,197,94,.25);
      flex:0 0 auto;
    }
    .note{
      font-size:12px;
      color:rgba(17,19,24,.58);
      font-weight:650;
      line-height:1.45;
    }

    details.ats{
      margin-top:10px;
      border:1px solid rgba(17,19,24,.10);
      border-radius:16px;
      background:rgba(255,255,255,.70);
      padding:10px 12px;
    }
    details.ats summary{
      cursor:pointer;
      font-weight:900;
      color:rgba(17,19,24,.80);
      list-style:none;
    }
    details.ats summary::-webkit-details-marker{display:none}
    .footer{
      margin-top:16px;
      text-align:center;
      color:rgba(17,19,24,.55);
      font-weight:650;
      font-size:13px;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <nav class="nav">
      <a class="brand" href="./index.html" data-nav="1" aria-label="Home">
        <span class="logo" aria-hidden="true"></span>
        <span>jobmejob</span>
      </a>

      <div class="navlinks">
        <a class="pill active" href="./index.html" data-nav="1">Home</a>
        <a class="pill" href="./profile.html" data-nav="1">Profile</a>
        <a class="pill" href="./plan.html" data-nav="1">Plan</a>
        <a class="pill" href="./jobs.html" data-nav="1">Jobs</a>
        <a class="pill" href="./dashboard.html" data-nav="1">Dashboard</a>
        <a class="pill" href="./signup.html" id="navSignIn" data-nav="1">Sign in</a>
        <button class="pill" id="navLogout" type="button" style="display:none;">Logout</button>
      </div>
    </nav>
  </header>

  <main class="main">
    <section class="hero">
      <div class="heroTop">
        <div style="min-width:0">
          <h1 class="heroTitle">Job search + CV tailoring, simplified.</h1>
          <p class="heroSub">
            Free: search jobs and tailor your CV per role. Paid: auto-apply that runs applications for you based on your plan.
          </p>
        </div>

        <span class="badge warn" id="homeStatus">Checking…</span>
      </div>

      <div class="errorTop" id="errorTop" style="margin-top:12px;"></div>

      <div class="heroGrid">
        <!-- Next step -->
        <div class="panel">
          <div class="panelHead">
            <h2>Next step</h2>
            <span class="badge" id="nextBadge">—</span>
          </div>

          <div class="note" id="nextText">
            Checking your account status…
          </div>

          <div class="ctaRow" id="nextCtas">
            <button class="btn primary" id="btnPrimary" type="button" disabled>Loading…</button>
            <a class="btn ghost" id="btnSecondary" href="./signup.html" data-nav="1">Go to sign in</a>
          </div>

          <details class="ats">
            <summary>What does “ATS” mean?</summary>
            <div class="note" style="margin-top:8px">
              ATS stands for <b>Applicant Tracking System</b>. It is software companies use to parse and search CVs.
              “ATS-safe” formatting means simple headings, no tables/columns, and consistent structure, so parsing is reliable.
            </div>
          </details>
        </div>

        <!-- Account -->
        <div class="panel">
          <div class="panelHead">
            <h2>Account</h2>
            <span class="badge warn" id="acctBadge">—</span>
          </div>

          <div class="kv">
            <div class="k">Signed in as</div>
            <div class="v" id="acctEmail">—</div>
          </div>
          <div class="kv">
            <div class="k">Profile</div>
            <div class="v" id="acctProfile">—</div>
          </div>
          <div class="kv">
            <div class="k">Plan</div>
            <div class="v" id="acctPlan">—</div>
          </div>
          <div class="kv">
            <div class="k">Queue (new jobs)</div>
            <div class="v" id="acctQueue">—</div>
          </div>

          <div class="ctaRow">
            <a class="btn" href="./profile.html" data-nav="1" id="btnEditProfile">Edit profile</a>
            <a class="btn" href="./plan.html" data-nav="1" id="btnChangePlan">Change plan</a>
          </div>
        </div>
      </div>
    </section>

    <section class="featureGrid" aria-label="Features">
      <div class="featureCard">
        <div class="featureHead">
          <div>
            <h3 class="featureTitle">Jobs</h3>
            <div class="featureDesc">Fetch and review your queue. Prioritize or skip jobs quickly.</div>
          </div>
          <span class="badge good">Free</span>
        </div>
        <div class="ctaRow" style="margin-top:12px">
          <a class="btn primary" href="./jobs.html" data-nav="1">Open Jobs</a>
          <a class="btn ghost" href="./dashboard.html" data-nav="1">Open Dashboard</a>
        </div>
      </div>

      <div class="featureCard">
        <div class="featureHead">
          <div>
            <h3 class="featureTitle">CV tailoring</h3>
            <div class="featureDesc">Tailor your CV per role and keep ATS-safe formatting.</div>
          </div>
          <span class="badge good">Free</span>
        </div>
        <div class="ctaRow" style="margin-top:12px">
          <a class="btn" href="./dashboard.html" data-nav="1">Tailor from Dashboard</a>
          <span class="badge warn">CV Studio coming next</span>
        </div>
      </div>

      <div class="featureCard">
        <div class="featureHead">
          <div>
            <h3 class="featureTitle">Auto-apply</h3>
            <div class="featureDesc">Start automated applications based on your plan and rules.</div>
          </div>
          <span class="badge warn">Paid</span>
        </div>
        <div class="ctaRow" style="margin-top:12px">
          <a class="btn primary" href="./plan.html" data-nav="1">View plans</a>
          <a class="btn ghost" href="./dashboard.html" data-nav="1">See status</a>
        </div>
      </div>
    </section>

    <section class="card howCard">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div style="font-weight:950">How it works</div>
        <span class="badge good">Fast</span>
      </div>

      <div class="stepList">
        <div class="step">
          <div class="num">1</div>
          <div>
            <div style="font-weight:950">Sign in and set your profile</div>
            <div class="note">Upload your CV and define titles, locations, and filters. We use this to focus the job search.</div>
          </div>
        </div>
        <div class="step">
          <div class="num">2</div>
          <div>
            <div style="font-weight:950">Search jobs and tailor your CV</div>
            <div class="note">We extract keywords from job descriptions and adjust your CV wording (truthfully) to match the role.</div>
          </div>
        </div>
        <div class="step">
          <div class="num">3</div>
          <div>
            <div style="font-weight:950">Auto-apply (paid)</div>
            <div class="note">When you start auto-apply, we run your daily quota based on your plan and keep a clear activity log.</div>
          </div>
        </div>
      </div>
    </section>

    <div class="footer">
      © jobmejob · Need help? <a href="mailto:team@jobmejob.com">team@jobmejob.com</a>
    </div>
  </main>

  <!-- Scripts: order matters -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./auth.js"></script>
  <script src="./shared.js"></script>

  <script>
  (() => {
    "use strict";

    const S = window.JobMeJobShared || null;
    if (S && S.wireNavTransitions) S.wireNavTransitions();

    const $ = (id) => document.getElementById(id);

    function showError(msg){
      if (S && S.showTopError) return S.showTopError("errorTop", msg);
      const el = $("errorTop");
      if(!el) return;
      if(!msg){ el.style.display="none"; el.textContent=""; return; }
      el.style.display="block"; el.textContent = String(msg);
    }

    function setBadge(id, cls, txt){
      if (S && S.setBadge) return S.setBadge(id, cls, txt);
      const el = $(id);
      if(!el) return;
      el.className = "badge" + (cls ? (" " + cls) : "");
      el.textContent = txt || "";
    }

    function setText(id, txt){
      const el = $(id);
      if(el) el.textContent = (txt === undefined || txt === null) ? "" : String(txt);
    }

    function setPrimary(label, hrefOrFn){
      const btn = $("btnPrimary");
      if(!btn) return;
      btn.disabled = false;
      btn.textContent = label;
      btn.onclick = null;

      if(typeof hrefOrFn === "function"){
        btn.addEventListener("click", hrefOrFn, { once:true });
      }else{
        btn.addEventListener("click", () => {
          if (S && S.go) S.go(hrefOrFn);
          else window.location.href = hrefOrFn;
        }, { once:true });
      }
    }

    function setSignedOutUI(){
      setBadge("homeStatus", "warn", "Not signed in");
      setBadge("acctBadge", "warn", "Signed out");
      setText("acctEmail", "—");
      setText("acctProfile", "—");
      setText("acctPlan", "—");
      setText("acctQueue", "—");

      setBadge("nextBadge", "", "Sign in");
      setText("nextText", "If you are new: sign in → upload CV → pick a plan → start applying.");

      const navLogout = $("navLogout");
      const navSignIn = $("navSignIn");
      if(navLogout) navLogout.style.display = "none";
      if(navSignIn) navSignIn.style.display = "";

      const btn = $("btnPrimary");
      if(btn){
        btn.disabled = false;
        btn.textContent = "Go to sign in";
        btn.onclick = () => (S && S.go ? S.go("./signup.html") : (window.location.href="./signup.html"));
      }
      const sec = $("btnSecondary");
      if(sec){ sec.textContent = "Open dashboard"; sec.setAttribute("href","./dashboard.html"); }
    }

    function planLabel(planId){
      const p = String(planId || "").toLowerCase();
      if(p === "starter") return "Starter (1/day)";
      if(p === "pro") return "Growth (5/day)";
      if(p === "max") return "Max (10/day)";
      if(!p) return "—";
      return planId;
    }

    function computeNext(state){
      // state fields from /me/state used elsewhere:
      // - profile_complete, plan_id
      const profileOk = !!(state && state.profile_complete);
      const planOk = !!(state && state.plan_id);

      if(!profileOk) return { label:"Continue to Profile", href:"./profile.html", badge:"Profile" };
      if(!planOk) return { label:"Choose a Plan", href:"./plan.html", badge:"Plan" };
      return { label:"Open Dashboard", href:"./dashboard.html", badge:"Dashboard" };
    }

    function localFallbackState(){
      const prof = (localStorage.getItem("jm_profile_complete") || localStorage.getItem("ja_profile_complete") || "").toLowerCase();
      const plan = localStorage.getItem("jm_plan") || localStorage.getItem("ja_plan") || "";
      return {
        profile_complete: prof === "true",
        plan_id: plan || null
      };
    }

    async function safeGetState(session){
      // Prefer auth helper (keeps logic consistent with other pages)
      try{
        if(window.JobApplyAI && window.JobApplyAI.auth && typeof window.JobApplyAI.auth.syncStateToLocalStorage === "function"){
          const st = await window.JobApplyAI.auth.syncStateToLocalStorage(session);
          if(st) return st;
        }
      }catch(_){}

      // Fallback: call /me/state directly
      try{
        const apiBase = (S && S.resolveApiBase) ? S.resolveApiBase("https://jobmejob.schoene-viktor.workers.dev") : "https://jobmejob.schoene-viktor.workers.dev";
        const res = await fetch(apiBase.replace(/\/+$/,"") + "/me/state", {
          method:"GET",
          headers:{ Authorization: "Bearer " + session.access_token }
        });
        const txt = await res.text().catch(()=> "");
        const json = txt ? JSON.parse(txt) : null;
        if(res.ok && json) return json;
      }catch(_){}

      return localFallbackState();
    }

    async function safeGetQueueCount(session){
      try{
        const apiBase = (S && S.resolveApiBase) ? S.resolveApiBase("https://jobmejob.schoene-viktor.workers.dev") : "https://jobmejob.schoene-viktor.workers.dev";
        const res = await fetch(apiBase.replace(/\/+$/,"") + "/me/jobs/queue", {
          method:"GET",
          headers:{ Authorization: "Bearer " + session.access_token }
        });
        const txt = await res.text().catch(()=> "");
        const json = txt ? JSON.parse(txt) : null;
        if(!res.ok) return null;
        const c = (json && typeof json.count === "number") ? json.count : (Array.isArray(json?.data) ? json.data.length : null);
        return (typeof c === "number") ? c : null;
      }catch(_){
        return null;
      }
    }

    async function boot(){
      showError("");
      setBadge("homeStatus", "warn", "Checking…");
      setBadge("acctBadge", "warn", "Checking…");
      setText("acctEmail", "—");

      // Always stop the “Checking…” state after a short time (never hang)
      let safetyTimer = setTimeout(() => {
        // only update if still checking
        const hs = $("homeStatus");
        if(hs && hs.textContent.includes("Checking")){
          setBadge("homeStatus","warn","Offline / retry");
          setBadge("acctBadge","warn","—");
          setBadge("nextBadge","", "Sign in");
          setText("nextText","Could not load account status. You can still continue.");
          const btn = $("btnPrimary");
          if(btn){
            btn.disabled = false;
            btn.textContent = "Go to sign in";
            btn.onclick = () => (S && S.go ? S.go("./signup.html") : (window.location.href="./signup.html"));
          }
        }
      }, 4500);

      // Require auth.js to be present (it is already working on signup)
      if(!window.JobApplyAI || !window.JobApplyAI.auth || typeof window.JobApplyAI.auth.getSession !== "function"){
        clearTimeout(safetyTimer);
        setBadge("homeStatus","bad","Config error");
        showError("auth.js did not load. Ensure multipage/auth.js exists and is referenced as ./auth.js.");
        return;
      }

      // Session
      const session = await window.JobApplyAI.auth.getSession();
      if(!session || !session.user || !session.user.email){
        clearTimeout(safetyTimer);
        setSignedOutUI();
        return;
      }

      // Signed in UI (immediate)
      const email = String(session.user.email);
      setBadge("homeStatus","good","Signed in");
      setBadge("acctBadge","good","Active");
      setText("acctEmail", email);

      const navLogout = $("navLogout");
      const navSignIn = $("navSignIn");
      if(navLogout) navLogout.style.display = "";
      if(navSignIn) navSignIn.style.display = "none";

      // Make sure customer exists (non-blocking, but helps downstream calls)
      try{
        if(typeof window.JobApplyAI.auth.requireAuthAndCustomer === "function"){
          await window.JobApplyAI.auth.requireAuthAndCustomer({ redirectTo: "./signup.html" });
        }
      }catch(_){}

      // Load state + queue in parallel (non-blocking)
      const statePromise = safeGetState(session);
      const queuePromise = safeGetQueueCount(session);

      const [state, qCount] = await Promise.all([statePromise, queuePromise]);

      // State -> account and next step
      const next = computeNext(state);
      setBadge("nextBadge","", next.badge);
      setText("nextText", next.badge === "Profile"
        ? "Upload your CV and set preferences so we can find the right jobs."
        : (next.badge === "Plan"
          ? "Pick a plan to unlock auto-apply. (Job search + CV tailoring stay free.)"
          : "Everything is set. Review jobs, tailor CVs, and track progress."
        )
      );
      setPrimary(next.label, next.href);

      // Account details
      setText("acctProfile", (state && state.profile_complete) ? "Complete" : "Needs setup");
      setText("acctPlan", (state && state.plan_id) ? planLabel(state.plan_id) : "Not selected");
      setText("acctQueue", (typeof qCount === "number") ? String(qCount) : "—");

      clearTimeout(safetyTimer);
    }

    // Logout button (works even if page did not fully load)
    $("navLogout")?.addEventListener("click", async () => {
      try{
        if(window.JobApplyAI && window.JobApplyAI.auth && typeof window.JobApplyAI.auth.logout === "function"){
          await window.JobApplyAI.auth.logout("./index.html");
          return;
        }
      }catch(_){}
      // fallback
      try{
        if(window.supabaseClient && window.supabaseClient.auth) await window.supabaseClient.auth.signOut();
      }catch(_){}
      window.location.href = "./index.html";
    });

    window.addEventListener("load", () => {
      boot().catch((e) => {
        setBadge("homeStatus","bad","Error");
        showError(e && e.message ? e.message : String(e));
        // still allow sign in
        const btn = $("btnPrimary");
        if(btn){
          btn.disabled = false;
          btn.textContent = "Go to sign in";
          btn.onclick = () => (S && S.go ? S.go("./signup.html") : (window.location.href="./signup.html"));
        }
      });
    });
  })();
  </script>
</body>
</html>
