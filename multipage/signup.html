<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>jobmejob • Sign in</title>
<style>
:root{
  --bg:#f6f7fb;
  --text:#111318;
  --muted:rgba(17,19,24,.64);
  --line:rgba(17,19,24,.12);
  --accent:#22c55e;
  --accent2:#16a34a;
  --shadow:0 12px 34px rgba(17,19,24,.12);
  --radius:18px;
  --max:1120px;
  --safeTop: env(safe-area-inset-top, 0px);
  --safeBottom: env(safe-area-inset-bottom, 0px);
  --surface:#ffffff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  color:var(--text);
  background:
    radial-gradient(1200px 650px at 20% -10%, rgba(34,197,94,.18), transparent 55%),
    radial-gradient(900px 500px at 90% 10%, rgba(22,163,74,.14), transparent 55%),
    radial-gradient(800px 600px at 70% 110%, rgba(34,197,94,.10), transparent 55%),
    var(--bg);
  overflow-x:hidden;
}
a{color:inherit;text-decoration:none}
.topbar{
  position:sticky; top:0; z-index:30;
  background:rgba(246,247,251,.86);
  backdrop-filter:saturate(1.2) blur(12px);
  border-bottom:1px solid var(--line);
  padding-top:var(--safeTop);
}
.nav{
  max-width:var(--max);
  margin:0 auto;
  padding:12px 16px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
.brand{
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:950;
  letter-spacing:.2px;
  min-width:0;
}
.logo{
  width:34px;height:34px;border-radius:11px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  box-shadow: 0 10px 30px rgba(34,197,94,.22);
  flex:0 0 auto;
  position:relative;
  overflow:hidden;
}
.logo::after{
  content:"";
  position:absolute;
  inset:-45%;
  background:linear-gradient(90deg, transparent, rgba(255,255,255,.75), transparent);
  transform:rotate(20deg);
  animation:shine 2.8s ease-in-out infinite;
}
@keyframes shine{
  0%{transform:translateX(-55%) rotate(20deg);opacity:0}
  35%{opacity:1}
  70%{opacity:0}
  100%{transform:translateX(55%) rotate(20deg);opacity:0}
}
.navlinks{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
  justify-content:flex-end;
}
.pill{
  padding:9px 12px;
  border:1px solid var(--line);
  border-radius:999px;
  background:rgba(17,19,24,.04);
  font-weight:850;
  font-size:13px;
  transition:.15s ease;
  cursor:pointer;
  white-space:nowrap;
}
.pill:hover{transform:translateY(-1px);background:rgba(17,19,24,.06)}
.pill.active{border-color:rgba(34,197,94,.60); background:rgba(34,197,94,.16)}
.main{
  max-width:var(--max);
  margin:0 auto;
  padding:18px 16px calc(18px + var(--safeBottom));
}
.h1{
  font-size:34px;
  line-height:1.05;
  letter-spacing:-.8px;
  margin:10px 0 8px 0;
}
.sub{margin:0 0 14px 0;color:var(--muted);font-weight:650}
.card{
  background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.82));
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:14px;
  overflow:hidden;
}
.grid{
  display:grid;
  grid-template-columns: 1.1fr .9fr;
  gap:14px;
  align-items:stretch;
}
@media (max-width:980px){ .grid{grid-template-columns:1fr} }
.btn{
  appearance:none;
  border:1px solid var(--line);
  background:rgba(17,19,24,.06);
  color:var(--text);
  padding:12px 14px;
  border-radius:14px;
  font-weight:950;
  font-size:14px;
  cursor:pointer;
  transition:.15s ease;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  width:100%;
}
.btn:hover{transform:translateY(-1px); background:rgba(17,19,24,.08)}
.btn:disabled{opacity:.6; cursor:not-allowed; transform:none}
.btn.primary{
  border-color:rgba(34,197,94,.55);
  background:linear-gradient(135deg, rgba(34,197,94,.30), rgba(22,163,74,.18));
}
.badge{
  display:inline-flex;align-items:center;gap:8px;
  padding:7px 10px;border-radius:999px;border:1px solid var(--line);
  background:rgba(17,19,24,.05);color:var(--muted);
  font-size:12px;font-weight:900;white-space:nowrap;
}
.badge.good{border-color:rgba(34,197,94,.40); background:rgba(34,197,94,.12); color:#0a3d1f}
.badge.warn{border-color:rgba(255,179,0,.5); background:rgba(255,179,0,.12); color:#5a3b00}
.errorTop{
  display:none;
  margin:12px 0 12px 0;
  padding:12px 14px;
  border-radius:16px;
  border:1px solid rgba(255,61,113,.25);
  background:rgba(255,61,113,.10);
  color:#5a1130;
  font-weight:800;
  white-space:pre-wrap;
}
.small{font-size:12px;color:rgba(17,19,24,.55);font-weight:650;line-height:1.45}
.steps{display:grid;gap:10px;margin-top:10px}
.step{display:flex;gap:12px;padding:12px 14px;border-radius:16px;border:1px solid rgba(17,19,24,.10);background:rgba(17,19,24,.03)}
.num{width:28px;height:28px;border-radius:10px;display:grid;place-items:center;font-weight:950;background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.25);flex:0 0 auto}
</style>
</head>

<body>
<header class="topbar">
  <nav class="nav">
    <a class="brand" href="index.html" data-nav="1"><span class="logo" aria-hidden="true"></span><span>jobmejob</span></a>
    <div class="navlinks">
      <a class="pill" href="index.html" data-nav="1">Home</a>
      <a class="pill active" href="signup.html" data-nav="1">Sign in</a>
      <a class="pill" href="profile.html" data-nav="1">Profile</a>
      <a class="pill" href="plan.html" data-nav="1">Plan</a>
      <a class="pill" href="jobs.html" data-nav="1">Jobs</a>
      <a class="pill" href="dashboard.html" data-nav="1">Dashboard</a>
    </div>
  </nav>
</header>

<main class="main">
  <h1 class="h1">Sign in to start</h1>
  <p class="sub">Continue with Google. We will create (or reuse) your customer record, then send you to the next step.</p>

  <div class="errorTop" id="errorTop"></div>

  <div class="grid">
    <section class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
        <div class="badge warn" id="stateBadge">Not signed in</div>
        <div class="small" id="who"></div>
      </div>

      <div style="margin-top:12px">
        <button class="btn primary" id="btnGoogle" type="button">Continue with Google</button>
      </div>

      <div class="small" id="hint" style="margin-top:10px">You stay in control. Nothing is sent without your confirmation.</div>

      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn" id="btnSwitch" type="button" style="width:auto;display:none;">Switch account</button>
        <button class="btn" id="btnLogout" type="button" style="width:auto;display:none;">Logout</button>
        <button class="btn" id="btnCopyToken" type="button" style="width:auto;display:none;">Copy access token</button>
      </div>

      <div class="small" style="margin-top:12px">Support: <a href="mailto:team@jobmejob.com">team@jobmejob.com</a></div>
    </section>

    <aside class="card">
      <div style="font-weight:950;margin-bottom:8px">What happens next</div>
      <div class="steps">
        <div class="step"><div class="num">1</div><div><div style="font-weight:950">Profile</div><div class="small">Upload your CV and set job preferences (titles, locations, radius).</div></div></div>
        <div class="step"><div class="num">2</div><div><div style="font-weight:950">Plan</div><div class="small">Choose how many applications per day you want us to send.</div></div></div>
        <div class="step"><div class="num">3</div><div><div style="font-weight:950">Dashboard</div><div class="small">See your queue, tailor CVs, and (later) start paid auto-apply.</div></div></div>
      </div>
      <div class="small" style="margin-top:12px">
        If sign-in loops: Supabase → Auth → URL Configuration, ensure your current URL is allowed.
      </div>
    </aside>
  </div>
</main>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="./auth.js"></script>
<script>
"use strict";

function $(id){ return document.getElementById(id); }
function showError(msg){
  const el=$("errorTop");
  if(!el) return;
  if(!msg){ el.style.display="none"; el.textContent=""; return; }
  el.style.display="block";
  el.textContent=String(msg);
}
function setState(kind, text){
  const b=$("stateBadge");
  if(!b) return;
  b.className="badge " + (kind||"warn");
  b.textContent=text||"";
}
function go(url){
  document.body.classList.add("leaving");
  setTimeout(()=>{ window.location.href=url; }, 180);
}
document.addEventListener("click",(e)=>{
  const a=e.target.closest("a[data-nav='1']");
  if(!a) return;
  const url=a.getAttribute("href");
  if(!url || url.startsWith("#")) return;
  e.preventDefault();
  go(url);
});

async function routeNext(session){
  try{
    const state = await window.JobApplyAI.auth.syncStateToLocalStorage(session);
    if(state){
      if(!state.profile_complete) return go("./profile.html");
      if(!state.plan_id) return go("./plan.html");
      return go("./dashboard.html");
    }
  }catch(_){}

  const prof = localStorage.getItem("jm_profile_complete") || localStorage.getItem("ja_profile_complete");
  const plan = localStorage.getItem("jm_plan") || localStorage.getItem("ja_plan");
  if(prof !== "true") return go("./profile.html");
  if(!plan) return go("./plan.html");
  return go("./dashboard.html");
}

async function refreshUi(){
  showError("");
  const session = await window.JobApplyAI.auth.getSession();
  const who = $("who");
  const btnSwitch=$("btnSwitch");
  const btnLogout=$("btnLogout");
  const btnCopy=$("btnCopyToken");
  const btnGoogle=$("btnGoogle");

  if(!session || !session.user || !session.user.email){
    setState("warn","Not signed in");
    if(who) who.textContent="";
    if(btnSwitch) btnSwitch.style.display="none";
    if(btnLogout) btnLogout.style.display="none";
    if(btnCopy) btnCopy.style.display="none";
    if(btnGoogle) btnGoogle.disabled=false;
    return;
  }

  setState("good","Signed in");
  if(who) who.textContent="Signed in as " + String(session.user.email||"");
  if(btnSwitch) btnSwitch.style.display="";
  if(btnLogout) btnLogout.style.display="";
  if(btnCopy) btnCopy.style.display="";
  if(btnGoogle) btnGoogle.disabled=false;
}

async function handleGoogle(){
  try{
    showError("");
    const session = await window.JobApplyAI.auth.getSession();
    if(session && session.user && session.user.email){
      setState("good","Signed in");
      await window.JobApplyAI.auth.requireAuthAndCustomer({ redirectTo:"./signup.html" });
      return routeNext(session);
    }

    $("btnGoogle").disabled=true;
    setState("warn","Opening Google…");
    const redirectTo = window.location.href.split("#")[0];
    await window.JobApplyAI.auth.loginWithGoogle(redirectTo);
  }catch(e){
    $("btnGoogle").disabled=false;
    setState("warn","Not signed in");
    showError(e && e.message ? e.message : String(e));
  }
}

async function handleSwitch(){
  try{
    showError("");
    setState("warn","Switching…");
    await window.JobApplyAI.auth.logout("./signup.html");
  }catch(e){
    showError(e && e.message ? e.message : String(e));
  }
}

async function handleLogout(){
  try{
    showError("");
    await window.JobApplyAI.auth.logout("./index.html");
  }catch(e){
    showError(e && e.message ? e.message : String(e));
  }
}

async function copyToken(){
  try{
    const session = await window.JobApplyAI.auth.getSession();
    const tok = session && session.access_token ? session.access_token : "";
    if(!tok){ showError("No token found. Sign in first."); return; }
    await navigator.clipboard.writeText(tok);
  }catch(e){
    showError("Copy failed. Try again.");
  }
}

window.addEventListener("load", async ()=>{
  try{
    await refreshUi();
    const session = await window.JobApplyAI.auth.getSession();
    if(session && session.user && session.user.email){
      try{
        await window.JobApplyAI.auth.requireAuthAndCustomer({ redirectTo:"./signup.html" });
        await routeNext(session);
        return;
      }catch(_){}
    }
  }catch(e){
    showError(e && e.message ? e.message : String(e));
  }
});

$("btnGoogle").addEventListener("click", handleGoogle);
$("btnSwitch").addEventListener("click", handleSwitch);
$("btnLogout").addEventListener("click", handleLogout);
$("btnCopyToken").addEventListener("click", copyToken);
</script>
</body>
</html>
