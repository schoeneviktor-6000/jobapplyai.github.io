<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>jobmejob • Sign in</title>
  <meta name="description" content="Sign in to jobmejob with Google." />

  <!-- Shared styles -->
  <link rel="stylesheet" href="./shared.css" />

  <style>
    /* Page-specific layout only (keep shared.css generic) */
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      align-items:stretch;
    }
    @media (max-width:980px){
      .grid{grid-template-columns:1fr}
    }

    .stepList{display:grid;gap:10px;margin-top:10px}
    .step{
      display:flex;gap:12px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(17,19,24,.10);
      background:rgba(17,19,24,.03);
    }
    .num{
      width:28px;height:28px;border-radius:10px;
      display:grid;place-items:center;
      font-weight:950;
      background:rgba(34,197,94,.12);
      border:1px solid rgba(34,197,94,.25);
      flex:0 0 auto;
    }
    .note{
      font-size:12px;
      color:rgba(17,19,24,.58);
      font-weight:650;
      line-height:1.45;
    }

    .splitRow{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .who{font-size:12px;color:rgba(17,19,24,.58);font-weight:750}

    details.advanced{
      margin-top:12px;
      border:1px solid rgba(17,19,24,.10);
      border-radius:16px;
      background:rgba(17,19,24,.03);
      padding:10px 12px;
    }
    details.advanced summary{
      cursor:pointer;
      font-weight:900;
      color:rgba(17,19,24,.80);
      list-style:none;
    }
    details.advanced summary::-webkit-details-marker{ display:none }

    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btnRow .btn{width:auto}
    @media (max-width:620px){
      .btnRow{flex-direction:column;align-items:stretch}
      .btnRow .btn{width:100%}
    }

    /* Small helpers used in modal */
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .small{ font-size:12px; color:rgba(17,19,24,.56); font-weight:700; line-height:1.45; }
    .mono{
      font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New", monospace;
      font-size:12px;
      word-break:break-word;
      color:rgba(17,19,24,.64);
    }

    /* Activity list (modal) */
    .activityList{ display:flex; flex-direction:column; gap:10px; }
    .activityItem{
      border:1px solid rgba(17,19,24,.10);
      background:rgba(17,19,24,.03);
      border-radius:14px;
      padding:10px 12px;
    }
    .activityTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .activityTitle{ font-weight:950; }
    .activityMeta{
      margin-top:6px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      color:rgba(17,19,24,.60);
      font-size:12px;
      font-weight:750;
    }

    .iconX{
      border:1px solid rgba(17,19,24,.12);
      background:rgba(17,19,24,.04);
      border-radius:999px;
      padding:7px 10px;
      font-weight:950;
      cursor:pointer;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <nav class="nav">
      <a class="brand" href="./index.html" data-nav="1" aria-label="Home">
        <span class="logo" aria-hidden="true"></span>
        <span>jobmejob</span>
      </a>

      <div class="navlinks">
        <a class="pill" href="./index.html" data-nav="1">Home</a>
        <a class="pill" href="./cv.html" data-nav="1">CV Studio</a>
        <a class="pill" href="./jobs.html" data-nav="1">Jobs</a>
        <a class="pill" href="./plan.html" data-nav="1">Plan</a>

        <!-- Account dropdown (shown only when signed in) -->
        <details class="navDrop" id="navAccount" style="display:none">
          <summary class="pill" aria-label="Account menu">
            <span id="navAccountLabel">Account</span>
            <span aria-hidden="true">▾</span>
          </summary>

          <div class="navMenu" role="menu" aria-label="Account menu">
            <div class="menuLabel">Account</div>
            <a class="pill" href="./profile.html" data-nav="1" role="menuitem">Profile setup</a>
            <button class="btn ghost" id="navActivity" type="button" role="menuitem">Activity log</button>

            <div class="menuSep" role="separator"></div>
            <div class="menuLabel">More</div>
            <a class="pill" href="./dashboard.html" data-nav="1" role="menuitem">Dashboard</a>
            <span class="pill menuDisabled" role="menuitem" aria-disabled="true">Auto-apply (coming soon)</span>

            <div class="menuSep" role="separator"></div>
            <button class="btn danger" id="navLogout" type="button" role="menuitem">Logout</button>
          </div>
        </details>

        <a class="pill active" href="./signup.html" id="navSignIn" data-nav="1">Sign in</a>
      </div>
    </nav>
  </header>

  <main class="main">
    <h1 class="h1">Sign in to start</h1>
    <p class="sub">Continue with Google. Then we send you to the next step (Profile setup → CV Studio).</p>

    <div class="errorTop" id="errorTop"></div>

    <div class="grid">
      <section class="card">
        <div class="splitRow">
          <span class="badge warn" id="stateBadge">Not signed in</span>
          <span class="who" id="who"></span>
        </div>

        <div style="margin-top:12px">
          <button class="btn primary" id="btnGoogle" type="button" style="width:100%;justify-content:center;">
            Continue with Google
          </button>
        </div>

        <div class="note" style="margin-top:10px">
          Tip: if sign-in loops, open Supabase → Auth → URL Configuration and ensure your current GitHub Pages URL is allowed.
        </div>

        <!-- Hidden (not removed): debug / account controls -->
        <details class="advanced" id="advancedBox" style="display:none">
          <summary>More options</summary>

          <div class="btnRow">
            <button class="btn" id="btnSwitch" type="button">Switch account</button>
            <button class="btn" id="btnLogout" type="button">Logout</button>
            <button class="btn" id="btnCopyToken" type="button" title="Debug helper">Copy access token</button>
          </div>

          <div class="note" style="margin-top:8px">
            Support: <a href="mailto:team@jobmejob.com">team@jobmejob.com</a>
          </div>
        </details>

        <div class="note" style="margin-top:12px">
          Support: <a href="mailto:team@jobmejob.com">team@jobmejob.com</a>
        </div>
      </section>

      <aside class="card">
        <div style="font-weight:950;margin-bottom:8px">What happens next</div>

        <div class="stepList">
          <div class="step">
            <div class="num">1</div>
            <div>
              <div style="font-weight:950">Profile setup</div>
              <div class="note">Upload your CV and set job preferences (titles, location, radius). This is required.</div>
            </div>
          </div>
          <div class="step">
            <div class="num">2</div>
            <div>
              <div style="font-weight:950">CV Studio (core)</div>
              <div class="note">Tailor your CV per role. Paste a job description, or pick one from your Jobs queue.</div>
            </div>
          </div>
          <div class="step">
            <div class="num">3</div>
            <div>
              <div style="font-weight:950">Jobs + Auto-apply (coming soon)</div>
              <div class="note">For now: jobs are Germany-only. Plans will matter when Auto-apply launches.</div>
            </div>
          </div>
        </div>

        <div class="note" style="margin-top:12px">
          If you just want CV tailoring: you can use CV Studio for free (no plan needed).
        </div>
      </aside>
    </div>
  </main>

  <!-- Activity log modal (Account dropdown) -->
  <div class="modalBackdrop" id="activityModal" style="display:none">
    <div class="modalCard">
      <div class="modalScroll">
        <div class="modalHeader">
          <div style="min-width:0">
            <div class="modalTitle">Activity log</div>
            <div class="small">Recent actions like queued, prioritized, skipped, applied, rejected.</div>
          </div>
          <button class="iconX" id="activityCloseX" type="button" aria-label="Close">✕</button>
        </div>

        <div class="row" style="margin-top:12px; justify-content:space-between">
          <div class="row" style="gap:10px">
            <label class="small" for="activityFilter">Filter</label>
            <select id="activityFilter">
              <option value="">All</option>
              <option value="queued">Queued</option>
              <option value="prioritized">Prioritized</option>
              <option value="skipped">Skipped</option>
              <option value="applied">Applied</option>
              <option value="rejected">Rejected</option>
            </select>
          </div>
          <button class="btn" id="activityRefresh" type="button">Refresh</button>
        </div>

        <div class="errorTop" id="activityError"></div>

        <div id="activityWrap" style="margin-top:10px">
          <div class="modalMonoBox">Loading…</div>
        </div>
      </div>

      <div class="modalActions">
        <a class="btn ghost" href="./cv.html" data-nav="1">Open CV Studio</a>
        <button class="btn" id="activityClose" type="button">Close</button>
      </div>
    </div>
  </div>

  <!-- Scripts: order matters -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./auth.js"></script>
  <script src="./shared.js"></script>

  <script>
  (() => {
    "use strict";

    const S = window.JobMeJobShared || null;
    if (S && S.wireNavTransitions) S.wireNavTransitions();

    const $ = (id) => document.getElementById(id);

    // Fallbacks (so one missing helper doesn't break the whole page)
    const F = {
      escapeHtml: (s) => String(s ?? "").replace(/[&<>"']/g, (c) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])),
      showModal: (id) => { const el = $(id); if(el) el.style.display = "flex"; document.body.classList.add("modalOpen"); },
      hideModal: (id) => { const el = $(id); if(el) el.style.display = "none"; document.body.classList.remove("modalOpen"); },
      showTopError: (id, msg) => {
        const el = $(id);
        if(!el) return;
        if(!msg){ el.style.display = "none"; el.textContent = ""; return; }
        el.style.display = "block";
        el.textContent = String(msg);
      },
      setBadge: (id, cls, txt) => {
        const el = $(id);
        if(!el) return;
        el.className = "badge" + (cls ? (" " + cls) : "");
        el.textContent = txt ?? "";
      },
      resolveApiBase: (x) => String(x || "").trim().replace(/\/+$/, ""),
      go: (url) => { window.location.href = url; }
    };

    const H = {
      escapeHtml: (S && S.escapeHtml) ? S.escapeHtml : F.escapeHtml,
      showModal: (S && S.showModal) ? S.showModal : F.showModal,
      hideModal: (S && S.hideModal) ? S.hideModal : F.hideModal,
      showTopError: (S && S.showTopError) ? S.showTopError : F.showTopError,
      setBadge: (S && S.setBadge) ? S.setBadge : F.setBadge,
      resolveApiBase: (S && S.resolveApiBase) ? S.resolveApiBase : F.resolveApiBase,
      go: (S && S.go) ? S.go : F.go
    };

    const API_BASE = H.resolveApiBase(
      (window.JobApplyAI && window.JobApplyAI.config && window.JobApplyAI.config.API_BASE)
        ? window.JobApplyAI.config.API_BASE
        : "https://jobmejob.schoene-viktor.workers.dev"
    );

    let session = null;

    function showError(msg){
      H.showTopError("errorTop", msg);
    }

    function setState(kind, text){
      H.setBadge("stateBadge", kind || "warn", text || "");
    }

    function setText(id, txt){
      const el = $(id);
      if(el) el.textContent = String(txt ?? "");
    }

    function go(url){
      H.go(url);
    }

    async function routeNext(sess){
      // Prefer backend truth
      try{
        if (window.JobApplyAI?.auth?.syncStateToLocalStorage) {
          const st = await window.JobApplyAI.auth.syncStateToLocalStorage(sess);
          if(st){
            if(!st.profile_complete) return go("./profile.html");
            return go("./cv.html");
          }
        }
      }catch(_){}

      // Fallback to local flags (supports jm_* and ja_*)
      const prof = localStorage.getItem("jm_profile_complete") || localStorage.getItem("ja_profile_complete");
      if(prof !== "true") return go("./profile.html");
      return go("./cv.html");
    }

    /* -------------------------
       Activity log (modal)
       ------------------------- */

    function fmtWhen(ts){
      try{
        if(!ts) return "—";
        const d = new Date(ts);
        if(!Number.isFinite(d.getTime())) return String(ts);
        return d.toLocaleString();
      }catch(_){
        return String(ts || "—");
      }
    }

    function activityBadge(t){
      const x = String(t || "").toLowerCase();
      if(x === "applied" || x === "sent") return { cls:"good", label:"Applied" };
      if(x === "rejected") return { cls:"bad", label:"Rejected" };
      if(x === "skipped") return { cls:"warn", label:"Skipped" };
      if(x === "prioritized") return { cls:"prio", label:"Prioritized" };
      if(x === "queued" || x === "new") return { cls:"", label:"Queued" };
      return { cls:"", label: (t ? String(t) : "Event") };
    }

    function setHtml(id, html){
      const el = $(id);
      if(el) el.innerHTML = html;
    }

    function renderActivityList(items, kind){
      const arr = Array.isArray(items) ? items : [];
      if(!arr.length){
        return '<span class="badge warn">No activity yet</span>';
      }

      const html = arr.slice(0, 20).map((row) => {
        const evType = kind === "applications" ? String(row.status || "new") : String(row.event_type || "");
        const b = activityBadge(evType);

        const job = (row && row.job) ? row.job : {};
        const title = String(job.title || "Untitled");
        const company = String(job.company_name || job.company || "—");
        const loc = [job.city || "", job.region || ""].filter(Boolean).join(", ") || "—";
        const when = kind === "applications" ? (row.updated_at || row.created_at) : row.created_at;
        const link = job.apply_url ? String(job.apply_url) : "";

        const titleHtml = link
          ? ('<a href="' + H.escapeHtml(link) + '" target="_blank" rel="noopener">' + H.escapeHtml(title) + "</a>")
          : H.escapeHtml(title);

        let meta = "";
        try{
          if(kind !== "applications" && row.meta && typeof row.meta === "object"){
            if(row.meta.channel) meta = "via " + String(row.meta.channel);
            if(row.meta.reason_code) meta = meta ? (meta + " • reason: " + String(row.meta.reason_code)) : ("reason: " + String(row.meta.reason_code));
          }
        }catch(_){ }

        return (
          '<div class="activityItem">'
            + '<div class="activityTop">'
              + '<div class="activityTitle">' + titleHtml + '</div>'
              + '<span class="badge ' + H.escapeHtml(b.cls) + '">' + H.escapeHtml(b.label) + '</span>'
            + '</div>'
            + '<div class="activityMeta">'
              + '<span>' + H.escapeHtml(company) + '</span>'
              + '<span>•</span>'
              + '<span>' + H.escapeHtml(loc) + '</span>'
              + '<span>•</span>'
              + '<span>' + H.escapeHtml(fmtWhen(when)) + '</span>'
              + (meta ? ('<span class="mono">• ' + H.escapeHtml(meta) + '</span>') : '')
            + '</div>'
          + '</div>'
        );
      }).join("");

      return '<div class="activityList">' + html + '</div>';
    }

    async function loadActivityLog(){
      H.showTopError("activityError", "");
      setHtml("activityWrap", '<div class="modalMonoBox">Loading…</div>');

      const token = session && session.access_token ? String(session.access_token) : "";
      if(!token){
        H.showTopError("activityError", "You are signed out. Please sign in again.");
        setHtml("activityWrap", "");
        return;
      }

      const et = String($("activityFilter")?.value || "").trim();
      const headers = { Authorization: "Bearer " + token };

      // 1) Try timeline endpoint first
      try{
        let url = API_BASE + "/me/application-events?limit=20";
        if(et) url += "&event_type=" + encodeURIComponent(et);

        const res = await fetch(url, { method:"GET", headers });
        const text = await res.text().catch(() => "");
        let json = null;
        try{ json = JSON.parse(text); }catch{ json = { raw: text }; }

        if(!res.ok){
          const msg = (json && (json.error || json.message)) ? String(json.error || json.message) : (text || ("HTTP " + res.status));
          throw new Error(msg);
        }

        const items = Array.isArray(json?.data) ? json.data : [];
        setHtml("activityWrap", renderActivityList(items, "events"));
        return;
      }catch(_){
        // fallback below
      }

      // 2) Fallback: applications list
      try{
        const map = { queued:"new", prioritized:"new", applied:"applied", rejected:"rejected", skipped:"skipped", sent:"applied" };
        let url = API_BASE + "/me/applications?limit=20";
        if(et && map[et]) url += "&status=" + encodeURIComponent(map[et]);

        const res = await fetch(url, { method:"GET", headers });
        const text = await res.text().catch(() => "");
        let json = null;
        try{ json = JSON.parse(text); }catch{ json = { raw: text }; }

        if(!res.ok){
          const msg = (json && (json.error || json.message)) ? String(json.error || json.message) : (text || ("HTTP " + res.status));
          throw new Error(msg);
        }

        const items = Array.isArray(json?.data) ? json.data : [];
        setHtml("activityWrap", renderActivityList(items, "applications"));
      }catch(e){
        H.showTopError("activityError", e?.message || String(e));
        setHtml("activityWrap", '<span class="badge bad">Activity failed</span>');
      }
    }

    function openActivityModal(){
      const dd = $("navAccount");
      if(dd) dd.open = false;
      H.showModal("activityModal");
      loadActivityLog().catch((e) => H.showTopError("activityError", e?.message || String(e)));
    }

    function closeActivityModal(){
      H.hideModal("activityModal");
      H.showTopError("activityError", "");
    }

    /* -------------------------
       Auth UI
       ------------------------- */

    async function refreshUi(){
      showError("");

      // Require auth.js
      if(!window.JobApplyAI || !window.JobApplyAI.auth || typeof window.JobApplyAI.auth.getSession !== "function"){
        setState("bad", "Config error");
        showError("auth.js did not load. Ensure multipage/auth.js exists and is referenced as ./auth.js.");
        return null;
      }

      session = await window.JobApplyAI.auth.getSession();

      const who = $("who");
      const btnGoogle = $("btnGoogle");
      const advancedBox = $("advancedBox");

      if(!session || !session.user || !session.user.email){
        setState("warn", "Not signed in");
        setText("who", "");

        if(btnGoogle){
          btnGoogle.disabled = false;
          btnGoogle.textContent = "Continue with Google";
        }
        if(advancedBox) advancedBox.style.display = "none";

        // Nav state: hide account dropdown, show sign-in pill
        const navAcct = $("navAccount");
        if(navAcct) navAcct.style.display = "none";
        const navSignIn = $("navSignIn");
        if(navSignIn) navSignIn.style.display = "";

        return null;
      }

      const email = String(session.user.email || "");
      setState("good", "Signed in");
      if(who) who.textContent = "Signed in as " + email;

      if(btnGoogle){
        btnGoogle.disabled = false;
        btnGoogle.textContent = "Continue";
      }
      if(advancedBox) advancedBox.style.display = "";

      // Nav state: show account dropdown, hide sign-in
      const navAcct = $("navAccount");
      if(navAcct) navAcct.style.display = "";
      const navSignIn = $("navSignIn");
      if(navSignIn) navSignIn.style.display = "none";
      const navLabel = $("navAccountLabel");
      if(navLabel){
        const handle = email.includes("@") ? email.split("@")[0] : "Account";
        navLabel.textContent = handle.length > 16 ? (handle.slice(0,16) + "…") : handle;
      }

      return session;
    }

    async function handleGoogle(){
      try{
        showError("");
        const btn = $("btnGoogle");
        if(btn) btn.disabled = true;

        const sess = await window.JobApplyAI.auth.getSession();
        if(sess && sess.user && sess.user.email){
          try{
            if (typeof window.JobApplyAI.auth.requireAuthAndCustomer === "function"){
              await window.JobApplyAI.auth.requireAuthAndCustomer({ redirectTo: "./signup.html" });
            }
          }catch(_){}
          return routeNext(sess);
        }

        setState("warn", "Opening Google…");

        // Use the current page URL (without hash) so Supabase redirect matching works.
        const redirectTo = window.location.href.split("#")[0];

        await window.JobApplyAI.auth.loginWithGoogle(redirectTo);
      }catch(e){
        const btn = $("btnGoogle");
        if(btn) btn.disabled = false;
        setState("warn", "Not signed in");
        showError(e && e.message ? e.message : String(e));
      }
    }

    async function handleSwitch(){
      try{
        showError("");
        setState("warn", "Switching…");
        await window.JobApplyAI.auth.logout("./signup.html");
      }catch(e){
        showError(e && e.message ? e.message : String(e));
      }
    }

    async function handleLogout(redirectTo){
      try{
        showError("");
        await window.JobApplyAI.auth.logout(redirectTo || "./index.html");
      }catch(e){
        showError(e && e.message ? e.message : String(e));
      }
    }

    async function copyToken(){
      try{
        const sess = await window.JobApplyAI.auth.getSession();
        const tok = sess && sess.access_token ? sess.access_token : "";
        if(!tok){ showError("No token found. Sign in first."); return; }
        await navigator.clipboard.writeText(tok);
      }catch(_){
        showError("Copy failed. Try again.");
      }
    }

    // Close Account dropdown when clicking outside (nice UX on desktop)
    document.addEventListener("click", (e) => {
      const dd = $("navAccount");
      if(!dd || !dd.open) return;
      if(dd.contains(e.target)) return;
      dd.open = false;
    });

    // Wire modal actions
    $("navActivity")?.addEventListener("click", openActivityModal);
    $("activityCloseX")?.addEventListener("click", closeActivityModal);
    $("activityClose")?.addEventListener("click", closeActivityModal);
    $("activityModal")?.addEventListener("click", (e) => { if(e.target && e.target.id === "activityModal") closeActivityModal(); });
    $("activityRefresh")?.addEventListener("click", () => loadActivityLog().catch(()=>{}));
    $("activityFilter")?.addEventListener("change", () => loadActivityLog().catch(()=>{}));

    // Wire auth actions
    $("btnGoogle")?.addEventListener("click", handleGoogle);
    $("btnSwitch")?.addEventListener("click", handleSwitch);
    $("btnLogout")?.addEventListener("click", () => handleLogout("./index.html"));
    $("btnCopyToken")?.addEventListener("click", copyToken);

    $("navLogout")?.addEventListener("click", () => handleLogout("./index.html"));

    window.addEventListener("load", async () => {
      try{
        const sess = await refreshUi();
        if(sess && sess.user && sess.user.email){
          // Prevent dead-end "sign in" page when already signed in.
          try{
            if (typeof window.JobApplyAI.auth.requireAuthAndCustomer === "function"){
              await window.JobApplyAI.auth.requireAuthAndCustomer({ redirectTo: "./signup.html" });
            }
          }catch(_){}
          await routeNext(sess);
        }
      }catch(e){
        showError(e && e.message ? e.message : String(e));
      }
    });
  })();
  </script>
</body>
</html>
