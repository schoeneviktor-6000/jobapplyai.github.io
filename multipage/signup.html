<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>jobmejob • Sign in</title>
  <meta name="description" content="Sign in to jobmejob with Google." />

  <!-- Shared styles -->
  <link rel="stylesheet" href="./shared.css" />

  <style>
    /* Page-specific layout only (keep shared.css generic) */
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      align-items:stretch;
    }
    @media (max-width:980px){
      .grid{grid-template-columns:1fr}
    }
    .tight{max-width:var(--max);margin:0 auto}
    .stepList{display:grid;gap:10px;margin-top:10px}
    .step{
      display:flex;gap:12px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(17,19,24,.10);
      background:rgba(17,19,24,.03);
    }
    .num{
      width:28px;height:28px;border-radius:10px;
      display:grid;place-items:center;
      font-weight:950;
      background:rgba(34,197,94,.12);
      border:1px solid rgba(34,197,94,.25);
      flex:0 0 auto;
    }
    .note{
      font-size:12px;
      color:rgba(17,19,24,.58);
      font-weight:650;
      line-height:1.45;
    }
    .splitRow{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .who{font-size:12px;color:rgba(17,19,24,.58);font-weight:750}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btnRow .btn{width:auto}
    @media (max-width:620px){
      .btnRow{flex-direction:column;align-items:stretch}
      .btnRow .btn{width:100%}
    }
  </style>
</head>

<body>
  <header class="topbar">
    <nav class="nav">
      <a class="brand" href="./index.html" data-nav="1" aria-label="Home">
        <span class="logo" aria-hidden="true"></span>
        <span>jobmejob</span>
      </a>

      <div class="navlinks">
        <a class="pill" href="./index.html" data-nav="1">Home</a>
        <a class="pill active" href="./signup.html" data-nav="1">Sign in</a>
        <a class="pill" href="./profile.html" data-nav="1">Profile</a>
        <a class="pill" href="./plan.html" data-nav="1">Plan</a>
        <a class="pill" href="./jobs.html" data-nav="1">Jobs</a>
        <a class="pill" href="./dashboard.html" data-nav="1">Dashboard</a>
        <button class="pill" id="btnNavLogout" type="button" style="display:none;">Logout</button>
      </div>
    </nav>
  </header>

  <main class="main">
    <h1 class="h1">Sign in to start</h1>
    <p class="sub">Continue with Google. We will create (or reuse) your customer record, then send you to the next step.</p>

    <div class="errorTop" id="errorTop"></div>

    <div class="grid">
      <section class="card">
        <div class="splitRow">
          <span class="badge warn" id="stateBadge">Not signed in</span>
          <span class="who" id="who"></span>
        </div>

        <div style="margin-top:12px">
          <button class="btn primary" id="btnGoogle" type="button" style="width:100%;justify-content:center;">
            Continue with Google
          </button>
        </div>

        <div class="note" style="margin-top:10px">
          You stay in control. Nothing is sent without your confirmation.
        </div>

        <div class="btnRow">
          <button class="btn" id="btnSwitch" type="button" style="display:none;">Switch account</button>
          <button class="btn" id="btnLogout" type="button" style="display:none;">Logout</button>
          <button class="btn" id="btnCopyToken" type="button" style="display:none;">Copy access token</button>
        </div>

        <div class="note" style="margin-top:12px">
          Support: <a href="mailto:team@jobmejob.com">team@jobmejob.com</a>
        </div>
      </section>

      <aside class="card">
        <div style="font-weight:950;margin-bottom:8px">What happens next</div>

        <div class="stepList">
          <div class="step">
            <div class="num">1</div>
            <div>
              <div style="font-weight:950">Profile</div>
              <div class="note">Upload your CV and set job preferences (titles, locations, radius).</div>
            </div>
          </div>
          <div class="step">
            <div class="num">2</div>
            <div>
              <div style="font-weight:950">Plan</div>
              <div class="note">Choose how many applications per day you want us to send.</div>
            </div>
          </div>
          <div class="step">
            <div class="num">3</div>
            <div>
              <div style="font-weight:950">Dashboard</div>
              <div class="note">See your queue, tailor CVs, and (later) start paid auto-apply.</div>
            </div>
          </div>
        </div>

        <div class="note" style="margin-top:12px">
          If sign-in loops: Supabase → Auth → URL Configuration, ensure your current URL is allowed.
        </div>
      </aside>
    </div>
  </main>

  <!-- Scripts: order matters -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./auth.js"></script>
  <script src="./shared.js"></script>

  <script>
  (() => {
    "use strict";

    const S = window.JobMeJobShared || null;
    if (S && S.wireNavTransitions) S.wireNavTransitions();

    const $ = (id) => document.getElementById(id);

    function showError(msg){
      if (S && S.showTopError) return S.showTopError("errorTop", msg);
      const el = $("errorTop");
      if(!el) return;
      if(!msg){ el.style.display="none"; el.textContent=""; return; }
      el.style.display="block";
      el.textContent = String(msg);
    }

    function setState(kind, text){
      const b = $("stateBadge");
      if(!b) return;
      b.className = "badge " + (kind || "warn");
      b.textContent = text || "";
    }

    function go(url){
      if (S && S.go) return S.go(url);
      document.body.classList.add("leaving");
      setTimeout(()=>{ window.location.href = url; }, 180);
    }

    async function routeNext(session){
      try{
        const st = await window.JobApplyAI.auth.syncStateToLocalStorage(session);
        if(st){
          if(!st.profile_complete) return go("./profile.html");
          if(!st.plan_id) return go("./plan.html");
          return go("./dashboard.html");
        }
      }catch(_){}

      // Fallback to local flags (supports jm_* and ja_*).
      const prof = localStorage.getItem("jm_profile_complete") || localStorage.getItem("ja_profile_complete");
      const plan = localStorage.getItem("jm_plan") || localStorage.getItem("ja_plan");
      if(prof !== "true") return go("./profile.html");
      if(!plan) return go("./plan.html");
      return go("./dashboard.html");
    }

    async function refreshUi(){
      showError("");
      const sess = await window.JobApplyAI.auth.getSession();

      const who = $("who");
      const btnSwitch = $("btnSwitch");
      const btnLogout = $("btnLogout");
      const btnCopy = $("btnCopyToken");
      const btnGoogle = $("btnGoogle");
      const navLogout = $("btnNavLogout");

      if(!sess || !sess.user || !sess.user.email){
        setState("warn", "Not signed in");
        if(who) who.textContent = "";
        if(btnSwitch) btnSwitch.style.display = "none";
        if(btnLogout) btnLogout.style.display = "none";
        if(btnCopy) btnCopy.style.display = "none";
        if(navLogout) navLogout.style.display = "none";
        if(btnGoogle) btnGoogle.disabled = false;
        return null;
      }

      setState("good", "Signed in");
      if(who) who.textContent = "Signed in as " + String(sess.user.email || "");
      if(btnSwitch) btnSwitch.style.display = "";
      if(btnLogout) btnLogout.style.display = "";
      if(btnCopy) btnCopy.style.display = "";
      if(navLogout) navLogout.style.display = "";
      if(btnGoogle) btnGoogle.disabled = false;
      return sess;
    }

    async function handleGoogle(){
      try{
        showError("");
        $("btnGoogle").disabled = true;

        const sess = await window.JobApplyAI.auth.getSession();
        if(sess && sess.user && sess.user.email){
          await window.JobApplyAI.auth.requireAuthAndCustomer({ redirectTo: "./signup.html" });
          return routeNext(sess);
        }

        setState("warn","Opening Google…");

        // Use the current page URL (without hash) so Supabase redirect matching works.
        const redirectTo = window.location.href.split("#")[0];

        await window.JobApplyAI.auth.loginWithGoogle(redirectTo);
      }catch(e){
        $("btnGoogle").disabled = false;
        setState("warn","Not signed in");
        showError(e && e.message ? e.message : String(e));
      }
    }

    async function handleSwitch(){
      try{
        showError("");
        setState("warn","Switching…");
        await window.JobApplyAI.auth.logout("./signup.html");
      }catch(e){
        showError(e && e.message ? e.message : String(e));
      }
    }

    async function handleLogout(){
      try{
        showError("");
        await window.JobApplyAI.auth.logout("./index.html");
      }catch(e){
        showError(e && e.message ? e.message : String(e));
      }
    }

    async function handleNavLogout(){
      await handleLogout();
    }

    async function copyToken(){
      try{
        const sess = await window.JobApplyAI.auth.getSession();
        const tok = sess && sess.access_token ? sess.access_token : "";
        if(!tok){ showError("No token found. Sign in first."); return; }
        await navigator.clipboard.writeText(tok);
      }catch(_){
        showError("Copy failed. Try again.");
      }
    }

    window.addEventListener("load", async () => {
      try{
        const sess = await refreshUi();
        if(sess && sess.user && sess.user.email){
          // If we're already signed in, jump forward (prevents dead-end "sign in" page).
          await window.JobApplyAI.auth.requireAuthAndCustomer({ redirectTo: "./signup.html" });
          await routeNext(sess);
        }
      }catch(e){
        showError(e && e.message ? e.message : String(e));
      }
    });

    $("btnGoogle")?.addEventListener("click", handleGoogle);
    $("btnSwitch")?.addEventListener("click", handleSwitch);
    $("btnLogout")?.addEventListener("click", handleLogout);
    $("btnCopyToken")?.addEventListener("click", copyToken);
    $("btnNavLogout")?.addEventListener("click", handleNavLogout);

  })();
  </script>
</body>
</html>
