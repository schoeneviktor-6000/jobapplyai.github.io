<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>jobmejob | Sign in</title>
<meta name="description" content="Sign in to jobmejob with Google.">

<style>
:root{
  --bg:#f8fafc;
  --card:#ffffff;
  --card2:#f8fafc;
  --border:#e5e7eb;
  --text:#0f172a;
  --muted:#475569;
  --muted2:#64748b;
  --shadow:0 18px 40px rgba(15,23,42,.08);

  /* Green-only theme (no blue) */
  --g1:#22c55e;
  --g2:#16a34a;

  --link:#16a34a;
  --max:1060px;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  color:var(--text);
  background:
    radial-gradient(900px 520px at 15% 5%, rgba(34,197,94,16), transparent 58%),
    radial-gradient(900px 520px at 85% 0%, rgba(22,163,74,12), transparent 58%),
    radial-gradient(1100px 720px at 50% 120%, rgba(34,197,94,10), transparent 60%),
    var(--bg);
}
a{color:inherit}

.wrap{
  min-height:100%;
  display:grid;
  place-items:center;
  padding:28px 16px;
}
.shell{width:100%;max-width:var(--max)}
.top{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom:18px;
}
.brand{
  display:flex;
  align-items:center;
  gap:12px;
  text-decoration:none;
  user-select:none;
}
.logo{
  width:42px;height:42px;border-radius:14px;
  background:linear-gradient(135deg,var(--g1),var(--g2));
  box-shadow:0 14px 35px rgba(34,197,94,22);
  position:relative;
  overflow:hidden;
}
.logo::after{
  content:"";
  position:absolute;inset:-40%;
  background:linear-gradient(90deg, transparent, rgba(255,255,255,75), transparent);
  transform:rotate(20deg);
  animation:shine 2.8s ease-in-out infinite;
}
@keyframes shine{
  0%{transform:translateX(-55%) rotate(20deg);opacity:0}
  35%{opacity:1}
  70%{opacity:0}
  100%{transform:translateX(55%) rotate(20deg);opacity:0}
}
.wordmark{display:flex;flex-direction:column;gap:2px}
.wordmark .name{font-weight:950;letter-spacing:.2px;font-size:14px;line-height:1.1}
.wordmark .tag{font-weight:800;font-size:12px;color:var(--muted2);letter-spacing:.1px}
.pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:9px 12px;
  border-radius:999px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.9);
  font-weight:850;
  font-size:13px;
  color:var(--muted);
}

.grid{
  display:grid;
  grid-template-columns:1.1fr .9fr;
  gap:16px;
  align-items:stretch;
}
@media (max-width:980px){.grid{grid-template-columns:1fr}}

.card{
  border-radius:24px;
  border:1px solid var(--border);
  background:linear-gradient(180deg, var(--card), var(--card2));
  box-shadow:var(--shadow);
  padding:22px;
}

.hero{padding:26px;position:relative;overflow:hidden}
.hero::before{
  content:"";
  position:absolute;
  inset:-1px;
  background:
    radial-gradient(700px 280px at 10% 0%, rgba(34,197,94,12), transparent 60%),
    radial-gradient(700px 280px at 90% 0%, rgba(22,163,74,10), transparent 60%);
  pointer-events:none;
}
.hero > *{position:relative}

h1{margin:0 0 8px;font-size:30px;letter-spacing:-.4px;line-height:1.15}
.sub{margin:0 0 18px;color:var(--muted);line-height:1.55;max-width:58ch}

.focus{display:flex;flex-direction:column;gap:12px;margin-top:6px}

.googleBtn{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  padding:13px 16px;
  border-radius:14px;
  border:1px solid #d1d5db;
  background:#ffffff;
  color:#111827;
  font-weight:900;
  font-size:15px;
  cursor:pointer;
  transition:transform .12s ease, box-shadow .18s ease;
  box-shadow:0 14px 30px rgba(15,23,42,.12);
}
.googleBtn:hover{transform:translateY(-1px);box-shadow:0 18px 38px rgba(15,23,42,.16)}
.googleBtn:disabled{opacity:.62;cursor:not-allowed;transform:none;box-shadow:0 12px 26px rgba(15,23,42,.10)}
.googleIcon{width:18px;height:18px;display:inline-block}

.statusRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:12px 14px;
  border-radius:16px;
  border:1px solid var(--border);
  background:#ffffff;
}
.statusLeft{display:flex;flex-direction:column;gap:2px}
.statusLabel{font-size:12px;font-weight:900;color:var(--muted2);letter-spacing:.15px}
.statusValue{font-size:13px;font-weight:900;color:var(--muted)}
.linkBtn{
  appearance:none;border:0;background:transparent;
  padding:0;
  font-weight:900;
  color:var(--link);
  cursor:pointer;
  text-decoration:underline;
  text-underline-offset:3px;
}

.small{margin:0;color:var(--muted2);font-size:12px;line-height:1.55}

.steps{display:flex;flex-direction:column;gap:10px;margin-top:6px}
.step{
  display:flex;
  gap:12px;
  padding:12px 14px;
  border-radius:16px;
  border:1px solid var(--border);
  background:#f9fafb;
}
.num{
  width:28px;height:28px;border-radius:10px;
  display:grid;place-items:center;
  font-weight:950;
  background:linear-gradient(135deg, rgba(34,197,94,.20), rgba(22,163,74,.16));
  border:1px solid rgba(15,23,42,.06);
}
.stepText{display:flex;flex-direction:column;gap:2px}
.stepTitle{font-weight:950}
.stepDesc{color:var(--muted2);font-size:12px;line-height:1.45}

.footer{margin-top:18px;text-align:center;color:var(--muted2);font-size:12px}

.fadeIn{animation:fadeIn .35s ease both}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.leaving{opacity:.7;transform:translateY(6px);transition:all .18s ease}
.hr{height:1px;background:rgba(15,23,42,.08);margin:14px 0}

details{
  border:1px solid rgba(15,23,42,.10);
  border-radius:16px;
  padding:10px 12px;
  background:rgba(248,250,252,.9);
}
details summary{cursor:pointer;font-weight:950;color:var(--muted)}
.advRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.ghost{
  appearance:none;
  border:1px solid rgba(15,23,42,.12);
  background:#ffffff;
  color:var(--muted);
  font-weight:900;
  font-size:12px;
  padding:10px 12px;
  border-radius:12px;
  cursor:pointer;
  transition:transform .12s ease, box-shadow .18s ease;
}
.ghost:hover{transform:translateY(-1px);box-shadow:0 14px 30px rgba(15,23,42,.10)}
.ghost:disabled{opacity:.6;cursor:not-allowed;transform:none;box-shadow:none}

@media (max-width:720px){h1{font-size:28px}}
</style>
</head>

<body>
<div class="wrap">
  <div class="shell fadeIn">

    <div class="top">
      <a class="brand" href="./index.html" data-nav="1" aria-label="Back to home">
        <span class="logo" aria-hidden="true"></span>
        <span class="wordmark">
          <span class="name">jobmejob</span>
          <span class="tag">We apply for jobs for you</span>
        </span>
      </a>
      <span class="pill" id="topState">Not signed in</span>
    </div>

    <div class="grid">
      <section class="card hero">
        <h1>We apply for jobs for you</h1>
        <p class="sub">Sign in with Google to start. We’ll set up your account and take you to the next step.</p>

        <div class="focus">
          <button class="googleBtn" id="btnGoogle" type="button" aria-label="Continue with Google">
            <span class="googleIcon" aria-hidden="true">
              <svg viewBox="0 0 48 48" width="18" height="18" xmlns="http://www.w3.org/2000/svg">
                <path fill="#EA4335" d="M24 9.5c3.5 0 6.7 1.2 9.2 3.5l6.9-6.9C35.9 2.3 30.3 0 24 0 14.6 0 6.5 5.4 2.6 13.3l8.1 6.3C12.6 13.6 17.8 9.5 24 9.5z"/>
                <path fill="#4285F4" d="M46.1 24.5c0-1.6-.1-2.8-.4-4.1H24v7.8h12.6c-.3 2-1.9 5-5.4 7l8.3 6.4c4.9-4.5 7.6-11.1 7.6-19.1z"/>
                <path fill="#FBBC05" d="M10.7 28.4c-.5-1.4-.8-2.9-.8-4.4s.3-3 .8-4.4l-8.1-6.3C.9 16.7 0 20.3 0 24s.9 7.3 2.6 10.7l8.1-6.3z"/>
                <path fill="#34A853" d="M24 48c6.3 0 11.6-2.1 15.5-5.7l-8.3-6.4c-2.2 1.6-5.1 2.7-7.2 2.7-6.2 0-11.4-4.1-13.3-9.9l-8.1 6.3C6.5 42.6 14.6 48 24 48z"/>
              </svg>
            </span>
            <span id="btnGoogleText">Continue with Google</span>
          </button>

          <div class="statusRow" id="statusRow" style="display:none">
            <div class="statusLeft">
              <div class="statusLabel">Signed in as</div>
              <div class="statusValue" id="signedEmail">—</div>
            </div>
            <button class="linkBtn" id="btnSwitch" type="button">Switch</button>
          </div>

          <p class="small" id="hint">You stay in control. Nothing is sent without your confirmation.</p>

          <details id="advanced" style="display:none">
            <summary>Advanced</summary>
            <p class="small">For debugging only.</p>
            <div class="advRow">
              <button class="ghost" id="btnLogout" type="button">Logout</button>
              <button class="ghost" id="copyToken" type="button" disabled>Copy access token</button>
            </div>
          </details>
        </div>
      </section>

      <aside class="card">
        <div style="font-weight:950;margin-bottom:8px">How it works</div>
        <div class="steps">
          <div class="step">
            <div class="num">1</div>
            <div class="stepText">
              <div class="stepTitle">Set up once</div>
              <div class="stepDesc">Upload your CV + choose what you want us to apply to.</div>
            </div>
          </div>
          <div class="step">
            <div class="num">2</div>
            <div class="stepText">
              <div class="stepTitle">We apply for you</div>
              <div class="stepDesc">Applications are prepared and sent on your behalf.</div>
            </div>
          </div>
          <div class="step">
            <div class="num">3</div>
            <div class="stepText">
              <div class="stepTitle">Track everything</div>
              <div class="stepDesc">See applied jobs and your application activity.</div>
            </div>
          </div>
        </div>
        <div class="hr"></div>
        <p class="small">If sign-in loops: Supabase Auth settings must allow this page URL as a redirect URL.</p>
      </aside>
    </div>

    <div class="footer">Support: <a href="mailto:team@jobmejob.com">team@jobmejob.com</a></div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
/* =========================================================
   Signup (old style) + fixed auto-continue after Google sign-in
   - No second click required after OAuth redirect
   - Includes Google logo in the button
   ========================================================= */

const API_BASE = (window.JobApplyAI && window.JobApplyAI.config && window.JobApplyAI.config.API_BASE)
  ? String(window.JobApplyAI.config.API_BASE).replace(/\/+$/, "")
  : "https://jobmejob.schoene-viktor.workers.dev";

const SUPABASE_URL = "https://awlzvhcnjegfhjedswko.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF3bHp2aGNuamVnZmhqZWRzd2tvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2NTE2OTgsImV4cCI6MjA4MjIyNzY5OH0.-UmHiVi0_g9tKDkr6ldfROeBrOk8hm18YVPRfnb8luY";
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* Storage: migrate safely from old "ja_/jobapplyai_" to new "jm_/jobmejob_" */
const LS = {
  userEmail: ["jm_user_email","ja_user_email"],
  customerId: ["jm_customer_id","ja_customer_id"],
  profileDone: ["jm_profile_complete","ja_profile_complete"],
  workplace: ["jobmejob_workplace","jobapplyai_workplace"]
};

function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

function lsGetFirst(keys){
  for(const k of keys){
    const v = localStorage.getItem(k);
    if(v !== null && v !== undefined && v !== "") return v;
  }
  return null;
}
function lsSetAll(keys, value){
  for(const k of keys){
    try{ localStorage.setItem(k, value); }catch(_){}
  }
}

function go(url){
  document.body.classList.add("leaving");
  setTimeout(()=>{ window.location.href = url; }, 180);
}

document.addEventListener("click",(e)=>{
  const a = e.target.closest("a[data-nav='1']");
  if(!a) return;
  const url = a.getAttribute("href");
  if(!url || url.startsWith("#")) return;
  e.preventDefault();
  go(url);
});

function resetLocalStateForNewUser(currentEmail){
  const last=(lsGetFirst(LS.userEmail)||"").trim().toLowerCase();
  const now=(currentEmail||"").trim().toLowerCase();
  if(!now) return;

  if(last && last!==now){
    // Clear any state tied to a different email (prevents cross-account mixing)
    Object.keys(localStorage).forEach(k=>{
      if(k.startsWith("ja_") || k.startsWith("jobapplyai_") || k.startsWith("jm_") || k.startsWith("jobmejob_")){
        try{ localStorage.removeItem(k); }catch(_){}
      }
    });
    try{ sessionStorage.removeItem("sb_access_token"); }catch(_){}
  }
  lsSetAll(LS.userEmail, now);
}

function hasProfile(){ return (lsGetFirst(LS.profileDone) === "true"); }

/* New flow: Profile is the onboarding step, then Dashboard is the "home". */
function nextStepUrl(){
  if(!hasProfile()) return "./profile.html";
  return "./dashboard.html";
}

function readWorkplace(){
  const raw = lsGetFirst(LS.workplace) || "";
  try{ return raw ? JSON.parse(raw) : {}; }catch(_){ return {}; }
}
function writeWorkplace(patch){
  const obj = readWorkplace();
  const next = { ...obj, ...patch };
  const payload = JSON.stringify(next);
  lsSetAll(LS.workplace, payload);
}
function syncIdentity({customerId,email}){
  if(customerId) lsSetAll(LS.customerId, customerId);
  if(email) lsSetAll(LS.userEmail, email);

  const wp = readWorkplace();
  writeWorkplace({
    apiBase: wp.apiBase || API_BASE,
    customerId: customerId || wp.customerId || wp.customer_id || null,
    customerEmail: email || wp.customerEmail || null
  });
}

async function upsertCustomerByEmail(email){
  const res = await fetch(`${API_BASE}/customers/upsert`,{
    method:"POST",
    headers:{ "content-type":"application/json" },
    body:JSON.stringify({ email })
  });
  if(!res.ok){
    const text = await res.text().catch(()=> "");
    throw new Error(`Customer upsert failed: ${res.status} ${text}`);
  }
  return await res.json();
}

function setTopState(text){ const el=document.getElementById("topState"); if(el) el.textContent = text; }
function setHint(text){ const el=document.getElementById("hint"); if(el) el.textContent = text; }
function setGoogleButton(disabled, text){
  const btn=document.getElementById("btnGoogle");
  const t=document.getElementById("btnGoogleText");
  if(btn) btn.disabled = !!disabled;
  if(t && text) t.textContent = text;
}

async function getSession(){
  const { data, error } = await supabaseClient.auth.getSession();
  if(error) return null;
  return data?.session || null;
}

async function loginWithGoogle(){
  // Always redirect back to THIS page on the current domain
  const redirectTo = `${window.location.origin}${window.location.pathname}`;
  const { error } = await supabaseClient.auth.signInWithOAuth({
    provider:"google",
    options:{ redirectTo }
  });
  if(error) throw error;
}

function showSignedIn(email){
  setTopState("Signed in");
  const row=document.getElementById("statusRow");
  const em=document.getElementById("signedEmail");
  if(row) row.style.display="";
  if(em) em.textContent=email;

  const adv=document.getElementById("advanced");
  if(adv) adv.style.display="";

  const copy=document.getElementById("copyToken");
  if(copy) copy.disabled=false;
}

function showSignedOut(){
  setTopState("Not signed in");
  const row=document.getElementById("statusRow");
  if(row) row.style.display="none";

  const adv=document.getElementById("advanced");
  if(adv) adv.style.display="none";

  setGoogleButton(false,"Continue with Google");
  setHint("You stay in control. Nothing is sent without your confirmation.");
}


function cameFromOAuth(){
  try{
    const qs = new URLSearchParams(window.location.search || "");
    return qs.has("code") || qs.has("access_token") || qs.has("refresh_token") || qs.has("type");
  }catch(_){
    return false;
  }
}

async function maybeExchangeCodeForSession(){
  try{
    const qs = new URLSearchParams(window.location.search || "");
    if(!qs.has("code")) return;
    if(!supabaseClient?.auth || typeof supabaseClient.auth.exchangeCodeForSession !== "function") return;

    // Best-effort: exchange the OAuth code for a session.
    const { error } = await supabaseClient.auth.exchangeCodeForSession(window.location.href);
    if(error) console.warn("exchangeCodeForSession failed", error);
  }catch(e){
    console.warn(e);
  }
}

async function waitForSession(maxMs){
  const start = Date.now();
  while(Date.now() - start < maxMs){
    const s = await getSession();
    if(s && s.user && s.user.email) return s;
    await sleep(200);
  }
  return null;
}

async function ensureCustomerAndContinue(email){
  // This is the step that previously forced a "second click" when it didn't run automatically.
  // We now run it on page load after OAuth redirect, and also retry a few times for cold starts.
  const attempts = 3;
  for(let i=0;i<attempts;i++){
    try{
      setGoogleButton(true, i === 0 ? "Setting up…" : "Retrying setup…");
      setHint(i === 0 ? "Setting up your account…" : "Still setting up (retry)…");
      const data = await upsertCustomerByEmail(email);
      if(data && data.customer_id){
        syncIdentity({ customerId: data.customer_id, email });
        setHint("Done. Taking you to setup…");
        await sleep(450);
        go(nextStepUrl());
        return;
      }
      throw new Error("Customer upsert returned no customer_id");
    }catch(e){
      console.warn(e);
      if(i < attempts - 1){
        await sleep(700 * (i + 1));
        continue;
      }
      // Last failure: let the user retry by clicking the button
      setHint("Could not finish setup. Please click again to retry, or switch account.");
      setGoogleButton(false,"Try again");
    }
  }
}

async function hydrate(){
  let session = null;

  // If we just came back from Google OAuth, the session can take a moment to be available.
  // This was the main reason you sometimes had to click "Continue with Google" a second time.
  if(cameFromOAuth()){
    setTopState("Signing in…");
    setHint("Finishing Google sign-in…");
    setGoogleButton(true,"Signing in…");

    // Best-effort exchange (covers cases where the library doesn't auto-handle it fast enough)
    await maybeExchangeCodeForSession();

    // Wait briefly for the session to appear
    session = await waitForSession(5000);

    // Clean URL (remove ?code=...) once we have a session (keeps the URL pretty)
    if(session){
      try{ history.replaceState({}, document.title, window.location.pathname); }catch(_){}
    }
  }

  // Normal path
  if(!session){
    session = await getSession();
  }

  if(!session || !session.user || !session.user.email){
    showSignedOut();
    return;
  }

  const email = String(session.user.email || "").trim().toLowerCase();
  resetLocalStateForNewUser(email);

  try{ sessionStorage.setItem("sb_access_token", session.access_token); }catch(_){}

  showSignedIn(email);

  // Automatically continue (no second click needed)
  await ensureCustomerAndContinue(email);
}


document.getElementById("btnGoogle").addEventListener("click", async ()=>{
  try{
    const session = await getSession();
    if(session && session.user && session.user.email){
      const email = String(session.user.email || "").trim().toLowerCase();
      showSignedIn(email);
      await ensureCustomerAndContinue(email);
      return;
    }
    setGoogleButton(true,"Opening Google…");
    setHint("Opening Google sign-in…");
    await loginWithGoogle();
  }catch(e){
    console.error(e);
    setHint("Sign-in failed. Please retry.");
    setGoogleButton(false,"Continue with Google");
  }
});

document.getElementById("btnSwitch").addEventListener("click", async ()=>{
  try{
    setHint("Switching account…");
    await supabaseClient.auth.signOut();
    try{ sessionStorage.removeItem("sb_access_token"); }catch(_){}
    showSignedOut();
  }catch(e){
    console.error(e);
    setHint("Could not switch. Please retry.");
  }
});

const btnLogout = document.getElementById("btnLogout");
if(btnLogout){
  btnLogout.addEventListener("click", async ()=>{
    try{
      await supabaseClient.auth.signOut();
      try{ sessionStorage.removeItem("sb_access_token"); }catch(_){}
      showSignedOut();
      setHint("Signed out.");
    }catch(e){
      console.error(e);
      setHint("Logout failed. Please retry.");
    }
  });
}

const copy = document.getElementById("copyToken");
if(copy){
  copy.addEventListener("click", async ()=>{
    try{
      const tok = sessionStorage.getItem("sb_access_token") || "";
      await navigator.clipboard.writeText(tok);
      setHint(tok ? "Access token copied." : "No token found.");
    }catch(e){
      console.error(e);
      setHint("Copy failed.");
    }
  });
}

// Run immediately so OAuth return continues automatically
(async ()=>{
  try{ await hydrate(); }catch(e){ console.error(e); }
})();
    </script>
  </div>
</div>
</body>
</html>
