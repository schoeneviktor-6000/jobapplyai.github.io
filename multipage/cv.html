<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>jobmejob • CV Studio</title>
  <meta name="description" content="Tailor your CV per role with ATS-safe formatting."/>

  <!-- Shared styles -->
  <link rel="stylesheet" href="./shared.css"/>

  <style>
    /* =========================================================
       CV Studio (page-only styles)
       ========================================================= */

    .layout{
      display:grid;
      grid-template-columns: 1fr 1.2fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
    }

    .sectionTitle{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .sectionTitle h2{
      margin:0;
      font-size:14px;
      letter-spacing:.02em;
      text-transform:uppercase;
      color:rgba(17,19,24,.70);
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > *{ flex: 1 1 auto; }

    .label{
      font-weight:900;
      font-size:13px;
      color:rgba(17,19,24,.80);
      margin:10px 0 6px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .hint{
      font-size:12px;
      color:rgba(17,19,24,.58);
      font-weight:650;
      line-height:1.45;
      margin-top:6px;
    }

    .selectWide{ width:100%; }
    .jobMeta{
      font-size:13px;
      color:rgba(17,19,24,.62);
      font-weight:700;
      line-height:1.4;
      white-space:pre-wrap;
    }

    /* Strength */
    .strengthWrap{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:6px;
    }
    .strengthTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    input[type="range"]{ width:100%; }
    .strengthPills{ display:flex; gap:8px; flex-wrap:wrap; }
    .miniPill{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(17,19,24,.12);
      background:rgba(17,19,24,.04);
      font-weight:900;
      font-size:12px;
      color:rgba(17,19,24,.78);
      white-space:nowrap;
      cursor:pointer;
      user-select:none;
    }
    .miniPill.active{
      border-color: rgba(34,197,94,.55);
      background: rgba(34,197,94,.14);
      color:#0a3d1f;
    }

    details.info{
      margin-top:10px;
      border:1px solid rgba(17,19,24,.10);
      border-radius:16px;
      background:rgba(255,255,255,.70);
      padding:10px 12px;
    }
    details.info summary{
      cursor:pointer;
      font-weight:900;
      color:rgba(17,19,24,.78);
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    details.info summary::-webkit-details-marker{display:none}

    /* Output */
    .outputTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .tabs{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .tabBtn{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(17,19,24,.12);
      background:rgba(17,19,24,.04);
      font-weight:900;
      font-size:12px;
      cursor:pointer;
    }
    .tabBtn.active{
      border-color: rgba(34,197,94,.55);
      background: rgba(34,197,94,.14);
      color:#0a3d1f;
    }

    .cvBox{
      margin-top:12px;
      border:1px solid rgba(17,19,24,.12);
      background:rgba(17,19,24,.03);
      border-radius:16px;
      padding:12px;
      overflow:auto;
      max-height: 56vh;
      -webkit-overflow-scrolling:touch;
    }

    /* Preview rendering (HTML) */
    .cvPreview{
      background: rgba(255,255,255,.72);
      border: 1px solid rgba(17,19,24,.10);
      border-radius: 14px;
      padding: 14px 14px;
    }
    .cvName{
      font-size:30px;
      font-weight:950;
      letter-spacing:-.6px;
      color: rgba(17,19,24,.86);
    }
    .cvRole{
      margin-top:4px;
      font-size:13px;
      font-weight:850;
      color: rgba(17,19,24,.58);
    }
    .cvContact{
      margin-top:8px;
      font-size:12.5px;
      color: rgba(17,19,24,.62);
      font-weight:700;
    }
    .cvSection{ margin-top:16px; }
    .cvSectionTitle{
      font-size:14px;
      font-weight:950;
      letter-spacing:.04em;
      text-transform:uppercase;
      border-bottom:3px solid rgba(17,19,24,.86);
      padding-bottom:6px;
      margin:0 0 10px 0;
    }
    .cvItem{ margin-top:10px; }
    .cvItemTitle{ font-size:13.5px; font-weight:950; }
    .cvItemSub{ margin-top:2px; font-size:12.5px; font-weight:850; color:rgba(17,19,24,.62); }
    .cvMetaLine{ margin-top:2px; font-size:12.5px; color:rgba(17,19,24,.62); }
    .cvUl{ margin:6px 0 0 18px; padding:0; }
    .cvUl li{ margin:0 0 3px 0; font-size:13px; line-height:1.45; }
    .cvPara{ font-size:13px; line-height:1.5; margin:0; }
    .cvSkillLine{ font-size:13px; line-height:1.5; margin:2px 0; }

    /* Text view */
    textarea.cvText{
      width:100%;
      min-height: 56vh;
      border:0;
      outline:none;
      resize:vertical;
      background:transparent;
      font-size:13px;
      line-height:1.45;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color: rgba(17,19,24,.92);
    }

    /* Sticky actions */
    .stickyActions{
      position:sticky;
      bottom:0;
      margin-top:12px;
      padding-top:10px;
      background:linear-gradient(180deg, rgba(255,255,255,0), rgba(255,255,255,.92) 30%, rgba(255,255,255,.96));
      backdrop-filter: blur(10px);
    }
    .stickyRow{ display:flex; gap:10px; flex-wrap:wrap; }
    @media (max-width:620px){
      .stickyRow{ flex-direction:column; }
      .stickyRow .btn{ width:100%; justify-content:center; }
      .cvBox{ max-height: 52vh; }
      textarea.cvText{ min-height: 52vh; }
    }

    /* KPIs */
    .kpiRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:10px;
    }
    .kpi{
      flex: 1 1 170px;
      min-width: 170px;
      border:1px solid rgba(17,19,24,.10);
      background:rgba(255,255,255,.78);
      border-radius:16px;
      padding:10px 12px;
    }
    .kpi .k{ font-size:12px; color:rgba(17,19,24,.60); font-weight:850; }
    .kpi .v{ margin-top:6px; font-size:18px; font-weight:980; letter-spacing:-.4px; }
    .bar{ height:10px; border-radius:999px; background:rgba(17,19,24,.08); overflow:hidden; margin-top:10px; }
    .bar > div{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(34,197,94,.70), rgba(22,163,74,.70));
      border-radius:999px;
      transition:width .25s ease;
    }

    /* Chips */
    .chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .chip{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(17,19,24,.12);
      background:rgba(17,19,24,.04);
      font-weight:850;
      font-size:12px;
      color:rgba(17,19,24,.78);
      white-space:nowrap;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .chip.good{ border-color: rgba(34,197,94,.38); background: rgba(34,197,94,.12); color:#0a3d1f; }
    .chip.warn{ border-color: rgba(255,179,0,.42); background: rgba(255,179,0,.12); color:#5a3b00; }

    /* Clickable missing keyword chips */
    button.chipBtn{
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid rgba(255,179,0,.48);
      background: rgba(255,179,0,.12);
    }
    button.chipBtn:hover{
      background: rgba(255,179,0,.16);
      transform: translateY(-1px);
    }
    .chipPlus{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:18px;
      height:18px;
      border-radius:999px;
      background: rgba(255,179,0,.22);
      border:1px solid rgba(255,179,0,.28);
      font-weight:950;
      flex:0 0 auto;
    }

    .monoSmall{
      white-space:pre-wrap;
      font-size:12px;
      line-height:1.45;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color: rgba(17,19,24,.72);
      background:rgba(17,19,24,.04);
      border:1px solid rgba(17,19,24,.12);
      border-radius:14px;
      padding:10px;
      margin-top:10px;
    }

    /* Description modal */
    .descMeta{
      margin-top:6px;
      color:rgba(17,19,24,.62);
      font-weight:700;
      font-size:13px;
      line-height:1.35;
    }

    /* Keyword modal */
    .formRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .formRow > *{ flex:1 1 220px; min-width:220px; }
    .field{
      border:1px solid rgba(17,19,24,.12);
      background: rgba(17,19,24,.03);
      border-radius:14px;
      padding:10px 12px;
    }
    .fieldLabel{
      font-weight:900;
      font-size:12px;
      color: rgba(17,19,24,.72);
      margin-bottom:8px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .checkLine{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(17,19,24,.12);
      background: rgba(255,255,255,.72);
      font-size:13px;
      font-weight:800;
      color: rgba(17,19,24,.78);
    }
    .checkLine input{ margin-top:3px; }
    .tinyNote{
      font-size:12px;
      line-height:1.45;
      color: rgba(17,19,24,.60);
      font-weight:650;
      margin-top:8px;
    }
    .kwPreview{
      white-space:pre-wrap;
      font-size:12.5px;
      line-height:1.45;
      background: rgba(17,19,24,.03);
      border:1px solid rgba(17,19,24,.10);
      border-radius:14px;
      padding:10px 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      color: rgba(17,19,24,.86);
      margin-top:8px;
    }
    .pillToggle{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .pillToggle button{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(17,19,24,.12);
      background: rgba(17,19,24,.04);
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .pillToggle button.active{
      border-color: rgba(34,197,94,.55);
      background: rgba(34,197,94,.14);
      color:#0a3d1f;
    }

    .warnBox{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,179,0,.42);
      background: rgba(255,179,0,.10);
      color:#5a3b00;
      font-weight:800;
      font-size:12.5px;
      line-height:1.45;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <nav class="nav">
      <a class="brand" href="./index.html" data-nav="1" aria-label="Home">
        <span class="logo" aria-hidden="true"></span>
        <span>jobmejob</span>
      </a>

      <div class="navlinks">
        <a class="pill" href="./index.html" data-nav="1">Home</a>
        <a class="pill" href="./profile.html" data-nav="1">Profile</a>
        <a class="pill" href="./plan.html" data-nav="1">Plan</a>
        <a class="pill" href="./jobs.html" data-nav="1">Jobs</a>
        <a class="pill" href="./dashboard.html" data-nav="1">Dashboard</a>
        <a class="pill active" href="./cv.html" data-nav="1">CV Studio</a>

        <a class="pill" href="./signup.html" id="navSignIn" data-nav="1">Sign in</a>
        <button class="pill" id="navLogout" type="button" style="display:none;">Logout</button>
      </div>
    </nav>
  </header>

  <main class="main">
    <h1 class="h1">CV Studio</h1>
    <p class="sub" id="subTitle">Tailor your CV per role with ATS-safe formatting. Job search + CV tailoring stay free.</p>

    <div class="errorTop" id="errorTop"></div>

    <section class="layout">
      <!-- LEFT: Controls -->
      <div class="card">
        <div class="sectionTitle">
          <h2 id="setupTitle">Setup</h2>
          <span class="badge warn" id="authBadge">Checking…</span>
        </div>

        <div class="label" id="jobToTailorLbl">Job to tailor</div>
        <div class="row">
          <select id="jobSelect" class="selectWide">
            <option value="">Loading…</option>
          </select>
          <a class="btn" href="./jobs.html" data-nav="1" style="flex:0 0 auto" id="openJobsBtn">Open Jobs</a>
        </div>
        <div class="hint" id="jobHint">Pick a job from your queue.</div>
        <div class="jobMeta" id="jobMeta"></div>

        <div class="row" style="margin-top:10px">
          <button class="btn ghost" id="btnViewDesc" type="button" disabled>View description</button>
          <button class="btn ghost" id="btnCopyDesc" type="button" disabled>Copy description</button>
        </div>

        <div class="hr"></div>

        <div class="label">
          <span id="templateLbl">Template</span>
          <span class="badge" title="ATS-safe formatting" id="atsSafeBadge">ATS-safe</span>
        </div>
        <div class="row">
          <select id="tplSelect" class="selectWide">
            <option value="professional">Professional (ATS-safe)</option>
          </select>
          <button class="btn ghost" id="btnAtsInfo" type="button" style="flex:0 0 auto">ATS?</button>
        </div>
        <div class="hint" id="atsHintLine">ATS-safe formatting = simple headings, no tables/columns, easy-to-parse structure.</div>

        <div class="label" id="tailorStrengthLbl">Tailoring strength</div>
        <div class="strengthWrap">
          <div class="strengthTop">
            <div class="strengthPills" id="strengthPills">
              <span class="miniPill" data-s="0" id="pillLight">Light</span>
              <span class="miniPill active" data-s="1" id="pillBalanced">Balanced</span>
              <span class="miniPill" data-s="2" id="pillAggressive">Aggressive</span>
            </div>
            <span class="badge" id="strengthBadge">Balanced</span>
          </div>

          <input id="strengthRange" type="range" min="0" max="2" step="1" value="1" />

          <div class="hint" id="strengthHint">
            Improves summary and bullets to match the job, without over-rewriting.
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <button class="btn primary" id="btnGenerate" type="button" disabled>Generate tailored CV</button>
          <button class="btn" id="btnGenerateAgain" type="button" disabled>Generate again</button>
        </div>
        <div class="hint" id="genHint">
          Same settings reuse a cached result (fast). To create a different version, change the tailoring strength.
        </div>

        <details class="info" open>
          <summary>
            <span id="stepsTitle">What we tailor (step-by-step)</span>
            <span class="badge" id="stepsBadge">Ready</span>
          </summary>

          <div class="hint" style="margin-top:8px" id="stepsIntro">
            This is what happens when you click “Generate”:
          </div>

          <ul style="margin:10px 0 0 18px; color:rgba(17,19,24,.70); font-weight:750; line-height:1.55" id="stepsList">
            <li><span id="s1">Extract job keywords</span></li>
            <li><span id="s2">Align summary & bullets</span></li>
            <li><span id="s3">Keep ATS-safe structure</span></li>
            <li><span id="s4">Compute ATS match</span></li>
            <li><span id="s5">Prepare preview & export</span></li>
          </ul>

          <div class="hint" style="margin-top:10px" id="truthHint">
            We stay truthful: we never invent experience or certifications. We only rephrase / reorder based on your uploaded CV + profile.
          </div>
        </details>

        <details class="info" id="pipelineDetails">
          <summary>
            <span id="pipelineTitle">Pipeline status</span>
            <span class="badge" id="pipeBadge">—</span>
          </summary>
          <div class="monoSmall" id="pipeBox">Generate a CV to see pipeline details.</div>
        </details>
      </div>

      <!-- RIGHT: Output -->
      <div class="card">
        <div class="outputTop">
          <div>
            <div style="font-weight:980;font-size:18px;letter-spacing:-.2px" id="tailoredTitle">Tailored CV</div>
            <div class="hint" id="outHint">Generate a CV to see preview and ATS match.</div>
          </div>

          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
            <span class="badge warn" id="outStatus">Not generated</span>
            <span class="badge" id="outModel">Model: —</span>
          </div>
        </div>

        <div class="kpiRow">
          <div class="kpi">
            <div class="k" id="kpiAts">ATS match</div>
            <div class="v" id="atsScore">—</div>
            <div class="bar" aria-hidden="true"><div id="atsBar"></div></div>
            <div class="hint" id="atsHint">Calculated from keyword coverage (used vs missing).</div>
          </div>

          <div class="kpi">
            <div class="k" id="kpiUsed">Keywords used</div>
            <div class="v" id="kwUsedCount">—</div>
            <div class="hint" id="kpiUsedHint">Found in your tailored CV.</div>
          </div>

          <div class="kpi">
            <div class="k" id="kpiMissing">Keywords missing</div>
            <div class="v" id="kwMissCount">—</div>
            <div class="hint" id="kpiMissingHint">Click a missing keyword to add it (truthfully).</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="tabs" role="tablist" aria-label="Output view">
          <button class="tabBtn active" id="tabPreview" type="button">Preview</button>
          <button class="tabBtn" id="tabText" type="button">Text</button>
        </div>

        <div class="cvBox" id="cvBox">
          <div id="cvPreviewWrap" style="display:block;">
            <div id="cvPreview" class="cvPreview">
              <div class="hint">No CV generated yet.</div>
            </div>
          </div>

          <div id="cvTextWrap" style="display:none;">
            <textarea class="cvText" id="cvText" spellcheck="false"></textarea>
          </div>
        </div>

        <div class="stickyActions">
          <div class="stickyRow">
            <button class="btn" id="btnCopy" type="button" disabled>Copy</button>
            <button class="btn" id="btnDownload" type="button" disabled>Download .txt</button>
            <button class="btn primary" id="btnPrint" type="button" disabled>Print / PDF</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="sectionTitle" style="margin-bottom:6px">
          <h2 id="atsKwTitle">ATS keywords</h2>
          <div class="row" style="justify-content:flex-end; flex:0 0 auto">
            <button class="btn small" id="btnUndoEdit" type="button" disabled>Undo</button>
            <button class="btn small" id="btnResetEdits" type="button" disabled>Reset</button>
            <button class="btn small" id="btnCopyMissing" type="button" disabled>Copy missing</button>
          </div>
        </div>

        <div class="hint" id="atsKwHint">These keywords are extracted from the job description. Click a missing keyword to add it to your CV (truthfully) and improve your ATS match.</div>

        <div class="label" style="margin-top:12px" id="usedLbl">Used</div>
        <div class="chips" id="chipsUsed"></div>

        <div class="label" style="margin-top:12px" id="missingLbl">Missing</div>
        <div class="chips" id="chipsMissing"></div>

        <details class="info" style="margin-top:12px">
          <summary id="debugTitle">Debug details</summary>
          <div class="monoSmall" id="debugBox">—</div>
        </details>
      </div>
    </section>
  </main>

  <!-- ATS info modal -->
  <div class="modalBackdrop" id="atsModal" style="display:none" role="dialog" aria-modal="true" aria-labelledby="atsTitle">
    <div class="modalCard">
      <div class="modalScroll">
        <div class="modalHeader">
          <div>
            <h3 class="modalTitle" id="atsTitle">What does ATS mean?</h3>
            <div class="hint" style="margin-top:6px" id="atsModalIntro">
              ATS = Applicant Tracking System. Companies use ATS to parse, search, and rank CVs.
            </div>
          </div>
          <button class="btn small" id="atsClose" type="button">Close</button>
        </div>

        <div class="hr"></div>

        <div class="hint" id="atsModalBody">
          <b>ATS-safe formatting</b> improves the chance your CV is parsed correctly:
          <ul style="margin:10px 0 0 18px; line-height:1.6">
            <li>Use simple headings (Experience, Education, Skills).</li>
            <li>Avoid tables, columns, text boxes, and complex layouts.</li>
            <li>Use consistent dates and bullet structure.</li>
          </ul>
          <div style="margin-top:10px">
            Our CV Studio keeps formatting simple and focuses on keywords and relevance — without inventing facts.
          </div>
        </div>
      </div>

      <div class="modalActions">
        <button class="btn primary" id="atsOk" type="button">Got it</button>
      </div>
    </div>
  </div>

  <!-- Job description modal -->
  <div class="modalBackdrop" id="descModal" style="display:none" role="dialog" aria-modal="true" aria-labelledby="descH">
    <div class="modalCard">
      <div class="modalScroll">
        <div class="modalHeader">
          <div style="min-width:0">
            <h3 class="modalTitle" id="descH">Job description</h3>
            <div class="descMeta" id="descMeta"></div>
          </div>
          <button class="btn small" id="descClose" type="button">Close</button>
        </div>
        <div class="hr"></div>
        <div class="modalMonoBox" id="descText">Loading…</div>
      </div>
      <div class="modalActions">
        <button class="btn" id="descCopy" type="button">Copy</button>
        <a class="btn primary" id="descOpen" href="#" target="_blank" rel="noopener">Open apply link</a>
      </div>
    </div>
  </div>

  <!-- Keyword booster modal -->
  <div class="modalBackdrop" id="kwModal" style="display:none" role="dialog" aria-modal="true" aria-labelledby="kwH">
    <div class="modalCard">
      <div class="modalScroll">
        <div class="modalHeader">
          <div style="min-width:0">
            <h3 class="modalTitle" id="kwH">Add keyword</h3>
            <div class="hint" style="margin-top:6px" id="kwSub">Add missing keywords — only if it's truly accurate for you.</div>
          </div>
          <button class="btn small" id="kwClose" type="button">Close</button>
        </div>

        <div class="hr"></div>

        <div class="field">
          <div class="fieldLabel" id="kwFieldLbl">Keyword</div>
          <div class="chips" style="margin-top:0">
            <span class="chip warn" id="kwChip">—</span>
          </div>

          <div class="checkLine" style="margin-top:10px">
            <input type="checkbox" id="kwTruth"/>
            <div>
              <div id="kwTruthLbl">I confirm this keyword is true for me.</div>
              <div class="tinyNote" id="kwTruthNote">We never invent experience. If it's not true, don’t add it.</div>
            </div>
          </div>
        </div>

        <div class="formRow" style="margin-top:12px">
          <div class="field">
            <div class="fieldLabel" id="kwWhereLbl">Where should it appear?</div>
            <select id="kwTarget">
              <option value="skills">Skills (recommended)</option>
              <option value="experience">Experience</option>
            </select>
            <div class="tinyNote" id="kwWhereNote">Skills is usually the safest option for ATS without adding new claims.</div>
          </div>

          <div class="field">
            <div class="fieldLabel" id="kwLangLbl">Language</div>
            <select id="kwLang">
              <option value="auto">Auto (match CV)</option>
              <option value="de">German</option>
              <option value="en">English</option>
            </select>
            <div class="tinyNote" id="kwLangNote">Auto matches your CV language. Choose German if your CV is in German.</div>
          </div>
        </div>

        <div class="field" style="margin-top:12px">
          <div class="fieldLabel" id="kwModeLbl">Insertion mode</div>
          <div class="pillToggle" id="kwModeToggle">
            <button type="button" data-mode="ai" class="active" id="kwModeAi">AI rewrite</button>
            <button type="button" data-mode="quick" id="kwModeQuick">Quick (no AI)</button>
          </div>
          <div class="tinyNote" id="kwModeNote">AI tries to integrate the keyword naturally into an existing bullet. If your backend has no AI endpoint, we automatically fall back to smart templates.</div>
        </div>

        <!-- Skills target -->
        <div id="kwSkillsBox" style="margin-top:12px">
          <div class="field">
            <div class="fieldLabel" id="kwSkillsGroupLbl">Which skill area?</div>
            <select id="kwSkillGroup"></select>
            <div class="tinyNote" id="kwSkillsGroupNote">We add the keyword with clean casing and consistent style.</div>
          </div>
        </div>

        <!-- Experience target -->
        <div id="kwExpBox" style="margin-top:12px; display:none">
          <div class="field">
            <div class="fieldLabel" id="kwExpRoleLbl">Which role?</div>
            <select id="kwExpRole"></select>
          </div>

          <div class="field" style="margin-top:12px">
            <div class="fieldLabel" id="kwExpHowLbl">How to insert?</div>
            <select id="kwExpHow">
              <option value="rewrite">Rewrite an existing bullet (recommended)</option>
              <option value="append">Append to an existing bullet</option>
              <option value="new">Add a new bullet</option>
            </select>
            <div class="tinyNote" id="kwExpHowNote">Rewriting is most natural and stays close to your real statements.</div>
          </div>

          <div class="field" style="margin-top:12px" id="kwBulletPickBox">
            <div class="fieldLabel" id="kwExpBulletLbl">Which bullet?</div>
            <select id="kwExpBullet"></select>
            <div class="kwPreview" id="kwBulletPreview">—</div>
          </div>

          <div class="field" style="margin-top:12px; display:none" id="kwNoteBox">
            <div class="fieldLabel" id="kwNoteLbl">Short note (important for new bullet)</div>
            <textarea id="kwNote" rows="3" style="width:100%;border:0;outline:none;background:transparent;resize:vertical;font-weight:750"></textarea>
            <div class="tinyNote" id="kwNoteHelp">Example: “Facilitated client workshops”, “Implemented OKRs”, “Built SQL reports”. Keeps it 100% truthful.</div>
          </div>

          <div class="warnBox" id="kwNewWarn" style="display:none">
            Tip: A new bullet without context can look “made up”. If you don’t add a note, it’s safer to add the keyword under Skills.
          </div>
        </div>

        <div class="field" style="margin-top:12px">
          <div class="fieldLabel" id="kwPreviewLbl">Preview</div>
          <div class="kwPreview" id="kwResultPreview">—</div>
          <div class="tinyNote" id="kwPreviewNote">You can always use Undo/Reset.</div>
        </div>

      </div>

      <div class="modalActions">
        <button class="btn" id="kwCancel" type="button">Cancel</button>
        <button class="btn primary" id="kwApply" type="button">Apply</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./auth.js"></script>
  <script src="./shared.js"></script>

  <script>
  (() => {
    "use strict";

    const S = window.JobMeJobShared || null;

    // Fallbacks (so one missing helper doesn't break the whole page)
    const F = {
      escapeHtml: (s) => String(s ?? "").replace(/[&<>"']/g, (c) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])),
      showModal: (id) => { const el = document.getElementById(id); if(el) el.style.display=""; },
      hideModal: (id) => { const el = document.getElementById(id); if(el) el.style.display="none"; },
      showTopError: (id, msg) => { const el = document.getElementById(id); if(el){ el.textContent = msg||""; el.style.display = msg ? "" : "none"; } },
      setBadge: (id, cls, txt) => {
        const el = document.getElementById(id); if(!el) return;
        el.className = "badge" + (cls ? (" " + cls) : "");
        el.textContent = txt ?? "";
      },
      resolveApiBase: (x) => String(x || "").trim()
    };

    const H = {
      escapeHtml: S?.escapeHtml ? S.escapeHtml : F.escapeHtml,
      showModal: S?.showModal ? S.showModal : F.showModal,
      hideModal: S?.hideModal ? S.hideModal : F.hideModal,
      showTopError: S?.showTopError ? S.showTopError : F.showTopError,
      setBadge: S?.setBadge ? S.setBadge : F.setBadge,
      resolveApiBase: S?.resolveApiBase ? S.resolveApiBase : F.resolveApiBase,
      wireNavTransitions: S?.wireNavTransitions ? S.wireNavTransitions.bind(S) : (()=>{})
    };

    H.wireNavTransitions();

    const $ = (id) => document.getElementById(id);

    const API_BASE = H.resolveApiBase("https://jobmejob.schoene-viktor.workers.dev").replace(/\/+$/, "");

    let session = null;
    let jobs = [];
    let selectedJob = null;
    let selectedDesc = "";
    let selectedApplyUrl = "";

    let lastCvText = "";
    let lastCvDoc = null;
    let lastLang = "en";

    // Keyword tracking
    let atsKeywordsAll = [];     // full list from server (union)
    let lastUsed = [];
    let lastMissing = [];
    let lastDebug = {};

    // Edits
    let baseSnapshot = null;
    let historyStack = [];

    // Keyword modal state
    let activeKeywordRaw = "";
    let activeKeywordDisplay = "";
    let kwMode = "ai"; // ai | quick

    // UI language (interface). Keep English UI; keyword insertion language follows your CV language (auto).
    let uiLang = "en";

    /* -------------------------
       i18n (interface)
       ------------------------- */
    const I18N = {
      de: {
        subTitle: "Passe deinen CV pro Rolle an – ATS-sicher formatiert. Jobsuche + CV Tailoring bleiben gratis.",
        setupTitle: "Setup",
        jobToTailorLbl: "Job auswählen",
        openJobsBtn: "Jobs öffnen",
        btnViewDesc: "Beschreibung ansehen",
        btnCopyDesc: "Beschreibung kopieren",
        templateLbl: "Template",
        atsHintLine: "ATS-sicher = einfache Überschriften, keine Tabellen/Spalten, leicht zu parsen.",
        tailorStrengthLbl: "Tailoring-Stärke",
        light: "Leicht",
        balanced: "Balanced",
        aggressive: "Aggressiv",
        gen: "Tailored CV generieren",
        genAgain: "Neu generieren",
        stepsTitle: "Was wir anpassen (Schritt für Schritt)",
        stepsIntro: "Das passiert, wenn du auf „Generieren“ klickst:",
        s1: "Job-Keywords extrahieren",
        s2: "Summary & Bullets anpassen",
        s3: "ATS-sichere Struktur beibehalten",
        s4: "ATS Match berechnen",
        s5: "Preview & Export vorbereiten",
        truthHint: "Wir bleiben ehrlich: Wir erfinden keine Erfahrung oder Zertifikate. Wir formulieren nur um / sortieren um – basierend auf deinem hochgeladenen CV + Profil.",
        pipelineTitle: "Pipeline-Status",

        tailoredTitle: "Tailored CV",
        outHint: "Generiere einen CV, um Preview und ATS Match zu sehen.",
        kpiAts: "ATS Match",
        atsHint: "Berechnet aus Keyword-Abdeckung (used vs missing).",
        kpiUsed: "Keywords gefunden",
        kpiUsedHint: "Im CV gefunden.",
        kpiMissing: "Keywords fehlen",
        kpiMissingHint: "Klicke ein fehlendes Keyword, um es (ehrlich) einzufügen.",
        tabPreview: "Preview",
        tabText: "Text",
        copy: "Kopieren",
        download: "Download .txt",
        print: "Drucken / PDF",

        atsKwTitle: "ATS Keywords",
        undo: "Undo",
        reset: "Reset",
        copyMissing: "Fehlende kopieren",
        atsKwHint: "Diese Keywords kommen aus der Jobbeschreibung. Klicke ein fehlendes Keyword, um es (ehrlich) einzufügen und dein ATS Match zu verbessern.",
        usedLbl: "Used",
        missingLbl: "Missing",
        debugTitle: "Debug Details",

        // Keyword modal
        kwH: "Add keyword",
        kwSub: "Add missing keywords — only if it's truly accurate for you.",
        close: "Schließen",
        kwTruthLbl: "I confirm this keyword is true for me.",
        kwTruthNote: "We never invent experience. If it's not true, don’t add it.",
        kwWhereLbl: "Where should it appear?",
        kwWhereNote: "Skills is usually the safest option for ATS without adding new claims.",
        kwLangLbl: "Language",
        kwLangNote: "Auto passt zur Sprache deines CV. Wähle Deutsch, wenn dein CV auf Deutsch ist.",
        kwModeLbl: "Insertion mode",
        kwModeAi: "AI rewrite",
        kwModeQuick: "Quick (no AI)",
        kwModeNote: "KI integriert das Keyword natürlich. Falls dein Backend keinen KI-Endpunkt hat, nutzen wir automatisch Smart-Templates.",
        kwSkillsGroupLbl: "Which skill area?",
        kwSkillsGroupNote: "We add the keyword with clean casing and consistent style.",
        kwExpRoleLbl: "Which role?",
        kwExpHowLbl: "How to insert?",
        kwExpHowNote: "Rewriting is most natural and stays close to your real statements.",
        kwExpBulletLbl: "Which bullet?",
        kwNoteLbl: "Short note (important for new bullet)",
        kwNoteHelp: "Beispiel: „Kundenworkshops moderiert“, „OKRs eingeführt“, „SQL-Reports gebaut“. Damit bleibt es 100% wahrheitsgemäß.",
        kwPreviewLbl: "Preview",
        kwPreviewNote: "You can always use Undo/Reset.",
        kwCancel: "Cancel",
        kwApply: "Apply",

        // errors
        pickJob: "Bitte wähle zuerst einen Job.",
        needCv: "Bitte generiere zuerst einen CV.",
        truthRequired: "Bitte bestätige, dass das Keyword für dich zutrifft.",
        needDoc: "Für diese Aktion brauchen wir die strukturierte CV-Ansicht (Preview). Bitte generiere den CV erneut.",
        noteRequired: "Bitte gib einen kurzen Hinweis, wie du das Keyword wirklich angewendet hast (für einen neuen Bullet).",
        aiFallback: "KI-Endpunkt nicht verfügbar — Smart-Template wurde verwendet.",
        added: "Eingefügt ✓",
        copied: "Kopiert ✓"
      },
      en: {
        subTitle: "Tailor your CV per role with ATS-safe formatting. Job search + CV tailoring stay free.",
        setupTitle: "Setup",
        jobToTailorLbl: "Job to tailor",
        openJobsBtn: "Open Jobs",
        btnViewDesc: "View description",
        btnCopyDesc: "Copy description",
        templateLbl: "Template",
        atsHintLine: "ATS-safe formatting = simple headings, no tables/columns, easy-to-parse structure.",
        tailorStrengthLbl: "Tailoring strength",
        light: "Light",
        balanced: "Balanced",
        aggressive: "Aggressive",
        gen: "Generate tailored CV",
        genAgain: "Generate again",
        stepsTitle: "What we tailor (step-by-step)",
        stepsIntro: "This is what happens when you click “Generate”:",
        s1: "Extract job keywords",
        s2: "Align summary & bullets",
        s3: "Keep ATS-safe structure",
        s4: "Compute ATS match",
        s5: "Prepare preview & export",
        truthHint: "We stay truthful: we never invent experience or certifications. We only rephrase / reorder based on your uploaded CV + profile.",
        pipelineTitle: "Pipeline status",

        tailoredTitle: "Tailored CV",
        outHint: "Generate a CV to see preview and ATS match.",
        kpiAts: "ATS match",
        atsHint: "Calculated from keyword coverage (used vs missing).",
        kpiUsed: "Keywords used",
        kpiUsedHint: "Found in your tailored CV.",
        kpiMissing: "Keywords missing",
        kpiMissingHint: "Click a missing keyword to add it (truthfully).",
        tabPreview: "Preview",
        tabText: "Text",
        copy: "Copy",
        download: "Download .txt",
        print: "Print / PDF",

        atsKwTitle: "ATS keywords",
        undo: "Undo",
        reset: "Reset",
        copyMissing: "Copy missing",
        atsKwHint: "These keywords are extracted from the job description. Click a missing keyword to add it to your CV (truthfully) and improve your ATS match.",
        usedLbl: "Used",
        missingLbl: "Missing",
        debugTitle: "Debug details",

        kwH: "Add keyword",
        kwSub: "Add missing keywords — only if they are truly accurate.",
        close: "Close",
        kwTruthLbl: "I confirm this keyword is true for me.",
        kwTruthNote: "We don’t invent experience. If it’s not true, don’t add it.",
        kwWhereLbl: "Where should it appear?",
        kwWhereNote: "Skills is usually the safest ATS option without creating new claims.",
        kwLangLbl: "Language",
        kwLangNote: "Auto matches your CV language. Choose German if your CV is in German.",
        kwModeLbl: "Insert mode",
        kwModeAi: "AI wording",
        kwModeQuick: "Quick (no AI)",
        kwModeNote: "AI tries to integrate the keyword naturally. If your backend has no AI endpoint, we automatically fall back to smart templates.",
        kwSkillsGroupLbl: "Which skill area?",
        kwSkillsGroupNote: "We add the keyword in consistent casing and style.",
        kwExpRoleLbl: "Which role?",
        kwExpHowLbl: "How to insert?",
        kwExpHowNote: "Rewriting is most natural and stays close to your real statements.",
        kwExpBulletLbl: "Which bullet?",
        kwNoteLbl: "Short note (important for new bullet)",
        kwNoteHelp: "Example: “Facilitated client workshops”, “Implemented OKRs”, “Built SQL reports”. Keeps it 100% truthful.",
        kwPreviewLbl: "Preview",
        kwPreviewNote: "You can always use Undo/Reset.",
        kwCancel: "Cancel",
        kwApply: "Apply",

        pickJob: "Pick a job first.",
        needCv: "Generate a CV first.",
        truthRequired: "Please confirm the keyword is true for you.",
        needDoc: "This action needs the structured CV view (Preview). Please generate again.",
        noteRequired: "Please add a short note describing how you actually used this keyword (for a new bullet).",
        aiFallback: "AI endpoint not available — used smart template instead.",
        added: "Applied ✓",
        copied: "Copied ✓"
      }
    };

    function guessUiLang(){
      return "en"; // Keep the interface in English
    }

    function t(key){
      return (I18N[uiLang] && I18N[uiLang][key]) || (I18N.en[key]) || key;
    }

    function applyUiTexts(){
      uiLang = guessUiLang();
      // top
      $("subTitle").textContent = t("subTitle");
      $("setupTitle").textContent = t("setupTitle");
      $("jobToTailorLbl").textContent = t("jobToTailorLbl");
      $("openJobsBtn").textContent = t("openJobsBtn");
      $("btnViewDesc").textContent = t("btnViewDesc");
      $("btnCopyDesc").textContent = t("btnCopyDesc");
      $("templateLbl").textContent = t("templateLbl");
      $("atsHintLine").textContent = t("atsHintLine");
      $("tailorStrengthLbl").textContent = t("tailorStrengthLbl");
      $("pillLight").textContent = t("light");
      $("pillBalanced").textContent = t("balanced");
      $("pillAggressive").textContent = t("aggressive");
      $("btnGenerate").textContent = t("gen");
      $("btnGenerateAgain").textContent = t("genAgain");

      $("stepsTitle").textContent = t("stepsTitle");
      $("stepsIntro").textContent = t("stepsIntro");
      $("s1").textContent = t("s1");
      $("s2").textContent = t("s2");
      $("s3").textContent = t("s3");
      $("s4").textContent = t("s4");
      $("s5").textContent = t("s5");
      $("truthHint").textContent = t("truthHint");
      $("pipelineTitle").textContent = t("pipelineTitle");

      $("tailoredTitle").textContent = t("tailoredTitle");
      // outHint is dynamic, leave default value for now
      $("kpiAts").textContent = t("kpiAts");
      $("atsHint").textContent = t("atsHint");
      $("kpiUsed").textContent = t("kpiUsed");
      $("kpiUsedHint").textContent = t("kpiUsedHint");
      $("kpiMissing").textContent = t("kpiMissing");
      $("kpiMissingHint").textContent = t("kpiMissingHint");

      $("tabPreview").textContent = t("tabPreview");
      $("tabText").textContent = t("tabText");
      $("btnCopy").textContent = t("copy");
      $("btnDownload").textContent = t("download");
      $("btnPrint").textContent = t("print");

      $("atsKwTitle").textContent = t("atsKwTitle");
      $("btnUndoEdit").textContent = t("undo");
      $("btnResetEdits").textContent = t("reset");
      $("btnCopyMissing").textContent = t("copyMissing");
      $("atsKwHint").textContent = t("atsKwHint");
      $("usedLbl").textContent = t("usedLbl");
      $("missingLbl").textContent = t("missingLbl");
      $("debugTitle").textContent = t("debugTitle");

      // Keyword modal
      $("kwH").textContent = t("kwH");
      $("kwSub").textContent = t("kwSub");
      $("kwClose").textContent = t("close");
      $("kwTruthLbl").textContent = t("kwTruthLbl");
      $("kwTruthNote").textContent = t("kwTruthNote");
      $("kwWhereLbl").textContent = t("kwWhereLbl");
      $("kwWhereNote").textContent = t("kwWhereNote");
      $("kwLangLbl").textContent = t("kwLangLbl");
      $("kwLangNote").textContent = t("kwLangNote");
      $("kwModeLbl").textContent = t("kwModeLbl");
      $("kwModeAi").textContent = t("kwModeAi");
      $("kwModeQuick").textContent = t("kwModeQuick");
      $("kwModeNote").textContent = t("kwModeNote");
      $("kwSkillsGroupLbl").textContent = t("kwSkillsGroupLbl");
      $("kwSkillsGroupNote").textContent = t("kwSkillsGroupNote");
      $("kwExpRoleLbl").textContent = t("kwExpRoleLbl");
      $("kwExpHowLbl").textContent = t("kwExpHowLbl");
      $("kwExpHowNote").textContent = t("kwExpHowNote");
      $("kwExpBulletLbl").textContent = t("kwExpBulletLbl");
      $("kwNoteLbl").textContent = t("kwNoteLbl");
      $("kwNoteHelp").textContent = t("kwNoteHelp");
      $("kwPreviewLbl").textContent = t("kwPreviewLbl");
      $("kwPreviewNote").textContent = t("kwPreviewNote");
      $("kwCancel").textContent = t("kwCancel");
      $("kwApply").textContent = t("kwApply");
    }

    /* -------------------------
       Helpers
       ------------------------- */
    function showError(msg){ H.showTopError("errorTop", msg || ""); }
    function setBadge(id, cls, txt){ H.setBadge(id, cls, txt); }
    function setText(id, txt){ const el = $(id); if (el) el.textContent = (txt == null) ? "" : String(txt); }

    function qs(name){
      try{ return new URL(window.location.href).searchParams.get(name); }
      catch{ return null; }
    }

    function joinNonEmpty(arr, sep){
      return (arr || []).map(x => String(x || "").trim()).filter(Boolean).join(sep);
    }
    function asStringArr(arr, max=999){
      if(!Array.isArray(arr)) return [];
      return arr.map(x => String(x || "").trim()).filter(Boolean).slice(0, max);
    }

    function deepCopy(obj){
      try{ return JSON.parse(JSON.stringify(obj)); }catch(_){ return null; }
    }

    function formatLoc(j){
      const parts = [];
      if (j.city) parts.push(j.city);
      if (j.region && j.region !== j.city) parts.push(j.region);
      if (j.country) parts.push(j.country);
      return parts.filter(Boolean).join(", ");
    }

    function applyUrlSafe(url){
      const u = String(url || "").trim();
      if (!u) return "";
      if (/^https?:\/\//i.test(u)) return u;
      return "https://" + u.replace(/^\/+/, "");
    }

    function isLikelyGerman(lang){
      const l = String(lang || "").toLowerCase();
      return l.startsWith("de");
    }

    /* Keyword casing + matching */
    const ACRONYMS = new Set([
      "API","APIs","SQL","AWS","GCP","AZURE","KPI","KPIs","OKR","OKRs","CRM","ERP","ETL","CI/CD","CI","CD","SaaS","B2B","B2C","GDPR","DSGVO","HR","UX","UI","QA","SEO","SEA"
    ]);

    function normalizeSpaces(s){ return String(s||"").replace(/\s+/g," ").trim(); }

    function titleCaseWord(w){
      if(!w) return w;
      const up = w.toUpperCase();
      if(ACRONYMS.has(up)) return up;
      // keep words that already contain uppercase letters or digits
      if(/[A-ZÄÖÜ]/.test(w)) return w;
      return w.charAt(0).toUpperCase() + w.slice(1);
    }

    function prettyKeyword(raw, lang){
      const k = normalizeSpaces(raw);
      if(!k) return k;

      // If it looks like an acronym, upper it
      if(k.length <= 5 && /^[a-z0-9\/\-\+]+$/.test(k) && /[a-z]/.test(k)){
        const up = k.toUpperCase();
        if(ACRONYMS.has(up)) return up;
      }

      // If mostly lowercase, apply title-ish case
      const lowerRatio = (k.match(/[a-zäöü]/g)||[]).length / Math.max(1,(k.match(/[a-zA-ZÄÖÜäöü]/g)||[]).length);
      if(lowerRatio > 0.75){
        const parts = k.split(" ").map(p => {
          // handle hyphenated
          return p.split("-").map(titleCaseWord).join("-");
        });
        return parts.join(" ");
      }
      return k;
    }

    function normForMatch(s){
      // lower, remove punctuation -> spaces, collapse
      const str = String(s||"").toLowerCase();
      try{
        return str.replace(/[^\p{L}\p{N}]+/gu, " ").trim().replace(/\s+/g, " ");
      }catch(_){
        return str.replace(/[^a-z0-9äöüß]+/g, " ").trim().replace(/\s+/g, " ");
      }
    }

    function keywordInText(keyword, text){
      const k = normForMatch(keyword);
      const ttxt = normForMatch(text);
      if(!k) return false;
      return ttxt.includes(k);
    }

    /* Deterministic variation (no randomness across refreshes) */
    function hashString(s){
      const str = String(s||"");
      let h = 2166136261;
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h >>> 0);
    }
    function pick(arr, seed){
      if(!arr.length) return "";
      const i = (seed % arr.length);
      return arr[i];
    }

    function localRewriteBullet(bullet, keyword, lang){
      const b = String(bullet||"").trim();
      const kw = prettyKeyword(keyword, lang);
      if(!b) return kw;
      if(keywordInText(keyword, b) || keywordInText(kw, b)) return b;

      const de = isLikelyGerman(lang);
      const seed = hashString(keyword + "|" + b + "|" + lang);

      const phrasesDe = [
        "mit Fokus auf " + kw,
        "unter Einsatz von " + kw,
        "unter Anwendung von " + kw,
        "inklusive " + kw,
        "in Bezug auf " + kw
      ];
      const phrasesEn = [
        "with a focus on " + kw,
        "using " + kw,
        "leveraging " + kw,
        "including " + kw,
        "related to " + kw
      ];
      const phrase = pick(de ? phrasesDe : phrasesEn, seed);

      // Choose joiner
      const joinersDe = [" – ", "; ", ", "];
      const joinersEn = [" – ", "; ", ", "];
      const joiner = pick(de ? joinersDe : joinersEn, seed + 7);

      // If bullet ends with punctuation, keep
      const end = b.slice(-1);
      const base = /[.!?]$/.test(end) ? b.slice(0,-1) : b;

      return base + joiner + phrase + ".";
    }

    function localAppendKeyword(bullet, keyword, lang){
      // Append (smaller change than rewrite)
      const b = String(bullet||"").trim();
      const kw = prettyKeyword(keyword, lang);
      if(!b) return kw;
      if(keywordInText(keyword, b) || keywordInText(kw, b)) return b;

      const de = isLikelyGerman(lang);
      const seed = hashString(keyword + "|" + b + "|" + lang);

      const tailsDe = [
        "(inkl. " + kw + ")",
        "(Fokus: " + kw + ")",
        "(mit " + kw + ")"
      ];
      const tailsEn = [
        "(incl. " + kw + ")",
        "(focus: " + kw + ")",
        "(with " + kw + ")"
      ];
      const tail = pick(de ? tailsDe : tailsEn, seed);

      // If already ends with punctuation, add space then tail, else add " " then tail.
      if(/[.!?]$/.test(b)) return b + " " + tail;
      return b + " " + tail;
    }

    function localNewBullet(keyword, note, lang){
      const kw = prettyKeyword(keyword, lang);
      const n = normalizeSpaces(note);
      const de = isLikelyGerman(lang);
      const seed = hashString(keyword + "|" + note + "|" + lang);

      if(n){
        const templatesDe = [
          "Anwendung von " + kw + " (z. B. " + n + ").",
          n + " – mit Fokus auf " + kw + ".",
          "Umsetzung von " + kw + " im Kontext von " + n + "."
        ];
        const templatesEn = [
          "Applied " + kw + " (e.g., " + n + ").",
          n + " – with a focus on " + kw + ".",
          "Implemented " + kw + " in the context of " + n + "."
        ];
        return pick(de ? templatesDe : templatesEn, seed);
      }

      // If no note, be conservative
      return de
        ? ("Erfahrung mit " + kw + ".")
        : ("Experience with " + kw + ".");
    }

    /* -------------------------
       API helpers
       ------------------------- */
    async function apiGet(path){
      const res = await fetch(API_BASE + path, {
        method:"GET",
        headers:{ Authorization: "Bearer " + session.access_token }
      });
      const txt = await res.text().catch(()=> "");
      let json = null;
      try{ json = txt ? JSON.parse(txt) : null; }catch{ json = { raw: txt }; }
      if(!res.ok){
        const msg = path + " failed: " + res.status + " " + (json?.error || json?.details || json?.message || txt);
        const err = new Error(msg);
        err.status = res.status;
        err.body = json;
        throw err;
      }
      return json;
    }

    async function apiPostJson(path, body){
      const res = await fetch(API_BASE + path, {
        method:"POST",
        headers:{
          Authorization: "Bearer " + session.access_token,
          "content-type":"application/json"
        },
        body: JSON.stringify(body || {})
      });
      const txt = await res.text().catch(()=> "");
      let json = null;
      try{ json = txt ? JSON.parse(txt) : null; }catch{ json = { raw: txt }; }
      if(!res.ok){
        const msg = path + " failed: " + res.status + " " + (json?.error || json?.details || json?.message || txt);
        const err = new Error(msg);
        err.status = res.status;
        err.body = json;
        throw err;
      }
      return json;
    }

    function isEndpointMissing(err){
      const s = Number(err?.status || 0);
      return s === 404 || s === 405;
    }

    function extractTextFromAiResponse(res){
      if(!res) return "";
      if(typeof res.rewritten_bullet === "string") return res.rewritten_bullet;
      if(typeof res.new_bullet === "string") return res.new_bullet;
      if(typeof res.text === "string") return res.text;
      if(typeof res.bullet === "string") return res.bullet;
      if(typeof res.output === "string") return res.output;
      if(res.result){
        const r = res.result;
        return r.rewritten_bullet || r.new_bullet || r.text || r.bullet || r.output || "";
      }
      return "";
    }

    async function tryAiRewriteOrCraft({ mode, keyword, lang, current_bullet, note, context }){
      // mode: "rewrite" | "new"
      const endpoints = [
        "/me/cv/keyword_polish",
        "/me/cv/keyword_boost",
        "/me/cv/keyword_inject",
        "/me/cv/keyword_insert"
      ];

      const payloadBase = {
        job_id: String(selectedJob?.id || ""),
        keyword: String(keyword || ""),
        language: String(lang || ""),
        lang: String(lang || ""),
        ui_language: String(uiLang || ""),
        mode: String(mode || ""),
        current_bullet: String(current_bullet || ""),
        note: String(note || ""),
        context: context || {}
      };

      for(const ep of endpoints){
        try{
          const res = await apiPostJson(ep, payloadBase);
          const out = extractTextFromAiResponse(res);
          if(out && String(out).trim()) return { ok:true, text:String(out).trim(), endpoint:ep };
        }catch(e){
          if(isEndpointMissing(e)) continue;
          // if endpoint exists but fails (401/500), don't silently swallow:
          throw e;
        }
      }
      return { ok:false, text:"", endpoint:"" };
    }

    /* -------------------------
       Tailor strength
       ------------------------- */
    function strengthValue(){
      const v = Number($("strengthRange").value);
      if (v === 0) return { key:"light", label:t("light"), help: uiLang==="de"
        ? "Kleine Verbesserungen, nah an deinem Original."
        : "Small improvements, keeps wording close to your original." };
      if (v === 2) return { key:"strong", label:t("aggressive"), help: uiLang==="de"
        ? "Stärkeres Rewriting für besseren Fit (immer noch wahrheitsgemäß)."
        : "Rewrites more strongly to highlight fit and align with job language (still truthful)." };
      return { key:"balanced", label:t("balanced"), help: uiLang==="de"
        ? "Verbessert Summary & Bullets ohne zu viel umzuschreiben."
        : "Improves summary and bullets to match the job, without over-rewriting." };
    }

    function setStrengthUi(){
      const v = Number($("strengthRange").value);
      const s = strengthValue();
      setText("strengthBadge", s.label);
      setText("strengthHint", s.help);

      const pills = $("strengthPills")?.querySelectorAll(".miniPill") || [];
      pills.forEach(p => p.classList.toggle("active", Number(p.getAttribute("data-s")) === v));

      try{ localStorage.setItem("cv_strength", String(v)); }catch{}
    }

    function setTemplateUi(){
      try{ localStorage.setItem("cv_template", String($("tplSelect").value || "professional")); }catch{}
    }

    function markSteps(state){
      const ids = ["s1","s2","s3","s4","s5"];
      ids.forEach(id => {
        const el = $(id);
        if(!el) return;
        el.style.fontWeight = "750";
        el.style.color = "rgba(17,19,24,.72)";
      });

      if(state === "idle"){ setBadge("stepsBadge", "", uiLang==="de" ? "Bereit" : "Ready"); return; }
      if(state === "running"){ setBadge("stepsBadge", "warn", uiLang==="de" ? "Generiere…" : "Generating…"); return; }
      if(state === "done"){
        setBadge("stepsBadge", "good", uiLang==="de" ? "Fertig" : "Done");
        ids.forEach(id => {
          const el = $(id); if(!el) return;
          el.style.color = "#0a3d1f";
          el.style.fontWeight = "900";
        });
        return;
      }
      if(state === "error"){ setBadge("stepsBadge", "bad", uiLang==="de" ? "Fehlgeschlagen" : "Failed"); return; }
    }

    function setOutputEnabled(enabled){
      $("btnCopy").disabled = !enabled;
      $("btnDownload").disabled = !enabled;
      $("btnPrint").disabled = !enabled;
      $("btnCopyMissing").disabled = !enabled;
      $("btnUndoEdit").disabled = !enabled;
      $("btnResetEdits").disabled = !enabled;
    }

    function updateUndoResetButtons(){
      const hasBase = !!baseSnapshot;
      $("btnResetEdits").disabled = !hasBase;
      $("btnUndoEdit").disabled = !(historyStack && historyStack.length);
    }

    /* -------------------------
       ATS score rendering
       ------------------------- */
    function computeAtsScore(used, missing){
      const u = Array.isArray(used) ? used.length : 0;
      const m = Array.isArray(missing) ? missing.length : 0;
      if(u + m <= 0) return null;
      return Math.round((u / (u + m)) * 100);
    }

    function renderKeywords(){
      const used = Array.isArray(lastUsed) ? lastUsed : [];
      const miss = Array.isArray(lastMissing) ? lastMissing : [];

      $("chipsUsed").innerHTML = used.length
        ? used.slice(0, 120).map(k => `<span class="chip good" title="${H.escapeHtml(k)}">${H.escapeHtml(prettyKeyword(k,lastLang))}</span>`).join("")
        : `<span class="hint">—</span>`;

      $("chipsMissing").innerHTML = miss.length
        ? miss.slice(0, 120).map(k => {
            const disp = prettyKeyword(k,lastLang);
            return `<button type="button" class="chip chipBtn warn" data-kw="${H.escapeHtml(k)}" title="${H.escapeHtml(k)}">
              <span style="min-width:0;overflow:hidden;text-overflow:ellipsis">${H.escapeHtml(disp)}</span>
              <span class="chipPlus" aria-hidden="true">＋</span>
            </button>`;
          }).join("")
        : `<span class="hint">—</span>`;

      setText("kwUsedCount", used.length ? String(used.length) : "0");
      setText("kwMissCount", miss.length ? String(miss.length) : "0");

      const score = computeAtsScore(used, miss);
      if(score == null){
        setText("atsScore", "—");
        $("atsBar").style.width = "0%";
      }else{
        setText("atsScore", score + "%");
        $("atsBar").style.width = score + "%";
      }
    }

    function recomputeCoverageFromCurrentText(){
      const text = $("cvText").value || "";
      const all = Array.isArray(atsKeywordsAll) && atsKeywordsAll.length
        ? atsKeywordsAll
        : Array.from(new Set([...(lastUsed||[]), ...(lastMissing||[])].map(x=>String(x||"").trim()).filter(Boolean)));

      const used = [];
      const miss = [];
      for(const kw of all){
        if(keywordInText(kw, text)) used.push(kw);
        else miss.push(kw);
      }
      lastUsed = used;
      lastMissing = miss;
      renderKeywords();
    }

    /* -------------------------
       CV doc formatting (ported from dashboard)
       ------------------------- */
    function cvLabels(lang){
      const de = isLikelyGerman(lang);
      return de ? {
        summary: "Profil",
        experience: "Experience",
        education: "Ausbildung",
        achievements: "Erfolge",
        skills: "Skills",
        courses: "Kurse",
        interests: "Interessen",
        languages: "Languagen"
      } : {
        summary: "Profile",
        experience: "Experience",
        education: "Education",
        achievements: "Key achievements",
        skills: "Skills",
        courses: "Courses",
        interests: "Interests",
        languages: "Languages"
      };
    }

    function ul(items){
      const arr = asStringArr(items, 999);
      if(!arr.length) return "";
      return `<ul class="cvUl">${arr.map(x => `<li>${H.escapeHtml(x)}</li>`).join("")}</ul>`;
    }

    function sec(title, inner){
      if(!inner || !String(inner).trim()) return "";
      return `<div class="cvSection"><div class="cvSectionTitle">${H.escapeHtml(title)}</div>${inner}</div>`;
    }

    function item(title, sub, meta, bullets){
      const t = String(title || "").trim();
      const s = String(sub || "").trim();
      const m = String(meta || "").trim();
      const b = asStringArr(bullets, 12);

      const parts = [];
      parts.push(`<div class="cvItem">`);
      if(t) parts.push(`<div class="cvItemTitle">${H.escapeHtml(t)}</div>`);
      if(s) parts.push(`<div class="cvItemSub">${H.escapeHtml(s)}</div>`);
      if(m) parts.push(`<div class="cvMetaLine">${H.escapeHtml(m)}</div>`);
      if(b.length) parts.push(ul(b));
      parts.push(`</div>`);
      return parts.join("");
    }

    function cvDocToPreviewHtml(doc, lang){
      const L = cvLabels(lang);
      const name = String(doc?.name || "YOUR NAME");
      const role = String(doc?.target_role || (isLikelyGerman(lang) ? "Die Rolle, auf die du dich bewirbst" : "The role you are applying for"));

      const c = doc?.contact || {};
      const contactLine = joinNonEmpty([c.phone, c.email, c.linkedin, c.portfolio, c.location], " · ");

      const summary = asStringArr(doc?.summary, 8);
      const exp = Array.isArray(doc?.experience) ? doc.experience : [];
      const edu = Array.isArray(doc?.education) ? doc.education : [];
      const ach = asStringArr(doc?.key_achievements, 10);

      const skills = doc?.skills || {};
      const skillGroups = Array.isArray(skills?.groups) ? skills.groups : [];
      const addSkills = asStringArr(skills?.additional, 24);

      const courses = asStringArr(doc?.courses, 12);
      const interests = asStringArr(doc?.interests, 12);
      const langs = asStringArr(doc?.languages, 12);

      const summaryHtml = summary.length ? `<p class="cvPara">${H.escapeHtml(summary.join(" "))}</p>` : "";

      const expHtml = exp.map(e => {
        const title = e?.title || "";
        const sub = joinNonEmpty([e?.company, e?.location], " · ");
        const meta = joinNonEmpty([e?.start, e?.end], " – ");
        return item(title, sub, meta, e?.bullets);
      }).join("");

      const eduHtml = edu.map(e => {
        const title = joinNonEmpty([e?.degree, e?.field], " · ");
        const sub = joinNonEmpty([e?.school, e?.location], " · ");
        const meta = joinNonEmpty([e?.start, e?.end], " – ");
        return item(title, sub, meta, e?.bullets);
      }).join("");

      const skillsInner = [
        skillGroups.map(g => {
          const label = String(g?.label || "").trim();
          const items = asStringArr(g?.items, 30);
          if(!items.length) return "";
          const line = label ? `${H.escapeHtml(label)}: ${H.escapeHtml(items.join(", "))}` : H.escapeHtml(items.join(", "));
          return `<div class="cvSkillLine">${line}</div>`;
        }).join(""),
        addSkills.length ? `<div class="cvSkillLine">${H.escapeHtml(addSkills.join(", "))}</div>` : ""
      ].join("");

      const coursesInner = courses.length ? `<div class="cvPara">${H.escapeHtml(courses.join(" · "))}</div>` : "";
      const interestsInner = interests.length ? `<div class="cvPara">${H.escapeHtml(interests.join(" · "))}</div>` : "";
      const langsInner = langs.length ? `<div class="cvPara">${H.escapeHtml(langs.join(" · "))}</div>` : "";

      return [
        `<div class="cvPreview">`,
        `<div class="cvName">${H.escapeHtml(name)}</div>`,
        `<div class="cvRole">${H.escapeHtml(role)}</div>`,
        contactLine ? `<div class="cvContact">${H.escapeHtml(contactLine)}</div>` : ``,
        sec(L.summary, summaryHtml),
        sec(L.experience, expHtml),
        sec(L.education, eduHtml),
        sec(L.achievements, ul(ach)),
        sec(L.skills, skillsInner),
        sec(L.courses, coursesInner),
        sec(L.interests, interestsInner),
        sec(L.languages, langsInner),
        `</div>`,
      ].join("");
    }

    function cvDocToPlainText(doc, lang){
      const L = cvLabels(lang);
      const lines = [];
      const name = String(doc?.name || "").trim();
      const role = String(doc?.target_role || "").trim();
      const c = doc?.contact || {};
      const contactLine = joinNonEmpty([c.phone, c.email, c.linkedin, c.portfolio, c.location], " · ");

      if(name) lines.push(name);
      if(role) lines.push(role);
      if(contactLine) lines.push(contactLine);
      if(lines.length) lines.push("");

      const summary = asStringArr(doc?.summary, 8);
      if(summary.length){
        lines.push(L.summary.toUpperCase());
        lines.push(summary.join(" "));
        lines.push("");
      }

      const exp = Array.isArray(doc?.experience) ? doc.experience : [];
      if(exp.length){
        lines.push(L.experience.toUpperCase());
        for(const e of exp){
          const t = String(e?.title || "").trim();
          const sub = joinNonEmpty([e?.company, e?.location], " · ");
          const meta = joinNonEmpty([e?.start, e?.end], " – ");
          if(t) lines.push(t);
          if(sub) lines.push(sub);
          if(meta) lines.push(meta);
          const b = asStringArr(e?.bullets, 12);
          for(const bb of b) lines.push("- " + bb);
          lines.push("");
        }
      }

      const edu = Array.isArray(doc?.education) ? doc.education : [];
      if(edu.length){
        lines.push(L.education.toUpperCase());
        for(const e of edu){
          const t = joinNonEmpty([e?.degree, e?.field], " · ");
          const sub = joinNonEmpty([e?.school, e?.location], " · ");
          const meta = joinNonEmpty([e?.start, e?.end], " – ");
          if(t) lines.push(t);
          if(sub) lines.push(sub);
          if(meta) lines.push(meta);
          const b = asStringArr(e?.bullets, 8);
          for(const bb of b) lines.push("- " + bb);
          lines.push("");
        }
      }

      const ach = asStringArr(doc?.key_achievements, 10);
      if(ach.length){
        lines.push(L.achievements.toUpperCase());
        for(const a of ach) lines.push("- " + a);
        lines.push("");
      }

      const skills = doc?.skills || {};
      const groups = Array.isArray(skills?.groups) ? skills.groups : [];
      const addSkills = asStringArr(skills?.additional, 24);
      const skillLines = [];
      for(const g of groups){
        const label = String(g?.label || "").trim();
        const items = asStringArr(g?.items, 30);
        if(!items.length) continue;
        skillLines.push(label ? (label + ": " + items.join(", ")) : items.join(", "));
      }
      if(addSkills.length) skillLines.push(addSkills.join(", "));
      if(skillLines.length){
        lines.push(L.skills.toUpperCase());
        for(const s of skillLines) lines.push(s);
        lines.push("");
      }

      const courses = asStringArr(doc?.courses, 12);
      if(courses.length){
        lines.push(L.courses.toUpperCase());
        lines.push(courses.join(" · "));
        lines.push("");
      }

      const interests = asStringArr(doc?.interests, 12);
      if(interests.length){
        lines.push(L.interests.toUpperCase());
        lines.push(interests.join(" · "));
        lines.push("");
      }

      const langs = asStringArr(doc?.languages, 12);
      if(langs.length){
        lines.push(L.languages.toUpperCase());
        lines.push(langs.join(" · "));
        lines.push("");
      }

      return lines.join("\n").trim() + "\n";
    }

    function cvTextToPrintableHtml(title, text){
      const safeTitle = H.escapeHtml(title || "Curriculum Vitae");
      const safeText = H.escapeHtml(String(text || "").trim());
      return `<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${safeTitle}</title>
<style>
  @page{ size:A4; margin:14mm 14mm 14mm 14mm; }
  body{ margin:0; padding:0; font-family: Arial, Helvetica, sans-serif; color:#111318; }
  .cvPaper{ max-width:820px; margin:0 auto; padding:0; }
  h1{ font-size:18px; margin:0 0 10px 0; }
  pre{ white-space:pre-wrap; font-size:12.5px; line-height:1.45; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
</style>
</head>
<body>
  <div class="cvPaper">
    <h1>${safeTitle}</h1>
    <pre>${safeText}</pre>
  </div>
</body>
</html>`;
    }

    function cvDocToPrintableHtml(cvDoc, lang, title){
      const css = `
        @page{ size:A4; margin:14mm 14mm 14mm 14mm; }
        body{ margin:0; padding:0; font-family: Arial, Helvetica, sans-serif; color:#111318; }
        .cvPaper{ max-width:820px; margin:0 auto; }
        .cvName{ font-size:34px; font-weight:900; letter-spacing:-.6px; color:#111318; }
        .cvRole{ margin-top:2px; font-size:14px; font-weight:800; color:#3b3f46; }
        .cvContact{ margin-top:6px; font-size:12.5px; color:#3b3f46; }
        .cvSection{ margin-top:16px; }
        .cvSectionTitle{ font-size:14px; font-weight:900; letter-spacing:.04em; text-transform:uppercase; border-bottom:3px solid #111318; padding-bottom:6px; margin:0 0 8px 0; }
        .cvItem{ margin-top:10px; }
        .cvItemTitle{ font-size:13.5px; font-weight:900; }
        .cvItemSub{ margin-top:2px; font-size:12.5px; font-weight:800; color:#3b3f46; }
        .cvMetaLine{ margin-top:2px; font-size:12.5px; color:#3b3f46; }
        .cvUl{ margin:6px 0 0 18px; padding:0; }
        .cvUl li{ margin:0 0 3px 0; font-size:13px; }
        .cvPara{ font-size:13px; line-height:1.45; margin:0; }
        .cvSkillLine{ font-size:13px; line-height:1.45; margin:2px 0; }
      `;

      const safeTitle = H.escapeHtml(title || "Curriculum Vitae");
      const bodyHtml = cvDocToPreviewHtml(cvDoc, lang).replace('<div class="cvPreview">', '<div class="cvPaper">');

      return `<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${safeTitle}</title>
<style>${css}</style>
</head>
<body>
${bodyHtml}
</body>
</html>`;
    }

    function printHtml(html){
      const blob = new Blob([html], {type:'text/html'});
      const url = URL.createObjectURL(blob);
      let iframe = document.getElementById('printFrame');
      if(!iframe){
        iframe = document.createElement('iframe');
        iframe.id = 'printFrame';
        iframe.style.position='fixed';
        iframe.style.right='0';
        iframe.style.bottom='0';
        iframe.style.width='1px';
        iframe.style.height='1px';
        iframe.style.opacity='0';
        iframe.style.pointerEvents='none';
        document.body.appendChild(iframe);
      }
      iframe.onload = () => {
        try{
          iframe.contentWindow.focus();
          iframe.contentWindow.print();
        }catch(_){}
        setTimeout(()=>{ try{ URL.revokeObjectURL(url); }catch(_){} }, 1500);
      };
      iframe.src = url;
    }

    /* -------------------------
       Tabs + rendering
       ------------------------- */
    function setTabs(which){
      const isPreview = which === "preview";
      $("tabPreview").classList.toggle("active", isPreview);
      $("tabText").classList.toggle("active", !isPreview);
      $("cvPreviewWrap").style.display = isPreview ? "" : "none";
      $("cvTextWrap").style.display = isPreview ? "none" : "";
    }

    function setCvOutput({ text, doc, lang }){
      lastCvText = String(text || "").trim();
      lastCvDoc = doc || null;
      lastLang = lang || "en";

      // Preview
      if(lastCvDoc){
        $("cvPreview").innerHTML = cvDocToPreviewHtml(lastCvDoc, lastLang);
      }else{
        $("cvPreview").innerHTML = `<div class="hint">${uiLang==="de" ? "Keine strukturierte Preview verfügbar. Zeige Text." : "No structured preview available. Showing text only."}</div>`;
      }

      // Text view
      const textOut = lastCvDoc ? cvDocToPlainText(lastCvDoc, lastLang) : lastCvText;
      $("cvText").value = textOut || "";

      setOutputEnabled(!!(textOut && textOut.trim()));
      updateUndoResetButtons();
    }

    function snapshotCurrent(){
      return {
        at: Date.now(),
        cv_doc: deepCopy(lastCvDoc),
        cv_text: $("cvText").value || "",
        lang: lastLang,
        used: Array.isArray(lastUsed) ? [...lastUsed] : [],
        missing: Array.isArray(lastMissing) ? [...lastMissing] : [],
        all: Array.isArray(atsKeywordsAll) ? [...atsKeywordsAll] : []
      };
    }

    function restoreSnapshot(snap){
      if(!snap) return;
      lastCvDoc = deepCopy(snap.cv_doc);
      lastLang = snap.lang || lastLang || "en";
      $("cvText").value = String(snap.cv_text || "");
      lastUsed = Array.isArray(snap.used) ? snap.used : [];
      lastMissing = Array.isArray(snap.missing) ? snap.missing : [];
      atsKeywordsAll = Array.isArray(snap.all) ? snap.all : atsKeywordsAll;

      // rerender preview from doc if possible
      if(lastCvDoc) $("cvPreview").innerHTML = cvDocToPreviewHtml(lastCvDoc, lastLang);
      renderKeywords();
      updateUndoResetButtons();
    }

    /* -------------------------
       Queue loading
       ------------------------- */
    async function loadQueue(){
      const resp = await apiGet("/me/jobs/queue");
      jobs = Array.isArray(resp?.data) ? resp.data : [];
      const sel = $("jobSelect");
      sel.innerHTML = "";

      if(!jobs.length){
        sel.innerHTML = `<option value="">${uiLang==="de" ? "Keine Jobs in der Queue" : "No jobs in queue"}</option>`;
        setText("jobHint", uiLang==="de" ? "Keine Jobs gefunden. Öffne Jobs und lade neue Jobs." : "No jobs found. Go to Jobs and fetch new jobs.");
        setText("jobMeta", "");
        $("btnGenerate").disabled = true;
        $("btnGenerateAgain").disabled = true;
        $("btnViewDesc").disabled = true;
        $("btnCopyDesc").disabled = true;
        return;
      }

      for(const j of jobs){
        const label = [j.title || (uiLang==="de" ? "Ohne Titel" : "Untitled"), j.company_name || (uiLang==="de" ? "Firma" : "Company")].filter(Boolean).join(" · ");
        const opt = document.createElement("option");
        opt.value = String(j.id);
        opt.textContent = label;
        sel.appendChild(opt);
      }

      const urlJobId = (qs("job_id") || "").trim();
      const storedJobId = (localStorage.getItem("cvstudio_selected_job_id") || "").trim();
      const preferred = urlJobId || storedJobId;

      if(preferred && jobs.some(j => String(j.id) === String(preferred))){
        sel.value = preferred;
      } else {
        sel.value = String(jobs[0].id);
      }

      await onJobChange();
    }

    async function onJobChange(){
      const jobId = $("jobSelect").value;
      selectedJob = jobs.find(j => String(j.id) === String(jobId)) || null;

      if(!selectedJob){
        setText("jobMeta", "");
        $("btnGenerate").disabled = true;
        $("btnGenerateAgain").disabled = true;
        $("btnViewDesc").disabled = true;
        $("btnCopyDesc").disabled = true;
        return;
      }

      try{ localStorage.setItem("cvstudio_selected_job_id", String(selectedJob.id)); }catch{}

      const meta = [
        selectedJob.company_name ? String(selectedJob.company_name) : null,
        formatLoc(selectedJob) || null
      ].filter(Boolean).join(" · ");

      setText("jobHint", (uiLang==="de" ? "Ausgewählt: " : "Selected: ") + (selectedJob.title || (uiLang==="de" ? "Job" : "Job")));
      setText("jobMeta", meta ? meta : "");

      $("btnGenerate").disabled = false;
      $("btnGenerateAgain").disabled = false;
      $("btnViewDesc").disabled = false;
      $("btnCopyDesc").disabled = false;

      // Restore last from localStorage for this job (best effort)
      try{
        const key = "cvstudio_last_" + String(selectedJob.id);
        const raw = localStorage.getItem(key);
        if(raw){
          const obj = JSON.parse(raw);
          if(obj && (obj.cv_doc || obj.cv_text)){
            lastUsed = Array.isArray(obj.used) ? obj.used : [];
            lastMissing = Array.isArray(obj.missing) ? obj.missing : [];
            atsKeywordsAll = Array.isArray(obj.all) ? obj.all : Array.from(new Set([...(lastUsed||[]), ...(lastMissing||[])]));

            renderKeywords();

            setCvOutput({ text: obj.cv_text || "", doc: obj.cv_doc || null, lang: obj.lang || obj.language || "en" });
            setBadge("outStatus","good", uiLang==="de" ? "Bereit (lokal)" : "Ready (local)");
            setText("outModel","Model: —");
            setText("outHint", uiLang==="de"
              ? "Letzten CV von diesem Gerät geladen. Generiere neu für ein frisches Ergebnis."
              : "Loaded your last tailored CV from this device. Generate to refresh from server."
            );

            baseSnapshot = snapshotCurrent();
            historyStack = [];
            updateUndoResetButtons();
          }
        }
      }catch(_){}
    }

    function buildTailorPayload(){
      // IMPORTANT: keep payload minimal to avoid breaking strict backends
      const tpl = String($("tplSelect").value || "professional").trim().toLowerCase();
      const s = strengthValue();
      return { job_id: String(selectedJob?.id || ""), template: tpl, strength: s.key };
    }

    /* -------------------------
       Generate
       ------------------------- */
    async function generate(){
      showError("");
      if(!selectedJob){
        showError(t("pickJob"));
        return;
      }

      markSteps("running");
      setBadge("outStatus", "warn", uiLang==="de" ? "Generiere…" : "Generating…");
      setText("outHint", uiLang==="de" ? "Dein CV wird erstellt…" : "Generating your tailored CV…");
      setText("debugBox", "—");
      setBadge("pipeBadge", "warn", uiLang==="de" ? "Arbeite…" : "Working…");

      $("btnGenerate").disabled = true;
      $("btnGenerateAgain").disabled = true;

      try{
        const payload = buildTailorPayload();
        const res = await apiPostJson("/me/cv/tailor", payload);

        if(!res || res.ok !== true){
          throw new Error(res?.error || "CV tailoring failed");
        }

        const r = res.result || {};
        const text = String(r.cv_text || "").trim();
        const doc = r.cv_doc || null;
        const lang = r.language || "en";

        lastUsed = Array.isArray(r.ats_keywords_used) ? r.ats_keywords_used : [];
        lastMissing = Array.isArray(r.ats_keywords_missing) ? r.ats_keywords_missing : [];
        atsKeywordsAll = Array.from(new Set([...(lastUsed||[]), ...(lastMissing||[])].map(x=>String(x||"").trim()).filter(Boolean)));

        lastDebug = {
          cached: !!res.cached,
          cache_age_seconds: res.cache_age_seconds ?? null,
          model: r.model || null,
          prompt_version: r.prompt_version || null,
          language: lang || null,
          desc_cache_status: r.desc_cache_status || null,
          cv_clean_status: r.cv_clean_status || null,
          cv_clean_model: r.cv_clean_model || null,
          cv_structured_status: r.cv_structured_status || null,
          cv_structured_model: r.cv_structured_model || null
        };

        renderKeywords();
        setCvOutput({ text, doc, lang });

        // Reset edit history on each new generation
        baseSnapshot = snapshotCurrent();
        historyStack = [];
        updateUndoResetButtons();

        setBadge("outStatus", "good", res.cached ? (uiLang==="de" ? "Bereit (cached)" : "Ready (cached)") : (uiLang==="de" ? "Bereit" : "Ready"));
        setText("outModel", "Model: " + (r.model || "—"));
        setText("outHint", res.cached
          ? (uiLang==="de"
            ? "Cached Ergebnis geladen. Ändere die Stärke, um eine neue Version zu erstellen."
            : "Loaded cached result. Change strength to create a different version.")
          : (uiLang==="de"
            ? "Neuer Tailored CV erstellt. Bitte prüfen und exportieren."
            : "Generated a new tailored CV. Review and export below.")
        );
        markSteps("done");

        const lines = [
          "Job description: " + String(r.desc_cache_status || "—"),
          "CV clean: " + String(r.cv_clean_status || "—") + (r.cv_clean_model ? (" (" + r.cv_clean_model + ")") : ""),
          "CV structured: " + String(r.cv_structured_status || "—") + (r.cv_structured_model ? (" (" + r.cv_structured_model + ")") : ""),
          res.cached ? ("Cache: used (" + String(res.cache_age_seconds || "0") + "s old)") : "Cache: generated"
        ];
        $("pipeBox").textContent = lines.join("\n");
        setBadge("pipeBadge", "good", "OK");

        $("debugBox").textContent = JSON.stringify({ ok:true, ...lastDebug }, null, 2);

        // Save last output locally (best effort)
        try{
          const key = "cvstudio_last_" + String(payload.job_id);
          localStorage.setItem(key, JSON.stringify({
            at: Date.now(),
            payload,
            cv_text: $("cvText").value || "",
            cv_doc: lastCvDoc,
            lang: lastLang,
            used: lastUsed,
            missing: lastMissing,
            all: atsKeywordsAll,
            debug: lastDebug
          }));
        }catch(_){}
      }catch(e){
        markSteps("error");
        setBadge("outStatus","bad", uiLang==="de" ? "Fehler" : "Failed");
        setBadge("pipeBadge","bad", uiLang==="de" ? "Fehler" : "Failed");
        showError(e?.message || String(e));
        $("debugBox").textContent = JSON.stringify({ ok:false, error: e?.message || String(e) }, null, 2);
        setText("outHint", uiLang==="de" ? "Generierung fehlgeschlagen. Prüfe CV Upload und Jobbeschreibung." : "Failed to generate. Check your CV upload and job description availability.");
      }finally{
        $("btnGenerate").disabled = false;
        $("btnGenerateAgain").disabled = false;
      }
    }

    /* -------------------------
       Description modal
       ------------------------- */
    async function openDescModal(){
      showError("");
      if(!selectedJob){
        showError(t("pickJob"));
        return;
      }

      H.showModal("descModal");
      $("descH").textContent = selectedJob.title || (uiLang==="de" ? "Jobbeschreibung" : "Job description");
      $("descMeta").textContent = [selectedJob.company_name || "", formatLoc(selectedJob) || ""].filter(Boolean).join(" · ");
      $("descText").textContent = uiLang==="de" ? "Lade…" : "Loading…";
      $("descOpen").setAttribute("href", "#");
      $("descCopy").textContent = t("copy");
      selectedDesc = "";
      selectedApplyUrl = applyUrlSafe(selectedJob.apply_url);

      if(selectedApplyUrl){
        $("descOpen").setAttribute("href", selectedApplyUrl);
        $("descOpen").classList.remove("ghost");
      }else{
        $("descOpen").setAttribute("href", "#");
        $("descOpen").classList.add("ghost");
      }

      try{
        const resp = await apiGet("/me/jobs/description?job_id=" + encodeURIComponent(String(selectedJob.id)));
        const job = resp?.job || null;
        const txt = String(job?.description_full || job?.description || "").trim();
        selectedDesc = txt || (uiLang==="de" ? "(Keine Beschreibung verfügbar.)" : "(No description available.)");
        $("descText").textContent = selectedDesc;
      }catch(e){
        $("descText").textContent = (uiLang==="de" ? "Beschreibung konnte nicht geladen werden." : "Failed to load description.") + "\n\n" + (e?.message || String(e));
      }
    }

    async function copyTextToClipboard(txt){
      const text = String(txt || "");
      if(!text) return;
      try{
        await navigator.clipboard.writeText(text);
      }catch(_){
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        try{ document.execCommand("copy"); }catch{}
        document.body.removeChild(ta);
      }
    }

    async function copyDesc(){
      if(!selectedDesc){
        await openDescModal();
        return;
      }
      await copyTextToClipboard(selectedDesc);
    }

    /* -------------------------
       Copy / Download / Print
       ------------------------- */
    async function copyCv(){
      const txt = $("cvText").value || "";
      if(!txt.trim()) return;
      await copyTextToClipboard(txt);
      $("btnCopy").textContent = t("copied");
      setTimeout(()=>{ $("btnCopy").textContent = t("copy"); }, 900);
    }

    function downloadTxt(){
      const txt = $("cvText").value || "";
      if(!txt.trim()) return;

      const title = selectedJob?.title ? String(selectedJob.title).slice(0, 60) : "tailored_cv";
      const safe = title.replace(/[^a-z0-9\-\_ ]/gi, "").trim().replace(/\s+/g, "_") || "tailored_cv";
      const filename = safe + ".txt";

      const blob = new Blob([txt], { type:"text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function printPdf(){
      const jobTitle = selectedJob?.title ? String(selectedJob.title) : "Curriculum Vitae";
      const html = (lastCvDoc)
        ? cvDocToPrintableHtml(lastCvDoc, lastLang, jobTitle)
        : cvTextToPrintableHtml(jobTitle, $("cvText").value || "");
      printHtml(html);
    }

    async function copyMissing(){
      const miss = Array.isArray(lastMissing) ? lastMissing : [];
      if(!miss.length) return;
      const text = miss.map(k => prettyKeyword(k,lastLang)).join(", ");
      await copyTextToClipboard(text);
      $("btnCopyMissing").textContent = t("copied");
      setTimeout(()=>{ $("btnCopyMissing").textContent = t("copyMissing"); }, 900);
    }

    /* -------------------------
       Keyword booster (modal)
       ------------------------- */
    function setKwMode(mode){
      kwMode = mode === "quick" ? "quick" : "ai";
      const btns = $("kwModeToggle").querySelectorAll("button");
      btns.forEach(b => b.classList.toggle("active", b.getAttribute("data-mode") === kwMode));
      updateKwPreview();
    }

    function chosenKwLang(){
      const v = String($("kwLang").value || "auto");
      if(v === "de" || v === "en") return v;
      // auto
      return isLikelyGerman(lastLang) ? "de" : "en";
    }

    function fillSkillGroups(){
      const sel = $("kwSkillGroup");
      sel.innerHTML = "";
      const groups = Array.isArray(lastCvDoc?.skills?.groups) ? lastCvDoc.skills.groups : [];
      groups.forEach((g, idx) => {
        const label = String(g?.label || "").trim() || (uiLang==="de" ? ("Gruppe " + (idx+1)) : ("Group " + (idx+1)));
        const opt = document.createElement("option");
        opt.value = "group:" + idx;
        opt.textContent = label;
        sel.appendChild(opt);
      });
      // additional bucket
      const opt2 = document.createElement("option");
      opt2.value = "additional";
      opt2.textContent = uiLang==="de" ? "Weitere Skills" : "Additional skills";
      sel.appendChild(opt2);

      if(sel.options.length) sel.value = sel.options[0].value;
    }

    function fillExperienceRoles(){
      const sel = $("kwExpRole");
      sel.innerHTML = "";
      const exp = Array.isArray(lastCvDoc?.experience) ? lastCvDoc.experience : [];
      exp.forEach((e, idx) => {
        const title = joinNonEmpty([e?.title, e?.company], " · ") || (uiLang==="de" ? ("Station " + (idx+1)) : ("Role " + (idx+1)));
        const opt = document.createElement("option");
        opt.value = String(idx);
        opt.textContent = title;
        sel.appendChild(opt);
      });
      if(sel.options.length) sel.value = "0";
      fillBulletsForSelectedRole();
    }

    function fillBulletsForSelectedRole(){
      const expIdx = Number($("kwExpRole").value || "0");
      const e = (Array.isArray(lastCvDoc?.experience) ? lastCvDoc.experience : [])[expIdx] || null;
      const bullets = asStringArr(e?.bullets, 50);

      const sel = $("kwExpBullet");
      sel.innerHTML = "";
      bullets.forEach((b, idx) => {
        const opt = document.createElement("option");
        opt.value = String(idx);
        opt.textContent = (String(b).length > 70 ? (String(b).slice(0,70) + "…") : String(b));
        sel.appendChild(opt);
      });

      if(sel.options.length){
        sel.value = "0";
        $("kwBulletPreview").textContent = bullets[0] || "—";
      }else{
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = uiLang==="de" ? "Keine Bullets vorhanden" : "No bullets available";
        sel.appendChild(opt);
        $("kwBulletPreview").textContent = uiLang==="de" ? "Diese Station hat noch keine Bullets." : "This role has no bullets.";
      }
    }

    function openKwModal(keywordRaw){
      showError("");
      if(!lastCvDoc && !($("cvText").value || "").trim()){
        showError(t("needCv"));
        return;
      }

      activeKeywordRaw = String(keywordRaw || "").trim();
      activeKeywordDisplay = prettyKeyword(activeKeywordRaw, lastLang);
      $("kwChip").textContent = activeKeywordDisplay || "—";
      $("kwTruth").checked = false;

      // Default target: skills (safe)
      $("kwTarget").value = "skills";

      // Default language: auto
      $("kwLang").value = "auto";

      // Default mode: AI
      setKwMode("ai");

      // Populate role/groups if doc available
      if(lastCvDoc){
        fillSkillGroups();
        fillExperienceRoles();
      }else{
        // if no doc, force skills box only (text-only)
        $("kwTarget").value = "skills";
      }

      // Show/hide boxes
      updateKwTargetUi();
      updateKwPreview();

      H.showModal("kwModal");
    }

    function closeKwModal(){
      H.hideModal("kwModal");
      activeKeywordRaw = "";
      activeKeywordDisplay = "";
      $("kwResultPreview").textContent = "—";
      $("kwNote").value = "";
    }

    function updateKwTargetUi(){
      const target = String($("kwTarget").value || "skills");
      const hasDoc = !!lastCvDoc;

      $("kwSkillsBox").style.display = (target === "skills") ? "" : "none";
      $("kwExpBox").style.display = (target === "experience" && hasDoc) ? "" : "none";

      if(target === "experience" && !hasDoc){
        // can't do experience insert without doc
        $("kwTarget").value = "skills";
        $("kwSkillsBox").style.display = "";
        $("kwExpBox").style.display = "none";
      }

      updateKwExpHowUi();
    }

    function updateKwExpHowUi(){
      const how = String($("kwExpHow").value || "rewrite");
      const showPick = (how === "rewrite" || how === "append");
      $("kwBulletPickBox").style.display = showPick ? "" : "none";

      const showNote = (how === "new");
      $("kwNoteBox").style.display = showNote ? "" : "none";
      $("kwNewWarn").style.display = showNote ? "" : "none";

      updateKwPreview();
    }

    function buildKwPreviewText(){
      const target = String($("kwTarget").value || "skills");
      const lang = chosenKwLang();
      const kw = activeKeywordRaw;

      if(!kw) return "—";

      if(target === "skills"){
        const group = String($("kwSkillGroup").value || "additional");
        const dest = group === "additional" ? (uiLang==="de" ? "Weitere Skills" : "Additional skills") : $("kwSkillGroup").selectedOptions?.[0]?.textContent;
        const verb = (lang==="de") ? "Füge hinzu:" : "Add:";
        return `${verb} ${prettyKeyword(kw, lang)} → ${dest}`;
      }

      // experience
      const expIdx = Number($("kwExpRole").value || "0");
      const exp = (Array.isArray(lastCvDoc?.experience) ? lastCvDoc.experience : [])[expIdx] || {};
      const roleName = joinNonEmpty([exp?.title, exp?.company], " · ") || (lang==="de" ? "Experience" : "Experience");
      const how = String($("kwExpHow").value || "rewrite");
      const bullets = asStringArr(exp?.bullets, 50);

      if(how === "new"){
        const note = $("kwNote").value || "";
        const b = (kwMode === "ai")
          ? localNewBullet(kw, note, lang) // AI preview might change, but good enough
          : localNewBullet(kw, note, lang);
        return (lang==="de")
          ? (`Neue Bullet bei ${roleName}:\n- ${b}`)
          : (`New bullet under ${roleName}:\n- ${b}`);
      }

      const bulletIdx = Number($("kwExpBullet").value || "0");
      const current = bullets[bulletIdx] || "";
      const rewritten = (how === "append")
        ? localAppendKeyword(current, kw, lang)
        : localRewriteBullet(current, kw, lang);

      const label = (how === "append")
        ? (lang==="de" ? "Anhängen:" : "Append:")
        : (lang==="de" ? "Umformulieren:" : "Rewrite:");
      return `${label} ${roleName}\nALT: ${current}\nNEU: ${rewritten}`;
    }

    function updateKwPreview(){
      $("kwResultPreview").textContent = buildKwPreviewText();
    }

    async function applyKeyword(){
      showError("");
      if(!activeKeywordRaw){
        closeKwModal();
        return;
      }
      if(!$("kwTruth").checked){
        showError(t("truthRequired"));
        return;
      }

      const target = String($("kwTarget").value || "skills");
      const lang = chosenKwLang();
      const kwRaw = activeKeywordRaw;
      const kwDisp = prettyKeyword(kwRaw, lang);

      // Take history snapshot
      historyStack.push(snapshotCurrent());
      updateUndoResetButtons();

      try{
        if(target === "skills"){
          if(!lastCvDoc){
            // text-only: just append to end as "Skills: ..."
            const txt = $("cvText").value || "";
            const addLine = (lang==="de") ? ("\nSKILLS\n" + kwDisp + "\n") : ("\nSKILLS\n" + kwDisp + "\n");
            $("cvText").value = (txt.trim() + "\n" + addLine).trim() + "\n";
          }else{
            const skillGroup = String($("kwSkillGroup").value || "additional");
            lastCvDoc.skills = lastCvDoc.skills || {};
            lastCvDoc.skills.groups = Array.isArray(lastCvDoc.skills.groups) ? lastCvDoc.skills.groups : [];
            lastCvDoc.skills.additional = Array.isArray(lastCvDoc.skills.additional) ? lastCvDoc.skills.additional : [];

            const ensureUniquePush = (arr, val) => {
              const exists = arr.some(x => normForMatch(x) === normForMatch(val));
              if(!exists) arr.push(val);
            };

            if(skillGroup.startsWith("group:")){
              const idx = Number(skillGroup.split(":")[1] || "0");
              const g = lastCvDoc.skills.groups[idx];
              if(g){
                g.items = Array.isArray(g.items) ? g.items : [];
                ensureUniquePush(g.items, kwDisp);
              }else{
                ensureUniquePush(lastCvDoc.skills.additional, kwDisp);
              }
            }else{
              ensureUniquePush(lastCvDoc.skills.additional, kwDisp);
            }

            // Update text and preview
            $("cvPreview").innerHTML = cvDocToPreviewHtml(lastCvDoc, lastLang);
            $("cvText").value = cvDocToPlainText(lastCvDoc, lastLang);
          }

          recomputeCoverageFromCurrentText();
          updateKwPreview();
          closeKwModal();
          return;
        }

        // Experience
        if(!lastCvDoc){
          showError(t("needDoc"));
          return;
        }

        const expIdx = Number($("kwExpRole").value || "0");
        const how = String($("kwExpHow").value || "rewrite");

        lastCvDoc.experience = Array.isArray(lastCvDoc.experience) ? lastCvDoc.experience : [];
        const exp = lastCvDoc.experience[expIdx];
        if(!exp){
          showError(t("needDoc"));
          return;
        }
        exp.bullets = Array.isArray(exp.bullets) ? exp.bullets : [];

        let changed = false;
        let usedAi = false;
        let aiNote = "";

        if(how === "new"){
          const note = String($("kwNote").value || "").trim();
          if(!note || note.length < 4){
            showError(t("noteRequired"));
            return;
          }

          if(kwMode === "ai"){
            const ctx = {
              cv_language: lastLang,
              target_language: lang,
              role_title: exp?.title || "",
              company: exp?.company || "",
              job_title: selectedJob?.title || "",
              job_company: selectedJob?.company_name || ""
            };
            const ai = await tryAiRewriteOrCraft({
              mode: "new",
              keyword: kwRaw,
              lang,
              current_bullet: "",
              note,
              context: ctx
            });
            if(ai.ok){
              exp.bullets.unshift(ai.text);
              usedAi = true;
            }else{
              aiNote = t("aiFallback");
              exp.bullets.unshift(localNewBullet(kwRaw, note, lang));
            }
          }else{
            exp.bullets.unshift(localNewBullet(kwRaw, note, lang));
          }
          changed = true;
        } else {
          const bulletIdx = Number($("kwExpBullet").value || "0");
          const current = String(exp.bullets[bulletIdx] || "").trim();
          if(!current){
            // If no bullets, degrade to new with required note
            const note = String($("kwNote").value || "").trim();
            exp.bullets.unshift(localNewBullet(kwRaw, note, lang));
            changed = true;
          }else{
            if(kwMode === "ai" && how === "rewrite"){
              const ctx = {
                cv_language: lastLang,
                target_language: lang,
                role_title: exp?.title || "",
                company: exp?.company || "",
                job_title: selectedJob?.title || "",
                job_company: selectedJob?.company_name || ""
              };
              const ai = await tryAiRewriteOrCraft({
                mode: "rewrite",
                keyword: kwRaw,
                lang,
                current_bullet: current,
                note: "",
                context: ctx
              });
              if(ai.ok){
                exp.bullets[bulletIdx] = ai.text;
                usedAi = true;
                changed = true;
              }else{
                aiNote = t("aiFallback");
                exp.bullets[bulletIdx] = localRewriteBullet(current, kwRaw, lang);
                changed = true;
              }
            } else if(how === "append"){
              exp.bullets[bulletIdx] = localAppendKeyword(current, kwRaw, lang);
              changed = true;
            } else {
              exp.bullets[bulletIdx] = localRewriteBullet(current, kwRaw, lang);
              changed = true;
            }
          }
        }

        if(changed){
          $("cvPreview").innerHTML = cvDocToPreviewHtml(lastCvDoc, lastLang);
          $("cvText").value = cvDocToPlainText(lastCvDoc, lastLang);
          recomputeCoverageFromCurrentText();

          if(aiNote){
            // non-blocking: show as top info
            showError(aiNote);
          }
          closeKwModal();
        }
      }catch(e){
        // rollback snapshot
        const snap = historyStack.pop();
        restoreSnapshot(snap);
        showError(e?.message || String(e));
      }finally{
        updateUndoResetButtons();
        // Save edited output locally
        try{
          const key = "cvstudio_last_" + String(selectedJob?.id || "");
          localStorage.setItem(key, JSON.stringify({
            at: Date.now(),
            payload: buildTailorPayload(),
            cv_text: $("cvText").value || "",
            cv_doc: lastCvDoc,
            lang: lastLang,
            used: lastUsed,
            missing: lastMissing,
            all: atsKeywordsAll,
            debug: lastDebug
          }));
        }catch(_){}
      }
    }

    function undoEdit(){
      if(!historyStack.length) return;
      const snap = historyStack.pop();
      restoreSnapshot(snap);
      updateUndoResetButtons();
    }

    function resetEdits(){
      if(!baseSnapshot) return;
      historyStack = [];
      restoreSnapshot(baseSnapshot);
      updateUndoResetButtons();
    }

    /* -------------------------
       Auth + boot
       ------------------------- */
    async function loadStateAndNav(){
      setBadge("authBadge","warn", uiLang==="de" ? "Prüfe…" : "Checking…");

      session = await window.JobApplyAI.auth.getSession();
      if(!session || !session.user || !session.user.email){
        setBadge("authBadge","warn", uiLang==="de" ? "Abgemeldet" : "Signed out");
        window.location.replace("./signup.html");
        return;
      }

      $("navLogout").style.display = "";
      $("navSignIn").style.display = "none";
      setBadge("authBadge","good", uiLang==="de" ? "Angemeldet" : "Signed in");

      // Ensure customer exists (best effort)
      try{
        await window.JobApplyAI.auth.requireAuthAndCustomer({ redirectTo: "./signup.html" });
      }catch(_){}

      try{
        await window.JobApplyAI.auth.syncStateToLocalStorage(session);
      }catch(_){}
    }

    async function boot(){
      showError("");

      applyUiTexts();
      setStrengthUi();

      if(!window.JobApplyAI || !window.JobApplyAI.auth){
        showError("auth.js did not load. Ensure multipage/auth.js exists and is referenced as ./auth.js.");
        setBadge("authBadge","bad","Config error");
        return;
      }

      await loadStateAndNav();

      // restore saved template/strength
      try{
        const sv = localStorage.getItem("cv_strength");
        if(sv !== null && sv !== undefined && sv !== "") $("strengthRange").value = String(sv);
      }catch(_){}
      setStrengthUi();

      try{
        const tv = localStorage.getItem("cv_template");
        if(tv) $("tplSelect").value = tv;
      }catch(_){}
      setTemplateUi();

      // load queue
      await loadQueue();

      // initial output state
      renderKeywords();
      setTabs("preview");
      markSteps("idle");
      setOutputEnabled(false);
      updateUndoResetButtons();
    }

    /* -------------------------
       Wire UI
       ------------------------- */
    $("jobSelect").addEventListener("change", onJobChange);

    $("strengthRange").addEventListener("input", setStrengthUi);
    $("strengthPills").addEventListener("click", (e) => {
      const p = e.target.closest(".miniPill");
      if(!p) return;
      $("strengthRange").value = String(p.getAttribute("data-s"));
      setStrengthUi();
    });

    $("tplSelect").addEventListener("change", setTemplateUi);

    $("btnAtsInfo").addEventListener("click", () => H.showModal("atsModal"));
    $("atsClose").addEventListener("click", () => H.hideModal("atsModal"));
    $("atsOk").addEventListener("click", () => H.hideModal("atsModal"));
    $("atsModal").addEventListener("click", (e) => { if(e.target && e.target.id === "atsModal") H.hideModal("atsModal"); });

    $("btnViewDesc").addEventListener("click", openDescModal);
    $("btnCopyDesc").addEventListener("click", async () => {
      try{
        if(!selectedDesc) await openDescModal();
        await copyDesc();
      }catch(_){}
    });

    $("descClose").addEventListener("click", () => H.hideModal("descModal"));
    $("descModal").addEventListener("click", (e) => { if(e.target && e.target.id === "descModal") H.hideModal("descModal"); });
    $("descCopy").addEventListener("click", async () => {
      if(!selectedDesc) return;
      await copyDesc();
      $("descCopy").textContent = t("copied");
      setTimeout(()=>{ $("descCopy").textContent = t("copy"); }, 900);
    });

    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape"){
        H.hideModal("atsModal");
        H.hideModal("descModal");
        H.hideModal("kwModal");
      }
    });

    $("btnGenerate").addEventListener("click", generate);
    $("btnGenerateAgain").addEventListener("click", generate);

    $("tabPreview").addEventListener("click", () => setTabs("preview"));
    $("tabText").addEventListener("click", () => setTabs("text"));

    $("btnCopy").addEventListener("click", () => copyCv());
    $("btnDownload").addEventListener("click", downloadTxt);
    $("btnPrint").addEventListener("click", printPdf);
    $("btnCopyMissing").addEventListener("click", copyMissing);

    // Track manual text edits -> recompute keyword coverage
    $("cvText").addEventListener("input", () => {
      // If user edits text manually, keep keywords in sync
      recomputeCoverageFromCurrentText();
      // We do not mutate doc here to avoid confusion; Preview stays as last doc.
    });

    // Keyword chips click
    $("chipsMissing").addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-kw]");
      if(!btn) return;
      const kw = btn.getAttribute("data-kw") || "";
      if(!kw) return;
      if(!lastCvDoc && !($("cvText").value||"").trim()){
        showError(t("needCv"));
        return;
      }
      openKwModal(kw);
    });

    // Undo / Reset
    $("btnUndoEdit").addEventListener("click", undoEdit);
    $("btnResetEdits").addEventListener("click", resetEdits);

    // Keyword modal wiring
    $("kwClose").addEventListener("click", closeKwModal);
    $("kwCancel").addEventListener("click", closeKwModal);
    $("kwModal").addEventListener("click", (e) => { if(e.target && e.target.id === "kwModal") closeKwModal(); });

    $("kwTarget").addEventListener("change", () => { updateKwTargetUi(); updateKwPreview(); });
    $("kwLang").addEventListener("change", updateKwPreview);

    $("kwModeToggle").addEventListener("click", (e) => {
      const b = e.target.closest("button[data-mode]");
      if(!b) return;
      setKwMode(b.getAttribute("data-mode"));
    });

    $("kwSkillGroup").addEventListener("change", updateKwPreview);
    $("kwExpRole").addEventListener("change", () => { fillBulletsForSelectedRole(); updateKwPreview(); });
    $("kwExpHow").addEventListener("change", updateKwExpHowUi);
    $("kwExpBullet").addEventListener("change", () => {
      const expIdx = Number($("kwExpRole").value || "0");
      const exp = (Array.isArray(lastCvDoc?.experience) ? lastCvDoc.experience : [])[expIdx] || null;
      const bullets = asStringArr(exp?.bullets, 50);
      const i = Number($("kwExpBullet").value || "0");
      $("kwBulletPreview").textContent = bullets[i] || "—";
      updateKwPreview();
    });
    $("kwNote").addEventListener("input", updateKwPreview);
    $("kwApply").addEventListener("click", applyKeyword);

    // Logout
    $("navLogout").addEventListener("click", async () => {
      try{
        await window.JobApplyAI.auth.logout("./index.html");
      }catch(_){
        window.location.href = "./index.html";
      }
    });

    // Initial view
    setTabs("preview");
    markSteps("idle");

    window.addEventListener("load", () => {
      boot().catch((e) => {
        showError(e?.message || String(e));
        setBadge("authBadge","bad","Error");
      });
    });

  })();
  </script>
</body>
</html>
