<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>jobmejob • CV Studio</title>
  <meta name="description" content="Tailor your CV per job with ATS-safe formatting."/>

  <!-- Shared styles -->
  <link rel="stylesheet" href="./shared.css"/>

  <style>
    /* =========================================================
       CV Studio (page-only styles)
       - Uses shared.css for base layout, cards, buttons, etc.
       ========================================================= */

    .layout{
      display:grid;
      grid-template-columns: 1fr 1.2fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
    }

    .sectionTitle{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .sectionTitle h2{
      margin:0;
      font-size:14px;
      letter-spacing:.02em;
      text-transform:uppercase;
      color:rgba(17,19,24,.70);
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > *{ flex: 1 1 auto; }

    .label{
      font-weight:900;
      font-size:13px;
      color:rgba(17,19,24,.80);
      margin:10px 0 6px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .hint{
      font-size:12px;
      color:rgba(17,19,24,.58);
      font-weight:650;
      line-height:1.45;
      margin-top:6px;
    }

    .selectWide{ width:100%; }
    .jobMeta{
      font-size:13px;
      color:rgba(17,19,24,.62);
      font-weight:700;
      line-height:1.4;
      white-space:pre-wrap;
    }

    /* Strength */
    .strengthWrap{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:6px;
    }
    .strengthTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    input[type="range"]{ width:100%; }
    .strengthPills{ display:flex; gap:8px; flex-wrap:wrap; }
    .miniPill{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(17,19,24,.12);
      background:rgba(17,19,24,.04);
      font-weight:900;
      font-size:12px;
      color:rgba(17,19,24,.78);
      white-space:nowrap;
      cursor:pointer;
      user-select:none;
    }
    .miniPill.active{
      border-color: rgba(34,197,94,.55);
      background: rgba(34,197,94,.14);
      color:#0a3d1f;
    }

    details.info{
      margin-top:10px;
      border:1px solid rgba(17,19,24,.10);
      border-radius:16px;
      background:rgba(255,255,255,.70);
      padding:10px 12px;
    }
    details.info summary{
      cursor:pointer;
      font-weight:900;
      color:rgba(17,19,24,.78);
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    details.info summary::-webkit-details-marker{display:none}

    /* Output */
    .outputTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .tabs{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .tabBtn{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(17,19,24,.12);
      background:rgba(17,19,24,.04);
      font-weight:900;
      font-size:12px;
      cursor:pointer;
    }
    .tabBtn.active{
      border-color: rgba(34,197,94,.55);
      background: rgba(34,197,94,.14);
      color:#0a3d1f;
    }

    .cvBox{
      margin-top:12px;
      border:1px solid rgba(17,19,24,.12);
      background:rgba(17,19,24,.03);
      border-radius:16px;
      padding:12px;
      overflow:auto;
      max-height: 56vh;
      -webkit-overflow-scrolling:touch;
    }

    /* Preview rendering (HTML) */
    .cvPreview{
      background: rgba(255,255,255,.72);
      border: 1px solid rgba(17,19,24,.10);
      border-radius: 14px;
      padding: 14px 14px;
    }
    .cvName{
      font-size:30px;
      font-weight:950;
      letter-spacing:-.6px;
      color: rgba(17,19,24,.86);
    }
    .cvRole{
      margin-top:4px;
      font-size:13px;
      font-weight:850;
      color: rgba(17,19,24,.58);
    }
    .cvContact{
      margin-top:8px;
      font-size:12.5px;
      color: rgba(17,19,24,.62);
      font-weight:700;
    }
    .cvSection{ margin-top:16px; }
    .cvSectionTitle{
      font-size:14px;
      font-weight:950;
      letter-spacing:.04em;
      text-transform:uppercase;
      border-bottom:3px solid rgba(17,19,24,.86);
      padding-bottom:6px;
      margin:0 0 10px 0;
    }
    .cvItem{ margin-top:10px; }
    .cvItemTitle{ font-size:13.5px; font-weight:950; }
    .cvItemSub{ margin-top:2px; font-size:12.5px; font-weight:850; color:rgba(17,19,24,.62); }
    .cvMetaLine{ margin-top:2px; font-size:12.5px; color:rgba(17,19,24,.62); }
    .cvUl{ margin:6px 0 0 18px; padding:0; }
    .cvUl li{ margin:0 0 3px 0; font-size:13px; line-height:1.45; }
    .cvPara{ font-size:13px; line-height:1.5; margin:0; }
    .cvSkillLine{ font-size:13px; line-height:1.5; margin:2px 0; }

    /* Text view */
    textarea.cvText{
      width:100%;
      min-height: 56vh;
      border:0;
      outline:none;
      resize:vertical;
      background:transparent;
      font-size:13px;
      line-height:1.45;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color: rgba(17,19,24,.92);
    }
    .cvPre{
      margin:0;
      white-space:pre-wrap;
      font-size:13px;
      line-height:1.45;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color: rgba(17,19,24,.92);
    }

    /* Sticky actions */
    .stickyActions{
      position:sticky;
      bottom:0;
      margin-top:12px;
      padding-top:10px;
      background:linear-gradient(180deg, rgba(255,255,255,0), rgba(255,255,255,.92) 30%, rgba(255,255,255,.96));
      backdrop-filter: blur(10px);
    }
    .stickyRow{ display:flex; gap:10px; flex-wrap:wrap; }
    @media (max-width:620px){
      .stickyRow{ flex-direction:column; }
      .stickyRow .btn{ width:100%; justify-content:center; }
      .cvBox{ max-height: 52vh; }
      textarea.cvText{ min-height: 52vh; }
    }

    /* KPIs */
    .kpiRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:10px;
    }
    .kpi{
      flex: 1 1 170px;
      min-width: 170px;
      border:1px solid rgba(17,19,24,.10);
      background:rgba(255,255,255,.78);
      border-radius:16px;
      padding:10px 12px;
    }
    .kpi .k{ font-size:12px; color:rgba(17,19,24,.60); font-weight:850; }
    .kpi .v{ margin-top:6px; font-size:18px; font-weight:980; letter-spacing:-.4px; }
    .bar{ height:10px; border-radius:999px; background:rgba(17,19,24,.08); overflow:hidden; margin-top:10px; }
    .bar > div{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(34,197,94,.70), rgba(22,163,74,.70));
      border-radius:999px;
      transition:width .25s ease;
    }

    /* Chips */
    .chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .chip{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(17,19,24,.12);
      background:rgba(17,19,24,.04);
      font-weight:850;
      font-size:12px;
      color:rgba(17,19,24,.78);
      white-space:nowrap;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .chip.good{ border-color: rgba(34,197,94,.38); background: rgba(34,197,94,.12); color:#0a3d1f; }
    .chip.warn{ border-color: rgba(255,179,0,.38); background: rgba(255,179,0,.12); color:#5a3b00; }

    .monoSmall{
      white-space:pre-wrap;
      font-size:12px;
      line-height:1.45;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color: rgba(17,19,24,.72);
      background:rgba(17,19,24,.04);
      border:1px solid rgba(17,19,24,.12);
      border-radius:14px;
      padding:10px;
      margin-top:10px;
    }

    /* Description modal */
    .descMeta{
      margin-top:6px;
      color:rgba(17,19,24,.62);
      font-weight:700;
      font-size:13px;
      line-height:1.35;
    }
  
    /* Keyword booster (truthful keyword insertion) */
    button.chipBtn{
      appearance:none;
      -webkit-appearance:none;
      background:transparent;
      font:inherit;
      border:0;
      padding:0;
      cursor:pointer;
      line-height:1;
    }
    button.chipBtn .plus{
      margin-left:6px;
      font-weight:950;
      opacity:.85;
    }
    button.chipBtn:focus-visible{
      outline:2px solid rgba(34,197,94,.55);
      outline-offset:2px;
      border-radius:999px;
    }

    .checkRow{
      display:flex;
      align-items:flex-start;
      gap:10px;
      margin-top:10px;
      font-weight:850;
      color:rgba(17,19,24,.80);
      line-height:1.35;
    }
    .checkRow input{ margin-top:2px; }

    .field{
      width:100%;
      border:1px solid rgba(17,19,24,.14);
      background:rgba(255,255,255,.86);
      border-radius:14px;
      padding:10px 12px;
      font-weight:800;
      font-size:13px;
      color:rgba(17,19,24,.88);
      outline:none;
    }
    .field:focus{
      border-color: rgba(34,197,94,.55);
      box-shadow: 0 0 0 3px rgba(34,197,94,.16);
    }
    textarea.field{
      resize:vertical;
      min-height: 96px;
      font-family: inherit;
      line-height: 1.45;
    }

  </style>
</head>

<body>
  <header class="topbar">
    <nav class="nav">
      <a class="brand" href="./index.html" data-nav="1" aria-label="Home">
        <span class="logo" aria-hidden="true"></span>
        <span>jobmejob</span>
      </a>

      <div class="navlinks">
        <a class="pill" href="./index.html" data-nav="1">Home</a>
        <a class="pill" href="./profile.html" data-nav="1">Profile</a>
        <a class="pill" href="./plan.html" data-nav="1">Plan</a>
        <a class="pill" href="./jobs.html" data-nav="1">Jobs</a>
        <a class="pill" href="./dashboard.html" data-nav="1">Dashboard</a>
        <a class="pill active" href="./cv.html" data-nav="1">CV Studio</a>

        <a class="pill" href="./signup.html" id="navSignIn" data-nav="1">Sign in</a>
        <button class="pill" id="navLogout" type="button" style="display:none;">Logout</button>
      </div>
    </nav>
  </header>

  <main class="main">
    <h1 class="h1">CV Studio</h1>
    <p class="sub">Tailor your CV per role with ATS-safe formatting. Job search + CV tailoring stay free.</p>

    <div class="errorTop" id="errorTop"></div>

    <section class="layout">
      <!-- LEFT: Controls -->
      <div class="card">
        <div class="sectionTitle">
          <h2>Setup</h2>
          <span class="badge warn" id="authBadge">Checking…</span>
        </div>

        <div class="label">Job to tailor</div>
        <div class="row">
          <select id="jobSelect" class="selectWide">
            <option value="">Loading…</option>
          </select>
          <a class="btn" href="./jobs.html" data-nav="1" style="flex:0 0 auto">Open Jobs</a>
        </div>
        <div class="hint" id="jobHint">Pick a job from your queue.</div>
        <div class="jobMeta" id="jobMeta"></div>

        <div class="row" style="margin-top:10px">
          <button class="btn ghost" id="btnViewDesc" type="button" disabled>View description</button>
          <button class="btn ghost" id="btnCopyDesc" type="button" disabled>Copy description</button>
        </div>

        <div class="hr"></div>

        <div class="label">
          Template
          <span class="badge" title="ATS-safe formatting">ATS-safe</span>
        </div>
        <div class="row">
          <select id="tplSelect" class="selectWide">
            <option value="professional">Professional (ATS-safe)</option>
          </select>
          <button class="btn ghost" id="btnAtsInfo" type="button" style="flex:0 0 auto">ATS?</button>
        </div>
        <div class="hint">ATS-safe formatting = simple headings, no tables/columns, easy-to-parse structure.</div>

        <div class="label">Tailoring strength</div>
        <div class="strengthWrap">
          <div class="strengthTop">
            <div class="strengthPills" id="strengthPills">
              <span class="miniPill" data-s="0">Light</span>
              <span class="miniPill active" data-s="1">Balanced</span>
              <span class="miniPill" data-s="2">Aggressive</span>
            </div>
            <span class="badge" id="strengthBadge">Balanced</span>
          </div>

          <input id="strengthRange" type="range" min="0" max="2" step="1" value="1" />

          <div class="hint" id="strengthHint">
            Improves summary and bullets to match the job, without over-rewriting.
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <button class="btn primary" id="btnGenerate" type="button" disabled>Generate tailored CV</button>
          <button class="btn" id="btnGenerateAgain" type="button" disabled>Generate again</button>
        </div>
        <div class="hint" id="genHint">
          Same settings reuse a cached result (fast). To create a different version, change the tailoring strength.
        </div>

        <details class="info" open>
          <summary>
            What we tailor (step-by-step)
            <span class="badge" id="stepsBadge">Ready</span>
          </summary>

          <div class="hint" style="margin-top:8px">
            This is what happens when you click “Generate”:
          </div>

          <ul style="margin:10px 0 0 18px; color:rgba(17,19,24,.70); font-weight:750; line-height:1.55" id="stepsList">
            <li><span id="s1">Extract job keywords</span></li>
            <li><span id="s2">Align summary & bullets</span></li>
            <li><span id="s3">Keep ATS-safe structure</span></li>
            <li><span id="s4">Compute ATS match</span></li>
            <li><span id="s5">Prepare preview & export</span></li>
          </ul>

          <div class="hint" style="margin-top:10px">
            We stay truthful: we never invent experience or certifications. We only rephrase / reorder based on your uploaded CV + profile.
          </div>
        </details>

        <details class="info" id="pipelineDetails">
          <summary>
            Pipeline status
            <span class="badge" id="pipeBadge">—</span>
          </summary>
          <div class="monoSmall" id="pipeBox">Generate a CV to see pipeline details.</div>
        </details>
      </div>

      <!-- RIGHT: Output -->
      <div class="card">
        <div class="outputTop">
          <div>
            <div style="font-weight:980;font-size:18px;letter-spacing:-.2px">Tailored CV</div>
            <div class="hint" id="outHint">Generate a CV to see preview and ATS match.</div>
          </div>

          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
            <span class="badge warn" id="outStatus">Not generated</span>
            <span class="badge" id="outModel">Model: —</span>
          </div>
        </div>

        <div class="kpiRow">
          <div class="kpi">
            <div class="k">ATS match</div>
            <div class="v" id="atsScore">—</div>
            <div class="bar" aria-hidden="true"><div id="atsBar"></div></div>
            <div class="hint" id="atsHint">Calculated from keyword coverage (used vs missing).</div>
          </div>

          <div class="kpi">
            <div class="k">Keywords used</div>
            <div class="v" id="kwUsedCount">—</div>
            <div class="hint">Found in your tailored CV.</div>
          </div>

          <div class="kpi">
            <div class="k">Keywords missing</div>
            <div class="v" id="kwMissCount">—</div>
            <div class="hint">Consider adding (truthfully) if relevant.</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="tabs" role="tablist" aria-label="Output view">
          <button class="tabBtn active" id="tabPreview" type="button">Preview</button>
          <button class="tabBtn" id="tabText" type="button">Text</button>
        </div>

        <div class="cvBox" id="cvBox">
          <div id="cvPreviewWrap" style="display:block;">
            <div id="cvPreview" class="cvPreview">
              <div class="hint">No CV generated yet.</div>
            </div>
          </div>

          <div id="cvTextWrap" style="display:none;">
            <textarea class="cvText" id="cvText" spellcheck="false"></textarea>
          </div>
        </div>

        <div class="stickyActions">
          <div class="stickyRow">
            <button class="btn" id="btnCopy" type="button" disabled>Copy</button>
            <button class="btn" id="btnDownload" type="button" disabled>Download .txt</button>
            <button class="btn primary" id="btnPrint" type="button" disabled>Print / PDF</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="sectionTitle" style="margin-bottom:6px">
          <h2>ATS keywords</h2>
          <div class="row" style="justify-content:flex-end; flex:0 0 auto">
            <button class="btn small ghost" id="btnUndoEdit" type="button" disabled title="Undo last local edit">Undo</button>
            <button class="btn small ghost" id="btnResetEdits" type="button" disabled title="Reset to the last generated CV">Reset</button>
            <button class="btn small" id="btnCopyMissing" type="button" disabled>Copy missing</button>
          </div>
        </div>

        <div class="hint">These keywords are extracted from the job description. Click a <b>missing</b> keyword to add it to your CV (truthfully) and improve your ATS match.</div>

        <div class="label" style="margin-top:12px">Used</div>
        <div class="chips" id="chipsUsed"></div>

        <div class="label" style="margin-top:12px">Missing</div>
        <div class="chips" id="chipsMissing"></div>

        <details class="info" style="margin-top:12px">
          <summary>Debug details</summary>
          <div class="monoSmall" id="debugBox">—</div>
        </details>
      </div>
    </section>
  </main>

  <!-- ATS info modal -->
  <div class="modalBackdrop" id="atsModal" style="display:none" role="dialog" aria-modal="true" aria-labelledby="atsTitle">
    <div class="modalCard">
      <div class="modalScroll">
        <div class="modalHeader">
          <div>
            <h3 class="modalTitle" id="atsTitle">What does ATS mean?</h3>
            <div class="hint" style="margin-top:6px">
              ATS = Applicant Tracking System. Companies use ATS to parse, search, and rank CVs.
            </div>
          </div>
          <button class="btn small" id="atsClose" type="button">Close</button>
        </div>

        <div class="hr"></div>

        <div class="hint">
          <b>ATS-safe formatting</b> improves the chance your CV is parsed correctly:
          <ul style="margin:10px 0 0 18px; line-height:1.6">
            <li>Use simple headings (Experience, Education, Skills).</li>
            <li>Avoid tables, columns, text boxes, and complex layouts.</li>
            <li>Use consistent dates and bullet structure.</li>
          </ul>
          <div style="margin-top:10px">
            Our CV Studio keeps formatting simple and focuses on keywords and relevance — without inventing facts.
          </div>
        </div>
      </div>

      <div class="modalActions">
        <button class="btn primary" id="atsOk" type="button">Got it</button>
      </div>
    </div>
  </div>

  <!-- Job description modal -->
  <div class="modalBackdrop" id="descModal" style="display:none" role="dialog" aria-modal="true" aria-labelledby="descH">
    <div class="modalCard">
      <div class="modalScroll">
        <div class="modalHeader">
          <div style="min-width:0">
            <h3 class="modalTitle" id="descH">Job description</h3>
            <div class="descMeta" id="descMeta"></div>
          </div>
          <button class="btn small" id="descClose" type="button">Close</button>
        </div>
        <div class="hr"></div>
        <div class="modalMonoBox" id="descText">Loading…</div>
      </div>
      <div class="modalActions">
        <button class="btn" id="descCopy" type="button">Copy</button>
        <a class="btn primary" id="descOpen" href="#" target="_blank" rel="noopener">Open apply link</a>
      </div>
    </div>
  </div>


  <!-- Keyword insert modal -->
  <div class="modalBackdrop" id="kwModal" style="display:none" role="dialog" aria-modal="true" aria-labelledby="kwTitle">
    <div class="modalCard">
      <div class="modalScroll">
        <div class="modalHeader">
          <div style="min-width:0">
            <h3 class="modalTitle" id="kwTitle">Add keyword to CV</h3>
            <div class="hint" style="margin-top:6px" id="kwSub">
              We only add keywords that are true for you. Choose where it belongs and we’ll insert it in an ATS-safe way.
            </div>
          </div>
          <button class="btn small" id="kwClose" type="button">Close</button>
        </div>

        <div class="hr"></div>

        <div class="label">Keyword</div>
        <div class="row">
          <span class="badge warn" id="kwBadge">—</span>
          <span class="hint" style="margin:0; flex:1 1 260px" id="kwBadgeHint">We insert this exact phrase so ATS can find it.</span>
        </div>

        <label class="checkRow">
          <input type="checkbox" id="kwTruth"/>
          <span>I confirm this keyword is accurate for me and I want it on my CV.</span>
        </label>

        <div class="hint" style="margin-top:8px">
          We never invent experience or certifications. If it’s not true, don’t add it.
        </div>

        <div class="hr"></div>

        <div class="label">Where should it appear?</div>
        <select id="kwTarget" class="selectWide">
          <option value="skills">Skills</option>
          <option value="experience">Experience (a specific role)</option>
        </select>

        <div id="kwSkillsBox" style="margin-top:10px">
          <div class="label">Skills group</div>
          <select id="kwSkillGroup" class="selectWide"></select>
          <div class="hint">Best for tools, technologies, methods, domains.</div>
        </div>

        <div id="kwExpBox" style="display:none; margin-top:10px">
          <div class="label">Experience entry</div>
          <select id="kwExpIndex" class="selectWide"></select>

          <div class="label" style="margin-top:10px">How to add it</div>
          <select id="kwExpMode" class="selectWide">
            <option value="new">Add as a new bullet</option>
            <option value="append">Append to an existing bullet</option>
          </select>

          <div id="kwExpNewBox" style="margin-top:10px">
            <div class="label">New bullet text</div>
            <textarea id="kwNewBullet" class="field" placeholder="Keep it short, specific, and truthful."></textarea>
            <div class="hint">The keyword must appear. Tip: include outcome or context if possible.</div>
          </div>

          <div id="kwExpAppendBox" style="display:none; margin-top:10px">
            <div class="label">Which bullet?</div>
            <select id="kwExpBulletIndex" class="selectWide"></select>

            <div class="label" style="margin-top:10px">Append phrase</div>
            <input id="kwAppendPhrase" class="field" type="text" placeholder="e.g., including Kubernetes"/>
            <div class="hint">We’ll append this phrase to the selected bullet. Keep it truthful and readable.</div>
          </div>
        </div>

        <details class="info" id="kwAdvanced" style="margin-top:12px">
          <summary>Advanced</summary>
          <label class="checkRow">
            <input type="checkbox" id="kwApplyTextOnly"/>
            <span>Apply to text only (preserve manual text edits)</span>
          </label>
          <div class="hint" id="kwTextOnlyHint" style="margin-top:6px">
            If you edited the CV text manually, applying to the structured CV can overwrite your edits.
          </div>
        </details>

        <div class="monoSmall" id="kwValidation" style="margin-top:12px">—</div>
      </div>

      <div class="modalActions">
        <button class="btn" id="kwCancel" type="button">Cancel</button>
        <button class="btn primary" id="kwApply" type="button" disabled>Add keyword</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./auth.js"></script>
  <script src="./shared.js"></script>

  <script>
  (() => {
    "use strict";

    const S = window.JobMeJobShared || null;
    if (!S) {
      alert("shared.js not loaded. Ensure multipage/shared.js exists and is referenced as ./shared.js");
      return;
    }
    S.wireNavTransitions();

    const $ = (id) => document.getElementById(id);

    const API_BASE = S.resolveApiBase("https://jobmejob.schoene-viktor.workers.dev").replace(/\/+$/, "");

    let session = null;
    let jobs = [];
    let selectedJob = null;
    let selectedDesc = "";
    let selectedApplyUrl = "";

    let lastCvText = "";
    let lastCvDoc = null;
    let lastLang = "en";
    let lastUsed = [];
    let lastMissing = [];
    let lastDebug = {};

    // Local editing (keyword insertion)
    let baseSnapshot = null;         // last generated (server) snapshot
    let editHistory = [];            // undo stack
    let isEdited = false;            // any local edits applied
    let textDirty = false;           // user manually typed in the Text tab
    let activeKeyword = "";

    /* -------------------------
       Helpers
       ------------------------- */
    function showError(msg){ S.showTopError("errorTop", msg || ""); }
    function setBadge(id, cls, txt){ S.setBadge(id, cls, txt); }
    function setText(id, txt){ const el = $(id); if (el) el.textContent = (txt == null) ? "" : String(txt); }

    function qs(name){
      try{ return new URL(window.location.href).searchParams.get(name); }
      catch{ return null; }
    }

    function joinNonEmpty(arr, sep){
      return (arr || []).map(x => String(x || "").trim()).filter(Boolean).join(sep);
    }
    function asStringArr(arr, max=999){
      if(!Array.isArray(arr)) return [];
      return arr.map(x => String(x || "").trim()).filter(Boolean).slice(0, max);
    }

    function formatLoc(j){
      const parts = [];
      if (j.city) parts.push(j.city);
      if (j.region && j.region !== j.city) parts.push(j.region);
      if (j.country) parts.push(j.country);
      return parts.filter(Boolean).join(", ");
    }

    function applyUrlSafe(url){
      const u = String(url || "").trim();
      if (!u) return "";
      if (/^https?:\/\//i.test(u)) return u;
      return "https://" + u.replace(/^\/+/, "");
    }

    async function apiGet(path){
      const res = await fetch(API_BASE + path, {
        method:"GET",
        headers:{ Authorization: "Bearer " + session.access_token }
      });
      const txt = await res.text().catch(()=> "");
      let json = null;
      try{ json = txt ? JSON.parse(txt) : null; }catch{ json = { raw: txt }; }
      if(!res.ok){
        throw new Error(path + " failed: " + res.status + " " + (json?.error || json?.details || json?.message || txt));
      }
      return json;
    }

    async function apiPostJson(path, body){
      const res = await fetch(API_BASE + path, {
        method:"POST",
        headers:{
          Authorization: "Bearer " + session.access_token,
          "content-type":"application/json"
        },
        body: JSON.stringify(body || {})
      });
      const txt = await res.text().catch(()=> "");
      let json = null;
      try{ json = txt ? JSON.parse(txt) : null; }catch{ json = { raw: txt }; }
      if(!res.ok){
        throw new Error(path + " failed: " + res.status + " " + (json?.error || json?.details || json?.message || txt));
      }
      return json;
    }

    /* -------------------------
       Tailor strength
       ------------------------- */
    function strengthValue(){
      const v = Number($("strengthRange").value);
      if (v === 0) return { key:"light", label:"Light", help:"Small improvements, keeps wording close to your original." };
      if (v === 2) return { key:"strong", label:"Aggressive", help:"Rewrites more strongly to highlight fit and align with job language (still truthful)." };
      return { key:"balanced", label:"Balanced", help:"Improves summary and bullets to match the job, without over-rewriting." };
    }

    function setStrengthUi(){
      const v = Number($("strengthRange").value);
      const s = strengthValue();
      setText("strengthBadge", s.label);
      setText("strengthHint", s.help);

      const pills = $("strengthPills")?.querySelectorAll(".miniPill") || [];
      pills.forEach(p => p.classList.toggle("active", Number(p.getAttribute("data-s")) === v));

      try{ localStorage.setItem("cv_strength", String(v)); }catch{}
    }

    function setTemplateUi(){
      try{ localStorage.setItem("cv_template", String($("tplSelect").value || "professional")); }catch{}
    }

    function markSteps(state){
      const ids = ["s1","s2","s3","s4","s5"];
      ids.forEach(id => {
        const el = $(id);
        if(!el) return;
        el.style.fontWeight = "750";
        el.style.color = "rgba(17,19,24,.72)";
      });

      if(state === "idle"){ setBadge("stepsBadge", "", "Ready"); return; }
      if(state === "running"){ setBadge("stepsBadge", "warn", "Generating…"); return; }
      if(state === "done"){
        setBadge("stepsBadge", "good", "Done");
        ids.forEach(id => {
          const el = $(id); if(!el) return;
          el.style.color = "#0a3d1f";
          el.style.fontWeight = "900";
        });
        return;
      }
      if(state === "error"){ setBadge("stepsBadge", "bad", "Failed"); return; }
    }

    function updateEditButtons(){
      const hasOutput = !!(String($("cvText").value || "").trim());
      const canUndo = Array.isArray(editHistory) && editHistory.length > 0;
      const canReset = !!(baseSnapshot && isEdited);

      const undoBtn = $("btnUndoEdit");
      const resetBtn = $("btnResetEdits");
      if(undoBtn) undoBtn.disabled = !hasOutput || !canUndo;
      if(resetBtn) resetBtn.disabled = !hasOutput || !canReset;
    }

    function setOutputEnabled(enabled){
      $("btnCopy").disabled = !enabled;
      $("btnDownload").disabled = !enabled;
      $("btnPrint").disabled = !enabled;
      $("btnCopyMissing").disabled = !enabled;
      updateEditButtons();
    }

    /* -------------------------
       ATS score rendering
       ------------------------- */
    function computeAtsScore(used, missing){
      const u = Array.isArray(used) ? used.length : 0;
      const m = Array.isArray(missing) ? missing.length : 0;
      if(u + m <= 0) return null;
      return Math.round((u / (u + m)) * 100);
    }

    function renderKeywords(){
      const used = Array.isArray(lastUsed) ? lastUsed : [];
      const miss = Array.isArray(lastMissing) ? lastMissing : [];

      $("chipsUsed").innerHTML = used.length
        ? used.slice(0, 80).map(k => `<span class="chip good" title="${S.escapeHtml(k)}">${S.escapeHtml(k)}</span>`).join("")
        : `<span class="hint">—</span>`;

      $("chipsMissing").innerHTML = miss.length
        ? miss.slice(0, 80).map(k => `<button type="button" class="chip warn chipBtn" data-kw="${S.escapeHtml(k)}" title="Add this keyword to your CV">${S.escapeHtml(k)}<span class="plus" aria-hidden="true">＋</span></button>`).join("")
        : `<span class="hint">—</span>`;

      setText("kwUsedCount", used.length ? String(used.length) : "0");
      setText("kwMissCount", miss.length ? String(miss.length) : "0");

      const score = computeAtsScore(used, miss);
      if(score == null){
        setText("atsScore", "—");
        $("atsBar").style.width = "0%";
      }else{
        setText("atsScore", score + "%");
        $("atsBar").style.width = score + "%";
      }
    }

    /* -------------------------
       CV doc formatting (ported from dashboard)
       ------------------------- */
    function cvLabels(lang){
      const de = (String(lang||"").toLowerCase().startsWith("de"));
      return de ? {
        summary: "Profil",
        experience: "Berufserfahrung",
        education: "Ausbildung",
        achievements: "Erfolge",
        skills: "Skills",
        courses: "Kurse",
        interests: "Interessen",
        languages: "Sprachen"
      } : {
        summary: "Profile",
        experience: "Experience",
        education: "Education",
        achievements: "Key achievements",
        skills: "Skills",
        courses: "Courses",
        interests: "Interests",
        languages: "Languages"
      };
    }

    function ul(items){
      const arr = asStringArr(items, 999);
      if(!arr.length) return "";
      return `<ul class="cvUl">${arr.map(x => `<li>${S.escapeHtml(x)}</li>`).join("")}</ul>`;
    }

    function sec(title, inner){
      if(!inner || !String(inner).trim()) return "";
      return `<div class="cvSection"><div class="cvSectionTitle">${S.escapeHtml(title)}</div>${inner}</div>`;
    }

    function item(title, sub, meta, bullets){
      const t = String(title || "").trim();
      const s = String(sub || "").trim();
      const m = String(meta || "").trim();
      const b = asStringArr(bullets, 12);

      const parts = [];
      parts.push(`<div class="cvItem">`);
      if(t) parts.push(`<div class="cvItemTitle">${S.escapeHtml(t)}</div>`);
      if(s) parts.push(`<div class="cvItemSub">${S.escapeHtml(s)}</div>`);
      if(m) parts.push(`<div class="cvMetaLine">${S.escapeHtml(m)}</div>`);
      if(b.length) parts.push(ul(b));
      parts.push(`</div>`);
      return parts.join("");
    }

    function cvDocToPreviewHtml(doc, lang){
      const L = cvLabels(lang);
      const name = String(doc?.name || "YOUR NAME");
      const role = String(doc?.target_role || "The role you are applying for");

      const c = doc?.contact || {};
      const contactLine = joinNonEmpty([c.phone, c.email, c.linkedin, c.portfolio, c.location], " · ");

      const summary = asStringArr(doc?.summary, 8);
      const exp = Array.isArray(doc?.experience) ? doc.experience : [];
      const edu = Array.isArray(doc?.education) ? doc.education : [];
      const ach = asStringArr(doc?.key_achievements, 10);

      const skills = doc?.skills || {};
      const skillGroups = Array.isArray(skills?.groups) ? skills.groups : [];
      const addSkills = asStringArr(skills?.additional, 24);

      const courses = asStringArr(doc?.courses, 12);
      const interests = asStringArr(doc?.interests, 12);
      const langs = asStringArr(doc?.languages, 12);

      const summaryHtml = summary.length ? `<p class="cvPara">${S.escapeHtml(summary.join(" "))}</p>` : "";

      const expHtml = exp.map(e => {
        const title = e?.title || "";
        const sub = joinNonEmpty([e?.company, e?.location], " · ");
        const meta = joinNonEmpty([e?.start, e?.end], " – ");
        return item(title, sub, meta, e?.bullets);
      }).join("");

      const eduHtml = edu.map(e => {
        const title = joinNonEmpty([e?.degree, e?.field], " · ");
        const sub = joinNonEmpty([e?.school, e?.location], " · ");
        const meta = joinNonEmpty([e?.start, e?.end], " – ");
        return item(title, sub, meta, e?.bullets);
      }).join("");

      const skillsInner = [
        skillGroups.map(g => {
          const label = String(g?.label || "").trim();
          const items = asStringArr(g?.items, 30);
          if(!items.length) return "";
          const line = label ? `${S.escapeHtml(label)}: ${S.escapeHtml(items.join(", "))}` : S.escapeHtml(items.join(", "));
          return `<div class="cvSkillLine">${line}</div>`;
        }).join(""),
        addSkills.length ? `<div class="cvSkillLine">${S.escapeHtml(addSkills.join(", "))}</div>` : ""
      ].join("");

      const coursesInner = courses.length ? `<div class="cvPara">${S.escapeHtml(courses.join(" · "))}</div>` : "";
      const interestsInner = interests.length ? `<div class="cvPara">${S.escapeHtml(interests.join(" · "))}</div>` : "";
      const langsInner = langs.length ? `<div class="cvPara">${S.escapeHtml(langs.join(" · "))}</div>` : "";

      return [
        `<div class="cvPreview">`,
        `<div class="cvName">${S.escapeHtml(name)}</div>`,
        `<div class="cvRole">${S.escapeHtml(role)}</div>`,
        contactLine ? `<div class="cvContact">${S.escapeHtml(contactLine)}</div>` : ``,
        sec(L.summary, summaryHtml),
        sec(L.experience, expHtml),
        sec(L.education, eduHtml),
        sec(L.achievements, ul(ach)),
        sec(L.skills, skillsInner),
        sec(L.courses, coursesInner),
        sec(L.interests, interestsInner),
        sec(L.languages, langsInner),
        `</div>`,
      ].join("");
    }

    function cvDocToPlainText(doc, lang){
      const L = cvLabels(lang);
      const lines = [];
      const name = String(doc?.name || "").trim();
      const role = String(doc?.target_role || "").trim();
      const c = doc?.contact || {};
      const contactLine = joinNonEmpty([c.phone, c.email, c.linkedin, c.portfolio, c.location], " · ");

      if(name) lines.push(name);
      if(role) lines.push(role);
      if(contactLine) lines.push(contactLine);
      if(lines.length) lines.push("");

      const summary = asStringArr(doc?.summary, 8);
      if(summary.length){
        lines.push(L.summary.toUpperCase());
        lines.push(summary.join(" "));
        lines.push("");
      }

      const exp = Array.isArray(doc?.experience) ? doc.experience : [];
      if(exp.length){
        lines.push(L.experience.toUpperCase());
        for(const e of exp){
          const t = String(e?.title || "").trim();
          const sub = joinNonEmpty([e?.company, e?.location], " · ");
          const meta = joinNonEmpty([e?.start, e?.end], " – ");
          if(t) lines.push(t);
          if(sub) lines.push(sub);
          if(meta) lines.push(meta);
          const b = asStringArr(e?.bullets, 12);
          for(const bb of b) lines.push("- " + bb);
          lines.push("");
        }
      }

      const edu = Array.isArray(doc?.education) ? doc.education : [];
      if(edu.length){
        lines.push(L.education.toUpperCase());
        for(const e of edu){
          const t = joinNonEmpty([e?.degree, e?.field], " · ");
          const sub = joinNonEmpty([e?.school, e?.location], " · ");
          const meta = joinNonEmpty([e?.start, e?.end], " – ");
          if(t) lines.push(t);
          if(sub) lines.push(sub);
          if(meta) lines.push(meta);
          const b = asStringArr(e?.bullets, 8);
          for(const bb of b) lines.push("- " + bb);
          lines.push("");
        }
      }

      const ach = asStringArr(doc?.key_achievements, 10);
      if(ach.length){
        lines.push(L.achievements.toUpperCase());
        for(const a of ach) lines.push("- " + a);
        lines.push("");
      }

      const skills = doc?.skills || {};
      const groups = Array.isArray(skills?.groups) ? skills.groups : [];
      const addSkills = asStringArr(skills?.additional, 24);
      const skillLines = [];
      for(const g of groups){
        const label = String(g?.label || "").trim();
        const items = asStringArr(g?.items, 30);
        if(!items.length) continue;
        skillLines.push(label ? (label + ": " + items.join(", ")) : items.join(", "));
      }
      if(addSkills.length) skillLines.push(addSkills.join(", "));
      if(skillLines.length){
        lines.push(L.skills.toUpperCase());
        for(const s of skillLines) lines.push(s);
        lines.push("");
      }

      const courses = asStringArr(doc?.courses, 12);
      if(courses.length){
        lines.push(L.courses.toUpperCase());
        lines.push(courses.join(" · "));
        lines.push("");
      }

      const interests = asStringArr(doc?.interests, 12);
      if(interests.length){
        lines.push(L.interests.toUpperCase());
        lines.push(interests.join(" · "));
        lines.push("");
      }

      const langs = asStringArr(doc?.languages, 12);
      if(langs.length){
        lines.push(L.languages.toUpperCase());
        lines.push(langs.join(" · "));
        lines.push("");
      }

      return lines.join("\n").trim() + "\n";
    }

    function cvTextToPrintableHtml(title, text){
      const safeTitle = S.escapeHtml(title || "Curriculum Vitae");
      const safeText = S.escapeHtml(String(text || "").trim());
      return `<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${safeTitle}</title>
<style>
  @page{ size:A4; margin:14mm 14mm 14mm 14mm; }
  body{ margin:0; padding:0; font-family: Arial, Helvetica, sans-serif; color:#111318; }
  .cvPaper{ max-width:820px; margin:0 auto; padding:0; }
  h1{ font-size:18px; margin:0 0 10px 0; }
  pre{ white-space:pre-wrap; font-size:12.5px; line-height:1.45; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }

    /* Keyword booster (truthful keyword insertion) */
    button.chipBtn{
      appearance:none;
      -webkit-appearance:none;
      background:transparent;
      font:inherit;
      border:0;
      padding:0;
      cursor:pointer;
      line-height:1;
    }
    button.chipBtn .plus{
      margin-left:6px;
      font-weight:950;
      opacity:.85;
    }
    button.chipBtn:focus-visible{
      outline:2px solid rgba(34,197,94,.55);
      outline-offset:2px;
      border-radius:999px;
    }

    .checkRow{
      display:flex;
      align-items:flex-start;
      gap:10px;
      margin-top:10px;
      font-weight:850;
      color:rgba(17,19,24,.80);
      line-height:1.35;
    }
    .checkRow input{ margin-top:2px; }

    .field{
      width:100%;
      border:1px solid rgba(17,19,24,.14);
      background:rgba(255,255,255,.86);
      border-radius:14px;
      padding:10px 12px;
      font-weight:800;
      font-size:13px;
      color:rgba(17,19,24,.88);
      outline:none;
    }
    .field:focus{
      border-color: rgba(34,197,94,.55);
      box-shadow: 0 0 0 3px rgba(34,197,94,.16);
    }
    textarea.field{
      resize:vertical;
      min-height: 96px;
      font-family: inherit;
      line-height: 1.45;
    }

  </style>
</head>
<body>
  <div class="cvPaper">
    <h1>${safeTitle}</h1>
    <pre>${safeText}</pre>
  </div>
</body>
</html>`;
    }

    function cvDocToPrintableHtml(cvDoc, lang, title){
      const css = `
        @page{ size:A4; margin:14mm 14mm 14mm 14mm; }
        body{ margin:0; padding:0; font-family: Arial, Helvetica, sans-serif; color:#111318; }
        .cvPaper{ max-width:820px; margin:0 auto; }
        .cvName{ font-size:34px; font-weight:900; letter-spacing:-.6px; color:#111318; }
        .cvRole{ margin-top:2px; font-size:14px; font-weight:800; color:#3b3f46; }
        .cvContact{ margin-top:6px; font-size:12.5px; color:#3b3f46; }
        .cvSection{ margin-top:16px; }
        .cvSectionTitle{ font-size:14px; font-weight:900; letter-spacing:.04em; text-transform:uppercase; border-bottom:3px solid #111318; padding-bottom:6px; margin:0 0 8px 0; }
        .cvItem{ margin-top:10px; }
        .cvItemTitle{ font-size:13.5px; font-weight:900; }
        .cvItemSub{ margin-top:2px; font-size:12.5px; font-weight:800; color:#3b3f46; }
        .cvMetaLine{ margin-top:2px; font-size:12.5px; color:#3b3f46; }
        .cvUl{ margin:6px 0 0 18px; padding:0; }
        .cvUl li{ margin:0 0 3px 0; font-size:13px; }
        .cvPara{ font-size:13px; line-height:1.45; margin:0; }
        .cvSkillLine{ font-size:13px; line-height:1.45; margin:2px 0; }
      `;

      const safeTitle = S.escapeHtml(title || "Curriculum Vitae");
      const bodyHtml = cvDocToPreviewHtml(cvDoc, lang).replace('<div class="cvPreview">', '<div class="cvPaper">');

      return `<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${safeTitle}</title>
<style>${css}
    /* Keyword booster (truthful keyword insertion) */
    button.chipBtn{
      appearance:none;
      -webkit-appearance:none;
      background:transparent;
      font:inherit;
      border:0;
      padding:0;
      cursor:pointer;
      line-height:1;
    }
    button.chipBtn .plus{
      margin-left:6px;
      font-weight:950;
      opacity:.85;
    }
    button.chipBtn:focus-visible{
      outline:2px solid rgba(34,197,94,.55);
      outline-offset:2px;
      border-radius:999px;
    }

    .checkRow{
      display:flex;
      align-items:flex-start;
      gap:10px;
      margin-top:10px;
      font-weight:850;
      color:rgba(17,19,24,.80);
      line-height:1.35;
    }
    .checkRow input{ margin-top:2px; }

    .field{
      width:100%;
      border:1px solid rgba(17,19,24,.14);
      background:rgba(255,255,255,.86);
      border-radius:14px;
      padding:10px 12px;
      font-weight:800;
      font-size:13px;
      color:rgba(17,19,24,.88);
      outline:none;
    }
    .field:focus{
      border-color: rgba(34,197,94,.55);
      box-shadow: 0 0 0 3px rgba(34,197,94,.16);
    }
    textarea.field{
      resize:vertical;
      min-height: 96px;
      font-family: inherit;
      line-height: 1.45;
    }

  </style>
</head>
<body>
${bodyHtml}
</body>
</html>`;
    }

    function printHtml(html){
      // Hidden iframe to avoid popup blockers
      const blob = new Blob([html], {type:'text/html'});
      const url = URL.createObjectURL(blob);
      let iframe = document.getElementById('printFrame');
      if(!iframe){
        iframe = document.createElement('iframe');
        iframe.id = 'printFrame';
        iframe.style.position='fixed';
        iframe.style.right='0';
        iframe.style.bottom='0';
        iframe.style.width='1px';
        iframe.style.height='1px';
        iframe.style.opacity='0';
        iframe.style.pointerEvents='none';
        document.body.appendChild(iframe);
      }
      iframe.onload = () => {
        try{
          iframe.contentWindow.focus();
          iframe.contentWindow.print();
        }catch(_){}
        setTimeout(()=>{ try{ URL.revokeObjectURL(url); }catch(_){} }, 1500);
      };
      iframe.src = url;
    }

    /* -------------------------
       Tabs + rendering
       ------------------------- */
    function setTabs(which){
      const isPreview = which === "preview";
      $("tabPreview").classList.toggle("active", isPreview);
      $("tabText").classList.toggle("active", !isPreview);
      $("cvPreviewWrap").style.display = isPreview ? "" : "none";
      $("cvTextWrap").style.display = isPreview ? "none" : "";
    }

    function setCvOutput({ text, doc, lang }){
      lastCvText = String(text || "").trim();
      lastCvDoc = doc || null;
      lastLang = lang || "en";

      // Text view (prefer doc -> plain text to keep consistent formatting)
      const textOut = lastCvDoc ? cvDocToPlainText(lastCvDoc, lastLang) : lastCvText;
      lastCvText = String(textOut || "").trim();

      // Preview
      if(lastCvDoc){
        $("cvPreview").innerHTML = cvDocToPreviewHtml(lastCvDoc, lastLang);
      }else{
        const safe = S.escapeHtml(lastCvText || "");
        $("cvPreview").innerHTML = safe
          ? `<pre class="cvPre">${safe}</pre>`
          : `<div class="hint">No CV generated yet.</div>`;
      }

      $("cvText").value = textOut || "";
      textDirty = false;

      setOutputEnabled(!!(textOut && String(textOut).trim()));
    }else{
        $("cvPreview").innerHTML = `<div class="hint">No structured preview available. Showing text only.</div>`;
      }

      // Text view (prefer doc -> plain text to keep consistent formatting)
      const textOut = lastCvDoc ? cvDocToPlainText(lastCvDoc, lastLang) : lastCvText;
      $("cvText").value = textOut || "";

      setOutputEnabled(!!(textOut && textOut.trim()));
    }

    /* -------------------------
       Queue loading
       ------------------------- */
    async function loadQueue(){
      const resp = await apiGet("/me/jobs/queue");
      jobs = Array.isArray(resp?.data) ? resp.data : [];
      const sel = $("jobSelect");
      sel.innerHTML = "";

      if(!jobs.length){
        sel.innerHTML = `<option value="">No jobs in queue</option>`;
        setText("jobHint", "No jobs found. Go to Jobs and fetch new jobs.");
        setText("jobMeta", "");
        $("btnGenerate").disabled = true;
        $("btnGenerateAgain").disabled = true;
        $("btnViewDesc").disabled = true;
        $("btnCopyDesc").disabled = true;
        return;
      }

      for(const j of jobs){
        const label = [j.title || "Untitled", j.company_name || "Company"].filter(Boolean).join(" · ");
        const opt = document.createElement("option");
        opt.value = String(j.id);
        opt.textContent = label;
        sel.appendChild(opt);
      }

      const urlJobId = (qs("job_id") || "").trim();
      const storedJobId = (localStorage.getItem("cvstudio_selected_job_id") || "").trim();
      const preferred = urlJobId || storedJobId;

      if(preferred && jobs.some(j => String(j.id) === String(preferred))){
        sel.value = preferred;
      } else {
        sel.value = String(jobs[0].id);
      }

      await onJobChange();
    }

    async function onJobChange(){
      const jobId = $("jobSelect").value;
      selectedJob = jobs.find(j => String(j.id) === String(jobId)) || null;

      if(!selectedJob){
        setText("jobMeta", "");
        $("btnGenerate").disabled = true;
        $("btnGenerateAgain").disabled = true;
        $("btnViewDesc").disabled = true;
        $("btnCopyDesc").disabled = true;
        return;
      }

      try{ localStorage.setItem("cvstudio_selected_job_id", String(selectedJob.id)); }catch{}

      const meta = [
        selectedJob.company_name ? String(selectedJob.company_name) : null,
        formatLoc(selectedJob) || null
      ].filter(Boolean).join(" · ");

      setText("jobHint", "Selected: " + (selectedJob.title || "Job"));
      setText("jobMeta", meta ? meta : "");

      $("btnGenerate").disabled = false;
      $("btnGenerateAgain").disabled = false;
      $("btnViewDesc").disabled = false;
      $("btnCopyDesc").disabled = false;

      // Restore last from localStorage for this job (best effort)
      try{
        const key = "cvstudio_last_" + String(selectedJob.id);
        const raw = localStorage.getItem(key);
        if(raw){
          const obj = JSON.parse(raw);
          if(obj && (obj.cv_doc || obj.cv_text)){
            lastUsed = Array.isArray(obj.used) ? obj.used : [];
            lastMissing = Array.isArray(obj.missing) ? obj.missing : [];
            renderKeywords();

            setCvOutput({ text: obj.cv_text || "", doc: obj.cv_doc || null, lang: obj.lang || obj.language || "en" });
            try{ setBaseSnapshotFromCurrent(); }catch(_){ }
            setBadge("outStatus","good","Ready (local)");
            setText("outModel","Model: —");
            setText("outHint","Loaded your last tailored CV from this device. Generate to refresh from server.");
          }
        }
      }catch(_){}
    }

    function buildTailorPayload(){
      const tpl = String($("tplSelect").value || "professional").trim().toLowerCase();
      const s = strengthValue();
      return { job_id: String(selectedJob?.id || ""), template: tpl, strength: s.key };
    }

    /* -------------------------
       Generate
       ------------------------- */
    async function generate(){
      showError("");
      if(!selectedJob){
        showError("Pick a job first.");
        return;
      }

      markSteps("running");
      setBadge("outStatus", "warn", "Generating…");
      setText("outHint", "Generating your tailored CV…");
      setText("debugBox", "—");
      setBadge("pipeBadge", "warn", "Working…");

      $("btnGenerate").disabled = true;
      $("btnGenerateAgain").disabled = true;

      try{
        const payload = buildTailorPayload();
        const res = await apiPostJson("/me/cv/tailor", payload);

        if(!res || res.ok !== true){
          throw new Error(res?.error || "CV tailoring failed");
        }

        const r = res.result || {};
        const text = String(r.cv_text || "").trim();
        const doc = r.cv_doc || null;
        const lang = r.language || "en";

        lastUsed = Array.isArray(r.ats_keywords_used) ? r.ats_keywords_used : [];
        lastMissing = Array.isArray(r.ats_keywords_missing) ? r.ats_keywords_missing : [];
        lastDebug = {
          cached: !!res.cached,
          cache_age_seconds: res.cache_age_seconds ?? null,
          model: r.model || null,
          prompt_version: r.prompt_version || null,
          language: lang || null,
          desc_cache_status: r.desc_cache_status || null,
          cv_clean_status: r.cv_clean_status || null,
          cv_clean_model: r.cv_clean_model || null,
          cv_structured_status: r.cv_structured_status || null,
          cv_structured_model: r.cv_structured_model || null
        };

        renderKeywords();
        setCvOutput({ text, doc, lang });

        // Base snapshot for local edits (undo/reset)
        try{ setBaseSnapshotFromCurrent(); }catch(_){ }

        setBadge("outStatus", "good", res.cached ? "Ready (cached)" : "Ready");
        setText("outModel", "Model: " + (r.model || "—"));
        setText("outHint", res.cached
          ? "Loaded your last tailored CV for these settings (cached). Change strength to create a different version."
          : "Generated a new tailored CV. Review and export below."
        );
        markSteps("done");

        const lines = [
          "Job description: " + String(r.desc_cache_status || "—"),
          "CV clean: " + String(r.cv_clean_status || "—") + (r.cv_clean_model ? (" (" + r.cv_clean_model + ")") : ""),
          "CV structured: " + String(r.cv_structured_status || "—") + (r.cv_structured_model ? (" (" + r.cv_structured_model + ")") : ""),
          res.cached ? ("Cache: used (" + String(res.cache_age_seconds || "0") + "s old)") : "Cache: generated"
        ];
        $("pipeBox").textContent = lines.join("\n");
        setBadge("pipeBadge", "good", "OK");

        $("debugBox").textContent = JSON.stringify({ ok:true, ...lastDebug }, null, 2);

        // Save last output locally (best effort)
        try{
          const key = "cvstudio_last_" + String(payload.job_id);
          localStorage.setItem(key, JSON.stringify({
            at: Date.now(),
            payload,
            cv_text: text,
            cv_doc: doc,
            lang,
            used: lastUsed,
            missing: lastMissing,
            debug: lastDebug
          }));
        }catch(_){}
      }catch(e){
        markSteps("error");
        setBadge("outStatus","bad","Failed");
        setBadge("pipeBadge","bad","Failed");
        showError(e?.message || String(e));
        $("debugBox").textContent = JSON.stringify({ ok:false, error: e?.message || String(e) }, null, 2);
        setText("outHint", "Failed to generate. Check your CV upload and job description availability.");
      }finally{
        $("btnGenerate").disabled = false;
        $("btnGenerateAgain").disabled = false;
      }
    }

    /* -------------------------
       Description modal
       ------------------------- */
    async function openDescModal(){
      showError("");
      if(!selectedJob){
        showError("Pick a job first.");
        return;
      }

      S.showModal("descModal");
      $("descH").textContent = selectedJob.title || "Job description";
      $("descMeta").textContent = [selectedJob.company_name || "", formatLoc(selectedJob) || ""].filter(Boolean).join(" · ");
      $("descText").textContent = "Loading…";
      $("descOpen").setAttribute("href", "#");
      $("descCopy").textContent = "Copy";
      selectedDesc = "";
      selectedApplyUrl = applyUrlSafe(selectedJob.apply_url);

      if(selectedApplyUrl){
        $("descOpen").setAttribute("href", selectedApplyUrl);
        $("descOpen").classList.remove("ghost");
      }else{
        $("descOpen").setAttribute("href", "#");
        $("descOpen").classList.add("ghost");
      }

      try{
        const resp = await apiGet("/me/jobs/description?job_id=" + encodeURIComponent(String(selectedJob.id)));
        const job = resp?.job || null;
        const txt = String(job?.description_full || job?.description || "").trim();
        selectedDesc = txt || "(No description available.)";
        $("descText").textContent = selectedDesc;
      }catch(e){
        $("descText").textContent = "Failed to load description.\n\n" + (e?.message || String(e));
      }
    }

    async function copyTextToClipboard(txt){
      const text = String(txt || "");
      if(!text) return;
      try{
        await navigator.clipboard.writeText(text);
      }catch(_){
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        try{ document.execCommand("copy"); }catch{}
        document.body.removeChild(ta);
      }
    }

    async function copyDesc(){
      if(!selectedDesc){
        await openDescModal();
        return;
      }
      await copyTextToClipboard(selectedDesc);
    }

    /* -------------------------
       Copy / Download / Print
       ------------------------- */
    async function copyCv(){
      const txt = $("cvText").value || "";
      if(!txt.trim()) return;
      await copyTextToClipboard(txt);
      $("btnCopy").textContent = "Copied ✓";
      setTimeout(()=>{ $("btnCopy").textContent = "Copy"; }, 900);
    }

    function downloadTxt(){
      const txt = $("cvText").value || "";
      if(!txt.trim()) return;

      const title = selectedJob?.title ? String(selectedJob.title).slice(0, 60) : "tailored_cv";
      const safe = title.replace(/[^a-z0-9\-\_ ]/gi, "").trim().replace(/\s+/g, "_") || "tailored_cv";
      const filename = safe + ".txt";

      const blob = new Blob([txt], { type:"text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function printPdf(){
      const jobTitle = selectedJob?.title ? String(selectedJob.title) : "Curriculum Vitae";
      const html = (lastCvDoc)
        ? cvDocToPrintableHtml(lastCvDoc, lastLang, jobTitle)
        : cvTextToPrintableHtml(jobTitle, $("cvText").value || "");
      printHtml(html);
    }

    async function copyMissing(){
      const miss = Array.isArray(lastMissing) ? lastMissing : [];
      if(!miss.length) return;
      const text = miss.join(", ");
      await copyTextToClipboard(text);
      $("btnCopyMissing").textContent = "Copied ✓";
      setTimeout(()=>{ $("btnCopyMissing").textContent = "Copy missing"; }, 900);
    }


    /* -------------------------
       Keyword insertion (local edits)
       ------------------------- */
    function deepClone(obj){
      try{ return (obj == null) ? obj : JSON.parse(JSON.stringify(obj)); }
      catch(_){ return obj; }
    }

    function uniqCaseInsensitive(arr){
      const out = [];
      const seen = new Set();
      for(const x of (Array.isArray(arr) ? arr : [])){
        const s = String(x || "").trim();
        if(!s) continue;
        const key = s.toLowerCase();
        if(seen.has(key)) continue;
        seen.add(key);
        out.push(s);
      }
      return out;
    }

    function norm(s){
      return String(s || "")
        .toLowerCase()
        .replace(/[^a-z0-9]+/gi, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function containsKeyword(text, kw){
      const k = norm(kw);
      if(!k) return false;
      const t = " " + norm(text) + " ";
      return t.includes(" " + k + " ");
    }

    function getAllJobKeywords(){
      return uniqCaseInsensitive([
        ...(Array.isArray(lastUsed) ? lastUsed : []),
        ...(Array.isArray(lastMissing) ? lastMissing : [])
      ]);
    }

    function recomputeCoverageFromText(){
      const all = getAllJobKeywords();
      const txt = String($("cvText").value || "").trim();
      if(!all.length || !txt) return;

      const used = [];
      const miss = [];
      for(const kw of all){
        (containsKeyword(txt, kw) ? used : miss).push(kw);
      }
      lastUsed = used;
      lastMissing = miss;
      renderKeywords();
    }

    function captureSnapshot(){
      return {
        cv_doc: deepClone(lastCvDoc),
        cv_text: String($("cvText").value || lastCvText || "").trim(),
        lang: lastLang || "en",
        used: deepClone(lastUsed),
        missing: deepClone(lastMissing),
        debug: deepClone(lastDebug),
        isEdited: !!isEdited,
        textDirty: !!textDirty
      };
    }

    function renderFromCurrentState(){
      const txtOut = lastCvDoc ? cvDocToPlainText(lastCvDoc, lastLang) : String(lastCvText || "").trim();
      lastCvText = String(txtOut || "").trim();
      $("cvText").value = txtOut || "";

      if(lastCvDoc){
        $("cvPreview").innerHTML = cvDocToPreviewHtml(lastCvDoc, lastLang);
      }else{
        const safe = S.escapeHtml(lastCvText || "");
        $("cvPreview").innerHTML = safe
          ? `<pre class="cvPre">${safe}</pre>`
          : `<div class="hint">No CV generated yet.</div>`;
      }

      setOutputEnabled(!!(String($("cvText").value || "").trim()));
      renderKeywords();
      updateEditButtons();
    }

    function applySnapshot(snap){
      if(!snap) return;
      lastCvDoc = snap.cv_doc || null;
      lastCvText = String(snap.cv_text || "").trim();
      lastLang = snap.lang || lastLang || "en";
      lastUsed = Array.isArray(snap.used) ? snap.used : [];
      lastMissing = Array.isArray(snap.missing) ? snap.missing : [];
      lastDebug = snap.debug || lastDebug || {};
      isEdited = !!snap.isEdited;
      textDirty = !!snap.textDirty;

      renderFromCurrentState();

      if(isEdited){
        setBadge("outStatus","good","Ready (edited)");
      }
    }

    function setBaseSnapshotFromCurrent(){
      baseSnapshot = captureSnapshot();
      editHistory = [];
      isEdited = false;
      textDirty = false;
      updateEditButtons();
    }

    function pushHistory(){
      editHistory = Array.isArray(editHistory) ? editHistory : [];
      editHistory.push(captureSnapshot());
      if(editHistory.length > 30) editHistory.shift();
      updateEditButtons();
    }

    function persistLocalCv(){
      // best-effort local persistence so customer can come back later
      try{
        if(!selectedJob?.id) return;
        const key = "cvstudio_last_" + String(selectedJob.id);
        let existing = {};
        try{ existing = JSON.parse(localStorage.getItem(key) || "{}") || {}; }catch(_){}
        const payload = existing.payload || buildTailorPayload();
        localStorage.setItem(key, JSON.stringify({
          ...existing,
          at: Date.now(),
          payload,
          cv_text: String($("cvText").value || "").trim(),
          cv_doc: lastCvDoc,
          lang: lastLang,
          used: lastUsed,
          missing: lastMissing,
          debug: { ...(existing.debug || {}), ...(lastDebug || {}), edited_local:true }
        }));
      }catch(_){}
    }

    function markEdited(){
      isEdited = true;
      setBadge("outStatus", "good", "Ready (edited)");
      setText("outHint", "Edited locally. Export below when ready.");
      updateEditButtons();
      persistLocalCv();
    }

    function undoLastEdit(){
      if(!Array.isArray(editHistory) || !editHistory.length) return;
      const snap = editHistory.pop();
      applySnapshot(snap);
      isEdited = true;
      setBadge("outStatus", "good", "Ready (edited)");
      updateEditButtons();
      persistLocalCv();
    }

    function resetEdits(){
      if(!baseSnapshot) return;
      applySnapshot(baseSnapshot);
      editHistory = [];
      isEdited = false;
      textDirty = false;
      setBadge("outStatus", "good", "Ready");
      setText("outHint", "Reset to the last generated CV.");
      updateEditButtons();
      persistLocalCv();
    }

    function insertKeywordIntoDocSkills(doc, kw, groupIdx){
      doc.skills = doc.skills || {};
      doc.skills.groups = Array.isArray(doc.skills.groups) ? doc.skills.groups : [];
      doc.skills.additional = Array.isArray(doc.skills.additional) ? doc.skills.additional : [];

      const key = norm(kw);
      if(!key) return { ok:false, msg:"Empty keyword." };

      const existsInAdditional = doc.skills.additional.some(x => norm(x) === key);
      const existsInGroups = doc.skills.groups.some(g => Array.isArray(g?.items) && g.items.some(x => norm(x) === key));

      if(existsInAdditional || existsInGroups){
        return { ok:true, msg:"Keyword already present in Skills." };
      }

      const gi = Number(groupIdx);
      if(!Number.isFinite(gi) || gi < 0 || !doc.skills.groups[gi]){
        doc.skills.additional.push(kw);
        doc.skills.additional = uniqCaseInsensitive(doc.skills.additional).slice(0, 40);
        return { ok:true, msg:"Added to Additional skills." };
      }

      const g = doc.skills.groups[gi];
      g.items = Array.isArray(g.items) ? g.items : [];
      g.items.push(kw);
      g.items = uniqCaseInsensitive(g.items).slice(0, 40);
      return { ok:true, msg:"Added to Skills → " + String(g.label || "Group") + "." };
    }

    function insertKeywordIntoDocExperience(doc, kw, expIdx, mode, bulletIdx, newBulletText, appendPhrase){
      doc.experience = Array.isArray(doc.experience) ? doc.experience : [];
      const ei = Number(expIdx);
      if(!Number.isFinite(ei) || !doc.experience[ei]) return { ok:false, msg:"Experience entry not found." };

      const e = doc.experience[ei];
      e.bullets = Array.isArray(e.bullets) ? e.bullets : [];

      if(mode === "append"){
        const bi = Number(bulletIdx);
        if(!Number.isFinite(bi) || !e.bullets[bi]) return { ok:false, msg:"Bullet not found." };

        const base = String(e.bullets[bi] || "").trim();
        if(containsKeyword(base, kw)) return { ok:true, msg:"Keyword already present in that bullet." };

        let phrase = String(appendPhrase || "").trim();
        if(!phrase) phrase = "including " + kw;
        if(!containsKeyword(phrase, kw)) phrase = phrase + " (" + kw + ")";

        const spacer = base.endsWith(".") ? " " : " ";
        e.bullets[bi] = (base + spacer + phrase).trim();
        return { ok:true, msg:"Appended to selected bullet." };
      }

      // new bullet
      let bullet = String(newBulletText || "").trim();
      if(!bullet) bullet = "Applied " + kw + " in day-to-day work.";
      if(!containsKeyword(bullet, kw)) bullet = (bullet + " (" + kw + ")").trim();

      if(e.bullets.length >= 12) e.bullets = e.bullets.slice(0, 11);
      e.bullets.push(bullet);
      return { ok:true, msg:"Added new bullet to experience." };
    }

    // Plain-text insertion (fallback / preserve manual edits)
    function isHeadingLine(line){
      const s = String(line || "").trim();
      if(!s) return false;
      if(s.length > 40) return false;
      return s === s.toUpperCase() && /[A-Z]/.test(s) && !/[a-z]/.test(s);
    }

    function findSectionBounds(lines, heading){
      const H = String(heading || "").trim().toUpperCase();
      let start = -1;
      for(let i=0;i<lines.length;i++){
        if(String(lines[i] || "").trim().toUpperCase() === H){ start = i; break; }
      }
      if(start < 0) return null;

      let end = lines.length;
      for(let i=start+1;i<lines.length;i++){
        if(isHeadingLine(lines[i])){ end = i; break; }
      }
      return { start, end };
    }

    function insertKeywordIntoPlainTextSkills(text, kw){
      const lines = String(text || "").split(/\r?\n/);
      const bounds = findSectionBounds(lines, "SKILLS");
      if(!bounds){
        if(lines.length && lines[lines.length-1].trim() !== "") lines.push("");
        lines.push("SKILLS");
        lines.push(kw);
        lines.push("");
        return lines.join("\n").trim() + "\n";
      }

      // place it near the end of Skills section
      let lastNonEmpty = -1;
      for(let i=bounds.end-1;i>bounds.start;i--){
        if(String(lines[i] || "").trim() !== ""){ lastNonEmpty = i; break; }
      }

      if(lastNonEmpty > bounds.start){
        const cur = String(lines[lastNonEmpty] || "");
        if(!containsKeyword(cur, kw)){
          if(cur.length < 160 && /[:,·]/.test(cur)){
            lines[lastNonEmpty] = cur.replace(/\s*$/, "") + (cur.trim().endsWith("·") ? " " : " · ") + kw;
          }else{
            lines.splice(lastNonEmpty+1, 0, kw);
          }
        }
      }else{
        lines.splice(bounds.start+1, 0, kw);
      }

      return lines.join("\n").trim() + "\n";
    }

    function insertKeywordIntoPlainTextExperience(text, kw, mode, appendPhrase, newBulletText){
      const lines = String(text || "").split(/\r?\n/);
      const bounds = findSectionBounds(lines, "EXPERIENCE");
      if(!bounds){
        if(lines.length && lines[lines.length-1].trim() !== "") lines.push("");
        lines.push("EXPERIENCE");
        lines.push("(Add your experience here)");
        const b = String(newBulletText || ("Applied " + kw + ".")).trim();
        lines.push("- " + (containsKeyword(b, kw) ? b : (b + " (" + kw + ")")));
        lines.push("");
        return lines.join("\n").trim() + "\n";
      }

      // insert before end of experience section (simple + robust)
      let insertAt = bounds.end;
      for(let i=bounds.end-1;i>bounds.start;i--){
        if(String(lines[i] || "").trim() === ""){
          insertAt = i;
          break;
        }
      }

      if(mode === "append"){
        // try append to last bullet in experience section, else add a new bullet
        let lastBullet = -1;
        for(let i=insertAt-1;i>bounds.start;i--){
          const s = String(lines[i] || "").trim();
          if(s.startsWith("- ")){ lastBullet = i; break; }
          if(s === "") break;
        }

        let phrase = String(appendPhrase || "").trim();
        if(!phrase) phrase = "including " + kw;
        if(!containsKeyword(phrase, kw)) phrase = phrase + " (" + kw + ")";

        if(lastBullet >= 0){
          const base = String(lines[lastBullet] || "").trim();
          if(!containsKeyword(base, kw)){
            lines[lastBullet] = (base + " " + phrase).trim();
          }
        }else{
          const b = String(newBulletText || ("Applied " + kw + ".")).trim();
          lines.splice(insertAt, 0, "- " + (containsKeyword(b, kw) ? b : (b + " (" + kw + ")")));
        }
      }else{
        const b = String(newBulletText || ("Applied " + kw + ".")).trim();
        lines.splice(insertAt, 0, "- " + (containsKeyword(b, kw) ? b : (b + " (" + kw + ")")));
      }

      return lines.join("\n").trim() + "\n";
    }

    function setKwModalUi(){
      const target = String($("kwTarget").value || "skills");
      const mode = String($("kwExpMode").value || "new");

      $("kwSkillsBox").style.display = (target === "skills") ? "" : "none";
      $("kwExpBox").style.display = (target === "experience") ? "" : "none";
      $("kwExpNewBox").style.display = (target === "experience" && mode === "new") ? "" : "none";
      $("kwExpAppendBox").style.display = (target === "experience" && mode === "append") ? "" : "none";

      // If user typed in Text tab, steer them to preserve edits
      const hint = $("kwTextOnlyHint");
      if(hint){
        hint.textContent = textDirty
          ? "You edited the CV text manually. Applying to the structured CV may overwrite those edits. Use “Apply to text only” to preserve them."
          : "If you edited the CV text manually, applying to the structured CV can overwrite your edits.";
      }

      validateKwModal();
    }

    function populateKwSkillGroups(){
      const sel = $("kwSkillGroup");
      sel.innerHTML = "";

      const o0 = document.createElement("option");
      o0.value = "-1";
      o0.textContent = "Additional skills (recommended)";
      sel.appendChild(o0);

      const groups = Array.isArray(lastCvDoc?.skills?.groups) ? lastCvDoc.skills.groups : [];
      for(let i=0;i<groups.length;i++){
        const g = groups[i] || {};
        const label = String(g.label || ("Group " + (i+1))).trim();
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = label;
        sel.appendChild(opt);
      }

      sel.value = "-1";
    }

    function expLabel(e, i){
      const title = String(e?.title || "").trim() || ("Role " + (i+1));
      const company = String(e?.company || "").trim();
      const loc = String(e?.location || "").trim();
      const meta = [company, loc].filter(Boolean).join(" · ");
      return meta ? (title + " — " + meta) : title;
    }

    function populateKwExperiences(){
      const sel = $("kwExpIndex");
      sel.innerHTML = "";

      const exp = Array.isArray(lastCvDoc?.experience) ? lastCvDoc.experience : [];
      if(exp.length){
        for(let i=0;i<exp.length;i++){
          const opt = document.createElement("option");
          opt.value = String(i);
          opt.textContent = expLabel(exp[i], i);
          sel.appendChild(opt);
        }
        sel.value = "0";
      }else{
        const opt = document.createElement("option");
        opt.value = "0";
        opt.textContent = "Experience section (text only)";
        sel.appendChild(opt);
        sel.value = "0";
      }

      populateKwBullets();
    }

    function populateKwBullets(){
      const sel = $("kwExpBulletIndex");
      sel.innerHTML = "";

      const ei = Number($("kwExpIndex").value || 0);
      const bullets = Array.isArray(lastCvDoc?.experience?.[ei]?.bullets) ? lastCvDoc.experience[ei].bullets : [];

      if(!bullets.length){
        const opt = document.createElement("option");
        opt.value = "0";
        opt.textContent = "(No bullets found)";
        sel.appendChild(opt);
        sel.value = "0";
        return;
      }

      for(let i=0;i<bullets.length;i++){
        const b = String(bullets[i] || "").trim();
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = (b.length > 90) ? (b.slice(0, 90) + "…") : b;
        sel.appendChild(opt);
      }
      sel.value = "0";
    }

    function validateKwModal(){
      const kw = String(activeKeyword || "").trim();
      const truth = !!$("kwTruth").checked;
      const target = String($("kwTarget").value || "skills");
      const mode = String($("kwExpMode").value || "new");
      const applyTextOnly = !!$("kwApplyTextOnly").checked;

      const lines = [];
      let ok = true;

      if(!kw){ ok = false; lines.push("No keyword selected."); }
      if(!truth){ ok = false; lines.push("Please confirm the keyword is true to enable insertion."); }

      if(target === "skills"){
        const groupSel = $("kwSkillGroup");
        const groupLabel = groupSel ? groupSel.options[groupSel.selectedIndex]?.textContent : "Skills";
        lines.push("Where: Skills → " + String(groupLabel || "Additional skills") + ".");
        lines.push("Insert: " + kw);
      }else{
        const expSel = $("kwExpIndex");
        const expLabelTxt = expSel ? expSel.options[expSel.selectedIndex]?.textContent : "Experience";
        lines.push("Where: Experience → " + String(expLabelTxt || "Selected role") + ".");

        if(mode === "new"){
          const bullet = String($("kwNewBullet").value || "").trim();
          if(!bullet){ ok = false; lines.push("New bullet text is empty."); }
          else{
            if(!containsKeyword(bullet, kw)){
              ok = false;
              lines.push("New bullet must contain the keyword.");
            }
            lines.push("New bullet: " + bullet);
          }
        }else{
          const phraseRaw = String($("kwAppendPhrase").value || "").trim();
          const phrase = phraseRaw || ("including " + kw);
          if(!phrase){ ok = false; lines.push("Append phrase is empty."); }
          lines.push("Append phrase: " + phrase + (containsKeyword(phrase, kw) ? "" : "  (keyword will be appended automatically)"));
        }
      }

      if(textDirty && !applyTextOnly && lastCvDoc){
        lines.push("");
        lines.push("⚠ This will overwrite your manual text edits (structured CV becomes the source).");
      }
      if(applyTextOnly){
        lines.push("");
        lines.push("Applying to: Text only (preview becomes text-based).");
      }else{
        lines.push("");
        lines.push("Applying to: Structured CV (recommended).");
      }

      $("kwValidation").textContent = lines.join("\n");
      $("kwApply").disabled = !ok;
    }

    function openKwModal(keyword){
      const kw = String(keyword || "").trim();
      if(!kw) return;

      activeKeyword = kw;

      $("kwBadge").textContent = kw;
      $("kwTruth").checked = false;
      $("kwTarget").value = "skills";
      $("kwExpMode").value = "new";
      $("kwApplyTextOnly").checked = false;

      populateKwSkillGroups();
      populateKwExperiences();

      // defaults
      $("kwNewBullet").value = "Applied " + kw + " in day-to-day work to support key deliverables.";
      $("kwAppendPhrase").value = "including " + kw;

      setKwModalUi();
      S.showModal("kwModal");
    }

    function applyKwModal(){
      const kw = String(activeKeyword || "").trim();
      if(!kw) return;
      if(!$("kwTruth").checked) return;

      const target = String($("kwTarget").value || "skills");
      const mode = String($("kwExpMode").value || "new");
      const groupIdx = $("kwSkillGroup") ? $("kwSkillGroup").value : "-1";
      const expIdx = $("kwExpIndex") ? $("kwExpIndex").value : "0";
      const bulletIdx = $("kwExpBulletIndex") ? $("kwExpBulletIndex").value : "0";
      const newBullet = String($("kwNewBullet").value || "").trim();
      const appendPhrase = String($("kwAppendPhrase").value || "").trim();
      const applyTextOnly = !!$("kwApplyTextOnly").checked || !lastCvDoc;

      pushHistory();

      if(applyTextOnly){
        // Apply to plain text output (preserve manual edits)
        let txt = String($("cvText").value || lastCvText || "").trim();
        if(target === "skills"){
          txt = insertKeywordIntoPlainTextSkills(txt, kw);
        }else{
          txt = insertKeywordIntoPlainTextExperience(txt, kw, mode, appendPhrase, newBullet);
        }

        lastCvDoc = null; // avoid preview/text mismatch
        lastCvText = String(txt || "").trim();
        $("cvText").value = txt || "";
        textDirty = false;

        // Re-render as text preview
        renderFromCurrentState();
      }else{
        // Apply to structured CV doc
        const doc = deepClone(lastCvDoc) || {};
        let result = { ok:false, msg:"Failed." };

        if(target === "skills"){
          result = insertKeywordIntoDocSkills(doc, kw, groupIdx);
        }else{
          result = insertKeywordIntoDocExperience(doc, kw, expIdx, mode, bulletIdx, newBullet, appendPhrase);
        }

        lastCvDoc = doc;
        textDirty = false;
        renderFromCurrentState();

        // quick feedback in modal (will close shortly)
        $("kwValidation").textContent = (result.ok ? "✓ " : "✕ ") + String(result.msg || "");
      }

      // update keyword coverage based on current text
      recomputeCoverageFromText();
      markEdited();

      // close modal
      S.hideModal("kwModal");
    }

    /* -------------------------
       Auth + boot
       ------------------------- */
    async function loadStateAndNav(){
      setBadge("authBadge","warn","Checking…");

      session = await window.JobApplyAI.auth.getSession();
      if(!session || !session.user || !session.user.email){
        setBadge("authBadge","warn","Signed out");
        window.location.replace("./signup.html");
        return;
      }

      $("navLogout").style.display = "";
      $("navSignIn").style.display = "none";
      setBadge("authBadge","good","Signed in");

      // Ensure customer exists (best effort)
      try{
        await window.JobApplyAI.auth.requireAuthAndCustomer({ redirectTo: "./signup.html" });
      }catch(_){}

      try{
        await window.JobApplyAI.auth.syncStateToLocalStorage(session);
      }catch(_){}
    }

    async function boot(){
      showError("");

      if(!window.JobApplyAI || !window.JobApplyAI.auth){
        showError("auth.js did not load. Ensure multipage/auth.js exists and is referenced as ./auth.js.");
        setBadge("authBadge","bad","Config error");
        return;
      }

      await loadStateAndNav();

      // restore saved template/strength
      try{
        const sv = localStorage.getItem("cv_strength");
        if(sv !== null && sv !== undefined && sv !== "") $("strengthRange").value = String(sv);
      }catch(_){}
      setStrengthUi();

      try{
        const tv = localStorage.getItem("cv_template");
        if(tv) $("tplSelect").value = tv;
      }catch(_){}
      setTemplateUi();

      // load queue
      await loadQueue();

      // initial output state
      renderKeywords();
      setTabs("preview");
      markSteps("idle");
      setOutputEnabled(false);
    }

    /* -------------------------
       Wire UI
       ------------------------- */
    $("jobSelect").addEventListener("change", onJobChange);

    $("strengthRange").addEventListener("input", setStrengthUi);
    $("strengthPills").addEventListener("click", (e) => {
      const p = e.target.closest(".miniPill");
      if(!p) return;
      $("strengthRange").value = String(p.getAttribute("data-s"));
      setStrengthUi();
    });

    $("tplSelect").addEventListener("change", setTemplateUi);

    $("btnAtsInfo").addEventListener("click", () => S.showModal("atsModal"));
    $("atsClose").addEventListener("click", () => S.hideModal("atsModal"));
    $("atsOk").addEventListener("click", () => S.hideModal("atsModal"));
    $("atsModal").addEventListener("click", (e) => { if(e.target && e.target.id === "atsModal") S.hideModal("atsModal"); });

    $("btnViewDesc").addEventListener("click", openDescModal);
    $("btnCopyDesc").addEventListener("click", async () => {
      try{
        if(!selectedDesc) await openDescModal();
        await copyDesc();
      }catch(_){}
    });

    $("descClose").addEventListener("click", () => S.hideModal("descModal"));
    $("descModal").addEventListener("click", (e) => { if(e.target && e.target.id === "descModal") S.hideModal("descModal"); });
    $("descCopy").addEventListener("click", async () => {
      if(!selectedDesc) return;
      await copyDesc();
      $("descCopy").textContent = "Copied ✓";
      setTimeout(()=>{ $("descCopy").textContent = "Copy"; }, 900);
    });

    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape"){
        S.hideModal("atsModal");
        S.hideModal("descModal");
        S.hideModal("kwModal");
      }
    });

    $("btnGenerate").addEventListener("click", generate);
    $("btnGenerateAgain").addEventListener("click", generate);

    $("tabPreview").addEventListener("click", () => setTabs("preview"));
    $("tabText").addEventListener("click", () => setTabs("text"));

    $("btnCopy").addEventListener("click", () => copyCv());
    $("btnDownload").addEventListener("click", downloadTxt);
    $("btnPrint").addEventListener("click", printPdf);
    $("btnCopyMissing").addEventListener("click", copyMissing);

    // Missing keyword chips -> insert modal
    $("chipsMissing").addEventListener("click", (e) => {
      const btn = e.target.closest("button.chipBtn");
      if(!btn) return;
      const kw = btn.getAttribute("data-kw") || btn.textContent || "";
      if(!String($("cvText").value || "").trim()){
        showError("Generate a CV first, then add keywords.");
        return;
      }
      openKwModal(kw);
    });

    // Undo / reset local edits
    $("btnUndoEdit").addEventListener("click", undoLastEdit);
    $("btnResetEdits").addEventListener("click", resetEdits);

    // Keyword modal wiring
    $("kwClose").addEventListener("click", () => S.hideModal("kwModal"));
    $("kwCancel").addEventListener("click", () => S.hideModal("kwModal"));
    $("kwModal").addEventListener("click", (e) => { if(e.target && e.target.id === "kwModal") S.hideModal("kwModal"); });

    $("kwTarget").addEventListener("change", setKwModalUi);
    $("kwExpMode").addEventListener("change", setKwModalUi);
    $("kwSkillGroup").addEventListener("change", validateKwModal);
    $("kwExpIndex").addEventListener("change", () => { populateKwBullets(); validateKwModal(); });
    $("kwExpBulletIndex").addEventListener("change", validateKwModal);
    $("kwTruth").addEventListener("change", validateKwModal);
    $("kwApplyTextOnly").addEventListener("change", validateKwModal);
    $("kwNewBullet").addEventListener("input", validateKwModal);
    $("kwAppendPhrase").addEventListener("input", validateKwModal);

    $("kwApply").addEventListener("click", applyKwModal);

    // Track manual edits in Text tab (preview becomes text-based)
    $("cvText").addEventListener("input", () => {
      const v = String($("cvText").value || "");
      lastCvText = v.trim();
      if(lastCvDoc){
        lastCvDoc = null; // avoid preview mismatch
      }
      textDirty = true;
      isEdited = true;
      setBadge("outStatus","good","Ready (edited)");

      const safe = S.escapeHtml(lastCvText || "");
      $("cvPreview").innerHTML = safe
        ? `<pre class="cvPre">${safe}</pre>`
        : `<div class="hint">—</div>`;

      recomputeCoverageFromText();
      updateEditButtons();
      persistLocalCv();
    });

    // Logout
    $("navLogout").addEventListener("click", async () => {
      try{
        await window.JobApplyAI.auth.logout("./index.html");
      }catch(_){
        window.location.href = "./index.html";
      }
    });

    // Initial view
    setTabs("preview");
    markSteps("idle");

    window.addEventListener("load", () => {
      boot().catch((e) => {
        showError(e?.message || String(e));
        setBadge("authBadge","bad","Error");
      });
    });

  })();
  </script>
</body>
</html>
