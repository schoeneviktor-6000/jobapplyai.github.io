<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>jobmejob • CV Studio</title>
  <meta name="description" content="Tailor your CV per role with ATS-safe formatting."/>
  <link rel="stylesheet" href="./shared.css"/>

  <style>
    /* Page-specific layout (shared.css provides the base UI) */
    .grid{
      display:grid;
      grid-template-columns: 0.95fr 1.05fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width:1100px){
      .grid{grid-template-columns:1fr}
    }
    .tabs{
      display:flex;
      gap:8px;
      margin:10px 0 10px;
      flex-wrap:wrap;
    }
    .tabBtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      background:rgba(255,255,255,.65);
      cursor:pointer;
      font-weight:600;
    }
    .tabBtn.active{
      border-color: rgba(46, 204, 113, .65);
      box-shadow: 0 0 0 3px rgba(46, 204, 113, .15);
    }
    .panel{display:none}
    .panel.active{display:block}
    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:700px){
      .twoCol{grid-template-columns:1fr}
    }
    .muted{color:rgba(0,0,0,.62)}
    .descBox{
      white-space:pre-wrap;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      line-height:1.5;
      border:1px solid rgba(0,0,0,.10);
      background:rgba(255,255,255,.72);
      border-radius:12px;
      padding:12px;
      max-height:320px;
      overflow:auto;
    }
    .cvPreview{
      white-space:pre-wrap;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      line-height:1.45;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      border-radius:14px;
      padding:16px;
      min-height:260px;
    }
    .metrics{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin:10px 0 0;
    }
    @media (max-width:900px){
      .metrics{grid-template-columns:1fr}
    }
    .metricCard{
      border:1px solid rgba(0,0,0,.10);
      border-radius:14px;
      padding:12px;
      background:rgba(255,255,255,.65);
    }
    .metricTitle{font-weight:700;margin-bottom:6px}
    .metricValue{font-size:22px;font-weight:800}
    .pillRow{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      background:rgba(255,255,255,.75);
      font-size:13px;
      font-weight:600;
    }
    .chip.missing{border-color:rgba(255, 99, 71, .55); background: rgba(255, 99, 71, .08);}
    .chip.used{border-color:rgba(46, 204, 113, .55); background: rgba(46, 204, 113, .08);}
    .chip button{
      border:none;background:transparent;cursor:pointer;
      font-weight:800;color:inherit;
    }
    .sourceTabs{
      display:flex;
      gap:8px;
      margin:6px 0 12px;
    }
    .sourceTabs .pill{
      cursor:pointer;
    }
    .inlineActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .tiny{font-size:12px;color:rgba(0,0,0,.62)}
    textarea.big{
      min-height:220px;
      resize:vertical;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      line-height:1.4;
    }
    .statusLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .statusLineRight{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>

<body>
<header class="topbar">
  <nav class="nav">
    <a class="brand" data-nav="1" href="./index.html"><span aria-hidden="true" class="logo"></span><span>jobmejob</span></a>
    <div class="navlinks">
      <a class="pill" data-nav="1" href="./index.html">Home</a>
      <a class="pill" data-nav="1" href="./profile.html">Profile</a>
      <a class="pill" data-nav="1" href="./plan.html">Plan</a>
      <a class="pill" data-nav="1" href="./jobs.html">Jobs</a>
      <a class="pill" data-nav="1" href="./dashboard.html">Dashboard</a>
      <a class="pill active" data-nav="1" href="./cv_studio.html">CV Studio</a>
      <button aria-label="Logout" class="pill iconOnly" id="btnLogout" type="button">Logout</button>
    </div>
  </nav>
</header>

<main class="main">
  <h1 class="h1">CV Studio</h1>
  <p class="sub">Tailor your CV per role with ATS-safe formatting. Job search + CV tailoring stay free.</p>

  <div class="errorTop" id="errorTop"></div>

  <div class="grid">
    <!-- LEFT: setup -->
    <section class="card" aria-label="Setup">
      <div class="statusLine">
        <h2 style="margin:0">Setup</h2>
        <span class="badge ok" id="authBadge">Checking…</span>
      </div>

      <div class="sourceTabs">
        <button class="pill active" id="tabJobs" type="button">From my Jobs</button>
        <button class="pill" id="tabPaste" type="button">Paste description</button>
      </div>

      <!-- From my Jobs -->
      <div id="panelJobs">
        <div class="field">
          <label for="jobSelect">Job to tailor</label>
          <select id="jobSelect"></select>
          <div class="tiny muted" id="jobMetaLine"></div>
        </div>

        <div class="inlineActions">
          <button class="btn" id="openJobsBtn" type="button">Open Jobs</button>
          <button class="btn" id="viewDescBtn" type="button" disabled>View description</button>
          <button class="btn" id="copyDescBtn" type="button" disabled>Copy description</button>
        </div>

        <div style="margin-top:10px">
          <div class="tiny muted">Description status: <span class="mono" id="descStatus">—</span></div>
          <div class="descBox" id="descBox" style="margin-top:6px; display:none"></div>
        </div>
      </div>

      <!-- Paste description -->
      <div id="panelPaste" style="display:none">
        <div class="field">
          <label for="pasteJobTitle">Job title</label>
          <input id="pasteJobTitle" type="text" placeholder="e.g., Head of Operations"/>
        </div>

        <div class="twoCol">
          <div class="field">
            <label for="pasteCompany">Company (optional)</label>
            <input id="pasteCompany" type="text" placeholder="e.g., HASH"/>
          </div>
          <div class="field">
            <label for="pasteApplyUrl">Apply link (optional)</label>
            <input id="pasteApplyUrl" type="url" placeholder="https://..."/>
          </div>
        </div>

        <div class="twoCol">
          <div class="field">
            <label for="pasteLang">Language</label>
            <select id="pasteLang">
              <option value="auto" selected>Auto</option>
              <option value="en">English</option>
              <option value="de">Deutsch</option>
            </select>
          </div>
          <div class="field">
            <label>Quality</label>
            <div><span class="badge" id="pasteQualityBadge">—</span></div>
          </div>
        </div>

        <div class="field">
          <label for="pasteDesc">Job description</label>
          <textarea class="big" id="pasteDesc" placeholder="Paste the full job description here…"></textarea>
          <div class="tiny muted" id="pasteStats">0 chars · 0 words · 0 lines</div>
          <div class="tiny muted">Tip: include Responsibilities + Requirements + Tech stack. Don’t paste confidential info.</div>
        </div>
      </div>

      <hr class="hr"/>

      <div class="twoCol">
        <div class="field">
          <label for="templateSelect">Template</label>
          <select id="templateSelect">
            <option value="professional" selected>Professional (ATS-safe)</option>
          </select>
        </div>

        <div class="field">
          <label for="strengthSelect">Strength</label>
          <select id="strengthSelect">
            <option value="light">Light</option>
            <option value="balanced" selected>Balanced</option>
            <option value="strong">Strong</option>
          </select>
        </div>
      </div>

      <div class="inlineActions">
        <button class="btn primary" id="generateBtn" type="button" disabled>Generate tailored CV</button>
        <button class="btn" id="copyCvBtn" type="button" disabled>Copy tailored CV</button>
      </div>

      <div class="tiny muted" id="generateHint" style="margin-top:8px">
        Select a job or paste a description to enable generation.
      </div>
    </section>

    <!-- RIGHT: result -->
    <section class="card" aria-label="Tailored CV">
      <div class="statusLine">
        <div>
          <h2 style="margin:0">Tailored CV</h2>
          <div class="tiny muted" id="tailorSub">Ready when you are.</div>
        </div>
        <div class="statusLineRight">
          <span class="badge" id="tailorStatusBadge">Idle</span>
          <span class="chip"><span class="muted">Model:</span> <span class="mono" id="modelValue">—</span></span>
        </div>
      </div>

      <div class="metrics">
        <div class="metricCard">
          <div class="metricTitle">ATS match</div>
          <div class="metricValue" id="atsMatchPct">—</div>
          <div class="tiny muted">Calculated from keyword coverage (used vs missing).</div>
        </div>
        <div class="metricCard">
          <div class="metricTitle">Keywords used</div>
          <div class="metricValue" id="kwUsedCount">0</div>
          <div class="tiny muted">Found in your tailored CV.</div>
        </div>
        <div class="metricCard">
          <div class="metricTitle">Keywords missing</div>
          <div class="metricValue" id="kwMissingCount">0</div>
          <div class="tiny muted">Add (truthfully) where it fits.</div>
        </div>
      </div>

      <div style="margin-top:10px">
        <div class="tiny muted">Keywords</div>
        <div class="pillRow" id="kwLists">
          <div class="pillRow" id="kwUsedList"></div>
          <div class="pillRow" id="kwMissingList"></div>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="Result tabs">
        <button class="tabBtn active" id="tabPreviewBtn" type="button">Preview</button>
        <button class="tabBtn" id="tabTextBtn" type="button">Text</button>
        <button class="tabBtn" id="tabChangesBtn" type="button">Changes</button>
      </div>

      <div class="panel active" id="panelPreview">
        <div class="cvPreview" id="cvPreview">No tailored CV yet.</div>
      </div>

      <div class="panel" id="panelText">
        <div class="field">
          <label for="cvTextArea">Tailored CV (text)</label>
          <textarea class="big" id="cvTextArea" readonly></textarea>
          <div class="tiny muted">Tip: Use this tab to copy-paste into your application system.</div>
        </div>
      </div>

      <div class="panel" id="panelChanges">
        <div class="tiny muted">Warnings & notes</div>
        <div class="descBox" id="warningsBox">—</div>
      </div>
    </section>
  </div>
</main>

<!-- Scripts -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="./auth.js"></script>
<script src="./shared.js"></script>

<script>
/* CV Studio (ready-to-deploy)
   - Fixes: /me/cv/tailor_from_text now always sends Authorization Bearer token.
   - Uses same auth + api helpers as profile.html to avoid "401 Unauthorized" bugs.
*/
const S = (window.JobApplyAI && window.JobApplyAI.shared) ? window.JobApplyAI.shared : null;
if (S && S.wireNavTransitions) { try { S.wireNavTransitions(); } catch {} }

const API_BASE = (window.JobApplyAI && window.JobApplyAI.config && window.JobApplyAI.config.API_BASE)
  || (S && S.resolveApiBase ? S.resolveApiBase("https://jobmejob.schoene-viktor.workers.dev") : "https://jobmejob.schoene-viktor.workers.dev");

const SUPABASE_URL = "https://awlzvhcnjegfhjedswko.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF3bHp2aGNuamVnZmhqZWRzd2tvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2NTE2OTgsImV4cCI6MjA4MjIyNzY5OH0.-UmHiVi0_g9tKDkr6ldfROeBrOk8hm18YVPRfnb8luY";

let supabaseClient = null;
let session = null;

let jobs = [];
let selectedJobId = "";
let selectedJobDesc = "";
let selectedJobDescStatus = "";

let lastTailorResult = null; // { cv_text, model, keywords... }

const FETCH_TIMEOUT_MS = 45000;

function $(id){ return document.getElementById(id); }

function showTopError(msg){
  if (S && S.showTopError) return S.showTopError("errorTop", msg);
  const el = $("errorTop");
  if(!el) return;
  const m = String(msg || "").trim();
  el.style.display = m ? "block" : "none";
  el.textContent = m;
}

function clearTopError(){ showTopError(""); }

function setBadge(id, kind, text){
  if (S && S.setBadge) return S.setBadge(id, kind, text);
  const el = $(id);
  if(!el) return;
  el.className = "badge" + (kind ? (" " + kind) : "");
  el.textContent = String(text || "");
}

function toNetworkError(path, e){
  const msg = (e && e.message) ? String(e.message) : String(e||"");
  if(String(msg).toLowerCase().includes("failed to fetch") || String(msg).toLowerCase().includes("network")){
    return new Error(
      path + " failed: network error (Failed to fetch). " +
      "This is usually caused by CORS, a blocker/Private DNS blocking workers.dev, or a flaky connection."
    );
  }
  return new Error(path + " failed: " + msg);
}

async function fetchWithTimeout(url, options, timeoutMs){
  const ms = Number(timeoutMs) || FETCH_TIMEOUT_MS;
  if(typeof AbortController === "undefined"){
    return await fetch(url, options || {});
  }
  const ctrl = new AbortController();
  const t = setTimeout(()=>{ try{ ctrl.abort("timeout"); }catch{} }, ms);
  try{
    return await fetch(url, { ...(options||{}), signal: ctrl.signal });
  } finally {
    clearTimeout(t);
  }
}

function toErrorMessage(path, res, json, text){
  const detail = (json && (json.error || json.details || json.message))
    ? (json.error || json.details || json.message)
    : "";
  const body = String(detail || text || "").trim();
  const clipped = body ? body.slice(0, 380) : "";
  return path + " failed: " + res.status + (clipped ? (" — " + clipped) : "");
}

const TOKEN_REFRESH_SKEW_SEC = 90;

async function getSessionFresh(forceRefresh){
  if(!supabaseClient) throw new Error("Supabase not initialized");
  let s = null;

  try{
    const r = await supabaseClient.auth.getSession();
    s = r && r.data ? r.data.session : null;
  }catch{}

  if(!s) s = session;

  if(!s || !s.access_token) return null;

  // Refresh if token is close to expiry (or if forced)
  const now = Math.floor(Date.now()/1000);
  const exp = Number(s.expires_at || 0);
  const ttl = exp ? (exp - now) : 999999;

  if(forceRefresh || (exp && ttl < TOKEN_REFRESH_SKEW_SEC)){
    try{
      const rr = await supabaseClient.auth.refreshSession();
      if(rr && rr.data && rr.data.session) s = rr.data.session;
    }catch{}
  }

  session = s;
  try{ sessionStorage.setItem("sb_access_token", s.access_token); }catch{}
  return s;
}

async function authFetch(path, options){
  const url = API_BASE + path;
  const opt = options || {};
  const headers = new Headers(opt.headers || {});

  // Always fetch the latest token (and refresh if near expiry)
  let s = await getSessionFresh(false);
  if(!s || !s.access_token) throw new Error("Unauthorized: missing session. Please sign in again.");

  headers.set("Authorization", "Bearer " + s.access_token);

  let res;
  try{
    res = await fetchWithTimeout(url, { ...opt, headers }, FETCH_TIMEOUT_MS);
  }catch(e){
    throw toNetworkError(path, e);
  }

  if(res.status === 401){
    // Token might be expired/rotated. Refresh once and retry.
    const s2 = await getSessionFresh(true);
    if(s2 && s2.access_token){
      headers.set("Authorization", "Bearer " + s2.access_token);
      try{
        res = await fetchWithTimeout(url, { ...opt, headers }, FETCH_TIMEOUT_MS);
      }catch(e){
        throw toNetworkError(path, e);
      }
    }
  }

  return res;
}

async function apiGet(path){
  const res = await authFetch(path, { method: "GET", cache: "no-store" });
  const text = await res.text().catch(()=> "");
  let json = null;
  try{ json = JSON.parse(text); }catch{ json = { raw:text }; }
  if(!res.ok) throw new Error(toErrorMessage(path, res, json, text));
  return json;
}

async function apiPostJson(path, body){
  const res = await authFetch(path, {
    method: "POST",
    headers: { "content-type": "application/json" },
    body: JSON.stringify(body || {})
  });
  const text = await res.text().catch(()=> "");
  let json = null;
  try{ json = JSON.parse(text); }catch{ json = { raw:text }; }
  if(!res.ok) throw new Error(toErrorMessage(path, res, json, text));
  return json;
}

async function ensureCustomer(email){
  const res = await fetch(API_BASE + "/customers/upsert", {
    method: "POST",
    headers: {"content-type":"application/json"},
    body: JSON.stringify({ email })
  });
  const text = await res.text().catch(()=> "");
  if(!res.ok) throw new Error("customers/upsert failed: " + res.status + " " + text);
  return JSON.parse(text);
}

function setGenerateEnabled(enabled, hint){
  $("generateBtn").disabled = !enabled;
  $("generateHint").textContent = hint || (enabled ? "Ready to generate." : "Select a job or paste a description to enable generation.");
}

function setCopyEnabled(enabled){
  $("copyCvBtn").disabled = !enabled;
}

function switchSource(mode){
  // mode: "jobs" | "paste"
  const isJobs = mode === "jobs";
  $("tabJobs").classList.toggle("active", isJobs);
  $("tabPaste").classList.toggle("active", !isJobs);
  $("panelJobs").style.display = isJobs ? "block" : "none";
  $("panelPaste").style.display = !isJobs ? "block" : "none";
  lastTailorResult = null;
  setCopyEnabled(false);
  $("cvPreview").textContent = "No tailored CV yet.";
  $("cvTextArea").value = "";
  $("warningsBox").textContent = "—";
  $("modelValue").textContent = "—";
  $("atsMatchPct").textContent = "—";
  $("kwUsedCount").textContent = "0";
  $("kwMissingCount").textContent = "0";
  $("kwUsedList").innerHTML = "";
  $("kwMissingList").innerHTML = "";
  setBadge("tailorStatusBadge", "", "Idle");
  updateGenerateState();
}

function updatePasteStats(){
  const text = String($("pasteDesc").value || "");
  const chars = text.length;
  const words = text.trim() ? text.trim().split(/\s+/).filter(Boolean).length : 0;
  const lines = text.split(/\r\n|\r|\n/).length;
  $("pasteStats").textContent = `${chars} chars · ${words} words · ${lines} lines`;

  // Simple quality badge
  let kind = "";
  let label = "—";
  if(chars < 80){ kind = ""; label = "Too short"; }
  else if(chars < 800){ kind = "ok"; label = "Good"; }
  else { kind = "ok"; label = "Looks great"; }
  setBadge("pasteQualityBadge", kind, label);

  updateGenerateState();
}

function updateGenerateState(){
  const isJobs = $("panelJobs").style.display !== "none";
  if(isJobs){
    const ok = !!selectedJobId;
    setGenerateEnabled(ok, ok ? "Ready. We’ll tailor using the selected job." : "Pick a job to enable generation.");
    return;
  }
  const jd = String($("pasteDesc").value || "").trim();
  const ok = jd.length >= 80;
  setGenerateEnabled(ok, ok ? "Ready. We’ll tailor using your pasted job description." : "Paste at least 80 characters of job description.");
}

function setActiveTab(which){
  const map = {
    preview: ["tabPreviewBtn","panelPreview"],
    text: ["tabTextBtn","panelText"],
    changes: ["tabChangesBtn","panelChanges"],
  };
  for(const k of Object.keys(map)){
    const [btnId, panelId] = map[k];
    $(btnId).classList.toggle("active", k===which);
    $(panelId).classList.toggle("active", k===which);
  }
}

function renderKeywordChips(list, kind, containerId){
  const el = $(containerId);
  el.innerHTML = "";
  const arr = Array.isArray(list) ? list : [];
  for(const k of arr.slice(0, 50)){
    const kw = String(k||"").trim();
    if(!kw) continue;
    const chip = document.createElement("span");
    chip.className = "chip " + (kind || "");
    chip.textContent = kw;
    el.appendChild(chip);
  }
}

function computeAtsMatch(used, missing){
  const u = Array.isArray(used) ? used.length : 0;
  const m = Array.isArray(missing) ? missing.length : 0;
  const denom = u + m;
  if(!denom) return null;
  return Math.round((u / denom) * 100);
}

async function loadJobs(){
  $("jobSelect").innerHTML = "<option value=''>Loading…</option>";
  const data = await apiGet("/me/jobs/queue");
  jobs = Array.isArray(data?.data) ? data.data : [];
  if(!jobs.length){
    $("jobSelect").innerHTML = "<option value=''>No jobs found</option>";
    $("jobMetaLine").textContent = "Add a job first in Jobs → then come back here.";
    selectedJobId = "";
    selectedJobDesc = "";
    $("viewDescBtn").disabled = true;
    $("copyDescBtn").disabled = true;
    updateGenerateState();
    return;
  }
  const opts = ["<option value=''>Select a job…</option>"];
  for(const j of jobs){
    const title = String(j.title || "Untitled");
    const co = String(j.company_name || "");
    const loc = [j.city, j.region, j.country].filter(Boolean).join(", ");
    const label = (co ? (title + " · " + co) : title) + (loc ? (" — " + loc) : "");
    opts.push(`<option value="${j.id}">${escapeHtml(label)}</option>`);
  }
  $("jobSelect").innerHTML = opts.join("");
  $("jobMetaLine").textContent = "Choose a saved job from your queue.";
  updateGenerateState();
}

function escapeHtml(s){
  const v = String(s ?? "");
  return v.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
}

async function loadJobDescription(jobId){
  selectedJobDesc = "";
  selectedJobDescStatus = "";
  $("descBox").style.display = "none";
  $("descBox").textContent = "";
  $("descStatus").textContent = "Loading…";
  $("viewDescBtn").disabled = true;
  $("copyDescBtn").disabled = true;

  if(!jobId){
    $("descStatus").textContent = "—";
    return;
  }

  try{
    const resp = await apiGet("/me/jobs/description?job_id=" + encodeURIComponent(jobId));
    const job = resp?.job || {};
    const text = String(job.description_full || "").trim();
    const status = String(resp?.status || "unknown");
    selectedJobDescStatus = status;
    $("descStatus").textContent = status + (resp?.from_cache ? " (cached)" : "");
    if(text){
      selectedJobDesc = text;
      $("viewDescBtn").disabled = false;
      $("copyDescBtn").disabled = false;
    }else{
      selectedJobDesc = "";
      $("viewDescBtn").disabled = false; // allow "view" to show info
      $("copyDescBtn").disabled = true;
    }

    // Show a small preview box automatically (first 900 chars)
    const prev = text ? (text.slice(0, 900) + (text.length > 900 ? "\n\n…(clipped)" : "")) : "(No full description available yet. You can still tailor, but results will be weaker.)";
    $("descBox").textContent = prev;
    $("descBox").style.display = "block";
  }catch(e){
    $("descStatus").textContent = "error";
    $("descBox").textContent = "Failed to load description: " + (e && e.message ? e.message : String(e));
    $("descBox").style.display = "block";
    $("viewDescBtn").disabled = false;
    $("copyDescBtn").disabled = true;
  }
}

async function copyToClipboard(text){
  const t = String(text || "");
  if(!t) return;
  try{
    if(noneEmpty(navigator.clipboard) && typeof navigator.clipboard.writeText === "function"){
      await navigator.clipboard.writeText(t);
      return true;
    }
  }catch(_){}
  // fallback
  const ta = document.createElement("textarea");
  ta.value = t;
  ta.style.position = "fixed";
  ta.style.left = "-9999px";
  document.body.appendChild(ta);
  ta.select();
  try{ document.execCommand("copy"); }catch(_){}
  document.body.removeChild(ta);
  return true;
}
function noneEmpty(v){ return v !== null && v !== undefined; }

function normalizeStrength(v){
  const s = String(v || "balanced").toLowerCase().trim();
  if(s === "light" || s === "balanced" || s === "strong") return s;
  return "balanced";
}

async function handleGenerate(){
  clearTopError();
  setBadge("tailorStatusBadge", "warn", "Working…");
  $("tailorSub").textContent = "Generating… (this can take ~10–30s depending on model availability)";
  $("generateBtn").disabled = true;
  setCopyEnabled(false);

  const template = String($("templateSelect").value || "professional");
  const strength = normalizeStrength($("strengthSelect").value);

  const isJobs = $("panelJobs").style.display !== "none";

  try{
    let resp;
    if(isJobs){
      if(!selectedJobId) throw new Error("Please select a job first.");
      resp = await apiPostJson("/me/cv/tailor", {
        job_id: selectedJobId,
        template,
        strength,
        language_hint: "auto",
        force: true
      });
    } else {
      const jd = String($("pasteDesc").value || "").trim();
      if(jd.length < 80) throw new Error("job_description must be at least 80 characters.");
      resp = await apiPostJson("/me/cv/tailor_from_text", {
        job_title: String($("pasteJobTitle").value || "").trim(),
        company_name: String($("pasteCompany").value || "").trim(),
        apply_url: String($("pasteApplyUrl").value || "").trim(),
        job_description: jd,
        language_hint: String($("pasteLang").value || "auto"),
        template,
        strength
      });
    }

    const result = resp && resp.result ? resp.result : null;
    if(!result || !result.cv_text){
      throw new Error("No CV text returned.");
    }

    lastTailorResult = result;

    // UI updates
    setBadge("tailorStatusBadge", "ok", "Done");
    $("tailorSub").textContent = "Generated successfully.";

    $("modelValue").textContent = result.model || "—";

    const used = Array.isArray(result.ats_keywords_used) ? result.ats_keywords_used : [];
    const missing = Array.isArray(result.ats_keywords_missing) ? result.ats_keywords_missing : [];

    $("kwUsedCount").textContent = String(used.length);
    $("kwMissingCount").textContent = String(missing.length);

    const pct = computeAtsMatch(used, missing);
    $("atsMatchPct").textContent = (pct === null) ? "—" : (pct + "%");

    renderKeywordChips(used, "used", "kwUsedList");
    renderKeywordChips(missing, "missing", "kwMissingList");

    const warnings = Array.isArray(result.warnings) ? result.warnings : [];
    $("warningsBox").textContent = warnings.length ? warnings.join("\n• ") : "—";

    $("cvPreview").textContent = result.cv_text;
    $("cvTextArea").value = result.cv_text;

    setCopyEnabled(true);
    setActiveTab("preview");

  }catch(e){
    setBadge("tailorStatusBadge", "bad", "Failed");
    $("tailorSub").textContent = "Failed to generate. Check your CV upload and job description availability.";
    showTopError(e && e.message ? e.message : String(e));
  } finally {
    updateGenerateState();
  }
}

async function boot(){
  try{
    setBadge("authBadge","warn","Checking…");
    supabaseClient = (window.JobApplyAI && window.JobApplyAI.auth && window.JobApplyAI.auth.supabaseClient)
      ? window.JobApplyAI.auth.supabaseClient
      : window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);


    // Keep "session" up to date when Supabase refreshes the token in the background
    try{
      supabaseClient.auth.onAuthStateChange((_event, newSession)=>{
        if(newSession && newSession.access_token){
          session = newSession;
          try{ sessionStorage.setItem("sb_access_token", newSession.access_token); }catch{}
        } else {
          session = null;
          try{ sessionStorage.removeItem("sb_access_token"); }catch{}
        }
      });
    }catch{}

    session = (window.JobApplyAI && window.JobApplyAI.auth && typeof window.JobApplyAI.auth.getSession === "function")
      ? await window.JobApplyAI.auth.getSession()
      : null;

    if(!session){
      const s = await supabaseClient.auth.getSession();
      session = s && s.data ? s.data.session : null;
    }
        // Ensure we have a fresh access token (prevents "invalid or expired token" without requiring a page refresh)
    try{ session = (await getSessionFresh(false)) || session; }catch{}

if(!session || !session.user || !session.user.email){
      window.location.replace("./signup.html");
      return;
    }

    try{ sessionStorage.setItem("sb_access_token", session.access_token); }catch{}

    setBadge("authBadge","ok","Signed in");
    clearTopError();

    await ensureCustomer(String(session.user.email||"").trim().toLowerCase());

    // Events
    $("btnLogout").addEventListener("click", async ()=>{
      try{
        await supabaseClient.auth.signOut();
        try{ sessionStorage.removeItem("sb_access_token"); }catch{}
        window.location.replace("./index.html");
      }catch(e){
        showTopError(e && e.message ? e.message : String(e));
      }
    });

    $("tabJobs").addEventListener("click", ()=>switchSource("jobs"));
    $("tabPaste").addEventListener("click", ()=>switchSource("paste"));

    $("jobSelect").addEventListener("change", async ()=>{
      selectedJobId = String($("jobSelect").value || "");
      updateGenerateState();
      await loadJobDescription(selectedJobId);
    });

    $("openJobsBtn").addEventListener("click", ()=>{ window.location.href = "./jobs.html"; });

    $("viewDescBtn").addEventListener("click", ()=>{
      const text = selectedJobDesc ? selectedJobDesc : $("descBox").textContent;
      alert(text || "(No description available.)");
    });

    $("copyDescBtn").addEventListener("click", async ()=>{
      const ok = await copyToClipboard(selectedJobDesc || "");
      if(ok) setBadge("tailorStatusBadge","ok","Copied");
      setTimeout(()=>{ if(!lastTailorResult) setBadge("tailorStatusBadge","", "Idle"); }, 900);
    });

    $("pasteDesc").addEventListener("input", updatePasteStats);
    $("pasteJobTitle").addEventListener("input", updateGenerateState);
    $("pasteLang").addEventListener("change", updateGenerateState);
    $("strengthSelect").addEventListener("change", updateGenerateState);
    $("templateSelect").addEventListener("change", updateGenerateState);

    $("generateBtn").addEventListener("click", handleGenerate);
    $("copyCvBtn").addEventListener("click", async ()=>{
      const txt = lastTailorResult && lastTailorResult.cv_text ? lastTailorResult.cv_text : "";
      if(!txt) return;
      await copyToClipboard(txt);
      setBadge("tailorStatusBadge","ok","Copied");
      setTimeout(()=>{ setBadge("tailorStatusBadge","ok","Done"); }, 900);
    });

    $("tabPreviewBtn").addEventListener("click", ()=>setActiveTab("preview"));
    $("tabTextBtn").addEventListener("click", ()=>setActiveTab("text"));
    $("tabChangesBtn").addEventListener("click", ()=>setActiveTab("changes"));

    // Initial load
    await loadJobs();
    await loadJobDescription(""); // clear

    updatePasteStats();
    updateGenerateState();

  }catch(e){
    setBadge("authBadge","bad","Error");
    showTopError(e && e.message ? e.message : String(e));
  }
}

window.addEventListener("load", boot);
</script>
</body>
</html>
