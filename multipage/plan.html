<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>jobmejob • Plan</title>
  <meta name="description" content="Choose a plan for your daily application quota."/>

  <!-- Shared styles -->
  <link rel="stylesheet" href="./shared.css" />

  <style>
    /* Page-specific layout only */
    .sectionHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }
    .small{font-size:12px;color:var(--muted2);font-weight:650;line-height:1.45}

    .pricingWrap{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:14px;
      margin-top:14px;
      align-items:stretch;
    }
    @media (max-width:980px){
      .pricingWrap{grid-template-columns:1fr}
    }

    .planCard{
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow:0 12px 34px rgba(17,19,24,.10);
      position:relative;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:360px;
    }
    .planCard.selected{
      outline:3px solid rgba(34,197,94,.22);
      border-color:rgba(34,197,94,.35);
    }
    .planCard.featured{
      border-color:rgba(34,197,94,.30);
      box-shadow:0 18px 48px rgba(34,197,94,.16);
      transform:translateY(-2px);
    }
    @media (max-width:980px){
      .planCard.featured{transform:none}
    }

    .ribbon{
      position:absolute;
      top:14px;
      right:14px;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(34,197,94,.14);
      border:1px solid rgba(34,197,94,.28);
      color:#0a3d1f;
      font-weight:950;
      font-size:12px;
      white-space:nowrap;
    }

    .priceRow{
      display:flex;
      align-items:flex-end;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .priceRow strong{
      font-size:36px;
      line-height:1;
      letter-spacing:-.9px;
      font-weight:980;
    }
    .priceRow span{
      font-size:13px;
      color:var(--muted2);
      font-weight:850;
      padding-bottom:5px;
    }
    .strike{
      font-size:13px;
      color:var(--muted2);
      text-decoration:line-through;
      font-weight:900;
    }
    .save{
      display:inline-flex;
      align-items:center;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(17,19,24,.05);
      border:1px solid rgba(17,19,24,.10);
      color:rgba(17,19,24,.78);
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
    }

    .valueRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px;
      border-radius:18px;
      background:rgba(17,19,24,.03);
      border:1px solid rgba(17,19,24,.10);
      margin-top:12px;
    }
    .valueRow strong{font-weight:950;color:rgba(17,19,24,.90);font-size:13px}
    .valueRow span{color:var(--muted);font-size:13px;font-weight:800}
    .valueBadge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background:rgba(34,197,94,.14);
      border:1px solid rgba(34,197,94,.28);
      color:#0a3d1f;
      font-weight:950;
      font-size:12px;
      white-space:nowrap;
      text-transform:uppercase;
      letter-spacing:.02em;
    }

    .features{
      list-style:none;
      padding:0;
      margin:12px 0 0 0;
      display:grid;
      gap:10px;
    }
    .features li{
      display:flex;
      gap:10px;
      align-items:flex-start;
      color:var(--muted);
      font-size:14px;
      font-weight:700;
      line-height:1.35;
    }
    .tick{
      width:18px;height:18px;border-radius:8px;
      border:1px solid rgba(17,19,24,.14);
      background:rgba(17,19,24,.04);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
      margin-top:1px;
    }
    .tick svg{width:14px;height:14px}
    .planActions{margin-top:auto;padding-top:14px}
    .planActions .btn{width:100%;justify-content:center}
    .fineprint{
      margin:12px 0 0 0;
      color:var(--muted2);
      font-size:12px;
      font-weight:650;
      line-height:1.45;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <nav class="nav">
      <a class="brand" href="./index.html" data-nav="1" aria-label="Home">
        <span class="logo" aria-hidden="true"></span>
        <span>jobmejob</span>
      </a>

      <div class="navlinks">
        <a class="pill" href="./index.html" data-nav="1">Home</a>
        <a class="pill" href="./profile.html" data-nav="1">Profile</a>
        <a class="pill active" href="./plan.html" data-nav="1">Plan</a>
        <a class="pill" href="./jobs.html" data-nav="1">Jobs</a>
        <a class="pill" href="./dashboard.html" data-nav="1">Dashboard</a>
        <a class="pill" href="./signup.html" id="navSignIn" data-nav="1">Sign in</a>
        <button class="pill" id="navLogout" type="button" style="display:none;">Logout</button>
      </div>
    </nav>
  </header>

  <main class="main">
    <h1 class="h1">Choose a plan</h1>
    <p class="sub" id="subLine">Loading…</p>
    <div class="errorTop" id="errorTop"></div>

    <section class="card">
      <div class="sectionHead">
        <div>
          <div class="badge prio" id="currentPlanBadge">Current plan: —</div>
          <div class="small" style="margin-top:8px">
            Plans map to your daily application output. You can change plans anytime.
          </div>
        </div>
        <div class="badge warn" id="authBadge">Checking…</div>
      </div>

      <div class="pricingWrap" style="margin-top:14px">
        <!-- Starter -->
        <div class="planCard" id="cardStarter">
          <h3 style="margin:0 0 6px;font-weight:980;letter-spacing:-.2px">Starter</h3>
          <p style="margin:0;color:var(--muted);font-size:14px;font-weight:700">For steady progress.</p>

          <div class="priceRow">
            <div class="strike">$29</div>
            <strong>$20</strong>
            <span>/ month</span>
            <span class="save">Save 31%</span>
          </div>

          <div class="valueRow" aria-label="Monthly value">
            <div>
              <strong>1 application / day</strong>
              <span>≈ 30 per month</span>
            </div>
            <div class="valueBadge" id="badgeStarter">starter</div>
          </div>

          <ul class="features">
            <li><span class="tick" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none"><path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>Manual email application</li>
            <li><span class="tick" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none"><path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>Basic application log</li>
            <li><span class="tick" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none"><path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>CV upload + OCR</li>
          </ul>

          <div class="planActions">
            <button class="btn primary" id="btnStarter" type="button">Select Starter</button>
          </div>
        </div>

        <!-- Growth / Pro -->
        <div class="planCard featured" id="cardPro" aria-label="Best value plan">
          <div class="ribbon">Best value</div>
          <h3 style="margin:0 0 6px;font-weight:980;letter-spacing:-.2px">Growth</h3>
          <p style="margin:0;color:var(--muted);font-size:14px;font-weight:700">For active searches.</p>

          <div class="priceRow">
            <div class="strike">$69</div>
            <strong>$45</strong>
            <span>/ month</span>
            <span class="save">Save 35%</span>
          </div>

          <div class="valueRow" aria-label="Monthly value">
            <div>
              <strong>5 applications / day</strong>
              <span>≈ 150 per month</span>
            </div>
            <div class="valueBadge" id="badgePro">pro</div>
          </div>

          <ul class="features">
            <li><span class="tick" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none"><path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>Priority turnaround</li>
            <li><span class="tick" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none"><path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>Better tracking view</li>
            <li><span class="tick" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none"><path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>CV tailoring (ATS-safe)</li>
          </ul>

          <div class="planActions">
            <button class="btn primary" id="btnPro" type="button">Select Growth</button>
          </div>
        </div>

        <!-- Max -->
        <div class="planCard" id="cardMax">
          <h3 style="margin:0 0 6px;font-weight:980;letter-spacing:-.2px">Max</h3>
          <p style="margin:0;color:var(--muted);font-size:14px;font-weight:700">For high volume.</p>

          <div class="priceRow">
            <div class="strike">$119</div>
            <strong>$79</strong>
            <span>/ month</span>
            <span class="save">Save 34%</span>
          </div>

          <div class="valueRow" aria-label="Monthly value">
            <div>
              <strong>10 applications / day</strong>
              <span>≈ 300 per month</span>
            </div>
            <div class="valueBadge" id="badgeMax">max</div>
          </div>

          <ul class="features">
            <li><span class="tick" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none"><path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>Fastest turnaround</li>
            <li><span class="tick" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none"><path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>Full activity log</li>
            <li><span class="tick" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none"><path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>Max coverage</li>
          </ul>

          <div class="planActions">
            <button class="btn primary" id="btnMax" type="button">Select Max</button>
          </div>
        </div>
      </div>

      <div class="fineprint">
        Note: “Auto-apply” is the paid feature that uses your plan quota. Job search + CV tailoring remain free.
      </div>
    </section>
  </main>

  <!-- Scripts: order matters -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./auth.js"></script>
  <script src="./shared.js"></script>

  <script>
  (() => {
    "use strict";

    const S = window.JobMeJobShared || null;
    if (S && S.wireNavTransitions) S.wireNavTransitions();

    const $ = (id) => document.getElementById(id);

    let session = null;
    let state = null;

    function showError(msg){
      if (S && S.showTopError) return S.showTopError("errorTop", msg);
      const el = $("errorTop");
      if(!el) return;
      if(!msg){ el.style.display="none"; el.textContent=""; return; }
      el.style.display="block";
      el.textContent = String(msg);
    }

    function setBadge(id, cls, txt){
      if (S && S.setBadge) return S.setBadge(id, cls, txt);
      const el = $(id);
      if(!el) return;
      el.className = "badge" + (cls ? (" " + cls) : "");
      el.textContent = String(txt ?? "");
    }

    function setText(id, txt){
      const el = $(id);
      if(el) el.textContent = String(txt ?? "");
    }

    function apiBase(){
      return (S && S.resolveApiBase)
        ? S.resolveApiBase("https://jobmejob.schoene-viktor.workers.dev")
        : "https://jobmejob.schoene-viktor.workers.dev";
    }

    async function apiGet(path){
      const base = apiBase().replace(/\/+$/,"");
      const res = await fetch(base + path, {
        method:"GET",
        headers:{ Authorization: "Bearer " + session.access_token }
      });
      const txt = await res.text().catch(()=> "");
      let json = null;
      try{ json = txt ? JSON.parse(txt) : null; }catch{ json = { raw: txt }; }
      if(!res.ok){
        throw new Error(path + " failed: " + res.status + " " + (json?.error || json?.details || txt));
      }
      return json;
    }

    async function apiPostJson(path, body){
      const base = apiBase().replace(/\/+$/,"");
      const res = await fetch(base + path, {
        method:"POST",
        headers:{
          Authorization: "Bearer " + session.access_token,
          "content-type":"application/json"
        },
        body: JSON.stringify(body || {})
      });
      const txt = await res.text().catch(()=> "");
      let json = null;
      try{ json = txt ? JSON.parse(txt) : null; }catch{ json = { raw: txt }; }
      if(!res.ok){
        throw new Error(path + " failed: " + res.status + " " + (json?.error || json?.details || txt));
      }
      return json;
    }

    function applySelectionUI(planId){
      const pid = String(planId || "").toLowerCase();
      const map = { starter: "Starter (1/day)", pro:"Growth (5/day)", max:"Max (10/day)" };

      $("cardStarter")?.classList.toggle("selected", pid==="starter");
      $("cardPro")?.classList.toggle("selected", pid==="pro");
      $("cardMax")?.classList.toggle("selected", pid==="max");

      setText("currentPlanBadge", "Current plan: " + (map[pid] || "—"));
    }

    async function refreshState(){
      // Prefer the shared auth helper if it exists (keeps behavior consistent across pages)
      try{
        if (window.JobApplyAI?.auth?.syncStateToLocalStorage) {
          const st = await window.JobApplyAI.auth.syncStateToLocalStorage(session);
          if(st){
            state = st;
            applySelectionUI(st.plan_id || "");
            return;
          }
        }
      }catch(_){}

      state = await apiGet("/me/state");
      applySelectionUI(state?.plan_id || "");
    }

    function setButtonsEnabled(enabled){
      ["btnStarter","btnPro","btnMax"].forEach(id => {
        const b = $(id);
        if(b) b.disabled = !enabled;
      });
    }

    async function selectPlan(planId){
      showError("");
      setBadge("authBadge","warn","Saving…");
      setButtonsEnabled(false);

      try{
        const pid = String(planId || "").toLowerCase();
        await apiPostJson("/me/plan", { plan_id: pid });

        // Set local fallback so other pages can show plan even if state calls are delayed.
        try{
          localStorage.setItem("jm_plan", pid);
          localStorage.setItem("ja_plan", pid);
        }catch(_){}

        await refreshState();
        setBadge("authBadge","good","Saved");

        const profOk = !!(state && state.profile_complete);
        if(S && S.go) S.go(profOk ? "./dashboard.html" : "./profile.html");
        else window.location.href = profOk ? "./dashboard.html" : "./profile.html";
      }catch(e){
        showError(e?.message || String(e));
        setBadge("authBadge","bad","Failed");
      }finally{
        setButtonsEnabled(true);
      }
    }

    async function boot(){
      showError("");
      setBadge("authBadge","warn","Checking…");
      setText("subLine","Checking session…");

      // Require auth.js
      if(!window.JobApplyAI || !window.JobApplyAI.auth || typeof window.JobApplyAI.auth.getSession !== "function"){
        setBadge("authBadge","bad","Config error");
        showError("auth.js did not load. Ensure multipage/auth.js exists and is referenced as ./auth.js.");
        return;
      }

      session = await window.JobApplyAI.auth.getSession();
      if(!session || !session.user || !session.user.email){
        if(S && S.go) return S.go("./signup.html");
        window.location.href = "./signup.html";
        return;
      }

      // Nav sign in/out
      $("navLogout") && ($("navLogout").style.display = "");
      $("navSignIn") && ($("navSignIn").style.display = "none");

      setText("subLine","Signed in as " + String(session.user.email));
      setBadge("authBadge","good","Signed in");

      // Ensure customer exists (best effort)
      try{
        if (typeof window.JobApplyAI.auth.requireAuthAndCustomer === "function"){
          await window.JobApplyAI.auth.requireAuthAndCustomer({ redirectTo: "./signup.html" });
        }
      }catch(e){
        // Don't block plan UI completely; just show the warning and continue.
        console.warn("requireAuthAndCustomer failed", e);
      }

      await refreshState();

      $("btnStarter")?.addEventListener("click", () => selectPlan("starter"));
      $("btnPro")?.addEventListener("click", () => selectPlan("pro"));
      $("btnMax")?.addEventListener("click", () => selectPlan("max"));
    }

    $("navLogout")?.addEventListener("click", async () => {
      try{
        if(window.JobApplyAI?.auth?.logout){
          await window.JobApplyAI.auth.logout("./index.html");
          return;
        }
      }catch(_){}
      try{
        if(window.supabaseClient?.auth) await window.supabaseClient.auth.signOut();
      }catch(_){}
      window.location.href = "./index.html";
    });

    window.addEventListener("load", () => {
      boot().catch((e)=>{
        showError(e?.message || String(e));
        setBadge("authBadge","bad","Error");
      });
    });
  })();
  </script>
</body>
</html>
