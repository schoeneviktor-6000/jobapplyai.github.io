<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>jobmejob • Jobs</title>
  <meta name="description" content="Fetch jobs into your queue and tailor your CV per role." />

  <link rel="stylesheet" href="./shared.css" />

  <style>
    /* Jobs page: keep it calm + focused */
    .topRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .small{
      font-size:12px;
      color:var(--muted2);
      font-weight:650;
      line-height:1.45;
    }

    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    .filterRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:12px;
    }
    .filterRow input{
      flex:1 1 260px;
      min-width:220px;
    }

    .jobList{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:12px;
    }
    .jobCard{
      border:1px solid rgba(17,19,24,.12);
      background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.82));
      border-radius:18px;
      padding:14px;
      box-shadow:0 12px 34px rgba(17,19,24,.08);
    }
    .jobTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .jobTitle{
      font-weight:950;
      line-height:1.2;
      font-size:15px;
      min-width:0;
    }
    .jobTitle a{
      color:inherit;
      text-decoration:underline;
      text-decoration-color:rgba(17,19,24,.22);
      text-underline-offset:3px;
    }
    .jobBadges{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      flex:0 0 auto;
    }
    .jobMeta{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      color:var(--muted2);
      font-size:12px;
      font-weight:750;
    }
    .jobActions{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .jobActions .btn{
      flex:1 1 auto;
      justify-content:center;
    }

    @media (max-width:620px){
      .jobActions{flex-direction:column; align-items:stretch;}
      .jobActions .btn{width:100%;}
    }
  </style>
</head>

<body>
  <!-- NAV (same structure as cv.html) -->
  <header class="topbar">
    <nav class="nav">
      <a class="brand" href="./index.html" data-nav="1" aria-label="Home">
        <span class="logo" aria-hidden="true"></span>
        <span>jobmejob</span>
      </a>

      <div class="navlinks">
        <a class="pill" href="./index.html" data-nav="1">Home</a>
        <a class="pill" href="./cv.html" data-nav="1">CV Studio</a>
        <a class="pill active" href="./jobs.html" data-nav="1">Jobs</a>
        <a class="pill" href="./plan.html" data-nav="1">Plan</a>

        <details class="navDrop" id="navAccount" style="display:none">
          <summary class="pill" aria-label="Account menu">
            <span id="navAccountLabel">Account</span>
            <span aria-hidden="true">▾</span>
          </summary>

          <div class="navMenu" role="menu" aria-label="Account menu">
            <div class="menuLabel">Account</div>
            <a class="pill" href="./profile.html" data-nav="1" role="menuitem">Profile setup</a>
            <button class="btn ghost" id="navActivity" type="button" role="menuitem">Activity log</button>

            <div class="menuSep" role="separator"></div>
            <div class="menuLabel">More</div>
            <span class="pill menuDisabled" role="menuitem" aria-disabled="true">Auto-apply (coming soon)</span>

            <div class="menuSep" role="separator"></div>
            <button class="btn danger" id="navLogout" type="button" role="menuitem">Logout</button>
          </div>
        </details>

        <a class="pill" href="./signup.html" id="navSignIn" data-nav="1">Sign in</a>
      </div>
    </nav>
  </header>

  <main class="main">
    <h1 class="h1">Jobs</h1>
    <p class="sub">Fetch jobs into your queue → then tailor your CV in CV Studio.</p>

    <div class="errorTop" id="errorTop"></div>

    <section class="card">
      <div class="topRow">
        <div>
          <div class="badge warn" id="authBadge">Checking…</div>
          <div class="small" id="authHint" style="margin-top:8px">Loading your session…</div>
        </div>

        <div class="toolbar">
          <button class="btn primary" id="btnFetch" type="button" disabled>Fetch new jobs</button>
          <button class="btn ghost" id="btnRefresh" type="button" disabled>Refresh queue</button>
          <a class="btn" href="./cv.html" data-nav="1">Open CV Studio</a>
        </div>
      </div>

      <div class="hr"></div>

      <div class="topRow">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <div class="badge" id="queueBadge">Queue: —</div>
          <div class="badge" id="fetchMeta">Last fetch: —</div>
        </div>
        <div class="small" id="fetchStatus"></div>
      </div>

      <div class="filterRow">
        <input id="filterInput" type="text" placeholder="Filter by title or company…" />
        <select id="sortSelect">
          <option value="newest">Sort: newest first</option>
          <option value="oldest">Sort: oldest first</option>
          <option value="company">Sort: company</option>
          <option value="title">Sort: title</option>
        </select>
      </div>

      <div class="jobList" id="queueWrap" aria-label="Job queue">
        <span class="badge warn">Loading…</span>
      </div>
    </section>
  </main>

  <!-- ========= Activity Log Modal (from dropdown) ========= -->
  <div class="modalBackdrop" id="activityModal" style="display:none">
    <div class="modalCard" style="max-width:980px">
      <div class="modalScroll">
        <div class="modalHeader">
          <h3 class="modalTitle">Activity log</h3>
          <button class="btn ghost small" id="activityCloseX" type="button">Close</button>
        </div>

        <div class="small" style="margin-top:6px">
          This log is loaded on demand. Use filters if you have a lot of events.
        </div>

        <div class="errorTop" id="activityError" style="margin-top:12px;"></div>

        <div class="actions" style="margin-top:10px">
          <select id="activityFilter" style="min-width:220px">
            <option value="all">All</option>
            <option value="applied">Applied</option>
            <option value="sent">Sent</option>
            <option value="replied">Replied</option>
            <option value="rejected">Rejected</option>
            <option value="skipped">Skipped</option>
            <option value="prioritized">Prioritized</option>
          </select>
          <button class="btn" id="activityRefresh" type="button">Refresh</button>
        </div>

        <div class="hr"></div>
        <div id="activityWrap" class="modalMonoBox">Loading…</div>
      </div>

      <div class="modalActions">
        <button class="btn" id="activityClose" type="button">Close</button>
      </div>
    </div>
  </div>

  <!-- ========= Skip Modal ========= -->
  <div class="modalBackdrop" id="skipModal" style="display:none">
    <div class="modalCard" style="max-width:720px">
      <div class="modalScroll">
        <div class="modalHeader">
          <h3 class="modalTitle">Skip this job</h3>
          <button class="btn ghost small" id="skipCloseX" type="button">Close</button>
        </div>

        <div class="field" style="margin-top:12px">
          <label for="skipReason">Reason</label>
          <select id="skipReason">
            <option value="not_relevant">Not relevant</option>
            <option value="too_far">Too far</option>
            <option value="wrong_industry">Wrong industry</option>
            <option value="salary_too_low">Salary too low</option>
            <option value="already_applied">Already applied</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="field">
          <label for="skipNote">Note</label>
          <textarea id="skipNote" placeholder="Optional note…"></textarea>
        </div>
      </div>

      <div class="modalActions">
        <button class="btn ghost" id="skipCancel" type="button">Cancel</button>
        <button class="btn danger" id="skipConfirm" type="button">Skip</button>
      </div>
    </div>
  </div>

  <!-- ========= Description Modal ========= -->
  <div class="modalBackdrop" id="descModal" style="display:none">
    <div class="modalCard" style="max-width:980px">
      <div class="modalScroll">
        <div class="modalHeader">
          <h3 class="modalTitle" id="descTitle">Job description</h3>
          <button class="btn ghost small" id="descCloseX" type="button">Close</button>
        </div>

        <div class="small" id="descMeta" style="margin-top:6px"></div>
        <div class="hr"></div>
        <div id="descBody" class="modalMonoBox">Loading…</div>
      </div>

      <div class="modalActions">
        <button class="btn ghost" id="descClose" type="button">Close</button>
        <button class="btn" id="descCopy" type="button">Copy</button>
      </div>
    </div>
  </div>

  <!-- Scripts (order matters) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./auth.js"></script>
  <script src="./shared.js"></script>

  <script>
  (() => {
    "use strict";

    const S = window.JobMeJobShared || null;

    // Safe fallbacks (so one missing helper doesn't break the whole page)
    const F = {
      escapeHtml: (s) => String(s ?? "").replace(/[&<>"']/g, (c) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])),
      showModal: (id) => { const el = document.getElementById(id); if(el) { el.style.display="flex"; document.body.classList.add("modalOpen"); } },
      hideModal: (id) => { const el = document.getElementById(id); if(el) { el.style.display="none"; document.body.classList.remove("modalOpen"); } },
      showTopError: (id, msg) => { const el = document.getElementById(id); if(el){ el.textContent = msg||""; el.style.display = msg ? "" : "none"; } },
      setBadge: (id, cls, txt) => { const el = document.getElementById(id); if(!el) return; el.className = "badge" + (cls ? (" " + cls) : ""); el.textContent = txt ?? ""; },
      resolveApiBase: (x) => String(x || "").trim(),
      wireNavTransitions: () => {}
    };

    const H = {
      escapeHtml: S?.escapeHtml ? S.escapeHtml : F.escapeHtml,
      showModal: S?.showModal ? S.showModal : F.showModal,
      hideModal: S?.hideModal ? S.hideModal : F.hideModal,
      showTopError: S?.showTopError ? S.showTopError : F.showTopError,
      setBadge: S?.setBadge ? S.setBadge : F.setBadge,
      resolveApiBase: S?.resolveApiBase ? S.resolveApiBase : F.resolveApiBase,
      wireNavTransitions: S?.wireNavTransitions ? S.wireNavTransitions.bind(S) : F.wireNavTransitions
    };

    H.wireNavTransitions();

    const $ = (id) => document.getElementById(id);

    const API_BASE = H.resolveApiBase("https://jobmejob.schoene-viktor.workers.dev").replace(/\/+$/, "");
    const FETCH_COOLDOWN_MS = 10 * 60 * 1000;

    let session = null;
    let queueJobs = [];
    let pendingSkipJobId = null;
    let pendingDescJobId = null;
    let currentDescText = "";

    function showError(msg){ H.showTopError("errorTop", msg || ""); }

    function setText(id, txt){
      const el = $(id);
      if(el) el.textContent = (txt === undefined || txt === null) ? "" : String(txt);
    }

    function applyUrlSafe(url){
      const u = String(url || "").trim();
      if (!u) return "";
      if (/^https?:\/\//i.test(u)) return u;
      return "https://" + u.replace(/^\/+/, "");
    }

    function formatLoc(j){
      const parts = [];
      if (j?.city) parts.push(j.city);
      if (j?.region && j.region !== j.city) parts.push(j.region);
      if (j?.country) parts.push(j.country);
      return parts.filter(Boolean).join(", ");
    }

    function getNextFetchAllowedAt(){
      const v = Number(localStorage.getItem("jm_last_manual_fetch_ts") || "0");
      return v ? (v + FETCH_COOLDOWN_MS) : 0;
    }

    function updateFetchMetaUI(){
      const lastTs = Number(localStorage.getItem("jm_last_manual_fetch_ts") || "0");
      if(!lastTs){
        H.setBadge("fetchMeta","", "Last fetch: —");
        return;
      }
      const last = new Date(lastTs).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      const next = lastTs + FETCH_COOLDOWN_MS;
      const now = Date.now();
      if(now < next){
        const sec = Math.ceil((next-now)/1000);
        const min = Math.floor(sec/60);
        const s = sec % 60;
        H.setBadge("fetchMeta","warn", "Last fetch: " + last + " · Next: " + min + ":" + String(s).padStart(2,"0"));
      }else{
        H.setBadge("fetchMeta","good", "Last fetch: " + last + " · Ready");
      }
    }

    function authHeaders(){
      const token = session?.access_token || "";
      return token ? { Authorization: "Bearer " + token } : {};
    }

    async function apiGet(path){
      const res = await fetch(API_BASE + path, { method:"GET", headers: authHeaders() });
      const text = await res.text().catch(()=> "");
      let json = null;
      try{ json = text ? JSON.parse(text) : {}; }catch{ json = { raw: text }; }
      if(!res.ok){
        const msg = (json && (json.error || json.message)) ? String(json.error || json.message) : (text || ("HTTP " + res.status));
        throw new Error(msg);
      }
      return json;
    }

    async function apiPost(path, body){
      const res = await fetch(API_BASE + path, {
        method:"POST",
        headers: { ...authHeaders(), "content-type":"application/json" },
        body: JSON.stringify(body || {})
      });
      const text = await res.text().catch(()=> "");
      let json = null;
      try{ json = text ? JSON.parse(text) : {}; }catch{ json = { raw: text }; }
      if(!res.ok){
        const msg = (json && (json.error || json.message)) ? String(json.error || json.message) : (text || ("HTTP " + res.status));
        throw new Error(msg);
      }
      return json;
    }

    function sortJobs(list, mode){
      const arr = [...list];
      const s = String(mode || "newest");
      const byStr = (a,b, k) => String(a?.[k]||"").localeCompare(String(b?.[k]||""), undefined, { sensitivity:"base" });

      if(s === "company"){ arr.sort((a,b)=>byStr(a,b,"company_name")); return arr; }
      if(s === "title"){ arr.sort((a,b)=>byStr(a,b,"title")); return arr; }
      if(s === "oldest"){
        arr.sort((a,b)=>String(a?.created_at||"").localeCompare(String(b?.created_at||"")));
        return arr;
      }
      // newest
      arr.sort((a,b)=>String(b?.created_at||"").localeCompare(String(a?.created_at||"")));
      return arr;
    }

    function renderQueue(){
      const wrap = $("queueWrap");
      if(!wrap) return;

      const q = String($("filterInput")?.value || "").trim().toLowerCase();
      const sortMode = $("sortSelect")?.value || "newest";

      let items = Array.isArray(queueJobs) ? queueJobs : [];
      if(q){
        items = items.filter(j => {
          const t = String(j?.title || "").toLowerCase();
          const c = String(j?.company_name || "").toLowerCase();
          return t.includes(q) || c.includes(q);
        });
      }

      items = sortJobs(items, sortMode);

      H.setBadge("queueBadge", items.length ? "good" : "warn", "Queue: " + items.length);

      if(!items.length){
        wrap.innerHTML = '<span class="badge warn">No jobs found</span>';
        return;
      }

      wrap.innerHTML = items.slice(0, 60).map(j => {
        const id = String(j?.id || "");
        const title = j?.title ? String(j.title) : "Untitled";
        const company = j?.company_name ? String(j.company_name) : "—";
        const loc = formatLoc(j) || "—";
        const posted = j?.posted_at ? String(j.posted_at).slice(0,10) : "—";
        const apply = applyUrlSafe(j?.apply_url || "");
        const prio = !!(j?._application && j._application.priority);

        const titleHtml = apply
          ? '<a href="'+H.escapeHtml(apply)+'" target="_blank" rel="noopener">'+H.escapeHtml(title)+'</a>'
          : H.escapeHtml(title);

        const prioBadge = prio ? '<span class="badge prio">prio</span>' : '<span class="badge">new</span>';

        return (
          '<div class="jobCard">' +
            '<div class="jobTop">' +
              '<div class="jobTitle">' + titleHtml + '</div>' +
              '<div class="jobBadges">' + prioBadge + '</div>' +
            '</div>' +

            '<div class="jobMeta">' +
              '<span>' + H.escapeHtml(company) + '</span>' +
              '<span>•</span><span>' + H.escapeHtml(loc) + '</span>' +
              '<span>•</span><span>Posted ' + H.escapeHtml(posted) + '</span>' +
            '</div>' +

            '<div class="jobActions">' +
              '<a class="btn small primary" href="./cv.html?job_id=' + encodeURIComponent(id) + '" data-nav="1">Tailor in CV Studio</a>' +
              '<button class="btn small ghost" type="button" data-desc="'+H.escapeHtml(id)+'">Description</button>' +
              (prio
                ? '<button class="btn small ghost" type="button" data-unprio="'+H.escapeHtml(id)+'">Unprio</button>'
                : '<button class="btn small" type="button" data-prio="'+H.escapeHtml(id)+'">Prio</button>'
              ) +
              '<button class="btn small danger" type="button" data-skip="'+H.escapeHtml(id)+'">Skip</button>' +
            '</div>' +
          '</div>'
        );
      }).join("");
    }

    async function loadQueue(){
      setText("fetchStatus", "");
      const wrap = $("queueWrap");
      if(wrap) wrap.innerHTML = '<span class="badge warn">Loading…</span>';

      const resp = await apiGet("/me/jobs/queue");
      const items = Array.isArray(resp?.data) ? resp.data : (Array.isArray(resp?.jobs) ? resp.jobs : []);
      queueJobs = items || [];
      renderQueue();
    }

    function openSkipModal(jobId){
      pendingSkipJobId = jobId;
      $("skipReason").value = "not_relevant";
      $("skipNote").value = "";
      H.showModal("skipModal");
    }
    function closeSkipModal(){
      pendingSkipJobId = null;
      H.hideModal("skipModal");
    }

    async function submitSkip(){
      if(!pendingSkipJobId) return;
      const reason_code = $("skipReason").value || "not_relevant";
      const reason_note = String($("skipNote").value || "").trim();

      try{
        await apiPost("/me/applications/skip", {
          job_id: pendingSkipJobId,
          reason_code,
          reason_note
        });
        closeSkipModal();
        await loadQueue();
      }catch(e){
        closeSkipModal();
        showError(e?.message || String(e));
      }
    }

    function openDescModal(jobId){
      pendingDescJobId = jobId;
      currentDescText = "";
      setText("descTitle", "Job description");
      setText("descMeta", "");
      setText("descBody", "Loading…");
      H.showModal("descModal");
      loadDesc(jobId).catch(()=>{});
    }
    function closeDescModal(){
      pendingDescJobId = null;
      H.hideModal("descModal");
    }

    async function loadDesc(jobId){
      try{
        const resp = await apiGet("/me/jobs/description?job_id=" + encodeURIComponent(jobId));
        const job = resp && resp.job ? resp.job : null;

        const title = (job && job.title) ? String(job.title) : "Job description";
        const company = (job && job.company_name) ? String(job.company_name) : "";
        const source = (job && job.description_full_source) ? String(job.description_full_source) : "";
        const fetchedAt = (job && job.description_full_fetched_at) ? String(job.description_full_fetched_at) : "";

        setText("descTitle", title);
        setText("descMeta", [company ? ("Company: " + company) : "", source ? ("Source: " + source) : "", fetchedAt ? ("Fetched: " + fetchedAt) : ""].filter(Boolean).join(" · "));

        const text = (job && job.description_full) ? String(job.description_full) : "";
        currentDescText = text;

        if(text){
          setText("descBody", text);
        }else if(job && job.description_full_error){
          setText("descBody", "No description yet. Last error: " + job.description_full_error);
        }else{
          setText("descBody", "No description found.");
        }
      }catch(e){
        setText("descBody", "Failed to load description: " + (e?.message || String(e)));
      }
    }

    async function copyDesc(){
      try{
        const t = currentDescText || "";
        if(!t){ alert("Nothing to copy yet."); return; }
        await navigator.clipboard.writeText(t);
        alert("Description copied.");
      }catch(_){
        window.prompt("Copy description:", currentDescText || "");
      }
    }

    async function prioritize(jobId){
      await apiPost("/me/applications/prioritize", { job_id: jobId });
      await loadQueue();
    }
    async function unprioritize(jobId){
      await apiPost("/me/applications/unprioritize", { job_id: jobId });
      await loadQueue();
    }

    async function manualFetchJobs(){
      const btn = $("btnFetch");
      const next = getNextFetchAllowedAt();
      const now = Date.now();
      if(next && now < next){
        const sec = Math.ceil((next-now)/1000);
        setText("fetchStatus", "Please wait " + sec + "s before fetching again.");
        updateFetchMetaUI();
        return;
      }

      try{
        showError("");
        if(btn){ btn.disabled = true; btn.textContent = "Fetching…"; }
        setText("fetchStatus", "Fetching…");

        // start cooldown immediately (prevents double clicks)
        localStorage.setItem("jm_last_manual_fetch_ts", String(Date.now()));
        updateFetchMetaUI();

        const resp = await apiPost("/me/jobs/fetch", { fetch_mode: "profile" });

        if(resp && resp.skipped){
          if(resp.reason === "queue_full"){
            setText("fetchStatus", "Skipped: queue is full (" + resp.queue_new_count + " new jobs).");
          }else{
            setText("fetchStatus", "Skipped: " + String(resp.reason || "unknown"));
          }
        }else{
          const added = (typeof resp?.jobs_added === "number") ? resp.jobs_added : 0;
          const q = (typeof resp?.queue_new_count === "number") ? resp.queue_new_count : "—";
          setText("fetchStatus", "Added " + added + " · Queue new: " + q);
        }

        await loadQueue();
      }catch(e){
        showError(e?.message || String(e));
        setText("fetchStatus", "Fetch failed.");
      }finally{
        if(btn){ btn.disabled = false; btn.textContent = "Fetch new jobs"; }
        updateFetchMetaUI();
      }
    }

    /* =========================
       Activity log (same logic as cv.html)
       ========================= */
    function eventBadge(t){
      const x = String(t||"").toLowerCase();
      if(x==="applied"||x==="sent"||x==="replied") return {cls:"good", label:x};
      if(x==="rejected") return {cls:"bad", label:x};
      if(x==="skipped") return {cls:"warn", label:x};
      if(x==="prioritized") return {cls:"prio", label:"prio"};
      if(x==="unprioritized") return {cls:"", label:"unprio"};
      if(x==="queued") return {cls:"", label:"queued"};
      if(x==="unskipped") return {cls:"", label:"undo"};
      return {cls:"", label:x||"event"};
    }

    function renderActivityList(items, mode){
      if(!items || !items.length) return '<span class="badge warn">No events yet</span>';

      const rows = items.slice(0, 50).map(ev => {
        const type = (ev.event_type || ev.type || ev.status || "");
        const b = eventBadge(type);
        const when = (ev.created_at || ev.at || ev.timestamp || ev.updated_at || "");
        const w = when ? String(when).replace("T"," ").slice(0,16) : "—";

        // job fields can be nested in event.job, or directly on event
        const job = ev.job || ev;
        const title = job?.title ? String(job.title) : "—";
        const company = job?.company_name ? String(job.company_name) : "";
        const note = ev.reason_note || ev.note || "";

        return (
          '<div style="display:flex;gap:10px;align-items:flex-start;justify-content:space-between; padding:10px 0; border-top:1px solid rgba(17,19,24,.10)">' +
            '<div style="min-width:0">' +
              '<div style="font-weight:900">' + H.escapeHtml(title) + (company ? (' <span class="small">· ' + H.escapeHtml(company) + '</span>') : "") + '</div>' +
              (note ? ('<div class="small" style="margin-top:4px">' + H.escapeHtml(note) + '</div>') : '') +
              '<div class="small" style="margin-top:4px">' + H.escapeHtml(w) + '</div>' +
            '</div>' +
            '<span class="badge ' + H.escapeHtml(b.cls) + '">' + H.escapeHtml(b.label) + '</span>' +
          '</div>'
        );
      }).join("");

      return '<div style="border-top:1px solid rgba(17,19,24,.10)">' + rows + '</div>';
    }

    async function loadActivityLog(){
      H.showTopError("activityError", "");
      const wrap = $("activityWrap");
      if(wrap) wrap.innerHTML = "Loading…";

      const et = String($("activityFilter")?.value || "all").trim().toLowerCase();
      const headers = { ...authHeaders() };

      // 1) Try /me/activity first
      try{
        let url = API_BASE + "/me/activity?limit=30";
        if(et && et !== "all") url += "&event_type=" + encodeURIComponent(et);

        const res = await fetch(url, { method:"GET", headers });
        const text = await res.text().catch(()=> "");
        let json = null;
        try{ json = text ? JSON.parse(text) : {}; }catch{ json = { raw: text }; }

        if(!res.ok) throw new Error((json && (json.error || json.message)) ? String(json.error || json.message) : (text || ("HTTP " + res.status)));

        const items = Array.isArray(json?.data) ? json.data : [];
        if(wrap) wrap.innerHTML = renderActivityList(items, "events");
        return;
      }catch(_){ /* fallback */ }

      // 2) Fallback: /me/applications
      try{
        const map = { queued:"new", prioritized:"new", applied:"applied", rejected:"rejected", skipped:"skipped", sent:"applied" };
        let url = API_BASE + "/me/applications?limit=20";
        if(et && map[et]) url += "&status=" + encodeURIComponent(map[et]);

        const res = await fetch(url, { method:"GET", headers });
        const text = await res.text().catch(()=> "");
        let json = null;
        try{ json = text ? JSON.parse(text) : {}; }catch{ json = { raw: text }; }

        if(!res.ok) throw new Error((json && (json.error || json.message)) ? String(json.error || json.message) : (text || ("HTTP " + res.status)));

        const items = Array.isArray(json?.data) ? json.data : [];
        if(wrap) wrap.innerHTML = renderActivityList(items, "applications");
      }catch(e){
        H.showTopError("activityError", e?.message || String(e));
        if(wrap) wrap.innerHTML = '<span class="badge bad">Activity failed</span>';
      }
    }

    function openActivityModal(){
      const dd = $("navAccount");
      if(dd) dd.open = false;
      H.showModal("activityModal");
      loadActivityLog().catch((e)=>H.showTopError("activityError", e?.message || String(e)));
    }
    function closeActivityModal(){
      H.hideModal("activityModal");
      H.showTopError("activityError", "");
    }

    /* =========================
       Boot
       ========================= */
    async function boot(){
      showError("");

      if(!window.JobApplyAI || !window.JobApplyAI.auth || typeof window.JobApplyAI.auth.getSession !== "function"){
        H.setBadge("authBadge", "bad", "Config error");
        setText("authHint", "auth.js did not load. Ensure multipage/auth.js exists and is referenced as ./auth.js.");
        return;
      }

      session = await window.JobApplyAI.auth.getSession();
      try{ if(session?.access_token) sessionStorage.setItem("sb_access_token", session.access_token); }catch(_){}

      if(!session || !session.user || !session.user.email){
        H.setBadge("authBadge", "warn", "Signed out");
        setText("authHint", "Please sign in to manage your jobs.");
        window.location.replace("./signup.html");
        return;
      }

      // Signed in nav state
      $("navAccount").style.display = "";
      $("navSignIn").style.display = "none";
      const email = String(session.user.email || "");
      $("navAccountLabel").textContent = email ? email.split("@")[0] : "Account";

      H.setBadge("authBadge", "good", "Signed in");
      setText("authHint", "Fetch jobs, then open CV Studio to tailor per role.");

      // Ensure customer exists (best effort)
      try{ await window.JobApplyAI.auth.requireAuthAndCustomer({ redirectTo: "./signup.html" }); }catch(_){}
      try{ await window.JobApplyAI.auth.syncStateToLocalStorage(session); }catch(_){}

      // Enable buttons
      $("btnFetch").disabled = false;
      $("btnRefresh").disabled = false;

      updateFetchMetaUI();
      await loadQueue();
    }

    /* =========================
       Events
       ========================= */
    $("btnFetch")?.addEventListener("click", () => manualFetchJobs());
    $("btnRefresh")?.addEventListener("click", () => loadQueue().catch(e => showError(e?.message || String(e))));
    $("filterInput")?.addEventListener("input", () => renderQueue());
    $("sortSelect")?.addEventListener("change", () => renderQueue());

    // Queue actions (event delegation)
    $("queueWrap")?.addEventListener("click", async (e) => {
      const desc = e.target.closest("[data-desc]");
      if(desc){
        const jobId = desc.getAttribute("data-desc") || "";
        if(jobId) openDescModal(jobId);
        return;
      }

      const skip = e.target.closest("[data-skip]");
      if(skip){
        const jobId = skip.getAttribute("data-skip") || "";
        if(jobId) openSkipModal(jobId);
        return;
      }

      const pr = e.target.closest("[data-prio]");
      if(pr){
        const jobId = pr.getAttribute("data-prio") || "";
        try{ await prioritize(jobId); }catch(err){ showError(err?.message || String(err)); }
        return;
      }

      const un = e.target.closest("[data-unprio]");
      if(un){
        const jobId = un.getAttribute("data-unprio") || "";
        try{ await unprioritize(jobId); }catch(err){ showError(err?.message || String(err)); }
      }
    });

    // Skip modal
    $("skipCancel")?.addEventListener("click", closeSkipModal);
    $("skipCloseX")?.addEventListener("click", closeSkipModal);
    $("skipConfirm")?.addEventListener("click", submitSkip);
    $("skipModal")?.addEventListener("click", (e) => { if(e.target && e.target.id === "skipModal") closeSkipModal(); });

    // Desc modal
    $("descClose")?.addEventListener("click", closeDescModal);
    $("descCloseX")?.addEventListener("click", closeDescModal);
    $("descCopy")?.addEventListener("click", copyDesc);
    $("descModal")?.addEventListener("click", (e) => { if(e.target && e.target.id === "descModal") closeDescModal(); });

    // Activity modal
    $("navActivity")?.addEventListener("click", openActivityModal);
    $("activityCloseX")?.addEventListener("click", closeActivityModal);
    $("activityClose")?.addEventListener("click", closeActivityModal);
    $("activityModal")?.addEventListener("click", (e) => { if(e.target && e.target.id === "activityModal") closeActivityModal(); });
    $("activityRefresh")?.addEventListener("click", () => loadActivityLog().catch(()=>{}));
    $("activityFilter")?.addEventListener("change", () => loadActivityLog().catch(()=>{}));

    // Logout
    $("navLogout")?.addEventListener("click", async () => {
      try{
        await window.JobApplyAI.auth.logout("./index.html");
      }catch(_){
        window.location.href = "./index.html";
      }
    });

    window.addEventListener("load", () => {
      boot().catch((e) => {
        showError(e?.message || String(e));
        H.setBadge("authBadge", "bad", "Error");
      });
    });
  })();
  </script>
</body>
</html>
