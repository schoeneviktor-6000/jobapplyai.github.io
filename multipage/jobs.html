<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jobs · jobmejob</title>
  <meta name="description" content="Review your job queue, prioritize roles, and fetch new jobs." />

  <!-- Shared styles -->
  <link rel="stylesheet" href="./shared.css" />

  <style>
    /* Page-specific (small) */
    .layout{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
    }

    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .rightCol{
      position:sticky;
      top:86px; /* sits under topbar */
      align-self:start;
    }
    @media (max-width: 980px){
      .rightCol{ position:static; top:auto; }
    }

    .fieldRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .fieldRow input{
      flex: 1 1 220px;
      min-width: 180px;
    }

    .jobList{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .jobCard{
      border:1px solid rgba(17,19,24,.12);
      border-radius:16px;
      background: rgba(255,255,255,.86);
      padding:12px;
      box-shadow: 0 10px 24px rgba(17,19,24,.08);
    }
    .jobTop{
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:flex-start;
    }
    .jobTitle{
      font-weight:950;
      line-height:1.2;
      margin:0;
      font-size:15px;
    }
    .jobMeta{
      margin-top:6px;
      color: rgba(17,19,24,.64);
      font-weight:650;
      font-size:13px;
      line-height:1.35;
    }
    .jobActions{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .mutedNote{
      color: rgba(17,19,24,.58);
      font-weight:650;
      font-size:13px;
      line-height:1.45;
    }

    .inlineStatus{
      margin-top:10px;
      color: rgba(17,19,24,.64);
      font-weight:750;
      font-size:13px;
      white-space:pre-wrap;
    }

    .empty{
      padding:14px;
      border-radius:16px;
      border:1px dashed rgba(17,19,24,.18);
      background: rgba(17,19,24,.03);
      color: rgba(17,19,24,.68);
      font-weight:750;
      line-height:1.5;
    }

    /* tiny skeleton */
    .skeleton{
      height: 12px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(17,19,24,.06), rgba(17,19,24,.10), rgba(17,19,24,.06));
      background-size: 200% 100%;
      animation: shimmer 1.2s ease-in-out infinite;
    }
    @keyframes shimmer{
      0%{ background-position: 200% 0; }
      100%{ background-position: -200% 0; }
    }
    .sRow{ margin-top:10px; display:flex; flex-direction:column; gap:10px; }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="nav">
      <a class="brand" href="./index.html" data-nav="1" aria-label="Home">
        <span class="logo" aria-hidden="true"></span>
        <span style="min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">jobmejob</span>
      </a>

      <nav class="navlinks" aria-label="Primary navigation">
        <a class="pill" href="./index.html" data-nav="1">Home</a>
        <a class="pill" href="./profile.html" data-nav="1">Profile</a>
        <a class="pill" href="./plan.html" data-nav="1">Plan</a>
        <a class="pill" href="./dashboard.html" data-nav="1">Dashboard</a>
        <a class="pill active" href="./jobs.html" data-nav="1">Jobs</a>
        <button class="pill" id="btnLogout" type="button" title="Logout">Logout</button>
      </nav>
    </div>
  </header>

  <main class="main">
    <div class="h1">Jobs</div>
    <p class="sub">
      Review your queue, prioritize roles, and fetch new jobs.
      <span class="badge" id="badgeQueue" style="margin-left:8px;">Queue: —</span>
      <span class="badge" id="badgeUser" style="margin-left:8px;">User: —</span>
    </p>

    <div class="errorTop" id="errorTop"></div>

    <section class="layout">
      <!-- LEFT: Job list -->
      <div class="card">
        <div class="toolbar">
          <div class="actions">
            <button class="btn primary" id="btnRefresh" type="button">Refresh list</button>
            <button class="btn" id="btnFetch" type="button">Fetch new jobs</button>
          </div>

          <div class="fieldRow" style="justify-content:flex-end;min-width:260px;">
            <input id="searchInput" placeholder="Search title/company/location…" />
          </div>
        </div>

        <div class="inlineStatus" id="fetchStatus"></div>

        <div class="hr"></div>

        <div id="jobList" class="jobList" aria-live="polite">
          <div class="sRow">
            <div class="skeleton" style="width:70%"></div>
            <div class="skeleton" style="width:55%"></div>
            <div class="skeleton" style="width:90%"></div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Guidance -->
      <aside class="card rightCol">
        <div style="font-weight:950;margin-bottom:8px;">What you can do here</div>

        <div class="mutedNote">
          <div style="margin-bottom:10px;">
            <span class="badge prio">Priority</span>
            means this job is marked as “focus first”.
          </div>

          <div style="margin-bottom:10px;">
            <span class="badge">View</span>
            opens the full description (cached by the backend so it’s fast next time).
          </div>

          <div style="margin-bottom:10px;">
            <span class="badge warn">Skip</span>
            removes it from your “New” queue so you can focus.
          </div>
        </div>

        <div class="hr"></div>

        <div class="actions">
          <a class="btn ghost" href="./profile.html" data-nav="1">Edit job preferences</a>
          <a class="btn ghost" href="./dashboard.html" data-nav="1">Go to Dashboard</a>
        </div>

        <div class="hr"></div>

        <div class="mutedNote">
          If your list is empty:
          <ul style="margin:8px 0 0 18px;">
            <li>Set at least 1 desired title + 1 location in Profile.</li>
            <li>Then click <b>Fetch new jobs</b>.</li>
          </ul>
        </div>
      </aside>
    </section>
  </main>

  <!-- DESCRIPTION MODAL -->
  <div class="modalBackdrop" id="descModal" style="display:none" role="dialog" aria-modal="true" aria-labelledby="descTitle">
    <div class="modalCard">
      <div class="modalScroll">
        <div class="modalHeader">
          <div>
            <h3 class="modalTitle" id="descTitle">Job description</h3>
            <div class="mutedNote" id="descMeta" style="margin-top:6px;"></div>
          </div>
          <button class="btn small" type="button" id="btnCloseDesc">Close</button>
        </div>

        <div class="hr"></div>

        <div class="modalMonoBox" id="descText">Loading…</div>
      </div>

      <div class="modalActions">
        <button class="btn" type="button" id="btnCopyDesc">Copy description</button>
        <a class="btn primary" id="btnOpenApply" href="#" target="_blank" rel="noopener">Open apply link</a>
      </div>
    </div>
  </div>

  <!-- Scripts: order matters -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./shared.js"></script>

  <script>
  (() => {
    "use strict";

    const { escapeHtml, wireNavTransitions, showTopError, showModal, hideModal, resolveApiBase } = window.JobMeJobShared || {};
    if (!escapeHtml || !wireNavTransitions) {
      alert("shared.js is missing or not loaded. Make sure multipage/shared.js exists.");
      return;
    }

    wireNavTransitions();

    /* ---------------------------
       Config (same as your other pages)
    --------------------------- */
    const API_BASE = resolveApiBase("https://jobmejob.schoene-viktor.workers.dev");
    const SUPABASE_URL_DEFAULT = "https://awlzvhcnjegfhjedswko.supabase.co";
    const SUPABASE_ANON_FALLBACK =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF3bHp2aGNuamVnZmhqZWRzd2tvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2NTE2OTgsImV4cCI6MjA4MjIyNzY5OH0.-UmHiVi0_g9tKDkr6ldfROeBrOk8hm18YVPRfnb8luY";

    function lsGet(k){ try { return localStorage.getItem(k); } catch { return null; } }
    function lsSet(k,v){ try { localStorage.setItem(k,v); } catch {} }

    if(!lsGet("sb_url")) lsSet("sb_url", SUPABASE_URL_DEFAULT);
    if(!lsGet("sb_anon")) lsSet("sb_anon", SUPABASE_ANON_FALLBACK);

    const SUPABASE_URL = (lsGet("sb_url") || SUPABASE_URL_DEFAULT).trim();
    const SUPABASE_ANON_KEY = (lsGet("sb_anon") || SUPABASE_ANON_FALLBACK).trim();

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ---------------------------
       DOM helpers
    --------------------------- */
    const $ = (id) => document.getElementById(id);

    const elJobList = $("jobList");
    const elSearch = $("searchInput");
    const elQueueBadge = $("badgeQueue");
    const elUserBadge = $("badgeUser");
    const elFetchStatus = $("fetchStatus");

    let session = null;
    let jobs = [];          // full list from API
    let filteredJobs = [];  // filtered by search

    let currentDescJob = null;
    let currentDescText = "";
    let currentApplyUrl = "";

    /* ---------------------------
       Auth / session
    --------------------------- */
    async function requireSession() {
      const { data, error } = await supabaseClient.auth.getSession();
      if (error) return null;
      if (!data || !data.session || !data.session.access_token) return null;
      return data.session;
    }

    async function logout() {
      try { await supabaseClient.auth.signOut(); } catch {}
      window.location.replace("./index.html");
    }

    $("btnLogout").addEventListener("click", logout);

    async function ensureCustomer(email){
      const res = await fetch(API_BASE + "/customers/upsert", {
        method:"POST",
        headers: { "content-type":"application/json" },
        body: JSON.stringify({ email })
      });
      const txt = await res.text().catch(()=> "");
      if(!res.ok) throw new Error("customers/upsert failed: " + res.status + " " + txt);
      let data = null;
      try { data = JSON.parse(txt); } catch { data = null; }
      if (data && data.customer_id) lsSet("ja_customer_id", String(data.customer_id));
      lsSet("ja_user_email", String(email).trim().toLowerCase());
      return data;
    }

    /* ---------------------------
       API helpers
    --------------------------- */
    async function apiGet(path){
      const res = await fetch(API_BASE + path, {
        method: "GET",
        headers: { Authorization: "Bearer " + session.access_token }
      });
      const txt = await res.text().catch(()=> "");
      let json = null;
      try { json = JSON.parse(txt); } catch { json = { raw: txt }; }
      if(!res.ok) {
        const msg = (json && (json.error || json.message || json.details)) ? (json.error || json.message || json.details) : txt;
        throw new Error(path + " failed: " + res.status + " " + msg);
      }
      return json;
    }

    async function apiPostJson(path, body){
      const res = await fetch(API_BASE + path, {
        method:"POST",
        headers: {
          Authorization: "Bearer " + session.access_token,
          "content-type":"application/json"
        },
        body: JSON.stringify(body || {})
      });
      const txt = await res.text().catch(()=> "");
      let json = null;
      try { json = JSON.parse(txt); } catch { json = { raw: txt }; }
      if(!res.ok) {
        const msg = (json && (json.error || json.message || json.details)) ? (json.error || json.message || json.details) : txt;
        throw new Error(path + " failed: " + res.status + " " + msg);
      }
      return json;
    }

    /* ---------------------------
       Rendering
    --------------------------- */
    function formatLocation(j){
      const parts = [];
      if (j.city) parts.push(j.city);
      if (j.region && j.region !== j.city) parts.push(j.region);
      if (j.country) parts.push(j.country);
      return parts.filter(Boolean).join(", ");
    }

    function applyUrlSafe(url){
      const u = String(url || "").trim();
      if (!u) return "";
      if (/^https?:\/\//i.test(u)) return u;
      return "https://" + u.replace(/^\/+/, "");
    }

    function renderJobs(list){
      if (!Array.isArray(list) || list.length === 0) {
        elJobList.innerHTML = `
          <div class="empty">
            No jobs in your queue yet.<br/><br/>
            1) Go to <b>Profile</b> and add at least 1 desired title + 1 location.<br/>
            2) Then click <b>Fetch new jobs</b> here (or on Dashboard).
          </div>
        `;
        return;
      }

      const html = list.map(j => {
        const title = escapeHtml(j.title || "Untitled role");
        const company = escapeHtml(j.company_name || "Company");
        const loc = escapeHtml(formatLocation(j) || "Location");
        const prio = !!(j._application && j._application.priority);

        const applyUrl = applyUrlSafe(j.apply_url);

        return `
          <div class="jobCard" data-job-id="${escapeHtml(j.id)}">
            <div class="jobTop">
              <div style="min-width:0">
                <div class="jobTitle">${title}</div>
                <div class="jobMeta">${company} · ${loc}</div>
              </div>
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
                ${prio ? `<span class="badge prio">Priority</span>` : `<span class="badge">New</span>`}
              </div>
            </div>

            <div class="jobActions">
              <button class="btn small" type="button" data-action="view">View</button>
              <button class="btn small" type="button" data-action="open" ${applyUrl ? "" : "disabled"}>Open</button>

              ${prio
                ? `<button class="btn small" type="button" data-action="unprioritize">Unprioritize</button>`
                : `<button class="btn small" type="button" data-action="prioritize">Prioritize</button>`
              }

              <button class="btn small danger" type="button" data-action="skip">Skip</button>
            </div>

            ${!applyUrl ? `<div class="mutedNote" style="margin-top:8px;">No apply link available for this job.</div>` : ``}
          </div>
        `;
      }).join("");

      elJobList.innerHTML = html;
    }

    function updateBadges(){
      const count = Array.isArray(jobs) ? jobs.length : 0;
      elQueueBadge.textContent = "Queue: " + count;
    }

    function applySearch(){
      const q = String(elSearch.value || "").trim().toLowerCase();
      if (!q) {
        filteredJobs = jobs.slice();
      } else {
        filteredJobs = jobs.filter(j => {
          const hay = [
            j.title, j.company_name, j.city, j.region, j.country
          ].map(x => String(x || "").toLowerCase()).join(" ");
          return hay.includes(q);
        });
      }
      renderJobs(filteredJobs);
    }

    /* ---------------------------
       Data loading
    --------------------------- */
    async function loadQueue(){
      showTopError("errorTop", "");
      elFetchStatus.textContent = "";

      // tiny skeleton
      elJobList.innerHTML = `
        <div class="sRow">
          <div class="skeleton" style="width:70%"></div>
          <div class="skeleton" style="width:55%"></div>
          <div class="skeleton" style="width:90%"></div>
        </div>
      `;

      const resp = await apiGet("/me/jobs/queue");
      const data = resp && Array.isArray(resp.data) ? resp.data : [];
      jobs = data;
      updateBadges();
      applySearch();
    }

    /* ---------------------------
       Manual fetch (POST /me/jobs/fetch)
       - uses profile titles + profile locations
    --------------------------- */
    function getNextFetchAllowedAt(){
      const ts = Number(lsGet("jm_last_manual_fetch_ts") || "0");
      if (!ts || !isFinite(ts)) return 0;
      // Frontend cooldown 60s (server is still the real gate: 10 minutes)
      return ts + 60 * 1000;
    }

    async function fetchNewJobs(){
      const btn = $("btnFetch");
      btn.disabled = true;

      try{
        const next = getNextFetchAllowedAt();
        if (next && Date.now() < next) {
          const sec = Math.ceil((next - Date.now()) / 1000);
          elFetchStatus.textContent = "Please wait " + sec + "s before fetching again.";
          btn.disabled = false;
          return;
        }

        // start local cooldown immediately to prevent double click spam
        lsSet("jm_last_manual_fetch_ts", String(Date.now()));

        elFetchStatus.textContent = "Fetching…";

        const resp = await apiPostJson("/me/jobs/fetch", {
          include_ai_titles: false,
          fetch_mode: "profile"
        });

        if (resp && resp.skipped) {
          elFetchStatus.textContent = resp.message || ("Skipped: " + String(resp.reason || ""));
          btn.disabled = false;
          return;
        }

        const added = (typeof resp.jobs_added === "number") ? resp.jobs_added : 0;
        const qNew = (typeof resp.queue_new_count === "number") ? resp.queue_new_count : "—";
        elFetchStatus.textContent = "Added " + added + " · Queue new: " + qNew;

        await loadQueue();
      }catch(e){
        const msg = e && e.message ? e.message : "Fetch failed";
        elFetchStatus.textContent = msg;
        showTopError("errorTop", msg);
      }finally{
        btn.disabled = false;
      }
    }

    /* ---------------------------
       Job actions
    --------------------------- */
    async function prioritize(jobId, on){
      const path = on ? "/me/applications/prioritize" : "/me/applications/unprioritize";
      await apiPostJson(path, { job_id: jobId });
    }

    async function skip(jobId){
      await apiPostJson("/me/applications/skip", { job_id: jobId });
    }

    async function openDescription(jobId){
      currentDescJob = jobId;
      currentDescText = "";
      currentApplyUrl = "";

      $("descTitle").textContent = "Job description";
      $("descMeta").textContent = "";
      $("descText").textContent = "Loading…";
      $("btnOpenApply").setAttribute("href", "#");
      $("btnOpenApply").classList.add("ghost");

      showModal("descModal");

      const resp = await apiGet("/me/jobs/description?job_id=" + encodeURIComponent(jobId));
      const job = resp && resp.job ? resp.job : null;

      const title = job && job.title ? String(job.title) : "Job description";
      const company = job && job.company_name ? String(job.company_name) : "";
      const loc = job ? formatLocation(job) : "";
      const applyUrl = applyUrlSafe(job && job.apply_url ? job.apply_url : "");

      currentApplyUrl = applyUrl;
      $("descTitle").textContent = title;
      $("descMeta").textContent = [company, loc].filter(Boolean).join(" · ");

      const desc = job && job.description_full ? String(job.description_full) : "";
      currentDescText = desc || "(No description available.)";

      // Show as plain text (safe) inside pre-wrap box
      $("descText").textContent = currentDescText;

      if (applyUrl) {
        $("btnOpenApply").setAttribute("href", applyUrl);
        $("btnOpenApply").classList.remove("ghost");
      } else {
        $("btnOpenApply").setAttribute("href", "#");
        $("btnOpenApply").classList.add("ghost");
      }
    }

    async function copyDescription(){
      const text = String(currentDescText || "").trim();
      if (!text) return;
      try{
        await navigator.clipboard.writeText(text);
        $("btnCopyDesc").textContent = "Copied ✓";
        setTimeout(()=>{ $("btnCopyDesc").textContent = "Copy description"; }, 900);
      }catch{
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand("copy"); } catch {}
        document.body.removeChild(ta);
        $("btnCopyDesc").textContent = "Copied ✓";
        setTimeout(()=>{ $("btnCopyDesc").textContent = "Copy description"; }, 900);
      }
    }

    /* ---------------------------
       Wire events
    --------------------------- */
    $("btnRefresh").addEventListener("click", () => loadQueue().catch(e => showTopError("errorTop", e.message || String(e))));
    $("btnFetch").addEventListener("click", () => fetchNewJobs());

    elSearch.addEventListener("input", () => applySearch());

    elJobList.addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-action]");
      if(!btn) return;

      const card = btn.closest(".jobCard");
      const jobId = card ? card.getAttribute("data-job-id") : "";
      if(!jobId) return;

      const action = btn.getAttribute("data-action");

      btn.disabled = true;
      showTopError("errorTop", "");

      try{
        if(action === "view"){
          await openDescription(jobId);
        } else if(action === "open"){
          const j = jobs.find(x => String(x.id) === String(jobId)) || null;
          const url = applyUrlSafe(j && j.apply_url ? j.apply_url : "");
          if(url) window.open(url, "_blank", "noopener");
        } else if(action === "prioritize"){
          await prioritize(jobId, true);
          await loadQueue();
        } else if(action === "unprioritize"){
          await prioritize(jobId, false);
          await loadQueue();
        } else if(action === "skip"){
          await skip(jobId);
          await loadQueue();
        }
      }catch(err){
        showTopError("errorTop", err && err.message ? err.message : String(err));
      }finally{
        btn.disabled = false;
      }
    });

    // Modal controls
    $("btnCloseDesc").addEventListener("click", () => hideModal("descModal"));
    $("btnCopyDesc").addEventListener("click", copyDescription);
    $("descModal").addEventListener("click", (e) => {
      if (e.target && e.target.id === "descModal") hideModal("descModal");
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") hideModal("descModal");
    });

    /* ---------------------------
       Boot
    --------------------------- */
    (async () => {
      session = await requireSession();
      if(!session || !session.user || !session.user.email){
        window.location.replace("./signup.html");
        return;
      }

      const email = String(session.user.email).trim().toLowerCase();
      elUserBadge.textContent = "User: " + email;

      try{
        await ensureCustomer(email);
      }catch(e){
        // Not fatal for UI, but endpoints like /me/* might fail if customer doesn't exist.
        showTopError("errorTop", e && e.message ? e.message : String(e));
      }

      await loadQueue();
    })().catch((e) => {
      showTopError("errorTop", e && e.message ? e.message : String(e));
    });

  })();
  </script>
</body>
</html>
