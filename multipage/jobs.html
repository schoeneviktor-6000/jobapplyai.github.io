<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>jobmejob • Jobs</title>
  <meta name="description" content="Fetch and review your job queue, then open a job in CV Studio."/>

  <!-- Shared styles -->
  <link rel="stylesheet" href="./shared.css"/>

  <style>
    /* =========================================================
       Jobs (page-only styles)
       Goal: LinkedIn-like 2-pane layout (list left, details right)
       ========================================================= */

    .grid{
      display:grid;
      grid-template-columns: minmax(340px, 420px) 1fr;
      gap:14px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .sectionHeader{
      padding:14px;
      border-bottom:1px solid rgba(17,19,24,.10);
      background:rgba(255,255,255,.88);
      backdrop-filter:saturate(1.2) blur(10px);
    }
    .sectionBody{ padding:14px; }

    /* On desktop: both panes scroll inside their cards */
    .queueCard, .detailCard{
      display:flex;
      flex-direction:column;
    }
    @media (min-width: 981px){
      .queueCard, .detailCard{
        height: calc(100dvh - 210px);
      }
      .queueCard .sectionBody,
      .detailCard .sectionBody{
        flex:1 1 auto;
        min-height:0;
        overflow:auto;
      }
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .small{ font-size:12px; color:rgba(17,19,24,.56); font-weight:700; line-height:1.45; }
    .mono{
      font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:12px;
      word-break:break-word;
      color:rgba(17,19,24,.64);
    }

    /* -------------------------
       Queue list (left)
       ------------------------- */
    .jobList{ display:flex; flex-direction:column; gap:14px; }

/* Sectioned list (Priority pinned like LinkedIn "Saved") */
.jobSection{ display:flex; flex-direction:column; gap:8px; }
.jobSectionHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding: 2px 6px 0;
  color: rgba(17,19,24,.58);
  font-weight: 950;
  font-size: 12px;
  letter-spacing: .03em;
  text-transform: uppercase;
}
.jobSectionList{ display:flex; flex-direction:column; gap:10px; }
.jobSectionDivider{
  height:1px;
  background: rgba(17,19,24,.10);
  margin: 4px 0 2px;
  border-radius: 999px;
}

    .jobRow{
      border:1px solid rgba(17,19,24,.12);
      background:rgba(255,255,255,.72);
      border-radius:16px;
      padding:12px 12px;
      box-shadow: 0 14px 30px rgba(17,19,24,.06);
      cursor:pointer;
      transition:.12s ease;
      position:relative;
    }
    .jobRow:hover{ transform: translateY(-1px); background:rgba(255,255,255,.82); }
    .jobRow.selected{
      border-color: rgba(34,197,94,.55);
      background: rgba(34,197,94,.10);
      box-shadow: 0 18px 44px rgba(34,197,94,.10);
    }

    .jobRowTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .jobRowTitle{
      font-weight:950;
      line-height:1.2;
      letter-spacing:-.2px;
      color:rgba(17,19,24,.92);
    }
    .jobRowRight{
      display:flex;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .jobRowMeta{
      margin-top:6px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      color:rgba(17,19,24,.56);
      font-size:12px;
      font-weight:750;
    }
    .jobRowMeta span{ white-space:nowrap; }
    .badgeGroup{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

    .heartBtn{
      width:38px;
      height:38px;
      flex: 0 0 auto;
    }
    .heartBtn span{
      font-size:16px;
      line-height:1;
      transform: translateY(-1px);
      display:inline-block;
    }
    .heartBtn.on{
      border-color: rgba(34,197,94,.38);
      background: rgba(34,197,94,.14);
    }

    /* -------------------------
       Details pane (right)
       ------------------------- */
    .detailHeaderTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .detailTitle{
      font-weight:980;
      font-size:18px;
      line-height:1.15;
      letter-spacing:-.3px;
    }
    .detailMeta{
      margin-top:6px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      color:rgba(17,19,24,.58);
      font-size:12px;
      font-weight:750;
    }
    .detailActions{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .detailActions .btn{ justify-content:center; }
    .detailActions .btn.primary{ flex: 1 1 240px; }
    .detailActions .btn.ghost{ flex: 0 1 auto; }
    .detailActions .btn.danger{ flex: 0 1 auto; }

    .skipInlineNote{
      margin-top:8px;
      font-size:12px;
      color:rgba(17,19,24,.56);
      font-weight:700;
      line-height:1.4;
    }

    .descBox{
      margin-top:10px;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(17,19,24,.10);
      background:rgba(17,19,24,.03);
      white-space:pre-wrap;
      word-break:break-word;
      font-size:12px;
      color:rgba(17,19,24,.74);
    }

    .detailEmpty{
      padding:14px;
    }
    .detailEmptyTitle{
      font-weight:950;
      letter-spacing:-.2px;
    }

    /* -------------------------
       Skeletons
       ------------------------- */
    .skeleton{
      border-radius:12px;
      height:12px;
      background:linear-gradient(90deg, rgba(17,19,24,.10), rgba(17,19,24,.04), rgba(17,19,24,.10));
      background-size:200% 100%;
      animation:shimmer 1.2s linear infinite;
    }
    .skeleton.block{ height:140px; border-radius:16px; }
    .skeleton.line{ height:12px; border-radius:10px; }
    .skeleton.tall{ height:220px; border-radius:16px; }
    @keyframes shimmer{
      0%{ background-position:200% 0 }
      100%{ background-position:-200% 0 }
    }

    details.advanced{
      margin-top:10px;
      border:1px solid rgba(17,19,24,.10);
      border-radius:16px;
      background:rgba(17,19,24,.03);
      padding:10px 12px;
    }
    details.advanced summary{
      cursor:pointer;
      font-weight:900;
      color:rgba(17,19,24,.80);
      list-style:none;
    }
    details.advanced summary::-webkit-details-marker{ display:none }

    .toggleRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 0;
      border-top:1px solid rgba(17,19,24,.10);
      margin-top:8px;
    }
    .toggleRow:first-of-type{ border-top:0; margin-top:0; }

    .switch{
      display:inline-flex;
      align-items:center;
      gap:10px;
      font-weight:850;
      font-size:13px;
      color:rgba(17,19,24,.78);
      user-select:none;
    }
    .switch input{ width:18px; height:18px; }

    /* Activity list (modal) */
    .activityList{ display:flex; flex-direction:column; gap:10px; }
    .activityItem{
      border:1px solid rgba(17,19,24,.10);
      background:rgba(17,19,24,.03);
      border-radius:14px;
      padding:10px 12px;
    }
    .activityTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .activityTitle{ font-weight:950; }
    .activityMeta{ margin-top:6px; display:flex; flex-wrap:wrap; gap:8px; color:rgba(17,19,24,.60); font-size:12px; font-weight:750; }

    .iconX{
      border:1px solid rgba(17,19,24,.12);
      background:rgba(17,19,24,.04);
      border-radius:999px;
      padding:7px 10px;
      font-weight:950;
      cursor:pointer;
    }
</style>
</head>

<body>
  <header class="topbar">
    <nav class="nav">
      <a class="brand" href="./index.html" data-nav="1" aria-label="Home">
        <span class="logo" aria-hidden="true"></span>
        <span>jobmejob</span>
      </a>

      <div class="navlinks">
        <a class="pill" href="./dashboard.html" data-nav="1">Dashboard</a>
        <a class="pill" href="./cv.html" data-nav="1">CV Studio</a>
        <a class="pill active" href="./jobs.html" data-nav="1">Jobs</a>
        <a class="pill" href="./plan.html" data-nav="1">Plan</a>

        <details class="navDrop" id="navAccount" style="display:none">
          <summary class="pill" aria-label="Account menu">
            <span id="navAccountLabel">Account</span>
            <span aria-hidden="true">▾</span>
          </summary>

          <div class="navMenu" role="menu" aria-label="Account menu">
            <div class="menuLabel">Account</div>
            <a class="pill" href="./profile.html" data-nav="1" role="menuitem">Profile setup</a>
            <button class="btn ghost" id="navActivity" type="button" role="menuitem">Activity log</button>

            <div class="menuSep" role="separator"></div>
            <div class="menuLabel">More</div>
            <a class="pill" href="./dashboard.html" data-nav="1" role="menuitem">Dashboard</a>
            <span class="pill menuDisabled" role="menuitem" aria-disabled="true">Auto-apply (coming soon)</span>

            <div class="menuSep" role="separator"></div>
            <button class="btn danger" id="navLogout" type="button" role="menuitem">Logout</button>
          </div>
        </details>

        <a class="pill" href="./signup.html" id="navSignIn" data-nav="1">Sign in</a>
      </div>
    </nav>
  </header>

  <main class="main">
    <div class="row" style="align-items:flex-end; justify-content:space-between">
      <div>
        <h1 class="h1">Jobs</h1>
        <p class="sub">Fetch jobs into your queue, then open any job in CV Studio to tailor your CV.</p>
      </div>
      <span class="badge warn" id="authBadge">Checking…</span>
    </div>

    <div class="errorTop" id="errorTop"></div>

    <section class="grid">
      <!-- LEFT: Queue -->
      <section class="card cardNoPad queueCard">
        <div class="sectionHeader">
          <div class="row" style="justify-content:space-between">
            <div style="min-width:220px">
              <div style="font-weight:950">Your queue</div>
              <div class="small" id="queueHint">Browse your queue on the left. Click a job to see details on the right.</div>
            </div>

            <div class="row" style="justify-content:flex-end">
              <span class="badge warn">Germany only</span>
              <span class="badge" id="badgeQueue">—</span>
              <button class="btn primary" id="btnFetchJobsNow" type="button">Fetch new jobs</button>
              <button class="btn" id="btnRefresh" type="button">Refresh</button>
            </div>
          </div>

          <div class="small" id="fetchMeta" style="margin-top:8px"></div>
        </div>

        <div class="sectionBody" id="queueScroll">
          <div class="small" id="fetchJobsStatus"></div>

          <div class="field" style="margin-top:10px">
            <input id="queueSearch" class="textInput" type="text" placeholder="Search title, company, location…" autocomplete="off"/>
          </div>
          <div class="small" id="queueShowing" style="margin-top:8px"></div>


          <details class="advanced" id="fetchAdvanced">
            <summary>Fetch options</summary>

            <div class="toggleRow">
              <label class="switch">
                <input id="toggleAiOnly" type="checkbox"/>
                AI titles only
              </label>
              <span class="badge" id="badgeAi">—</span>
            </div>
            <div class="small" id="aiSwitchHint" style="display:none">Generate AI suggestions in Profile to unlock this.</div>
            <div class="small">If enabled, we use your AI-recommended role titles (from Profile) to fetch jobs. Otherwise we fetch based on your profile settings.</div>
          </details>

          <div class="hr"></div>

          <div id="queueWrap"><div class="skeleton block"></div></div>
          <div id="queueError"></div>
        </div>
      </section>

      <!-- RIGHT: Job details (LinkedIn-like) -->
      <aside class="card cardNoPad detailCard">
        <div class="sectionHeader">
          <div class="row" style="justify-content:space-between">
            <div>
              <div style="font-weight:950">Job details</div>
              <div class="small" id="detailHint">Select a job on the left.</div>
            </div>
            <span class="badge" id="detailBadge">—</span>
          </div>
        </div>

        <div class="sectionBody" id="detailScroll">
          <div id="detailWrap">
            <div class="detailEmpty">
              <div class="detailEmptyTitle">Select a job</div>
              <div class="small" style="margin-top:6px">Pick a job from the list to see its full description and tailor your CV.</div>

              <div class="hr"></div>

              <div class="row" style="justify-content:flex-start">
                <a class="btn" href="./cv.html" data-nav="1">Open CV Studio</a>
                <a class="btn ghost" href="./profile.html" data-nav="1">Open Profile</a>
              </div>
            </div>
          </div>

          <div class="hr"></div>
          <div class="small" id="onboardingHint">Checking your account…</div>
        </div>
      </aside>
    </section>
  </main>

  <!-- Job description modal -->
  <div class="modalBackdrop" id="descModal" style="display:none">
    <div class="modalCard">
      <div class="modalScroll">
        <div class="modalHeader">
          <div style="min-width:0">
            <div class="modalTitle" id="descTitle">Job description</div>
            <div class="small" id="descMeta"></div>
          </div>
          <button class="iconX" id="descCloseX" type="button" aria-label="Close">✕</button>
        </div>

        <div class="modalMonoBox" id="descBody" style="margin-top:12px">Loading…</div>
      </div>
      <div class="modalActions">
        <button class="btn ghost" id="descCopy" type="button">Copy</button>
        <button class="btn" id="descClose" type="button">Close</button>
      </div>
    </div>
  </div>

  <!-- Skip modal -->
  <div class="modalBackdrop" id="skipModal" style="display:none">
    <div class="modalCard" style="max-width:720px">
      <div class="modalScroll">
        <div class="modalHeader">
          <div class="modalTitle">Skip job</div>
          <button class="iconX" id="skipCloseX" type="button" aria-label="Close">✕</button>
        </div>

        <div class="small" style="margin-top:10px">
          Skipped jobs won’t be shown in your queue. You can still see what happened in the Activity log.
        </div>

        <div class="row" style="margin-top:12px">
          <div style="flex:1 1 260px">
            <label for="skipReason" class="small" style="display:block;margin-bottom:6px">Reason</label>
            <select id="skipReason" style="width:100%">
              <option value="not_relevant">Not relevant</option>
              <option value="location">Wrong location</option>
              <option value="seniority">Wrong seniority</option>
              <option value="salary">Salary mismatch</option>
              <option value="tech_stack">Tech stack mismatch</option>
              <option value="visa">Visa / work permit</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div style="flex:1 1 260px">
            <label for="skipNote" class="small" style="display:block;margin-bottom:6px">Note (optional)</label>
            <input id="skipNote" type="text" placeholder="Short note (optional)" style="width:100%"/>
          </div>
        </div>

                <div class="small" style="margin-top:10px">
          <b>Note:</b> Skipped jobs will be excluded from Auto‑Apply once you activate a plan (coming soon).
        </div>

        <div class="small" id="skipGuardrail" style="display:none; margin-top:10px"></div>
      </div>

      <div class="modalActions">
        <button class="btn ghost" id="skipCancel" type="button">Cancel</button>
        <button class="btn danger" id="skipConfirm" type="button">Skip</button>
      </div>
    </div>
  </div>

  <!-- Activity log modal (Account dropdown) -->
  <div class="modalBackdrop" id="activityModal" style="display:none">
    <div class="modalCard">
      <div class="modalScroll">
        <div class="modalHeader">
          <div style="min-width:0">
            <div class="modalTitle">Activity log</div>
            <div class="small">Recent actions like queued, prioritized, skipped, applied, rejected.</div>
          </div>
          <button class="iconX" id="activityCloseX" type="button" aria-label="Close">✕</button>
        </div>

        <div class="row" style="margin-top:12px; justify-content:space-between">
          <div class="row" style="gap:10px">
            <label class="small" for="activityFilter">Filter</label>
            <select id="activityFilter">
              <option value="">All</option>
              <option value="queued">Queued</option>
              <option value="prioritized">Prioritized</option>
              <option value="skipped">Skipped</option>
              <option value="applied">Applied</option>
              <option value="rejected">Rejected</option>
            </select>
          </div>
          <button class="btn" id="activityRefresh" type="button">Refresh</button>
        </div>

        <div class="errorTop" id="activityError"></div>

        <div id="activityWrap" style="margin-top:10px">
          <div class="modalMonoBox">Loading…</div>
        </div>
      </div>

      <div class="modalActions">
        <a class="btn ghost" href="./cv.html" data-nav="1">Open CV Studio</a>
        <button class="btn" id="activityClose" type="button">Close</button>
      </div>
    </div>
  </div>

  <!-- Scripts: order matters -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./auth.js"></script>
  <script src="./shared.js"></script>

  <script>
  (() => {
    "use strict";

    const S = window.JobMeJobShared || null;

    // Fallbacks (so one missing helper doesn't break the whole page)
    const F = {
      escapeHtml: (s) => String(s ?? "").replace(/[&<>"']/g, (c) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])),
      showModal: (id) => { const el = document.getElementById(id); if(el) el.style.display = "flex"; document.body.classList.add("modalOpen"); },
      hideModal: (id) => { const el = document.getElementById(id); if(el) el.style.display = "none"; document.body.classList.remove("modalOpen"); },
      showTopError: (id, msg) => {
        const el = document.getElementById(id);
        if(!el) return;
        if(!msg){ el.style.display = "none"; el.textContent = ""; return; }
        el.style.display = "block";
        el.textContent = String(msg);
      },
      setBadge: (id, cls, txt) => {
        const el = document.getElementById(id);
        if(!el) return;
        el.className = "badge" + (cls ? (" " + cls) : "");
        el.textContent = txt ?? "";
      },
      resolveApiBase: (x) => String(x || "").trim().replace(/\/+$/, ""),
      go: (url) => { window.location.href = url; }
    };

    const H = {
      escapeHtml: (S && S.escapeHtml) ? S.escapeHtml : F.escapeHtml,
      showModal: (S && S.showModal) ? S.showModal : F.showModal,
      hideModal: (S && S.hideModal) ? S.hideModal : F.hideModal,
      showTopError: (S && S.showTopError) ? S.showTopError : F.showTopError,
      setBadge: (S && S.setBadge) ? S.setBadge : F.setBadge,
      resolveApiBase: (S && S.resolveApiBase) ? S.resolveApiBase : F.resolveApiBase,
      wireNavTransitions: (S && S.wireNavTransitions) ? S.wireNavTransitions.bind(S) : (() => {}),
      go: (S && S.go) ? S.go.bind(S) : F.go
    };

    H.wireNavTransitions();

    const $ = (id) => document.getElementById(id);

    const API_BASE = H.resolveApiBase("https://jobmejob.schoene-viktor.workers.dev").replace(/\/+$/, "");

    let session = null;
    let lastSessionToken = "";

    let lastQueueResponse = null;
    let currentQueueCount = 0;
    let currentPlanDaily = 0;


    let currentQueueItems = [];
    let selectedJobId = "";
    const detailCache = new Map();
    let detailReqSeq = 0;

    let pendingDescJobId = "";
    let currentDescText = "";

    let pendingSkipJobId = "";

    // AI titles cached from backend
    let aiTitles = [];

    // CV summaries for ATS badge (best-effort)
    const tailorSummaryMap = new Map();

    function setText(id, txt){
      const el = $(id);
      if(el) el.textContent = (txt === undefined || txt === null) ? "" : String(txt);
    }
    function setHtml(id, html){
      const el = $(id);
      if(el) el.innerHTML = html || "";
    }

    function showError(msg){ H.showTopError("errorTop", msg); }

    async function apiGet(path, accessToken){
      const res = await fetch(API_BASE + path, {
        method: "GET",
        headers: { Authorization: "Bearer " + accessToken }
      });
      const text = await res.text().catch(() => "");
      let json = null;
      try{ json = JSON.parse(text); }catch{ json = { raw: text }; }
      if(!res.ok){
        const msg = (json && (json.error || json.message)) ? String(json.error || json.message) : (text || ("HTTP " + res.status));
        throw new Error(msg);
      }
      return json;
    }

    async function apiPost(path, accessToken, body){
      const res = await fetch(API_BASE + path, {
        method: "POST",
        headers: {
          Authorization: "Bearer " + accessToken,
          "content-type": "application/json"
        },
        body: JSON.stringify(body || {})
      });
      const text = await res.text().catch(() => "");
      let json = null;
      try{ json = JSON.parse(text); }catch{ json = { raw: text }; }
      if(!res.ok){
        const msg = (json && (json.error || json.message)) ? String(json.error || json.message) : (text || ("HTTP " + res.status));
        throw new Error(msg);
      }
      return json;
    }

    function planFromState(planId){
      const pid = String(planId || "").trim().toLowerCase();
      if(pid === "starter") return { id:"starter", name:"Starter", daily:1, short:"Starter (1/day)" };
      if(pid === "pro") return { id:"pro", name:"Growth", daily:5, short:"Growth (5/day)" };
      if(pid === "max") return { id:"max", name:"Max", daily:10, short:"Max (10/day)" };
      return { id:null, name:"No plan", daily:0, short:"No plan" };
    }

    function normalizeKeywordList(x){
      if(!x) return [];
      if(Array.isArray(x)) return x.map(v => String(v || "").trim()).filter(Boolean);
      if(typeof x === "string"){
        const s = x.trim();
        if(!s) return [];
        try{
          const j = JSON.parse(s);
          if(Array.isArray(j)) return j.map(v => String(v || "").trim()).filter(Boolean);
        }catch(_){ }
        return s.split(/[\n,;]+/).map(t => t.trim()).filter(Boolean);
      }
      return [];
    }

    function computeAtsMatchPercent(used, missing){
      const u = normalizeKeywordList(used);
      const m = normalizeKeywordList(missing);
      const denom = u.length + m.length;
      if(denom <= 0) return null;
      return Math.round((u.length / denom) * 100);
    }

    async function loadTailorSummariesForJobs(jobIds){
      tailorSummaryMap.clear();

      const ids = Array.isArray(jobIds) ? jobIds : [];
      const uniq = [...new Set(ids.map(x => String(x || "").trim()).filter(Boolean))];
      if(!uniq.length) return;

      const chunkSize = 40;
      for(let i = 0; i < uniq.length; i += chunkSize){
        const chunk = uniq.slice(i, i + chunkSize);
        try{
          const qs = "job_ids=" + encodeURIComponent(chunk.join(","));
          const res = await apiGet("/me/cv/tailored?" + qs, lastSessionToken);
          const rows = (res && Array.isArray(res.data)) ? res.data : [];
          for(const row of rows){
            if(row && row.job_id) tailorSummaryMap.set(String(row.job_id), row);
          }
        }catch(err){
          // best-effort only
          return;
        }
      }
    }

    function isSingleColumn(){
      return window.matchMedia && window.matchMedia("(max-width: 980px)").matches;
    }

    function daysAgo(ts){
      if(!ts) return null;
      let d = new Date(ts);
      if(Number.isNaN(d.getTime())){
        const m = String(ts).match(/^(\d{4}-\d{2}-\d{2})/);
        if(!m) return null;
        d = new Date(m[1] + "T00:00:00Z");
        if(Number.isNaN(d.getTime())) return null;
      }
      const diffMs = Date.now() - d.getTime();
      const days = Math.floor(diffMs / 86400000);
      return days < 0 ? 0 : days;
    }

    function rememberCvStudioSelection(jobId){
  const id = String(jobId || "");
  if(!id) return;
  try{ localStorage.setItem("cvstudio_job_source", "queue"); }catch(_){ }
  try{ localStorage.setItem("cvstudio_selected_job_id", id); }catch(_){ }
}

function goToCvStudio(jobId){
  const id = String(jobId || "");
  if(!id) return;
  rememberCvStudioSelection(id);

  // Direct navigation (most reliable). We still apply the tiny "leaving" hint if available.
  try{ document.body.classList.add("leaving"); }catch(_){}
  window.location.href = "./cv.html?job_id=" + encodeURIComponent(id);
}


    function renderQueueCards(queue){
      const items = Array.isArray(queue?.data) ? queue.data : (Array.isArray(queue?.jobs) ? queue.jobs : []);
      currentQueueItems = items;

      // Filter (client-side): title / company / location
      const q = (document.getElementById("queueSearch")?.value || "").trim().toLowerCase();
      const viewItems = q ? items.filter((j) => {
        const hay = [
          j?.title || "",
          j?.company_name || "",
          j?.city || "",
          j?.region || ""
        ].join(" ").toLowerCase();
        return hay.includes(q);
      }) : items;

      // Queue "showing" line
      try{
        const el = $("queueShowing");
        if(el){
          if(q){
            el.textContent = "Showing " + viewItems.length + " of " + items.length + " (filtered)";
          }else{
            const total = (typeof currentQueueCount === "number" && currentQueueCount) ? currentQueueCount : items.length;
            el.textContent = (items.length === total)
              ? ("Showing " + items.length + " jobs")
              : ("Showing " + items.length + " of " + total + " jobs");
          }
        }
      }catch(_){}

      if(!items.length){
        // Clear selection + details when empty
        selectedJobId = "";
        try{ localStorage.removeItem("jobs_selected_job_id"); }catch(_){ }
        renderDetailEmpty();

        return (
          '<div class="jobList">'
            + '<div class="jobRow" style="cursor:default">'
              + '<div class="jobRowTop">'
                + '<div class="jobRowTitle">No jobs in your queue yet</div>'
                + '<div class="badgeGroup"><span class="badge warn">Empty</span></div>'
              + '</div>'
              + '<div class="jobRowMeta"><span>Tip:</span><span>Complete your Profile and click “Fetch new jobs”.</span></div>'
              + '<div class="detailActions" style="margin-top:12px">'
                + '<a class="btn" href="./profile.html" data-nav="1">Open Profile</a>'
                + '<button class="btn primary" id="btnFetchInline" type="button">Fetch now</button>'
              + '</div>'
            + '</div>'
          + '</div>'
        );
      }

      if(q && !viewItems.length){
        return (
          '<div class="jobList">'
            + '<div class="jobRow" style="cursor:default">'
              + '<div class="jobRowTop">'
                + '<div class="jobRowTitle">No matching jobs</div>'
                + '<div class="badgeGroup"><span class="badge warn">0 results</span></div>'
              + '</div>'
              + '<div class="jobRowMeta"><span>Try a different search, or clear it.</span></div>'
              + '<div class="detailActions" style="margin-top:12px">'
                + '<button class="btn" type="button" data-clear-search="1">Clear search</button>'
              + '</div>'
            + '</div>'
          + '</div>'
        );
      }

      // Restore last selected job (or default to first)
      const stored = (() => { try{ return localStorage.getItem("jobs_selected_job_id") || ""; }catch(_){ return ""; } })();
      if(!selectedJobId && stored) selectedJobId = stored;

      const hasSelected = selectedJobId && items.some(j => String(j?.id || "") === String(selectedJobId));
      if(!hasSelected){
        selectedJobId = items[0]?.id ? String(items[0].id) : "";
        try{ localStorage.setItem("jobs_selected_job_id", selectedJobId); }catch(_){ }
      }

      // Ensure right pane shows the selected job (best-effort; no await here)
      if(selectedJobId){
        setTimeout(() => { selectJob(selectedJobId, { keepDetailScroll: true, fromRender: true }).catch(()=>{}); }, 0);
      }

const prioItems = viewItems.filter(j => !!(j && j._application && j._application.priority));
const otherItems = viewItems.filter(j => !(j && j._application && j._application.priority));
const hasPrio = prioItems.length > 0;

const renderRow = (j) => {
  const jobId = j.id ? String(j.id) : "";
  const title = String(j.title || "Untitled");
  const company = String(j.company_name || "—");
  const loc = [j.city || "", j.region || ""].filter(Boolean).join(", ") || "—";
  const posted = j.posted_at ? String(j.posted_at).slice(0, 10) : "—";

  const prio = !!(j._application && j._application.priority);
  const prioBadge = prio ? "<span class='badge prio'>♥ prio</span>" : "<span class='badge'>new</span>";

  const tSum = tailorSummaryMap.get(String(jobId));
  let atsBadge = "";
  if(tSum){
    const pct = computeAtsMatchPercent(tSum.ats_keywords_used, tSum.ats_keywords_missing);
    if(pct !== null){
      const cls = (pct >= 80) ? "good" : (pct >= 60 ? "warn" : "bad");
      atsBadge = "<span class='badge " + H.escapeHtml(cls) + "'>ATS " + H.escapeHtml(pct) + "%</span>";
    }else{
      atsBadge = "<span class='badge'>tailored</span>";
    }
  }

  const badge = "<div class='badgeGroup'>" + prioBadge + atsBadge + "</div>";

  const updatedDays = daysAgo(j.source_modified_at);
  const updatedLabel = (updatedDays === null)
    ? "Updated —"
    : (updatedDays === 0 ? "Updated today" : ("Updated " + updatedDays + "d ago"));

  const heartBtn = prio
    ? "<button class='iconBtn heartBtn on' type='button' data-unprio='" + H.escapeHtml(jobId) + "' aria-label='Remove priority' aria-pressed='true' title='Unprioritize'><span aria-hidden='true'>♥</span></button>"
    : "<button class='iconBtn heartBtn' type='button' data-prio='" + H.escapeHtml(jobId) + "' aria-label='Mark as priority' aria-pressed='false' title='Prioritize'><span aria-hidden='true'>♡</span></button>";

  const selectedCls = (String(jobId) === String(selectedJobId)) ? " selected" : "";

  return (
    '<div class="jobRow' + selectedCls + '" data-select="' + H.escapeHtml(jobId) + '" role="button" tabindex="0" aria-label="Select job">'
      + '<div class="jobRowTop">'
        + '<div class="jobRowTitle">' + H.escapeHtml(title) + '</div>'
        + '<div class="jobRowRight">' + badge + heartBtn + '</div>'
      + '</div>'
      + '<div class="jobRowMeta">'
        + '<span>' + H.escapeHtml(company) + '</span><span>•</span>'
        + '<span>' + H.escapeHtml(loc) + '</span><span>•</span>'
        + '<span>Posted ' + H.escapeHtml(posted) + '</span>'
        + (updatedLabel ? ('<span>•</span><span>' + H.escapeHtml(updatedLabel) + '</span>') : '')
      + '</div>'
    + '</div>'
  );
};

const prioHtml = prioItems.map(renderRow).join("");
const otherHtml = otherItems.map(renderRow).join("");

// Always render both containers (for smooth DOM moves); hide the Priority section if empty.
return (
  '<div class="jobList">'
    + '<div class="jobSection" id="prioSection"' + (hasPrio ? '' : ' style="display:none"') + '>'
      + '<div class="jobSectionHeader">'
        + '<div>Priority</div>'
        + '<span class="badge prio" id="prioCount">' + H.escapeHtml(String(prioItems.length)) + '</span>'
      + '</div>'
      + '<div class="jobSectionList" id="prioList">' + prioHtml + '</div>'
    + '</div>'
    + '<div class="jobSectionDivider" id="prioDivider"' + (hasPrio ? '' : ' style="display:none"') + '></div>'
    + '<div class="jobSection" id="allSection">'
      + '<div class="jobSectionHeader">'
        + '<div id="allLabel">' + (hasPrio ? 'Other jobs' : 'Jobs') + '</div>'
        + '<span class="badge" id="allCount">' + H.escapeHtml(String(otherItems.length)) + '</span>'
      + '</div>'
      + '<div class="jobSectionList" id="jobList">' + otherHtml + '</div>'
    + '</div>'
  + '</div>'
);
    }

    function wireQueueClicks(){
      const wrap = $("queueWrap");
      if(!wrap) return;

      wrap.addEventListener("click", async (e) => {
        // Inline fetch CTA inside empty state
        const inlineFetch = e.target && e.target.id === "btnFetchInline";
        if(inlineFetch){
          const b = $("btnFetchJobsNow");
          if(b) b.click();
          return;
        }

        const clearSearch = e.target && e.target.closest ? e.target.closest('[data-clear-search="1"]') : null;
        if(clearSearch){
          const qs = $("queueSearch");
          if(qs) qs.value = "";
          if(lastQueueResponse) setHtml("queueWrap", renderQueueCards(lastQueueResponse));
          return;
        }

        const prBtn = e.target && e.target.closest ? e.target.closest("button[data-prio], button[data-unprio]") : null;
        if(prBtn){
          const makePrio = prBtn.hasAttribute("data-prio");
          const jobId = makePrio ? (prBtn.getAttribute("data-prio") || "") : (prBtn.getAttribute("data-unprio") || "");
          if(!jobId) return;

          // Smooth: optimistic UI + reorder (no skeleton refresh)
          await onTogglePriority(jobId, makePrio, prBtn);
          return;
        }

const row = e.target && e.target.closest ? e.target.closest(".jobRow[data-select]") : null;
        if(row){
          const jobId = row.getAttribute("data-select") || "";
          if(jobId){
            await selectJob(jobId, { keepDetailScroll:false });
          }
          return;
        }

      });
    }

    
    /* -------------------------
       Details pane (right)
       ------------------------- */
    function renderDetailEmpty(){
      setText("detailHint", "Select a job on the left.");
      H.setBadge("detailBadge", "", "—");

      setHtml("detailWrap", (
        '<div class="detailEmpty">'
          + '<div class="detailEmptyTitle">Select a job</div>'
          + '<div class="small" style="margin-top:6px">Pick a job from the list to see its full description and tailor your CV.</div>'
          + '<div class="hr"></div>'
          + '<div class="row" style="justify-content:flex-start">'
            + '<a class="btn" href="./cv.html" data-nav="1">Open CV Studio</a>'
            + '<a class="btn ghost" href="./profile.html" data-nav="1">Open Profile</a>'
          + '</div>'
        + '</div>'
      ));
    }

    function findJobBase(jobId){
      const id = String(jobId || "");
      if(!id) return null;
      const j = currentQueueItems.find(x => String(x?.id || "") === id);
      return j || null;
    }

    function setSelectedJob(jobId){
      selectedJobId = String(jobId || "");
      if(!selectedJobId) return;
      try{ localStorage.setItem("jobs_selected_job_id", selectedJobId); }catch(_){ }
    }

    function highlightSelectedJob(){
      const wrap = $("queueWrap");
      if(!wrap) return;
      wrap.querySelectorAll(".jobRow[data-select]").forEach((el) => {
        const id = el.getAttribute("data-select") || "";
        el.classList.toggle("selected", String(id) === String(selectedJobId));
      });
    }

    
    /* -------------------------
       Priority (heart) — optimistic UI
       ------------------------- */

    function snapshotPriorityState(jobId){
      const id = String(jobId || "");
      const arr = Array.isArray(lastQueueResponse?.data) ? lastQueueResponse.data : currentQueueItems;
      const idx = Array.isArray(arr) ? arr.findIndex(j => String(j?.id || "") === id) : -1;
      const j = (idx >= 0 && Array.isArray(arr)) ? arr[idx] : findJobBase(id);
      const wasPrio = !!(j && j._application && j._application.priority);
      return { idx, wasPrio };
    }

    function setPriorityLocal(jobId, makePrio){
      const id = String(jobId || "");
      if(!id) return;

      // Update the in-memory job object (shared refs between currentQueueItems and lastQueueResponse.data)
      const j = findJobBase(id);
      if(j){
        j._application = j._application || {};
        j._application.priority = !!makePrio;
      }

      // Also ensure cached detail copy (if exists) matches, so the right pane doesn't drift
      try{
        const cached = detailCache.get(id);
        if(cached){
          cached._application = cached._application || {};
          cached._application.priority = !!makePrio;
        }
      }catch(_){}
    }

    function moveJobInData(jobId, makePrio){
      const id = String(jobId || "");
      const arr = Array.isArray(lastQueueResponse?.data) ? lastQueueResponse.data : null;
      if(!id || !Array.isArray(arr)) return;

      const idx = arr.findIndex(j => String(j?.id || "") === id);
      if(idx < 0) return;

      const [item] = arr.splice(idx, 1);

      if(makePrio){
        arr.unshift(item);
      }else{
        // Insert after all priority items (first non-prio index)
        let insertAt = arr.findIndex(j => !(j && j._application && j._application.priority));
        if(insertAt < 0) insertAt = arr.length;
        arr.splice(insertAt, 0, item);
      }

      currentQueueItems = arr;
    }

    function updateHeartButtonEl(btnEl, makePrio, jobId){
      if(!btnEl) return;

      // Always keep the base class
      btnEl.classList.toggle("on", !!makePrio);

      // Swap attributes so event delegation keeps working
      if(makePrio){
        btnEl.removeAttribute("data-prio");
        btnEl.setAttribute("data-unprio", String(jobId));
        btnEl.setAttribute("aria-label", "Remove priority");
        btnEl.setAttribute("aria-pressed", "true");
        btnEl.setAttribute("title", "Unprioritize");
        btnEl.innerHTML = "<span aria-hidden='true'>♥</span>";
      }else{
        btnEl.removeAttribute("data-unprio");
        btnEl.setAttribute("data-prio", String(jobId));
        btnEl.setAttribute("aria-label", "Mark as priority");
        btnEl.setAttribute("aria-pressed", "false");
        btnEl.setAttribute("title", "Prioritize");
        btnEl.innerHTML = "<span aria-hidden='true'>♡</span>";
      }
    }

    function updateRowPrioUI(jobId, makePrio, rowEl, btnEl){
      const row = rowEl || null;
      if(!row) return;

      // Badge group: first badge is always the prio/new badge
      try{
        const bg = row.querySelector(".badgeGroup");
        const first = bg ? bg.querySelector(".badge") : null;
        if(first){
          if(makePrio){
            first.className = "badge prio";
            first.textContent = "♥ prio";
          }else{
            first.className = "badge";
            first.textContent = "new";
          }
        }
      }catch(_){}

      // Heart button (use provided btnEl if possible)
      const heart = btnEl || row.querySelector("button.heartBtn");
      if(heart) updateHeartButtonEl(heart, makePrio, jobId);
    }

    function updateDetailPrioUI(jobId, makePrio, btnEl){
      if(String(selectedJobId) !== String(jobId)) return;

      try{
        H.setBadge("detailBadge", makePrio ? "prio" : "", makePrio ? "Priority" : "Ready");
      }catch(_){}

      const heart = btnEl || document.querySelector("#detailWrap button.heartBtn");
      if(heart) updateHeartButtonEl(heart, makePrio, jobId);
    }

    
function updateSectionVisibility(){
  const prioSection = document.getElementById("prioSection");
  const prioDivider = document.getElementById("prioDivider");
  const prioList = document.getElementById("prioList");
  const allList = document.getElementById("jobList");

  const prioCount = prioList ? prioList.querySelectorAll(".jobRow[data-select]").length : 0;
  const allCount = allList ? allList.querySelectorAll(".jobRow[data-select]").length : 0;

  const prioCountEl = document.getElementById("prioCount");
  const allCountEl = document.getElementById("allCount");
  const allLabelEl = document.getElementById("allLabel");

  if(prioCountEl) prioCountEl.textContent = String(prioCount);
  if(allCountEl) allCountEl.textContent = String(allCount);
  if(allLabelEl) allLabelEl.textContent = prioCount > 0 ? "Other jobs" : "Jobs";

  const showPrio = prioCount > 0;
  if(prioSection) prioSection.style.display = showPrio ? "" : "none";
  if(prioDivider) prioDivider.style.display = showPrio ? "" : "none";
}

function moveRowDom(jobId, makePrio, rowEl){
  const row = rowEl || null;
  if(!row) return;

  const prioList = document.getElementById("prioList");
  const allList = document.getElementById("jobList");
  if(!prioList || !allList) return;

  const first = row.getBoundingClientRect();

  if(makePrio){
    // Move into Priority section (pinned)
    prioList.insertBefore(row, prioList.firstChild);
  }else{
    // Move into normal list (top of “Other jobs”)
    allList.insertBefore(row, allList.firstChild);
  }

  updateSectionVisibility();

  const last = row.getBoundingClientRect();
  const dx = first.left - last.left;
  const dy = first.top - last.top;

  if((Math.abs(dx) > 0.5 || Math.abs(dy) > 0.5) && row.animate){
    row.animate(
      [
        { transform: `translate(${dx}px, ${dy}px)` },
        { transform: "translate(0, 0)" }
      ],
      { duration: 220, easing: "ease-out" }
    );
  }

  // Keep it visible (feels like it “pinned”)
  if(makePrio){
    try{ row.scrollIntoView({ behavior:"smooth", block:"nearest" }); }catch(_){}
  }
}

    function restorePrioritySnapshot(jobId, snap){
      const id = String(jobId || "");
      if(!id) return;

      // Restore flag
      setPriorityLocal(id, snap?.wasPrio);

      // Restore array order by index (best-effort)
      try{
        const arr = Array.isArray(lastQueueResponse?.data) ? lastQueueResponse.data : null;
        if(Array.isArray(arr) && typeof snap?.idx === "number" && snap.idx >= 0){
          const curIdx = arr.findIndex(j => String(j?.id || "") === id);
          if(curIdx >= 0 && curIdx !== snap.idx){
            const [item] = arr.splice(curIdx, 1);
            const target = Math.min(Math.max(0, snap.idx), arr.length);
            arr.splice(target, 0, item);
          }
          currentQueueItems = arr;
        }
      }catch(_){}

      // Re-render list (no network, no skeleton) to ensure badges/hearts match
      try{
        if(lastQueueResponse){
          setHtml("queueWrap", renderQueueCards(lastQueueResponse));
          highlightSelectedJob();
        }
      }catch(_){}

      // Update detail badge/heart
      try{ updateDetailPrioUI(id, !!(snap && snap.wasPrio)); }catch(_){}
    }

    async function onTogglePriority(jobId, makePrio, btnEl){
      const id = String(jobId || "");
      if(!id) return;

      showError("");

      const snap = snapshotPriorityState(id);

      // Identify the row in the list (even if click happened in the right pane)
      let rowEl = null;
      try{
        rowEl = btnEl && btnEl.closest ? btnEl.closest(".jobRow[data-select]") : null;
        if(!rowEl){
          // Best-effort: find row by job id
          rowEl = document.querySelector('.jobRow[data-select="' + CSS.escape(id) + '"]');
        }
      }catch(_){
        try{ rowEl = document.querySelector('.jobRow[data-select="' + id.replace(/"/g, "") + '"]'); }catch(__){}
      }

      // Optimistic UI (instant)
      try{
        setPriorityLocal(id, makePrio);
        moveJobInData(id, makePrio);

        // Update list row UI + move it
        if(rowEl){
          updateRowPrioUI(id, makePrio, rowEl, (btnEl && btnEl.closest && btnEl.closest("#queueWrap")) ? btnEl : null);
          moveRowDom(id, makePrio, rowEl);
        }

        // Update right pane badge + heart (if selected)
        updateDetailPrioUI(id, makePrio, (btnEl && btnEl.closest && btnEl.closest("#detailWrap")) ? btnEl : null);
      }catch(_){}

      // Persist to backend (no full refresh)
      try{
        const endpoint = makePrio ? "/me/applications/prioritize" : "/me/applications/unprioritize";
        await apiPost(endpoint, lastSessionToken, { job_id: id });
      }catch(err){
        // Revert locally (still no network)
        restorePrioritySnapshot(id, snap);

        // Error UX
        H.toast?.("Could not save priority. Please try again.", { kind:"bad", title:"Error" });
        showError(err?.message || String(err));
      }
    }

function renderDetailLoading(baseJob){
      const title = baseJob?.title ? String(baseJob.title) : "Loading…";
      const company = baseJob?.company_name ? String(baseJob.company_name) : "—";
      const loc = [baseJob?.city || "", baseJob?.region || ""].filter(Boolean).join(", ") || "—";
      const posted = baseJob?.posted_at ? String(baseJob.posted_at).slice(0,10) : "—";

      setText("detailHint", "Loading description…");
      H.setBadge("detailBadge", "warn", "Loading");

      setHtml("detailWrap", (
        '<div>'
          + '<div class="detailHeaderTop">'
            + '<div>'
              + '<div class="detailTitle">' + H.escapeHtml(title) + '</div>'
              + '<div class="detailMeta">'
                + '<span>' + H.escapeHtml(company) + '</span><span>•</span>'
                + '<span>' + H.escapeHtml(loc) + '</span><span>•</span>'
                + '<span>Posted ' + H.escapeHtml(posted) + '</span>'
              + '</div>'
            + '</div>'
          + '</div>'
          + '<div class="detailActions">'
            + '<div class="skeleton line" style="width:180px"></div>'
            + '<div class="skeleton line" style="width:140px"></div>'
            + '<div class="skeleton line" style="width:90px"></div>'
          + '</div>'
          + '<div class="hr"></div>'
          + '<div class="small">About the job</div>'
          + '<div class="skeleton tall" style="margin-top:10px"></div>'
        + '</div>'
      ));
    }

    function renderDetail(jobId, baseJob, fullJob){
      const j = fullJob || baseJob || {};
      const title = j?.title ? String(j.title) : "Untitled";
      const company = j?.company_name ? String(j.company_name) : "—";
      const loc = [j?.city || "", j?.region || ""].filter(Boolean).join(", ") || "—";
      const posted = j?.posted_at ? String(j.posted_at).slice(0,10) : "—";
      const applyUrl = j?.apply_url ? String(j.apply_url) : "";

      const prio = !!(j?._application && j._application.priority) || !!(baseJob?._application && baseJob._application.priority);
      const heartBtn = prio
        ? "<button class='iconBtn heartBtn on' type='button' data-unprio='" + H.escapeHtml(String(jobId)) + "' aria-label='Remove priority' aria-pressed='true' title='Unprioritize'><span aria-hidden='true'>♥</span></button>"
        : "<button class='iconBtn heartBtn' type='button' data-prio='" + H.escapeHtml(String(jobId)) + "' aria-label='Mark as priority' aria-pressed='false' title='Prioritize'><span aria-hidden='true'>♡</span></button>";

      const source = j?.description_full_source ? String(j.description_full_source) : "";
      const fetchedAt = j?.description_full_fetched_at ? String(j.description_full_fetched_at) : "";

      function stripHtml(html){
        const div = document.createElement("div");
        div.innerHTML = String(html || "");
        return (div.textContent || div.innerText || "").replace(/\s+\n/g,"\n").replace(/[ \t]+\n/g,"\n").replace(/\n{3,}/g,"\n\n").trim();
      }

      // Prefer stored full text, then fallbacks (some sources store different fields)
      const rawText =
        (j && (j.description_full || j.description_text || j.description || j.description_raw || "")) || "";

      let descText = String(rawText || "").trim();

      if(!descText && j && j.description_html){
        descText = stripHtml(j.description_html);
      }

      const hasDesc = !!descText && descText.replace(/\s+/g," ").length >= 80;

      // If backend reported an error fetching full description, keep it in debug but don't pretend it's a JD.
      const fetchError = (j && j.description_full_error) ? String(j.description_full_error) : "";

      currentDescText = hasDesc ? descText : "";

      setText("detailHint", "Selected job");
      H.setBadge("detailBadge", prio ? "prio" : "", prio ? "Priority" : "Ready");

      const openOriginalBtn = applyUrl
        ? ('<a class="btn ghost" href="' + H.escapeHtml(applyUrl) + '" target="_blank" rel="noopener">Open original ↗</a>')
        : "";

      setHtml("detailWrap", (
        '<div>'
          + '<div class="detailHeaderTop">'
            + '<div style="min-width:260px">'
              + '<div class="detailTitle">' + H.escapeHtml(title) + '</div>'
              + '<div class="detailMeta">'
                + '<span>' + H.escapeHtml(company) + '</span><span>•</span>'
                + '<span>' + H.escapeHtml(loc) + '</span><span>•</span>'
                + '<span>Posted ' + H.escapeHtml(posted) + '</span>'
                + (source ? ('<span>•</span><span>Source: ' + H.escapeHtml(source) + '</span>') : '')
                + (fetchedAt ? ('<span>•</span><span>Fetched: ' + H.escapeHtml(fetchedAt) + '</span>') : '')
              + '</div>'
            + '</div>'
            + '<div class="row" style="justify-content:flex-end">' + heartBtn + '</div>'
          + '</div>'

          + '<div class="detailActions">'
            + '<a class="btn primary" href="' + H.escapeHtml("./cv.html?job_id=" + encodeURIComponent(jobId)) + '" data-tailor="' + H.escapeHtml(String(jobId)) + '">Tailor in CV Studio</a>'
            + (hasDesc ? '<button class="btn ghost" type="button" data-copydesc="1">Copy description</button>' : '<button class="btn ghost" type="button" disabled title="No description available">Copy description</button>')
            + openOriginalBtn
            + '<button class="btn danger" type="button" data-skip="' + H.escapeHtml(String(jobId)) + '">Skip</button>'
          + '</div>'

          + '<div class="skipInlineNote">Skipped jobs will be excluded from Auto‑Apply once you activate a plan (coming soon).</div>'

          + '<div class="hr"></div>'
          + '<div class="small" style="font-weight:950;color:rgba(17,19,24,.70)">About the job</div>'
          + (hasDesc
              ? ('<div class="descBox" id="detailDesc">' + H.escapeHtml(descText) + '</div>')
              : ('<div class="descBox" id="detailDesc">'
                    + '<div style="font-weight:950">No description available</div>'
                    + '<div class="small" style="margin-top:6px">Some job sources do not provide a full description. Click “Open original ↗” and paste it into CV Studio.</div>'
                    + (fetchError ? ('<div class="small" style="margin-top:8px">Last fetch error: <span class="mono">' + H.escapeHtml(fetchError) + '</span></div>') : '')
                 + '</div>'))
        + '</div>'
      ));
    }

    async function ensureDetail(jobId, opts = {}){
      const id = String(jobId || "");
      if(!id){
        renderDetailEmpty();
        return;
      }

      const base = findJobBase(id);
      if(!opts.keepDetailScroll){
        try{ const ds = $("detailScroll"); if(ds) ds.scrollTop = 0; }catch(_){ }
      }

      // show quick skeleton (with base info)
      renderDetailLoading(base);

      const seq = ++detailReqSeq;

      try{
        let cached = detailCache.get(id);
        if(!cached){
          cached = await apiGet("/me/jobs/description?job_id=" + encodeURIComponent(id), lastSessionToken);
          detailCache.set(id, cached);
        }

        if(seq !== detailReqSeq) return; // stale response

        const fullJob = cached && cached.job ? cached.job : null;
        renderDetail(id, base, fullJob);
      }catch(err){
        if(seq !== detailReqSeq) return;
        setText("detailHint", "Failed to load details");
        H.setBadge("detailBadge", "bad", "Error");
        setHtml("detailWrap", (
          '<div class="detailEmpty">'
            + '<div class="detailEmptyTitle">Could not load job description</div>'
            + '<div class="small" style="margin-top:6px">' + H.escapeHtml(err?.message || String(err)) + '</div>'
            + '<div class="hr"></div>'
            + '<button class="btn" type="button" data-retry-detail="' + H.escapeHtml(id) + '">Retry</button>'
          + '</div>'
        ));
      }
    }

    async function selectJob(jobId, opts = {}){
      const id = String(jobId || "");
      if(!id){
        selectedJobId = "";
        renderDetailEmpty();
        return;
      }
      setSelectedJob(id);
      highlightSelectedJob();
      await ensureDetail(id, { keepDetailScroll: !!opts.keepDetailScroll });
    }

    function wireDetailClicks(){
      const wrap = $("detailWrap");
      if(!wrap || wireDetailClicks.__wired) return;
      wireDetailClicks.__wired = true;

      wrap.addEventListener("click", async (e) => {
        const retry = e.target.closest("button[data-retry-detail]");
        if(retry){
          const id = retry.getAttribute("data-retry-detail") || "";
          if(id) await ensureDetail(id, { keepDetailScroll:false });
          return;
        }

        const tl = e.target.closest("a[data-tailor], button[data-tailor]");
        if(tl){
          const id = tl.getAttribute("data-tailor") || selectedJobId;
          if(id) rememberCvStudioSelection(id);
          // If it is a real link, let the browser navigate (no preventDefault). If it's a button, navigate here.
          if(id && tl.tagName !== "A") goToCvStudio(id);
          return;
        }

        const cp = e.target.closest("button[data-copydesc]");
        if(cp){
          const t = currentDescText || "";
          if(!t){
            H.toast?.("Nothing to copy yet.", { kind:"warn", title:"Copy" });
            return;
          }
          const ok = await (H.copyToClipboard ? H.copyToClipboard(t) : navigator.clipboard.writeText(t).then(()=>true).catch(()=>false));
          if(ok) H.toast?.("Job description copied.", { kind:"good", title:"Copied" });
          else window.prompt("Copy description:", t);
          return;
        }

        const skip = e.target.closest("button[data-skip]");
        if(skip){
          const id = skip.getAttribute("data-skip") || "";
          if(id) openSkipModal(id);
          return;
        }

        const prBtn = e.target && e.target.closest ? e.target.closest("button[data-prio], button[data-unprio]") : null;
        if(prBtn){
          const makePrio = prBtn.hasAttribute("data-prio");
          const jobId = makePrio ? (prBtn.getAttribute("data-prio") || "") : (prBtn.getAttribute("data-unprio") || "");
          if(!jobId) return;

          await onTogglePriority(jobId, makePrio, prBtn);
          return;
        }

      });
    }

/* -------------------------
       Description modal
       ------------------------- */
    function openDescModal(jobId){
      pendingDescJobId = jobId;
      currentDescText = "";
      setText("descTitle", "Job description");
      setText("descMeta", "");
      setText("descBody", "Loading…");
      H.showModal("descModal");
      try{ const ms = document.querySelector('#descModal .modalScroll'); if(ms) ms.scrollTop = 0; }catch(_){ }
      loadDesc(jobId).catch((e) => {
        setText("descBody", "Failed to load description: " + (e?.message || String(e)));
      });
    }

    function closeDescModal(){
      pendingDescJobId = "";
      H.hideModal("descModal");
    }

    async function loadDesc(jobId){
      const resp = await apiGet("/me/jobs/description?job_id=" + encodeURIComponent(jobId), lastSessionToken);
      const job = resp && resp.job ? resp.job : null;
      const title = (job && job.title) ? String(job.title) : "Job description";
      const company = (job && job.company_name) ? String(job.company_name) : "";
      const source = (job && job.description_full_source) ? String(job.description_full_source) : "";
      const fetchedAt = (job && job.description_full_fetched_at) ? String(job.description_full_fetched_at) : "";

      setText("descTitle", title);
      setText("descMeta", [company ? ("Company: " + company) : "", source ? ("Source: " + source) : "", fetchedAt ? ("Fetched: " + fetchedAt) : ""].filter(Boolean).join(" · "));

      const text = (job && job.description_full) ? String(job.description_full) : "";
      currentDescText = text;

      if(text){
        setText("descBody", text);
      }else if(job && job.description_full_error){
        setText("descBody", "No description yet. Last error: " + String(job.description_full_error));
      }else{
        setText("descBody", "No description found.");
      }
    }

    async function copyDesc(){
      const t = String(currentDescText || "").trim();
      if(!t){
        // If there is no description, copying should not mislead the user.
        try{
          if(H && typeof H.showTopError === "function"){
            H.showTopError("errorTop", "No description to copy for this job. Open the original posting and paste the description into CV Studio.");
            setTimeout(() => { try{ H.showTopError("errorTop",""); }catch(_){ } }, 3500);
          }else{
            alert("No description to copy. Open original and paste into CV Studio.");
          }
        }catch(_){ }
        return;
      }

      try{
        if(S && typeof S.copyToClipboard === "function"){
          const ok = await S.copyToClipboard(t);
          if(ok && S.toast) S.toast("Description copied.", { kind:"good", ms: 1800 });
          else alert("Description copied.");
          return;
        }

        await navigator.clipboard.writeText(t);
        alert("Description copied.");
      }catch(_){
        window.prompt("Copy description:", t);
      }
    }

    /* -------------------------
       Skip modal
       ------------------------- */
    function openSkipModal(jobId){
      pendingSkipJobId = jobId;
      const reason = $("skipReason");
      const note = $("skipNote");
      const guard = $("skipGuardrail");
      if(reason) reason.value = "not_relevant";
      if(note) note.value = "";
      if(guard){ guard.style.display = "none"; guard.textContent = ""; }
      H.showModal("skipModal");
    }

    function closeSkipModal(){
      pendingSkipJobId = "";
      H.hideModal("skipModal");
    }

    async function submitSkip(){
      if(!pendingSkipJobId) return;

      // Guardrail (soft): avoid emptying the queue too hard if a plan is active
      const minSupply = Math.max(5, currentPlanDaily * 3);
      if(currentPlanDaily > 0 && currentQueueCount <= minSupply){
        const el = $("skipGuardrail");
        if(el){
          el.style.display = "block";
          el.style.color = "rgba(184,107,0,.95)";
          el.textContent = "Skipping is limited because your queue is getting low. Fetch more jobs or broaden your titles / radius.";
        }
        closeSkipModal();
        return;
      }

      const reason_code = String($("skipReason")?.value || "not_relevant");
      const reason_note = String($("skipNote")?.value || "").trim();

      try{
        await apiPost("/me/applications/skip", lastSessionToken, {
          job_id: pendingSkipJobId,
          reason_code,
          reason_note
        });
        closeSkipModal();
        await refreshQueue();
      }catch(e){
        closeSkipModal();
        showError(e?.message || String(e));
      }
    }

    /* -------------------------
       Fetch new jobs
       ------------------------- */
    const FETCH_COOLDOWN_MS = 10 * 60 * 1000;

    function getNextFetchAllowedAt(){
      try{
        const raw = localStorage.getItem("jm_last_manual_fetch_ts") || "";
        const v = Number(raw || "0");
        if(!v || !Number.isFinite(v)) return 0;
        return v + FETCH_COOLDOWN_MS;
      }catch(_){
        return 0;
      }
    }

    function updateFetchMetaUI(){
      const meta = $("fetchMeta");
      if(!meta) return;
      try{
        const raw = localStorage.getItem("jm_last_manual_fetch_ts") || "";
        const lastTs = Number(raw || "0");
        if(!lastTs){
          meta.textContent = "Tip: fetch jobs after your Profile is complete.";
          return;
        }
        const last = new Date(lastTs).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
        const next = lastTs + FETCH_COOLDOWN_MS;
        const now = Date.now();

        if(now < next){
          const sec = Math.ceil((next - now) / 1000);
          const min = Math.floor(sec / 60);
          const s = sec % 60;
          meta.textContent = "Last fetch: " + last + " · Next fetch in " + min + ":" + String(s).padStart(2, "0");
        }else{
          meta.textContent = "Last fetch: " + last + " · You can fetch again now";
        }
      }catch(_){
        meta.textContent = "";
      }
    }

    function getAiTitlesForFetch(){
      const out = [];
      const seen = new Set();

      const push = (t) => {
        const s = String(t || "").trim();
        if(!s) return;
        const k = s.toLowerCase();
        if(seen.has(k)) return;
        seen.add(k);
        out.push(s);
      };

      // Prefer server
      if(Array.isArray(aiTitles)){
        for(const t of aiTitles) push(t);
      }

      // Fallback: cached
      if(!out.length){
        try{
          const raw = localStorage.getItem("jm_ai_titles_server") || localStorage.getItem("ja_ai_titles_server") || "[]";
          const arr = JSON.parse(raw);
          if(Array.isArray(arr)) for(const t of arr) push(t);
        }catch(_){ }
      }

      return out;
    }

    function updateAiSwitchState(){
      const toggle = $("toggleAiOnly");
      const hint = $("aiSwitchHint");
      const badge = $("badgeAi");

      const titles = getAiTitlesForFetch();
      const available = titles.length > 0;

      if(toggle){
        toggle.disabled = !available;
        if(!available) toggle.checked = false;
      }

      if(hint) hint.style.display = available ? "none" : "block";
      if(badge) H.setBadge("badgeAi", available ? "good" : "warn", available ? (titles.length + " titles") : "Locked");
    }

    async function manualFetchJobs(){
      const btn = $("btnFetchJobsNow");
      const status = $("fetchJobsStatus");
      const toggle = $("toggleAiOnly");

      const setState = (loading, msg) => {
        if(btn){
          btn.disabled = !!loading;
          btn.textContent = loading ? "Fetching…" : "Fetch new jobs";
        }
        if(status) status.textContent = msg || "";
      };

      try{
        const next = getNextFetchAllowedAt();
        if(next && Date.now() < next){
          const sec = Math.ceil((next - Date.now()) / 1000);
          setState(false, "Please wait " + sec + "s before fetching again.");
          updateFetchMetaUI();
          return;
        }

        if(!lastSessionToken){
          throw new Error("No session token. Please sign in again.");
        }

        // Start cooldown immediately (avoid double-click spamming)
        try{ localStorage.setItem("jm_last_manual_fetch_ts", String(Date.now())); }catch(_){ }
        updateFetchMetaUI();

        const aiOnly = !!(toggle && toggle.checked);
        const titles = aiOnly ? getAiTitlesForFetch() : [];

        setState(true, aiOnly ? "Fetching (AI titles only)…" : "Fetching…");

        const resp = await apiPost("/me/jobs/fetch", lastSessionToken, {
          include_ai_titles: aiOnly,
          ai_titles: titles,
          fetch_mode: aiOnly ? "ai_only" : "profile"
        });

        if(resp && resp.skipped){
          if(resp.reason === "queue_full"){
            setState(false, "Skipped: queue has " + resp.queue_new_count + " new jobs (cap " + resp.max_queue_new + ").");
          }else{
            setState(false, "Skipped: " + String(resp.reason || ""));
          }
          await refreshQueue();
          return;
        }

        const added = (typeof resp.jobs_added === "number") ? resp.jobs_added : 0;
        const q = (typeof resp.queue_new_count === "number") ? resp.queue_new_count : "—";
        const rad = (resp.used_radius !== undefined && resp.used_radius !== null) ? resp.used_radius : "—";
        const ml = (resp.match_level !== undefined && resp.match_level !== null) ? resp.match_level : "—";

        setState(false, "Added " + added + " · Queue new: " + q + " · Radius " + rad + "km · Match " + ml);

        await refreshQueue();
      }catch(e){
        setState(false, e?.message || "Fetch failed");
        showError(e?.message || "Fetch failed");
      }finally{
        updateFetchMetaUI();
      }
    }

    /* -------------------------
       Refresh queue
       ------------------------- */
    async function refreshQueue(){
      const qScroll = $("queueScroll");
      const prevScrollTop = qScroll ? qScroll.scrollTop : null;
      showError("");
      setHtml("queueError", "");
      setHtml("queueWrap", '<div class="skeleton block"></div>');

      // Try to fetch a bigger chunk so the list can show your full queue (e.g. 200)
      let queue = null;
      try{
        queue = await apiGet("/me/jobs/queue?limit=250", lastSessionToken);
      }catch(_){
        queue = await apiGet("/me/jobs/queue", lastSessionToken);
      }

      // If API reports more than it returned, try once more with the exact count (best-effort)
      try{
        const got = Array.isArray(queue?.data) ? queue.data.length : 0;
        const cnt = (typeof queue?.count === "number") ? queue.count : 0;
        if(cnt && got && got < cnt && cnt <= 600){
          const bigger = await apiGet("/me/jobs/queue?limit=" + encodeURIComponent(String(cnt)), lastSessionToken);
          const got2 = Array.isArray(bigger?.data) ? bigger.data.length : 0;
          if(got2 > got) queue = bigger;
        }
      }catch(_){ }

      lastQueueResponse = queue;

      const qCount = (typeof queue.count === "number") ? queue.count : (Array.isArray(queue.data) ? queue.data.length : 0);
      currentQueueCount = qCount;

      H.setBadge("badgeQueue", qCount > 0 ? "good" : "warn", (qCount > 0 ? (qCount + " jobs") : "Empty"));

      // Tailor summaries (ATS badge) - best effort
      try{
        const ids = Array.isArray(queue.data) ? queue.data.map(j => j && j.id).filter(Boolean) : [];
        await loadTailorSummariesForJobs(ids);
      }catch(_){ }

      setHtml("queueWrap", renderQueueCards(queue));

      // Restore scroll position (better UX when you prio/skip in a long list)
      if(prevScrollTop !== null){
        try{ qScroll.scrollTop = prevScrollTop; }catch(_){ }
      }

      // Wire inline fetch if queue is empty (after we re-render)
      // (No-op if the element doesn't exist)
      updateFetchMetaUI();

      return queue;
    }

    /* -------------------------
       Nav: Activity log modal
       ------------------------- */
    function activityBadge(type){
      const t = String(type || "").toLowerCase();
      if(t === "applied") return { cls:"good", label:"Applied" };
      if(t === "sent") return { cls:"good", label:"Sent" };
      if(t === "rejected") return { cls:"bad", label:"Rejected" };
      if(t === "skipped") return { cls:"warn", label:"Skipped" };
      if(t === "prioritized") return { cls:"prio", label:"Prioritized" };
      if(t === "queued") return { cls:"warn", label:"Queued" };
      if(t === "new") return { cls:"warn", label:"New" };
      return { cls:"", label:(type || "Event") };
    }

    function fmtWhen(ts){
      try{
        if(!ts) return "—";
        const d = new Date(ts);
        if(Number.isNaN(d.getTime())) return String(ts);
        return d.toLocaleString();
      }catch(_){
        return String(ts || "—");
      }
    }

    function renderActivityList(items, kind){
      const arr = Array.isArray(items) ? items : [];
      if(!arr.length){
        return '<span class="badge warn">No activity yet</span>';
      }

      const html = arr.slice(0, 20).map((row) => {
        const evType = kind === "applications" ? String(row.status || "new") : String(row.event_type || "");
        const b = activityBadge(evType);

        const job = (row && row.job) ? row.job : {};
        const title = String(job.title || "Untitled");
        const company = String(job.company_name || job.company || "—");
        const loc = [job.city || "", job.region || ""].filter(Boolean).join(", ") || "—";
        const when = kind === "applications" ? (row.updated_at || row.created_at) : row.created_at;
        const link = job.apply_url ? String(job.apply_url) : "";

        const titleHtml = link
          ? ('<a href="' + H.escapeHtml(link) + '" target="_blank" rel="noopener">' + H.escapeHtml(title) + "</a>")
          : H.escapeHtml(title);

        let meta = "";
        try{
          if(kind !== "applications" && row.meta && typeof row.meta === "object"){
            if(row.meta.channel) meta = "via " + String(row.meta.channel);
            if(row.meta.reason_code) meta = meta ? (meta + " • reason: " + String(row.meta.reason_code)) : ("reason: " + String(row.meta.reason_code));
          }
        }catch(_){ }

        return (
          '<div class="activityItem">'
            + '<div class="activityTop">'
              + '<div class="activityTitle">' + titleHtml + '</div>'
              + '<span class="badge ' + H.escapeHtml(b.cls) + '">' + H.escapeHtml(b.label) + '</span>'
            + '</div>'
            + '<div class="activityMeta">'
              + '<span>' + H.escapeHtml(company) + '</span>'
              + '<span>•</span>'
              + '<span>' + H.escapeHtml(loc) + '</span>'
              + '<span>•</span>'
              + '<span>' + H.escapeHtml(fmtWhen(when)) + '</span>'
              + (meta ? ('<span class="mono">• ' + H.escapeHtml(meta) + '</span>') : '')
            + '</div>'
          + '</div>'
        );
      }).join("");

      return '<div class="activityList">' + html + '</div>';
    }

    async function loadActivityLog(){
      H.showTopError("activityError", "");
      setHtml("activityWrap", '<div class="modalMonoBox">Loading…</div>');

      const token = session && session.access_token ? String(session.access_token) : "";
      if(!token){
        H.showTopError("activityError", "You are signed out. Please sign in again.");
        setHtml("activityWrap", "");
        return;
      }

      const et = String($("activityFilter")?.value || "").trim();
      const headers = { Authorization: "Bearer " + token };

      // 1) Try timeline endpoint first
      try{
        let url = API_BASE + "/me/application-events?limit=20";
        if(et) url += "&event_type=" + encodeURIComponent(et);

        const res = await fetch(url, { method:"GET", headers });
        const text = await res.text().catch(() => "");
        let json = null;
        try{ json = JSON.parse(text); }catch{ json = { raw: text }; }

        if(!res.ok){
          const msg = (json && (json.error || json.message)) ? String(json.error || json.message) : (text || ("HTTP " + res.status));
          throw new Error(msg);
        }

        const items = Array.isArray(json?.data) ? json.data : [];
        setHtml("activityWrap", renderActivityList(items, "events"));
        return;
      }catch(_){
        // fallback below
      }

      // 2) Fallback: applications list
      try{
        const map = { queued:"new", prioritized:"new", applied:"applied", rejected:"rejected", skipped:"skipped", sent:"applied" };
        let url = API_BASE + "/me/applications?limit=20";
        if(et && map[et]) url += "&status=" + encodeURIComponent(map[et]);

        const res = await fetch(url, { method:"GET", headers });
        const text = await res.text().catch(() => "");
        let json = null;
        try{ json = JSON.parse(text); }catch{ json = { raw: text }; }

        if(!res.ok){
          const msg = (json && (json.error || json.message)) ? String(json.error || json.message) : (text || ("HTTP " + res.status));
          throw new Error(msg);
        }

        const items = Array.isArray(json?.data) ? json.data : [];
        setHtml("activityWrap", renderActivityList(items, "applications"));
      }catch(e){
        H.showTopError("activityError", e?.message || String(e));
        setHtml("activityWrap", '<span class="badge bad">Activity failed</span>');
      }
    }

    function openActivityModal(){
      const dd = $("navAccount");
      if(dd) dd.open = false;
      H.showModal("activityModal");
      loadActivityLog().catch((e) => H.showTopError("activityError", e?.message || String(e)));
    }

    function closeActivityModal(){
      H.hideModal("activityModal");
      H.showTopError("activityError", "");
    }

    /* -------------------------
       Boot
       ------------------------- */
    async function loadStateAndNav(){
      H.setBadge("authBadge", "warn", "Checking…");

      // Sanity check: auth.js must be present
      if(!window.JobApplyAI || !window.JobApplyAI.auth || typeof window.JobApplyAI.auth.getSession !== "function"){
        H.setBadge("authBadge", "bad", "Config error");
        showError("auth.js did not load. Ensure multipage/auth.js exists and is referenced as ./auth.js.");
        return null;
      }

      session = await window.JobApplyAI.auth.getSession();
      if(!session || !session.user || !session.user.email){
        H.setBadge("authBadge", "warn", "Signed out");
        window.location.replace("./signup.html");
        return null;
      }

      lastSessionToken = String(session.access_token || "");
      try{ if(lastSessionToken) sessionStorage.setItem("sb_access_token", lastSessionToken); }catch(_){ }

      // Nav state
      const navAcct = $("navAccount");
      if(navAcct) navAcct.style.display = "";
      const navSignIn = $("navSignIn");
      if(navSignIn) navSignIn.style.display = "none";

      H.setBadge("authBadge", "good", "Signed in");

      // Ensure customer exists (best-effort)
      try{ await window.JobApplyAI.auth.requireAuthAndCustomer({ redirectTo: "./signup.html" }); }catch(_){ }
      try{ await window.JobApplyAI.auth.syncStateToLocalStorage(session); }catch(_){ }

      return session;
    }

    async function loadAccountHints(){
      // AI titles from server for the fetch toggle
      try{
        const prof = await apiGet("/me/profile", lastSessionToken);
        const a = (prof && prof.profile && Array.isArray(prof.profile.ai_titles)) ? prof.profile.ai_titles : [];
        aiTitles = Array.isArray(a) ? a : [];
        try{ localStorage.setItem("jm_ai_titles_server", JSON.stringify(aiTitles)); }catch(_){ }
      }catch(_){
        aiTitles = [];
      }

      // State for onboarding hint + plan daily
      try{
        const st = await apiGet("/me/state", lastSessionToken);
        const profileOk = !!(st && st.profile_complete);
        const cvOk = !!(st && st.cv_uploaded);
        const plan = planFromState(st && st.plan_id);
        currentPlanDaily = plan.daily;

        if(!profileOk || !cvOk){
          setText("onboardingHint", "Your Profile is not complete yet. Go to Profile, upload your CV, then come back to fetch jobs.");
        }else{
          setText("onboardingHint", "Profile looks good. Fetch jobs, then tailor your CV per job.");
        }
      }catch(_){
        setText("onboardingHint", "You can fetch jobs after your Profile is complete.");
      }

      updateAiSwitchState();
      updateFetchMetaUI();
    }

    async function boot(){
      showError("");
      await loadStateAndNav();
      if(!session) return;

      await loadAccountHints();
      wireQueueClicks();
      wireDetailClicks();

      // Initial data
      await refreshQueue();
    }

    /* -------------------------
       Wire UI events
       ------------------------- */
    $("btnRefresh")?.addEventListener("click", () => {
      refreshQueue().catch((e) => showError(e?.message || String(e)));
    });

    $("queueSearch")?.addEventListener("input", () => {
      if(!lastQueueResponse) return;
      setHtml("queueWrap", renderQueueCards(lastQueueResponse));
    });

    $("queueSearch")?.addEventListener("keydown", (e) => {
      if(e.key === "Escape"){
        const qs = $("queueSearch");
        if(qs) qs.value = "";
        if(lastQueueResponse) setHtml("queueWrap", renderQueueCards(lastQueueResponse));
      }
    });


    $("btnFetchJobsNow")?.addEventListener("click", () => {
      manualFetchJobs().catch((e) => showError(e?.message || String(e)));
    });

    $("toggleAiOnly")?.addEventListener("change", () => {
      // Keep the badge fresh
      updateAiSwitchState();
    });

    // Description modal wiring
    $("descCloseX")?.addEventListener("click", closeDescModal);
    $("descClose")?.addEventListener("click", closeDescModal);
    $("descCopy")?.addEventListener("click", copyDesc);
    $("descModal")?.addEventListener("click", (e) => { if(e.target && e.target.id === "descModal") closeDescModal(); });

    // Skip modal wiring
    $("skipCloseX")?.addEventListener("click", closeSkipModal);
    $("skipCancel")?.addEventListener("click", closeSkipModal);
    $("skipConfirm")?.addEventListener("click", submitSkip);
    $("skipModal")?.addEventListener("click", (e) => { if(e.target && e.target.id === "skipModal") closeSkipModal(); });

    // Activity modal wiring
    $("navActivity")?.addEventListener("click", openActivityModal);
    $("activityCloseX")?.addEventListener("click", closeActivityModal);
    $("activityClose")?.addEventListener("click", closeActivityModal);
    $("activityModal")?.addEventListener("click", (e) => { if(e.target && e.target.id === "activityModal") closeActivityModal(); });
    $("activityRefresh")?.addEventListener("click", () => loadActivityLog().catch(()=>{}));
    $("activityFilter")?.addEventListener("change", () => loadActivityLog().catch(()=>{}));

    // Logout
    $("navLogout")?.addEventListener("click", async () => {
      try{ await window.JobApplyAI.auth.logout("./index.html"); }
      catch(_){ window.location.href = "./index.html"; }
    });

    window.addEventListener("load", () => {
      boot().catch((e) => {
        showError(e?.message || String(e));
        H.setBadge("authBadge", "bad", "Error");
      });
    });

  })();
  </script>
</body>
</html>
