<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>jobmejob • Jobs</title>
  <meta name="description" content="Fetch and review your job queue, then open a job in CV Studio."/>

  <!-- Shared styles -->
  <link rel="stylesheet" href="./shared.css"/>

  <style>
    /* =========================================================
       Jobs (page-only styles)
       Goal: classic job-board master/detail
       - Left: queue list
       - Right: selected job description
       ========================================================= */

    .grid{
      display:grid;
      grid-template-columns: .9fr 1.1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .sectionHeader{
      padding:14px;
      border-bottom:1px solid rgba(17,19,24,.10);
      background:rgba(255,255,255,.88);
      backdrop-filter:saturate(1.2) blur(10px);
    }
    .sectionBody{ padding:14px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .small{ font-size:12px; color:rgba(17,19,24,.56); font-weight:700; line-height:1.45; }
    .mono{
      font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:12px;
      word-break:break-word;
      color:rgba(17,19,24,.64);
    }

    /* Queue list */
    .list{ display:flex; flex-direction:column; gap:10px; }

    .item{
      border:1px solid rgba(17,19,24,.12);
      background:rgba(255,255,255,.78);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 14px 30px rgba(17,19,24,.07);
    }

    .item.selectable{ cursor:pointer; }
    .item.selectable:hover{ transform:translateY(-1px); background:rgba(255,255,255,.86); }
    .item.selected{
      border-color:rgba(34,197,94,.60);
      background:rgba(34,197,94,.10);
      box-shadow: 0 18px 38px rgba(17,19,24,.10);
    }

    .itemTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .itemTitle{ font-weight:950; line-height:1.2; }
    .itemMeta{
      margin-top:6px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      color:rgba(17,19,24,.56);
      font-size:12px;
      font-weight:750;
    }
    .badgeGroup{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

    .itemActions{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .itemActions .btn{ flex: 0 0 auto; }

    .skeleton{
      border-radius:12px;
      height:12px;
      background:linear-gradient(90deg, rgba(17,19,24,.10), rgba(17,19,24,.04), rgba(17,19,24,.10));
      background-size:200% 100%;
      animation:shimmer 1.2s linear infinite;
    }
    .skeleton.block{ height:140px; border-radius:16px; }
    .skeleton.lines{ height:12px; margin-top:10px; }
    @keyframes shimmer{
      0%{ background-position:200% 0 }
      100%{ background-position:-200% 0 }
    }

    details.advanced{
      margin-top:10px;
      border:1px solid rgba(17,19,24,.10);
      border-radius:16px;
      background:rgba(17,19,24,.03);
      padding:10px 12px;
    }
    details.advanced summary{
      cursor:pointer;
      font-weight:900;
      color:rgba(17,19,24,.80);
      list-style:none;
    }
    details.advanced summary::-webkit-details-marker{ display:none }

    .toggleRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 0;
      border-top:1px solid rgba(17,19,24,.10);
      margin-top:8px;
    }
    .toggleRow:first-of-type{ border-top:0; margin-top:0; }

    .switch{
      display:inline-flex;
      align-items:center;
      gap:10px;
      font-weight:850;
      font-size:13px;
      color:rgba(17,19,24,.78);
      user-select:none;
    }
    .switch input{ width:18px; height:18px; }

    /* Detail panel */
    .detailTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
    }
    .detailTitle{
      font-weight:980;
      font-size:18px;
      letter-spacing:-.2px;
      line-height:1.2;
      margin:0;
      word-break:break-word;
    }

    .monoBox{
      white-space:pre-wrap;
      font-size:13px;
      line-height:1.45;
      background:rgba(17,19,24,.04);
      border:1px solid rgba(17,19,24,.14);
      padding:12px;
      border-radius:14px;
      min-height: 180px;
    }

    .detailHint{
      font-size:12px;
      color:rgba(17,19,24,.58);
      font-weight:700;
      line-height:1.45;
    }

    /* Activity list (modal) */
    .activityList{ display:flex; flex-direction:column; gap:10px; }
    .activityItem{
      border:1px solid rgba(17,19,24,.10);
      background:rgba(17,19,24,.03);
      border-radius:14px;
      padding:10px 12px;
    }
    .activityTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .activityTitle{ font-weight:950; }
    .activityMeta{ margin-top:6px; display:flex; flex-wrap:wrap; gap:8px; color:rgba(17,19,24,.60); font-size:12px; font-weight:750; }

    .iconX{
      border:1px solid rgba(17,19,24,.12);
      background:rgba(17,19,24,.04);
      border-radius:999px;
      padding:7px 10px;
      font-weight:950;
      cursor:pointer;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <nav class="nav">
      <a class="brand" href="./index.html" data-nav="1" aria-label="Home">
        <span class="logo" aria-hidden="true"></span>
        <span>jobmejob</span>
      </a>

      <div class="navlinks">
        <a class="pill" href="./index.html" data-nav="1">Home</a>
        <a class="pill" href="./cv.html" data-nav="1">CV Studio</a>
        <a class="pill active" href="./jobs.html" data-nav="1">Jobs</a>
        <a class="pill" href="./plan.html" data-nav="1">Plan</a>

        <details class="navDrop" id="navAccount" style="display:none">
          <summary class="pill" aria-label="Account menu">
            <span id="navAccountLabel">Account</span>
            <span aria-hidden="true">▾</span>
          </summary>

          <div class="navMenu" role="menu" aria-label="Account menu">
            <div class="menuLabel">Account</div>
            <a class="pill" href="./profile.html" data-nav="1" role="menuitem">Profile setup</a>
            <button class="btn ghost" id="navActivity" type="button" role="menuitem">Activity log</button>

            <div class="menuSep" role="separator"></div>
            <div class="menuLabel">More</div>
            <a class="pill" href="./dashboard.html" data-nav="1" role="menuitem">Dashboard</a>
            <span class="pill menuDisabled" role="menuitem" aria-disabled="true">Auto-apply (coming soon)</span>

            <div class="menuSep" role="separator"></div>
            <button class="btn danger" id="navLogout" type="button" role="menuitem">Logout</button>
          </div>
        </details>

        <a class="pill" href="./signup.html" id="navSignIn" data-nav="1">Sign in</a>
      </div>
    </nav>
  </header>

  <main class="main">
    <div class="row" style="align-items:flex-end; justify-content:space-between">
      <div>
        <h1 class="h1">Jobs</h1>
        <p class="sub">Pick a job on the left and review the description on the right. Then open it in CV Studio to tailor your CV.</p>
      </div>
      <span class="badge warn" id="authBadge">Checking…</span>
    </div>

    <div class="errorTop" id="errorTop"></div>

    <section class="grid">
      <!-- LEFT: Queue list -->
      <section class="card cardNoPad">
        <div class="sectionHeader">
          <div class="row" style="justify-content:space-between">
            <div style="min-width:220px">
              <div style="font-weight:950">Your queue</div>
              <div class="small" id="queueHint">We show up to 16 jobs. Jobs are currently limited to Germany.</div>
            </div>

            <div class="row" style="justify-content:flex-end">
              <span class="badge warn" title="Current search market">Germany</span>
              <span class="badge" id="badgeQueue">—</span>
              <button class="btn primary" id="btnFetchJobsNow" type="button">Fetch new jobs</button>
              <button class="btn" id="btnRefresh" type="button">Refresh</button>
            </div>
          </div>

          <div class="small" id="fetchMeta" style="margin-top:8px"></div>
        </div>

        <div class="sectionBody">
          <div class="small" id="fetchJobsStatus"></div>

          <details class="advanced" id="fetchAdvanced">
            <summary>Fetch options</summary>

            <div class="toggleRow">
              <label class="switch">
                <input id="toggleAiOnly" type="checkbox"/>
                AI titles only
              </label>
              <span class="badge" id="badgeAi">—</span>
            </div>
            <div class="small" id="aiSwitchHint" style="display:none">Generate AI suggestions in Profile to unlock this.</div>
            <div class="small">If enabled, we use your AI-recommended role titles (from Profile) to fetch jobs. Otherwise we fetch based on your profile settings.</div>
          </details>

          <div class="hr"></div>

          <div id="queueWrap"><div class="skeleton block"></div></div>
          <div id="queueError"></div>
        </div>
      </section>

      <!-- RIGHT: Job detail panel -->
      <section class="card cardNoPad" id="detailCard">
        <div class="sectionHeader">
          <div class="row" style="justify-content:space-between">
            <div style="min-width:220px">
              <div style="font-weight:950">Job description</div>
              <div class="small" id="detailHeaderHint">Select a job to view details.</div>
            </div>

            <div class="row" style="justify-content:flex-end">
              <span class="badge warn" title="Current search market">Germany</span>
              <span class="badge" id="badgeDetailAts" style="display:none">—</span>
            </div>
          </div>
        </div>

        <div class="sectionBody">
          <div class="detailTop">
            <div style="min-width:0">
              <div class="detailTitle" id="detailTitle">Select a job</div>
              <div class="small" id="detailMeta">Click a job on the left. The full description will appear here.</div>
            </div>
            <div class="badgeGroup" id="detailBadges"></div>
          </div>

          <div class="row" id="detailActions" style="margin-top:12px"></div>

          <div class="hr"></div>

          <div class="small" id="detailDescMeta">—</div>
          <div class="monoBox" id="detailDesc" style="margin-top:10px">No job selected.</div>

          <div class="hr"></div>

          <div class="detailHint" id="onboardingHint">Checking your account…</div>
        </div>
      </section>
    </section>
  </main>

  <!-- Skip modal -->
  <div class="modalBackdrop" id="skipModal" style="display:none">
    <div class="modalCard" style="max-width:720px">
      <div class="modalScroll">
        <div class="modalHeader">
          <div class="modalTitle">Skip job</div>
          <button class="iconX" id="skipCloseX" type="button" aria-label="Close">✕</button>
        </div>

        <div class="small" style="margin-top:10px">
          Skipped jobs won’t be shown in your queue. You can still see what happened in the Activity log.
        </div>

        <div class="row" style="margin-top:12px">
          <div style="flex:1 1 260px">
            <label for="skipReason" class="small" style="display:block;margin-bottom:6px">Reason</label>
            <select id="skipReason" style="width:100%">
              <option value="not_relevant">Not relevant</option>
              <option value="location">Wrong location</option>
              <option value="seniority">Wrong seniority</option>
              <option value="salary">Salary mismatch</option>
              <option value="tech_stack">Tech stack mismatch</option>
              <option value="visa">Visa / work permit</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div style="flex:1 1 260px">
            <label for="skipNote" class="small" style="display:block;margin-bottom:6px">Note (optional)</label>
            <input id="skipNote" type="text" placeholder="Short note (optional)" style="width:100%"/>
          </div>
        </div>

        <div class="small" id="skipGuardrail" style="display:none; margin-top:10px"></div>
      </div>

      <div class="modalActions">
        <button class="btn ghost" id="skipCancel" type="button">Cancel</button>
        <button class="btn danger" id="skipConfirm" type="button">Skip</button>
      </div>
    </div>
  </div>

  <!-- Activity log modal (Account dropdown) -->
  <div class="modalBackdrop" id="activityModal" style="display:none">
    <div class="modalCard">
      <div class="modalScroll">
        <div class="modalHeader">
          <div style="min-width:0">
            <div class="modalTitle">Activity log</div>
            <div class="small">Recent actions like queued, prioritized, skipped, applied, rejected.</div>
          </div>
          <button class="iconX" id="activityCloseX" type="button" aria-label="Close">✕</button>
        </div>

        <div class="row" style="margin-top:12px; justify-content:space-between">
          <div class="row" style="gap:10px">
            <label class="small" for="activityFilter">Filter</label>
            <select id="activityFilter">
              <option value="">All</option>
              <option value="queued">Queued</option>
              <option value="prioritized">Prioritized</option>
              <option value="skipped">Skipped</option>
              <option value="applied">Applied</option>
              <option value="rejected">Rejected</option>
            </select>
          </div>
          <button class="btn" id="activityRefresh" type="button">Refresh</button>
        </div>

        <div class="errorTop" id="activityError"></div>

        <div id="activityWrap" style="margin-top:10px">
          <div class="modalMonoBox">Loading…</div>
        </div>
      </div>

      <div class="modalActions">
        <a class="btn ghost" href="./cv.html" data-nav="1">Open CV Studio</a>
        <button class="btn" id="activityClose" type="button">Close</button>
      </div>
    </div>
  </div>

  <!-- Scripts: order matters -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./auth.js"></script>
  <script src="./shared.js"></script>

  <script>
  (() => {
    "use strict";

    const S = window.JobMeJobShared || null;

    // Fallbacks (so one missing helper doesn't break the whole page)
    const F = {
      escapeHtml: (s) => String(s ?? "").replace(/[&<>"']/g, (c) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])),
      showModal: (id) => { const el = document.getElementById(id); if(el) el.style.display = "flex"; document.body.classList.add("modalOpen"); },
      hideModal: (id) => { const el = document.getElementById(id); if(el) el.style.display = "none"; document.body.classList.remove("modalOpen"); },
      showTopError: (id, msg) => {
        const el = document.getElementById(id);
        if(!el) return;
        if(!msg){ el.style.display = "none"; el.textContent = ""; return; }
        el.style.display = "block";
        el.textContent = String(msg);
      },
      setBadge: (id, cls, txt) => {
        const el = document.getElementById(id);
        if(!el) return;
        el.className = "badge" + (cls ? (" " + cls) : "");
        el.textContent = txt ?? "";
      },
      resolveApiBase: (x) => String(x || "").trim().replace(/\/+$/, ""),
      wireNavTransitions: () => {},
      go: (url) => { window.location.href = url; }
    };

    const H = {
      escapeHtml: (S && S.escapeHtml) ? S.escapeHtml : F.escapeHtml,
      showModal: (S && S.showModal) ? S.showModal : F.showModal,
      hideModal: (S && S.hideModal) ? S.hideModal : F.hideModal,
      showTopError: (S && S.showTopError) ? S.showTopError : F.showTopError,
      setBadge: (S && S.setBadge) ? S.setBadge : F.setBadge,
      resolveApiBase: (S && S.resolveApiBase) ? S.resolveApiBase : F.resolveApiBase,
      wireNavTransitions: (S && S.wireNavTransitions) ? S.wireNavTransitions.bind(S) : F.wireNavTransitions,
      go: (S && S.go) ? S.go.bind(S) : F.go
    };

    H.wireNavTransitions();

    const $ = (id) => document.getElementById(id);

    const API_BASE = H.resolveApiBase(
      (window.JobApplyAI && window.JobApplyAI.config && window.JobApplyAI.config.API_BASE)
        ? window.JobApplyAI.config.API_BASE
        : "https://jobmejob.schoene-viktor.workers.dev"
    );

    let session = null;
    let lastSessionToken = "";

    let lastQueueResponse = null;
    let currentQueueCount = 0;
    let currentPlanDaily = 0;

    let pendingSkipJobId = "";

    // AI titles cached from backend
    let aiTitles = [];

    // Queue cache for detail panel
    let jobById = new Map();
    let selectedJobId = "";
    let currentDescText = "";

    // CV summaries for ATS badge (best-effort)
    const tailorSummaryMap = new Map();

    function setText(id, txt){
      const el = $(id);
      if(el) el.textContent = (txt === undefined || txt === null) ? "" : String(txt);
    }
    function setHtml(id, html){
      const el = $(id);
      if(el) el.innerHTML = html || "";
    }

    function showError(msg){ H.showTopError("errorTop", msg); }

    async function apiGet(path, accessToken){
      const res = await fetch(API_BASE + path, {
        method: "GET",
        headers: { Authorization: "Bearer " + accessToken }
      });
      const text = await res.text().catch(() => "");
      let json = null;
      try{ json = JSON.parse(text); }catch{ json = { raw: text }; }
      if(!res.ok){
        const msg = (json && (json.error || json.message)) ? String(json.error || json.message) : (text || ("HTTP " + res.status));
        throw new Error(msg);
      }
      return json;
    }

    async function apiPost(path, accessToken, body){
      const res = await fetch(API_BASE + path, {
        method: "POST",
        headers: {
          Authorization: "Bearer " + accessToken,
          "content-type": "application/json"
        },
        body: JSON.stringify(body || {})
      });
      const text = await res.text().catch(() => "");
      let json = null;
      try{ json = JSON.parse(text); }catch{ json = { raw: text }; }
      if(!res.ok){
        const msg = (json && (json.error || json.message)) ? String(json.error || json.message) : (text || ("HTTP " + res.status));
        throw new Error(msg);
      }
      return json;
    }

    function planFromState(planId){
      const pid = String(planId || "").trim().toLowerCase();
      if(pid === "starter") return { id:"starter", name:"Starter", daily:1, short:"Starter (1/day)" };
      if(pid === "pro") return { id:"pro", name:"Growth", daily:5, short:"Growth (5/day)" };
      if(pid === "max") return { id:"max", name:"Max", daily:10, short:"Max (10/day)" };
      return { id:null, name:"No plan", daily:0, short:"No plan" };
    }

    function normalizeKeywordList(x){
      if(!x) return [];
      if(Array.isArray(x)) return x.map(v => String(v || "").trim()).filter(Boolean);
      if(typeof x === "string"){
        const s = x.trim();
        if(!s) return [];
        try{
          const j = JSON.parse(s);
          if(Array.isArray(j)) return j.map(v => String(v || "").trim()).filter(Boolean);
        }catch(_){ }
        return s.split(/[\n,;]+/).map(t => t.trim()).filter(Boolean);
      }
      return [];
    }

    function computeAtsMatchPercent(used, missing){
      const u = normalizeKeywordList(used);
      const m = normalizeKeywordList(missing);
      const denom = u.length + m.length;
      if(denom <= 0) return null;
      return Math.round((u.length / denom) * 100);
    }

    async function loadTailorSummariesForJobs(jobIds){
      tailorSummaryMap.clear();

      const ids = Array.isArray(jobIds) ? jobIds : [];
      const uniq = [...new Set(ids.map(x => String(x || "").trim()).filter(Boolean))];
      if(!uniq.length) return;

      const chunkSize = 40;
      for(let i = 0; i < uniq.length; i += chunkSize){
        const chunk = uniq.slice(i, i + chunkSize);
        try{
          const qs = "job_ids=" + encodeURIComponent(chunk.join(","));
          const res = await apiGet("/me/cv/tailored?" + qs, lastSessionToken);
          const rows = (res && Array.isArray(res.data)) ? res.data : [];
          for(const row of rows){
            if(row && row.job_id) tailorSummaryMap.set(String(row.job_id), row);
          }
        }catch(_){
          // best-effort only
          return;
        }
      }
    }

    function daysAgo(ts){
      if(!ts) return null;
      let d = new Date(ts);
      if(Number.isNaN(d.getTime())){
        const m = String(ts).match(/^(\d{4}-\d{2}-\d{2})/);
        if(!m) return null;
        d = new Date(m[1] + "T00:00:00Z");
        if(Number.isNaN(d.getTime())) return null;
      }
      const diffMs = Date.now() - d.getTime();
      const days = Math.floor(diffMs / 86400000);
      return days < 0 ? 0 : days;
    }

    function isSingleColumn(){
      return window.matchMedia && window.matchMedia("(max-width: 980px)").matches;
    }

    function scrollDetailIntoView(){
      if(!isSingleColumn()) return;
      const el = $("detailCard");
      if(!el) return;
      try{ el.scrollIntoView({ behavior: "smooth", block: "start" }); }
      catch(_){ el.scrollIntoView(); }
    }

    function goToCvStudio(jobId){
      try{ localStorage.setItem("cvstudio_job_source", "queue"); }catch(_){ }
      try{ localStorage.setItem("cvstudio_selected_job_id", String(jobId)); }catch(_){ }
      H.go("./cv.html");
    }

    function storeSelectedJobId(id){
      try{ localStorage.setItem("jm_selected_job_id", String(id || "")); }catch(_){ }
    }
    function readStoredSelectedJobId(){
      try{ return String(localStorage.getItem("jm_selected_job_id") || ""); }catch(_){ return ""; }
    }

    function setDetailEmpty(){
      selectedJobId = "";
      currentDescText = "";

      setText("detailHeaderHint", "Select a job to view details.");
      setText("detailTitle", "Select a job");
      setText("detailMeta", "Click a job on the left. The full description will appear here.");
      setHtml("detailBadges", "<span class='badge warn'>Germany</span>");
      setHtml("detailActions",
        '<a class="btn" href="./cv.html" data-nav="1">Open CV Studio</a>'
        + '<a class="btn ghost" href="./profile.html" data-nav="1">Profile setup</a>'
      );
      setText("detailDescMeta", "—");
      setText("detailDesc", "No job selected.");
      const ats = $("badgeDetailAts");
      if(ats) ats.style.display = "none";
    }

    function renderQueueList(queue){
      const items = Array.isArray(queue?.data) ? queue.data : (Array.isArray(queue?.jobs) ? queue.jobs : []);

      jobById = new Map();
      for(const j of items){
        if(j && j.id) jobById.set(String(j.id), j);
      }

      if(!items.length){
        return (
          '<div class="item">'
          + '<div class="itemTitle">No jobs in your queue yet</div>'
          + '<div class="itemMeta"><span>Tip:</span><span>Click “Fetch new jobs” after completing your profile.</span></div>'
          + '<div class="itemActions" style="margin-top:12px">'
            + '<a class="btn" href="./profile.html" data-nav="1">Open Profile</a>'
            + '<button class="btn primary" id="btnFetchInline" type="button">Fetch now</button>'
          + '</div>'
          + '</div>'
        );
      }

      const html = items.slice(0, 16).map((j) => {
        const jobId = j.id ? String(j.id) : "";
        const title = String(j.title || "Untitled");
        const company = String(j.company_name || "—");
        const loc = [j.city || "", j.region || ""].filter(Boolean).join(", ") || "—";
        const posted = j.posted_at ? String(j.posted_at).slice(0, 10) : "—";
        const link = j.apply_url ? String(j.apply_url) : "";

        const prio = !!(j._application && j._application.priority);
        const prioBadge = prio ? "<span class='badge prio'>prio</span>" : "<span class='badge'>new</span>";

        const tSum = tailorSummaryMap.get(String(jobId));
        let atsBadge = "";
        if(tSum){
          const pct = computeAtsMatchPercent(tSum.ats_keywords_used, tSum.ats_keywords_missing);
          if(pct !== null){
            const cls = (pct >= 80) ? "good" : (pct >= 60 ? "warn" : "bad");
            atsBadge = "<span class='badge " + H.escapeHtml(cls) + "'>ATS " + H.escapeHtml(pct) + "%</span>";
          }else{
            atsBadge = "<span class='badge'>tailored</span>";
          }
        }

        const geoBadge = "<span class='badge warn' title='Current market'>Germany</span>";
        const badge = "<div class='badgeGroup'>" + geoBadge + prioBadge + atsBadge + "</div>";

        const updatedDays = daysAgo(j.source_modified_at);
        const updatedLabel = (updatedDays === null)
          ? "Updated —"
          : (updatedDays === 0 ? "Updated today" : ("Updated " + updatedDays + "d ago"));

        const titleHtml = link
          ? ('<a href="' + H.escapeHtml(link) + '" target="_blank" rel="noopener">' + H.escapeHtml(title) + "</a>")
          : H.escapeHtml(title);

        const prioBtn = prio
          ? "<button class='btn small ghost' type='button' data-unprio='" + H.escapeHtml(jobId) + "'>Unprio</button>"
          : "<button class='btn small' type='button' data-prio='" + H.escapeHtml(jobId) + "'>Prio</button>";

        const selectedCls = (String(jobId) === String(selectedJobId)) ? " selected" : "";

        return (
          '<div class="item selectable' + selectedCls + '" data-select="' + H.escapeHtml(jobId) + '" role="button" tabindex="0" aria-label="Select job">'
            + '<div class="itemTop">'
              + '<div class="itemTitle">' + titleHtml + '</div>'
              + badge
            + '</div>'
            + '<div class="itemMeta">'
              + '<span>' + H.escapeHtml(company) + '</span><span>•</span>'
              + '<span>' + H.escapeHtml(loc) + '</span><span>•</span>'
              + '<span>Posted ' + H.escapeHtml(posted) + '</span>'
              + (updatedLabel ? ('<span>•</span><span>' + H.escapeHtml(updatedLabel) + '</span>') : '')
            + '</div>'
            + '<div class="itemActions">'
              + '<button class="btn small" type="button" data-tailor="' + H.escapeHtml(jobId) + '">Tailor</button>'
              + prioBtn
              + '<button class="btn small danger" type="button" data-skip="' + H.escapeHtml(jobId) + '">Skip</button>'
            + '</div>'
          + '</div>'
        );
      }).join("");

      return '<div class="list">' + html + '</div>';
    }

    function highlightSelectedInList(){
      const wrap = $("queueWrap");
      if(!wrap) return;
      const nodes = wrap.querySelectorAll(".item.selectable[data-select]");
      for(const n of nodes){
        const id = n.getAttribute("data-select") || "";
        const isSel = id && selectedJobId && id === selectedJobId;
        n.classList.toggle("selected", !!isSel);
      }
    }

    function setDetailLoading(jobId){
      const j = jobById.get(String(jobId)) || null;

      setText("detailHeaderHint", "Review the description, then tailor in CV Studio.");

      const title = j ? String(j.title || "Untitled") : "Job";
      const company = j ? String(j.company_name || "—") : "—";
      const loc = j ? [j.city || "", j.region || ""].filter(Boolean).join(", ") : "";
      const posted = j && j.posted_at ? String(j.posted_at).slice(0, 10) : "";

      setText("detailTitle", title);

      const metaParts = [];
      if(company) metaParts.push(company);
      if(loc) metaParts.push(loc);
      if(posted) metaParts.push("Posted " + posted);
      setText("detailMeta", metaParts.join(" · ") || "—");

      // Badges
      const prio = !!(j && j._application && j._application.priority);
      const prioBadge = prio ? "<span class='badge prio'>prio</span>" : "<span class='badge'>new</span>";
      const geoBadge = "<span class='badge warn'>Germany</span>";

      const tSum = tailorSummaryMap.get(String(jobId));
      let atsBadge = "";
      let atsHeader = "";
      if(tSum){
        const pct = computeAtsMatchPercent(tSum.ats_keywords_used, tSum.ats_keywords_missing);
        if(pct !== null){
          const cls = (pct >= 80) ? "good" : (pct >= 60 ? "warn" : "bad");
          atsBadge = "<span class='badge " + H.escapeHtml(cls) + "'>ATS " + H.escapeHtml(pct) + "%</span>";
          atsHeader = "ATS " + pct + "%";
        }else{
          atsBadge = "<span class='badge'>tailored</span>";
          atsHeader = "tailored";
        }
      }

      setHtml("detailBadges", geoBadge + prioBadge + atsBadge);

      const atsEl = $("badgeDetailAts");
      if(atsEl){
        if(atsHeader){
          atsEl.style.display = "inline-flex";
          atsEl.textContent = atsHeader;
        }else{
          atsEl.style.display = "none";
        }
      }

      // Actions
      const link = j && j.apply_url ? String(j.apply_url) : "";
      const prioBtn = prio
        ? '<button class="btn ghost" type="button" data-detail-unprio="' + H.escapeHtml(jobId) + '">Unprio</button>'
        : '<button class="btn" type="button" data-detail-prio="' + H.escapeHtml(jobId) + '">Prio</button>';

      const openLink = link
        ? ('<a class="btn ghost" href="' + H.escapeHtml(link) + '" target="_blank" rel="noopener">Open posting</a>')
        : '';

      setHtml("detailActions",
        '<button class="btn primary" type="button" data-detail-tailor="' + H.escapeHtml(jobId) + '">Tailor in CV Studio</button>'
        + openLink
        + '<button class="btn ghost" type="button" data-detail-copydesc="' + H.escapeHtml(jobId) + '">Copy description</button>'
        + '<button class="btn" type="button" data-detail-refreshdesc="' + H.escapeHtml(jobId) + '">Refresh description</button>'
        + prioBtn
        + '<button class="btn danger" type="button" data-detail-skip="' + H.escapeHtml(jobId) + '">Skip</button>'
      );

      // Description placeholders
      setText("detailDescMeta", "Loading description…");
      setHtml("detailDesc",
        '<div class="skeleton lines" style="width:62%"></div>'
        + '<div class="skeleton lines" style="width:92%"></div>'
        + '<div class="skeleton lines" style="width:86%"></div>'
        + '<div class="skeleton lines" style="width:78%"></div>'
        + '<div class="skeleton lines" style="width:90%"></div>'
      );

      currentDescText = "";
    }

    async function loadSelectedDescription(jobId){
      if(!jobId) return;

      // If selection changed while awaiting, ignore old result
      const wanted = String(jobId);

      try{
        const resp = await apiGet("/me/jobs/description?job_id=" + encodeURIComponent(wanted), lastSessionToken);
        if(String(selectedJobId) !== wanted) return;

        const job = resp && resp.job ? resp.job : null;
        const company = (job && job.company_name) ? String(job.company_name) : "";
        const source = (job && job.description_full_source) ? String(job.description_full_source) : "";
        const fetchedAt = (job && job.description_full_fetched_at) ? String(job.description_full_fetched_at) : "";

        setText("detailDescMeta",
          [
            company ? ("Company: " + company) : "",
            source ? ("Source: " + source) : "",
            fetchedAt ? ("Fetched: " + fetchedAt) : ""
          ].filter(Boolean).join(" · ") || "Description"
        );

        const text = (job && job.description_full) ? String(job.description_full) : "";
        currentDescText = text || "";

        if(text){
          setText("detailDesc", text);
        }else if(job && job.description_full_error){
          setText("detailDesc", "No description yet. Last error: " + String(job.description_full_error));
        }else{
          setText("detailDesc", "No description found yet. Try Refresh description.");
        }
      }catch(e){
        if(String(selectedJobId) !== wanted) return;
        setText("detailDescMeta", "Description");
        setText("detailDesc", "Failed to load description: " + (e?.message || String(e)));
      }
    }

    async function selectJob(jobId, opts = {}){
      const id = String(jobId || "");
      if(!id) return;

      selectedJobId = id;
      storeSelectedJobId(id);

      highlightSelectedInList();
      setDetailLoading(id);

      if(opts && opts.scroll) scrollDetailIntoView();

      await loadSelectedDescription(id);
    }

    function ensureSelectionAfterRender(queueItems){
      const ids = Array.isArray(queueItems) ? queueItems.map(j => j && j.id).filter(Boolean).map(x => String(x)) : [];
      if(!ids.length){
        setDetailEmpty();
        return;
      }

      const stored = readStoredSelectedJobId();
      const want = selectedJobId || stored;

      if(want && ids.includes(String(want))){
        selectedJobId = String(want);
      }else{
        selectedJobId = String(ids[0]);
      }

      storeSelectedJobId(selectedJobId);
      highlightSelectedInList();

      // Load detail
      selectJob(selectedJobId).catch(() => {});
    }

    function wireQueueClicks(){
      const wrap = $("queueWrap");
      if(!wrap) return;

      // Clicks
      wrap.addEventListener("click", async (e) => {
        // Inline fetch CTA inside empty state
        const inlineFetch = e.target && e.target.id === "btnFetchInline";
        if(inlineFetch){
          const b = $("btnFetchJobsNow");
          if(b) b.click();
          return;
        }

        const skip = e.target.closest("button[data-skip]");
        if(skip){
          const jobId = skip.getAttribute("data-skip") || "";
          if(jobId) openSkipModal(jobId);
          return;
        }

        const tl = e.target.closest("button[data-tailor]");
        if(tl){
          const jobId = tl.getAttribute("data-tailor") || "";
          if(jobId) goToCvStudio(jobId);
          return;
        }

        const pr = e.target.closest("button[data-prio]");
        if(pr){
          const jobId = pr.getAttribute("data-prio") || "";
          if(!jobId) return;
          try{
            await apiPost("/me/applications/prioritize", lastSessionToken, { job_id: jobId });
            await refreshQueue();
            await selectJob(jobId);
          }catch(err){
            showError(err?.message || String(err));
          }
          return;
        }

        const un = e.target.closest("button[data-unprio]");
        if(un){
          const jobId = un.getAttribute("data-unprio") || "";
          if(!jobId) return;
          try{
            await apiPost("/me/applications/unprioritize", lastSessionToken, { job_id: jobId });
            await refreshQueue();
            await selectJob(jobId);
          }catch(err){
            showError(err?.message || String(err));
          }
          return;
        }

        const sel = e.target.closest(".item.selectable[data-select]");
        if(sel){
          const jobId = sel.getAttribute("data-select") || "";
          if(jobId) selectJob(jobId, { scroll:true }).catch(()=>{});
        }
      });

      // Keyboard: Enter / Space to select
      wrap.addEventListener("keydown", (e) => {
        const key = e.key || "";
        if(key !== "Enter" && key !== " ") return;
        const sel = e.target && e.target.closest && e.target.closest(".item.selectable[data-select]");
        if(!sel) return;
        e.preventDefault();
        const jobId = sel.getAttribute("data-select") || "";
        if(jobId) selectJob(jobId, { scroll:true }).catch(()=>{});
      });
    }

    function wireDetailClicks(){
      const body = $("detailCard");
      if(!body) return;

      body.addEventListener("click", async (e) => {
        const tl = e.target.closest("button[data-detail-tailor]");
        if(tl){
          const jobId = tl.getAttribute("data-detail-tailor") || "";
          if(jobId) goToCvStudio(jobId);
          return;
        }

        const sk = e.target.closest("button[data-detail-skip]");
        if(sk){
          const jobId = sk.getAttribute("data-detail-skip") || "";
          if(jobId) openSkipModal(jobId);
          return;
        }

        const pr = e.target.closest("button[data-detail-prio]");
        if(pr){
          const jobId = pr.getAttribute("data-detail-prio") || "";
          if(!jobId) return;
          try{
            await apiPost("/me/applications/prioritize", lastSessionToken, { job_id: jobId });
            await refreshQueue();
            await selectJob(jobId);
          }catch(err){
            showError(err?.message || String(err));
          }
          return;
        }

        const un = e.target.closest("button[data-detail-unprio]");
        if(un){
          const jobId = un.getAttribute("data-detail-unprio") || "";
          if(!jobId) return;
          try{
            await apiPost("/me/applications/unprioritize", lastSessionToken, { job_id: jobId });
            await refreshQueue();
            await selectJob(jobId);
          }catch(err){
            showError(err?.message || String(err));
          }
          return;
        }

        const cp = e.target.closest("button[data-detail-copydesc]");
        if(cp){
          await copyCurrentDescription();
          return;
        }

        const rf = e.target.closest("button[data-detail-refreshdesc]");
        if(rf){
          const jobId = rf.getAttribute("data-detail-refreshdesc") || selectedJobId || "";
          if(jobId){
            setText("detailDescMeta", "Refreshing…");
            await loadSelectedDescription(jobId);
          }
        }
      });
    }

    async function copyCurrentDescription(){
      try{
        const t = currentDescText || "";
        if(!t){ alert("No description to copy yet."); return; }
        await navigator.clipboard.writeText(t);
        alert("Description copied.");
      }catch(_){
        window.prompt("Copy description:", currentDescText || "");
      }
    }

    /* -------------------------
       Skip modal
       ------------------------- */
    function openSkipModal(jobId){
      pendingSkipJobId = jobId;
      const reason = $("skipReason");
      const note = $("skipNote");
      const guard = $("skipGuardrail");
      if(reason) reason.value = "not_relevant";
      if(note) note.value = "";
      if(guard){ guard.style.display = "none"; guard.textContent = ""; }
      H.showModal("skipModal");
    }

    function closeSkipModal(){
      pendingSkipJobId = "";
      H.hideModal("skipModal");
    }

    async function submitSkip(){
      if(!pendingSkipJobId) return;

      // Guardrail (soft): avoid emptying the queue too hard if a plan is active
      const minSupply = Math.max(5, currentPlanDaily * 3);
      if(currentPlanDaily > 0 && currentQueueCount <= minSupply){
        const el = $("skipGuardrail");
        if(el){
          el.style.display = "block";
          el.style.color = "rgba(184,107,0,.95)";
          el.textContent = "Skipping is limited because your queue is getting low. Fetch more jobs or broaden your titles / radius.";
        }
        closeSkipModal();
        return;
      }

      const reason_code = String($("skipReason")?.value || "not_relevant");
      const reason_note = String($("skipNote")?.value || "").trim();

      try{
        const jobId = String(pendingSkipJobId);
        await apiPost("/me/applications/skip", lastSessionToken, {
          job_id: jobId,
          reason_code,
          reason_note
        });
        closeSkipModal();

        // If we skipped the currently selected job, we will auto-select another after refresh.
        await refreshQueue();
      }catch(e){
        closeSkipModal();
        showError(e?.message || String(e));
      }
    }

    /* -------------------------
       Fetch new jobs
       ------------------------- */
    const FETCH_COOLDOWN_MS = 10 * 60 * 1000;

    function getNextFetchAllowedAt(){
      try{
        const raw = localStorage.getItem("jm_last_manual_fetch_ts") || "";
        const v = Number(raw || "0");
        if(!v || !Number.isFinite(v)) return 0;
        return v + FETCH_COOLDOWN_MS;
      }catch(_){
        return 0;
      }
    }

    function updateFetchMetaUI(){
      const meta = $("fetchMeta");
      if(!meta) return;
      try{
        const raw = localStorage.getItem("jm_last_manual_fetch_ts") || "";
        const lastTs = Number(raw || "0");
        if(!lastTs){
          meta.textContent = "Tip: fetch jobs after your Profile is complete.";
          return;
        }
        const last = new Date(lastTs).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
        const next = lastTs + FETCH_COOLDOWN_MS;
        const now = Date.now();

        if(now < next){
          const sec = Math.ceil((next - now) / 1000);
          const min = Math.floor(sec / 60);
          const s = sec % 60;
          meta.textContent = "Last fetch: " + last + " · Next fetch in " + min + ":" + String(s).padStart(2, "0");
        }else{
          meta.textContent = "Last fetch: " + last + " · You can fetch again now";
        }
      }catch(_){
        meta.textContent = "";
      }
    }

    function getAiTitlesForFetch(){
      const out = [];
      const seen = new Set();

      const push = (t) => {
        const s = String(t || "").trim();
        if(!s) return;
        const k = s.toLowerCase();
        if(seen.has(k)) return;
        seen.add(k);
        out.push(s);
      };

      // Prefer server
      if(Array.isArray(aiTitles)){
        for(const t of aiTitles) push(t);
      }

      // Fallback: cached
      if(!out.length){
        try{
          const raw = localStorage.getItem("jm_ai_titles_server") || localStorage.getItem("ja_ai_titles_server") || "[]";
          const arr = JSON.parse(raw);
          if(Array.isArray(arr)) for(const t of arr) push(t);
        }catch(_){ }
      }

      return out;
    }

    function updateAiSwitchState(){
      const toggle = $("toggleAiOnly");
      const hint = $("aiSwitchHint");
      const badge = $("badgeAi");

      const titles = getAiTitlesForFetch();
      const available = titles.length > 0;

      if(toggle){
        toggle.disabled = !available;
        if(!available) toggle.checked = false;
      }

      if(hint) hint.style.display = available ? "none" : "block";
      if(badge) H.setBadge("badgeAi", available ? "good" : "warn", available ? (titles.length + " titles") : "Locked");
    }

    async function manualFetchJobs(){
      const btn = $("btnFetchJobsNow");
      const status = $("fetchJobsStatus");
      const toggle = $("toggleAiOnly");

      const setState = (loading, msg) => {
        if(btn){
          btn.disabled = !!loading;
          btn.textContent = loading ? "Fetching…" : "Fetch new jobs";
        }
        if(status) status.textContent = msg || "";
      };

      try{
        const next = getNextFetchAllowedAt();
        if(next && Date.now() < next){
          const sec = Math.ceil((next - Date.now()) / 1000);
          setState(false, "Please wait " + sec + "s before fetching again.");
          updateFetchMetaUI();
          return;
        }

        if(!lastSessionToken){
          throw new Error("No session token. Please sign in again.");
        }

        // Start cooldown immediately (avoid double-click spamming)
        try{ localStorage.setItem("jm_last_manual_fetch_ts", String(Date.now())); }catch(_){ }
        updateFetchMetaUI();

        const aiOnly = !!(toggle && toggle.checked);
        const titles = aiOnly ? getAiTitlesForFetch() : [];

        setState(true, aiOnly ? "Fetching (AI titles only)…" : "Fetching…");

        const resp = await apiPost("/me/jobs/fetch", lastSessionToken, {
          include_ai_titles: aiOnly,
          ai_titles: titles,
          fetch_mode: aiOnly ? "ai_only" : "profile"
        });

        if(resp && resp.skipped){
          if(resp.reason === "queue_full"){
            setState(false, "Skipped: queue has " + resp.queue_new_count + " new jobs (cap " + resp.max_queue_new + ").");
          }else{
            setState(false, "Skipped: " + String(resp.reason || ""));
          }
          await refreshQueue();
          return;
        }

        const added = (typeof resp.jobs_added === "number") ? resp.jobs_added : 0;
        const q = (typeof resp.queue_new_count === "number") ? resp.queue_new_count : "—";
        const rad = (resp.used_radius !== undefined && resp.used_radius !== null) ? resp.used_radius : "—";
        const ml = (resp.match_level !== undefined && resp.match_level !== null) ? resp.match_level : "—";

        setState(false, "Added " + added + " · Queue new: " + q + " · Radius " + rad + "km · Match " + ml);

        await refreshQueue();
      }catch(e){
        setState(false, e?.message || "Fetch failed");
        showError(e?.message || "Fetch failed");
      }finally{
        updateFetchMetaUI();
      }
    }

    /* -------------------------
       Refresh queue
       ------------------------- */
    async function refreshQueue(){
      showError("");
      setHtml("queueError", "");
      setHtml("queueWrap", '<div class="skeleton block"></div>');

      const queue = await apiGet("/me/jobs/queue", lastSessionToken);
      lastQueueResponse = queue;

      const qCount = (typeof queue.count === "number") ? queue.count : (Array.isArray(queue.data) ? queue.data.length : 0);
      currentQueueCount = qCount;

      H.setBadge("badgeQueue", qCount > 0 ? "good" : "warn", (qCount > 0 ? (qCount + " jobs") : "Empty"));

      // Tailor summaries (ATS badge) - best effort
      try{
        const ids = Array.isArray(queue.data) ? queue.data.map(j => j && j.id).filter(Boolean) : [];
        await loadTailorSummariesForJobs(ids);
      }catch(_){ }

      setHtml("queueWrap", renderQueueList(queue));

      updateFetchMetaUI();

      // Selection logic
      const items = Array.isArray(queue?.data) ? queue.data : [];
      ensureSelectionAfterRender(items);

      return queue;
    }

    /* -------------------------
       Nav: Activity log modal
       ------------------------- */
    function activityBadge(type){
      const t = String(type || "").toLowerCase();
      if(t === "applied") return { cls:"good", label:"Applied" };
      if(t === "sent") return { cls:"good", label:"Sent" };
      if(t === "rejected") return { cls:"bad", label:"Rejected" };
      if(t === "skipped") return { cls:"warn", label:"Skipped" };
      if(t === "prioritized") return { cls:"prio", label:"Prioritized" };
      if(t === "queued") return { cls:"warn", label:"Queued" };
      if(t === "new") return { cls:"warn", label:"New" };
      return { cls:"", label:(type || "Event") };
    }

    function fmtWhen(ts){
      try{
        if(!ts) return "—";
        const d = new Date(ts);
        if(Number.isNaN(d.getTime())) return String(ts);
        return d.toLocaleString();
      }catch(_){
        return String(ts || "—");
      }
    }

    function renderActivityList(items, kind){
      const arr = Array.isArray(items) ? items : [];
      if(!arr.length){
        return '<span class="badge warn">No activity yet</span>';
      }

      const html = arr.slice(0, 20).map((row) => {
        const evType = kind === "applications" ? String(row.status || "new") : String(row.event_type || "");
        const b = activityBadge(evType);

        const job = (row && row.job) ? row.job : {};
        const title = String(job.title || "Untitled");
        const company = String(job.company_name || job.company || "—");
        const loc = [job.city || "", job.region || ""].filter(Boolean).join(", ") || "—";
        const when = kind === "applications" ? (row.updated_at || row.created_at) : row.created_at;
        const link = job.apply_url ? String(job.apply_url) : "";

        const titleHtml = link
          ? ('<a href="' + H.escapeHtml(link) + '" target="_blank" rel="noopener">' + H.escapeHtml(title) + "</a>")
          : H.escapeHtml(title);

        let meta = "";
        try{
          if(kind !== "applications" && row.meta && typeof row.meta === "object"){
            if(row.meta.channel) meta = "via " + String(row.meta.channel);
            if(row.meta.reason_code) meta = meta ? (meta + " • reason: " + String(row.meta.reason_code)) : ("reason: " + String(row.meta.reason_code));
          }
        }catch(_){ }

        return (
          '<div class="activityItem">'
            + '<div class="activityTop">'
              + '<div class="activityTitle">' + titleHtml + '</div>'
              + '<span class="badge ' + H.escapeHtml(b.cls) + '">' + H.escapeHtml(b.label) + '</span>'
            + '</div>'
            + '<div class="activityMeta">'
              + '<span>' + H.escapeHtml(company) + '</span>'
              + '<span>•</span>'
              + '<span>' + H.escapeHtml(loc) + '</span>'
              + '<span>•</span>'
              + '<span>' + H.escapeHtml(fmtWhen(when)) + '</span>'
              + (meta ? ('<span class="mono">• ' + H.escapeHtml(meta) + '</span>') : '')
            + '</div>'
          + '</div>'
        );
      }).join("");

      return '<div class="activityList">' + html + '</div>';
    }

    async function loadActivityLog(){
      H.showTopError("activityError", "");
      setHtml("activityWrap", '<div class="modalMonoBox">Loading…</div>');

      const token = session && session.access_token ? String(session.access_token) : "";
      if(!token){
        H.showTopError("activityError", "You are signed out. Please sign in again.");
        setHtml("activityWrap", "");
        return;
      }

      const et = String($("activityFilter")?.value || "").trim();
      const headers = { Authorization: "Bearer " + token };

      // 1) Try timeline endpoint first
      try{
        let url = API_BASE + "/me/application-events?limit=20";
        if(et) url += "&event_type=" + encodeURIComponent(et);

        const res = await fetch(url, { method:"GET", headers });
        const text = await res.text().catch(() => "");
        let json = null;
        try{ json = JSON.parse(text); }catch{ json = { raw: text }; }

        if(!res.ok){
          const msg = (json && (json.error || json.message)) ? String(json.error || json.message) : (text || ("HTTP " + res.status));
          throw new Error(msg);
        }

        const items = Array.isArray(json?.data) ? json.data : [];
        setHtml("activityWrap", renderActivityList(items, "events"));
        return;
      }catch(_){
        // fallback below
      }

      // 2) Fallback: applications list
      try{
        const map = { queued:"new", prioritized:"new", applied:"applied", rejected:"rejected", skipped:"skipped", sent:"applied" };
        let url = API_BASE + "/me/applications?limit=20";
        if(et && map[et]) url += "&status=" + encodeURIComponent(map[et]);

        const res = await fetch(url, { method:"GET", headers });
        const text = await res.text().catch(() => "");
        let json = null;
        try{ json = JSON.parse(text); }catch{ json = { raw: text }; }

        if(!res.ok){
          const msg = (json && (json.error || json.message)) ? String(json.error || json.message) : (text || ("HTTP " + res.status));
          throw new Error(msg);
        }

        const items = Array.isArray(json?.data) ? json.data : [];
        setHtml("activityWrap", renderActivityList(items, "applications"));
      }catch(e){
        H.showTopError("activityError", e?.message || String(e));
        setHtml("activityWrap", '<span class="badge bad">Activity failed</span>');
      }
    }

    function openActivityModal(){
      const dd = $("navAccount");
      if(dd) dd.open = false;
      H.showModal("activityModal");
      loadActivityLog().catch((e) => H.showTopError("activityError", e?.message || String(e)));
    }

    function closeActivityModal(){
      H.hideModal("activityModal");
      H.showTopError("activityError", "");
    }

    /* -------------------------
       Boot
       ------------------------- */
    async function loadStateAndNav(){
      H.setBadge("authBadge", "warn", "Checking…");

      // Sanity check: auth.js must be present
      if(!window.JobApplyAI || !window.JobApplyAI.auth || typeof window.JobApplyAI.auth.getSession !== "function"){
        H.setBadge("authBadge", "bad", "Config error");
        showError("auth.js did not load. Ensure multipage/auth.js exists and is referenced as ./auth.js.");
        return null;
      }

      session = await window.JobApplyAI.auth.getSession();
      if(!session || !session.user || !session.user.email){
        H.setBadge("authBadge", "warn", "Signed out");
        window.location.replace("./signup.html");
        return null;
      }

      lastSessionToken = String(session.access_token || "");
      try{ if(lastSessionToken) sessionStorage.setItem("sb_access_token", lastSessionToken); }catch(_){ }

      // Nav state
      const navAcct = $("navAccount");
      if(navAcct) navAcct.style.display = "";
      const navSignIn = $("navSignIn");
      if(navSignIn) navSignIn.style.display = "none";

      H.setBadge("authBadge", "good", "Signed in");

      // Ensure customer exists (best-effort)
      try{ await window.JobApplyAI.auth.requireAuthAndCustomer({ redirectTo: "./signup.html" }); }catch(_){ }
      try{ await window.JobApplyAI.auth.syncStateToLocalStorage(session); }catch(_){ }

      return session;
    }

    async function loadAccountHints(){
      // AI titles from server for the fetch toggle
      try{
        const prof = await apiGet("/me/profile", lastSessionToken);
        const a = (prof && prof.profile && Array.isArray(prof.profile.ai_titles)) ? prof.profile.ai_titles : [];
        aiTitles = Array.isArray(a) ? a : [];
        try{ localStorage.setItem("jm_ai_titles_server", JSON.stringify(aiTitles)); }catch(_){ }
      }catch(_){
        aiTitles = [];
      }

      // State for onboarding hint + plan daily
      try{
        const st = await apiGet("/me/state", lastSessionToken);
        const profileOk = !!(st && st.profile_complete);
        const cvOk = !!(st && st.cv_uploaded);
        const plan = planFromState(st && st.plan_id);
        currentPlanDaily = plan.daily;

        if(!profileOk || !cvOk){
          setText("onboardingHint", "Your Profile is not complete yet. Go to Profile, upload your CV, then come back to fetch jobs.");
        }else{
          setText("onboardingHint", "Profile looks good. Select a job, review it, then tailor your CV in CV Studio.");
        }
      }catch(_){
        setText("onboardingHint", "You can fetch jobs after your Profile is complete.");
      }

      updateAiSwitchState();
      updateFetchMetaUI();
    }

    async function boot(){
      showError("");

      setDetailEmpty();

      await loadStateAndNav();
      if(!session) return;

      await loadAccountHints();
      wireQueueClicks();
      wireDetailClicks();

      // Initial data
      await refreshQueue();
    }

    /* -------------------------
       Wire UI events
       ------------------------- */
    $("btnRefresh")?.addEventListener("click", () => {
      refreshQueue().catch((e) => showError(e?.message || String(e)));
    });

    $("btnFetchJobsNow")?.addEventListener("click", () => {
      manualFetchJobs().catch((e) => showError(e?.message || String(e)));
    });

    $("toggleAiOnly")?.addEventListener("change", () => {
      updateAiSwitchState();
    });

    // Skip modal wiring
    $("skipCloseX")?.addEventListener("click", closeSkipModal);
    $("skipCancel")?.addEventListener("click", closeSkipModal);
    $("skipConfirm")?.addEventListener("click", submitSkip);
    $("skipModal")?.addEventListener("click", (e) => { if(e.target && e.target.id === "skipModal") closeSkipModal(); });

    // Activity modal wiring
    $("navActivity")?.addEventListener("click", openActivityModal);
    $("activityCloseX")?.addEventListener("click", closeActivityModal);
    $("activityClose")?.addEventListener("click", closeActivityModal);
    $("activityModal")?.addEventListener("click", (e) => { if(e.target && e.target.id === "activityModal") closeActivityModal(); });
    $("activityRefresh")?.addEventListener("click", () => loadActivityLog().catch(()=>{}));
    $("activityFilter")?.addEventListener("change", () => loadActivityLog().catch(()=>{}));

    // Logout
    $("navLogout")?.addEventListener("click", async () => {
      try{ await window.JobApplyAI.auth.logout("./index.html"); }
      catch(_){ window.location.href = "./index.html"; }
    });

    window.addEventListener("load", () => {
      boot().catch((e) => {
        showError(e?.message || String(e));
        H.setBadge("authBadge", "bad", "Error");
      });
    });

  })();
  </script>
</body>
</html>
