<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>jobmejob â€¢ dashboard</title>
<style>
:root{
--bg:#f6f7fb;
--text:#111318;
--muted:rgba(17,19,24,.64);
--muted2:rgba(17,19,24,.48);
--line:rgba(17,19,24,.12);

/* jobmejob green CI */
--accent:#22c55e;
--accent2:#16a34a;

--ok:#16a34a;
--warn:#b86b00;
--bad:#d81b60;
--shadow:0 12px 34px rgba(17,19,24,.12);
--radius:18px;
--max:1120px;
--safeTop: env(safe-area-inset-top, 0px);
--safeBottom: env(safe-area-inset-bottom, 0px);

--surface:#ffffff;
--surface2:#ffffff;
--surface3:#fbfcff;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
margin:0;
font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
color:var(--text);
background:
radial-gradient(1200px 650px at 20% -10%, rgba(34,197,94,.18), transparent 55%),
radial-gradient(900px 500px at 90% 10%, rgba(22,163,74,.14), transparent 55%),
radial-gradient(800px 600px at 70% 110%, rgba(34,197,94,.08), transparent 55%),
var(--bg);
overflow-x:hidden;
}
a{color:inherit;text-decoration:none}
small{color:var(--muted)}

.topbar{
position:sticky;
top:0;
z-index:30;
background:rgba(246,247,251,.86);
backdrop-filter:saturate(1.2) blur(12px);
border-bottom:1px solid var(--line);
padding-top:var(--safeTop);
}
.nav{
max-width:var(--max);
margin:0 auto;
padding:12px 16px;
display:flex;
align-items:center;
justify-content:space-between;
gap:12px;
}
.brand{
display:flex;
align-items:center;
gap:10px;
font-weight:950;
letter-spacing:.2px;
min-width:0;
}
.logo{
width:34px;height:34px;border-radius:11px;
background: linear-gradient(135deg, var(--accent), var(--accent2));
box-shadow: 0 10px 30px rgba(34,197,94,.22);
flex:0 0 auto;
position:relative;
overflow:hidden;
}
.logo::after{
content:"";
position:absolute;
inset:-45%;
background:linear-gradient(90deg, transparent, rgba(255,255,255,.75), transparent);
transform:rotate(20deg);
animation:shine 2.8s ease-in-out infinite;
}
@keyframes shine{
0%{transform:translateX(-55%) rotate(20deg);opacity:0}
35%{opacity:1}
70%{opacity:0}
100%{transform:translateX(55%) rotate(20deg);opacity:0}
}

.navlinks{
display:flex;
align-items:center;
gap:10px;
flex-wrap:wrap;
justify-content:flex-end;
}
.pill{
padding:9px 12px;
border:1px solid var(--line);
border-radius:999px;
background:rgba(17,19,24,.04);
font-weight:850;
font-size:13px;
transition:.15s ease;
cursor:pointer;
white-space:nowrap;
}
.pill:hover{transform:translateY(-1px);background:rgba(17,19,24,.06)}
.pill.active{border-color:rgba(34,197,94,.60); background:rgba(34,197,94,.16)}
.pill.iconOnly{padding:9px 10px}

.main{
max-width:var(--max);
margin:0 auto;
padding:18px 16px calc(18px + var(--safeBottom));
}
.h1{
font-size:36px;
line-height:1.05;
letter-spacing:-.8px;
margin:10px 0 8px 0;
}
.sub{margin:0 0 14px 0;color:var(--muted);font-weight:650}

.card{
background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.82));
border:1px solid var(--line);
border-radius:var(--radius);
box-shadow:var(--shadow);
padding:14px;
overflow:hidden;
}
.cardNoPad{padding:0}

.card h2{
margin:0 0 10px 0;
font-size:16px;
display:flex;
align-items:center;
justify-content:space-between;
gap:10px;
}
.hr{height:1px;background:var(--line);margin:12px 0}

.kpi{
display:flex;
align-items:flex-end;
justify-content:space-between;
gap:10px;
flex-wrap:wrap;
}
.kpi > div{min-width:0;flex:1 1 auto}
.kpi .value{
font-size:34px;
font-weight:950;
letter-spacing:-.6px;
line-height:1;
word-break:break-word;
}
.kpi .label{
color:var(--muted2);
font-weight:750;
font-size:12px;
}

.badge{
display:inline-flex;
align-items:center;
gap:8px;
padding:7px 10px;
border-radius:999px;
border:1px solid var(--line);
background:rgba(17,19,24,.05);
color:var(--muted);
font-size:12px;
font-weight:850;
white-space:nowrap;
max-width:100%;
}
.badge.good{border-color:rgba(34,197,94,.40); background:rgba(34,197,94,.12); color:#0a3d1f}
.badge.warn{border-color:rgba(255,179,0,.5); background:rgba(255,179,0,.12); color:#5a3b00}
.badge.bad{border-color:rgba(255,61,113,.55); background:rgba(255,61,113,.12); color:#5a1130}
.badge.prio{border-color:rgba(34,197,94,.55); background:rgba(34,197,94,.16); color:#0a3d1f}

.actions{
display:flex;
gap:10px;
flex-wrap:wrap;
align-items:center;
}
.btn{
appearance:none;
border:1px solid var(--line);
background:rgba(17,19,24,.06);
color:var(--text);
padding:11px 14px;
border-radius:999px;
font-weight:900;
font-size:13px;
cursor:pointer;
transition:.15s ease;
display:inline-flex;
align-items:center;
gap:8px;
text-decoration:none;
}
.btn:hover{transform:translateY(-1px); background:rgba(17,19,24,.08)}
.btn:disabled{opacity:.6; cursor:not-allowed; transform:none}
.btn.primary{
border-color:rgba(34,197,94,.55);
background:linear-gradient(135deg, rgba(34,197,94,.28), rgba(22,163,74,.16));
}
.btn.ghost{
border-color:rgba(17,19,24,.14);
background:rgba(17,19,24,.04);
}
.btn.danger{
border-color:rgba(255,61,113,.45);
background:rgba(255,61,113,.12);
}
.btn.small{
padding:9px 12px;
font-size:12px;
font-weight:900;
}

.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.chip{
border:1px solid rgba(17,19,24,.14);
background:rgba(17,19,24,.04);
color:var(--muted);
padding:8px 10px;
border-radius:999px;
font-weight:850;
font-size:12px;
cursor:pointer;
transition:.15s ease;
}
.chip:hover{transform:translateY(-1px); background:rgba(17,19,24,.06)}
.chip.active{border-color:rgba(34,197,94,.55); background:rgba(34,197,94,.16); color:#0a3d1f}

.small{font-size:12px;color:var(--muted2);font-weight:650}
.mono{
font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
font-size:12px;
word-break:break-all;
color:rgba(17,19,24,.64);
}

.meter{
width:100%;
height:10px;
border-radius:999px;
border:1px solid rgba(17,19,24,.14);
background:rgba(17,19,24,.04);
overflow:hidden;
margin-top:10px;
}
.meter > div{
height:100%;
width:0%;
background: linear-gradient(135deg, var(--accent), var(--accent2));
border-radius:999px;
transition:width .25s ease;
}

.errorTop{
margin:12px 0 12px 0;
padding:12px 14px;
border-radius:16px;
border:1px solid rgba(255,61,113,.25);
background:rgba(255,61,113,.10);
color:#5a1130;
font-weight:800;
display:none;
}
.error{
margin-top:10px;
padding:10px 12px;
border-radius:14px;
border:1px solid rgba(255,61,113,.25);
background:rgba(255,61,113,.10);
color:#5a1130;
font-weight:750;
font-size:13px;
}

.kpiBoard{
display:grid;
grid-template-columns: 2fr 1fr 1fr 1fr;
gap:14px;
margin:12px 0 16px 0;
align-items:stretch;
}
.kpiBoard .card{height:100%}

.grid{
display:grid;
grid-template-columns:repeat(12, minmax(0,1fr));
gap:16px;
align-items:start;
}
.grid > section.card{grid-column:span 8;}
.grid > aside.card{grid-column:span 4;position:sticky;top:92px}

.sectionHeader{
background:var(--surface2);
border-bottom:1px solid rgba(17,19,24,.10);
padding:14px;
}
.sectionBody{padding:14px}

.list{display:flex;flex-direction:column;gap:12px}
.listGrid{
display:grid;
grid-template-columns:repeat(2, minmax(0,1fr));
gap:12px;
}
.item{
border:1px solid rgba(17,19,24,.12);
background:var(--surface3);
border-radius:16px;
padding:14px;
}
.itemTop{
display:flex;
justify-content:space-between;
gap:10px;
align-items:flex-start;
}

.badgeGroup{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.itemTitle{font-weight:950;line-height:1.2}
.itemMeta{
margin-top:6px;
display:flex;
flex-wrap:wrap;
gap:8px;
color:var(--muted2);
font-size:12px;
font-weight:750;
}
.tagRow{margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;}
.tag{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid rgba(17,19,24,.12);background:rgba(17,19,24,.04);font-size:11px;font-weight:800;color:var(--muted2);}
.tag.ok{border-color:rgba(0,184,98,.25);background:rgba(0,184,98,.08);}
.tag.warn{border-color:rgba(255,179,0,.28);background:rgba(255,179,0,.10);}
.tag.bad{border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.08);}

.itemActions{
margin-top:10px;
display:flex;
gap:10px;
flex-wrap:wrap;
}
.itemActions .btn{flex:1 1 auto;justify-content:center}

/* Table swipe */
.tableWrap{
overflow-x:auto;
overflow-y:hidden;
-webkit-overflow-scrolling:touch;
touch-action:pan-x pan-y;
border-radius:16px;
border:1px solid rgba(17,19,24,.12);
background:rgba(17,19,24,.03);
}
.table{
width:100%;
min-width:1100px;
border-collapse:separate;
border-spacing:0;
}
.table th,.table td{
text-align:left;
padding:10px 10px;
font-size:13px;
border-bottom:1px solid rgba(17,19,24,.10);
vertical-align:top;
}
.table th{
background:rgba(17,19,24,.06);
font-weight:950;
position:sticky;
top:0;
}
.table tr:last-child td{border-bottom:0}
.table a{color:var(--accent2);text-decoration:underline}

.skeleton{
border-radius:12px;
height:12px;
background:linear-gradient(90deg, rgba(17,19,24,.10), rgba(17,19,24,.04), rgba(17,19,24,.10));
background-size:200% 100%;
animation:shimmer 1.2s linear infinite;
}
.skeleton.block{height:140px;border-radius:16px}
@keyframes shimmer{
0%{background-position:200% 0}
100%{background-position:-200% 0}
}

/* Modal */
.modalBackdrop{
position:fixed;
inset:0;
z-index:999;
background:rgba(17,19,24,.45);
display:flex;
align-items:center;
justify-content:center;
padding:16px;
}
.modalCard{
width:min(520px, 100%);
border:1px solid rgba(17,19,24,.14);
background:var(--surface2);
border-radius:18px;
box-shadow:0 18px 50px rgba(0,0,0,.55);
padding:14px;
}
.modalTitle{
font-weight:950;
font-size:16px;
margin:0 0 10px 0;
}
.field{
display:flex;
flex-direction:column;
gap:6px;
margin-top:10px;
}
label{font-size:12px;color:var(--muted);font-weight:800}
select,textarea{
border:1px solid rgba(17,19,24,.14);
background:rgba(17,19,24,.04);
color:var(--text);
border-radius:12px;
padding:10px 12px;
outline:none;
}
textarea{min-height:80px;resize:vertical}
.modalActions{
display:flex;
gap:10px;
flex-wrap:wrap;
justify-content:flex-end;
margin-top:12px;
}
.modalActions .btn{flex:0 0 auto}

.footer{
max-width:var(--max);
margin:0 auto;
padding:18px 16px 30px;
color:var(--muted2);
font-size:13px;
}

@media (max-width:1100px){
.grid{grid-template-columns:1fr}
.grid > section.card{grid-column:auto}
.grid > aside.card{grid-column:auto;position:static}
.kpiBoard{grid-template-columns:1fr 1fr}
.listGrid{grid-template-columns:1fr}
.table{min-width:980px}
}
@media (max-width:760px){
.kpiBoard{grid-template-columns:1fr 1fr}
.listGrid{grid-template-columns:1fr}
.table{min-width:900px}
}
@media (max-width:620px){
.nav{padding:10px 12px}
.main{padding:16px 12px calc(16px + var(--safeBottom))}
.h1{font-size:30px}
.actions{flex-direction:column;align-items:stretch}
.btn{justify-content:center;width:100%}
.kpiBoard{grid-template-columns:1fr}
.table{min-width:820px}
.modalActions{flex-direction:column}
.modalActions .btn{width:100%;justify-content:center}
}
@media (prefers-reduced-motion: reduce){
.skeleton{animation:none}
.meter > div{transition:none}
.pill,.btn,.chip{transition:none}
}

.pill.mini{padding:7px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(17,19,24,.04);font-weight:850;font-size:12px;display:inline-flex;align-items:center}
.leaving{opacity:.7;transform:translateY(6px);transition:all .18s ease}

/* Fetch button + AI switch */
#btnFetchJobsNow{
background: linear-gradient(135deg, var(--accent2), var(--accent));
border: 0;
color: #0b1020;
font-weight: 700;
box-shadow: 0 10px 22px rgba(79,104,255,.22);
}
#btnFetchJobsNow:disabled{
opacity: .55;
cursor: not-allowed;
box-shadow: none;
}
.switchWrap{display:flex;align-items:center;gap:10px;padding:6px 10px;border:1px solid rgba(255,255,255,.10);border-radius:999px;background:rgba(255,255,255,.04)}
.switch{position:relative;display:inline-block;width:44px;height:24px}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.25);transition:.2s;border-radius:999px}
.slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background:white;transition:.2s;border-radius:50%}
.switch input:checked + .slider{background:linear-gradient(135deg,var(--accent2),var(--accent))}
.switch input:checked + .slider:before{transform:translateX(20px)}


/* AI switch gated hint + fetch meta */
.switchHint{display:inline-flex;align-items:center;gap:8px;margin-left:10px;padding:4px 10px;border-radius:999px;background:rgba(0,0,0,.04);border:1px solid rgba(0,0,0,.06)}
.switchHint .lock{font-size:14px;opacity:.8}
.switchHint a{color:var(--accent2);text-decoration:none;font-weight:700}
.switchHint a:hover{text-decoration:underline}
#fetchMeta{white-space:nowrap}
.switch input:disabled + .slider{opacity:.5;cursor:not-allowed}

</style>
</head>
<body>
<header class="topbar" id="topbar">
<nav class="nav">
<a class="brand" href="index.html" data-nav="1"><span class="logo" aria-hidden="true"></span><span>jobmejob</span></a>
<div class="navlinks">
<a class="pill" href="index.html" data-nav="1">Home</a>
<a class="pill" href="profile.html" data-nav="1">Profile</a>
<a class="pill" href="plan.html" data-nav="1">Plan</a>
<a class="pill active" href="dashboard.html" data-nav="1">Dashboard</a>
<button class="pill iconOnly" id="btnLogout" type="button" aria-label="Logout">Logout</button>
</div>
</nav>
</header>

<main class="main">
<h1 class="h1">Dashboard</h1>
<p class="sub" id="subLine">Loadingâ€¦</p>
<div class="errorTop" id="errorTop"></div>

<div class="kpiBoard">
<div class="card">
<h2>Health status <span class="badge" id="badgeHealth">Loading</span></h2>
<div class="kpi">
<div>
<div class="value" id="kpiHealthLabel">â€“</div>
<div class="label">job supply vs your plan</div>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
<span class="badge" id="badgeHealthPlan">Plan: â€“</span>
<span class="badge" id="badgeHealthQueue">Queue: â€“</span>
<span class="badge" id="badgeHealthCap">Today cap: â€“</span>
</div>
</div>
<div class="meter"><div id="healthMeterFill"></div></div>
<div style="margin-top:10px" id="healthNote"></div>
</div>

<div class="card">
<h2>Job queue</h2>
<div class="kpi">
<div>
<div class="value" id="kpiQueue">â€“</div>
<div class="label">jobs ready</div>
</div>
<span class="badge" id="badgeQueue">Loading</span>
</div>
</div>

<div class="card">
<h2>Applications</h2>
<div class="kpi">
<div>
<div class="value" id="kpiAppsTotal">â€“</div>
<div class="label">total</div>
</div>
<span class="badge" id="badgeApps">Loading</span>
</div>
</div>

<div class="card">
<h2>Plan</h2>
<div class="kpi">
<div>
<div class="value" id="kpiPlanName">â€“</div>
<div class="label" id="kpiPlanMeta">selected</div>
</div>
<span class="badge" id="badgePlan">Loading</span>
</div>
</div>

<div class="card" id="aiInsightsCard">
<h2>AI insights <span class="badge" id="badgeAi">New</span></h2>
<div class="small" id="aiInsightsHint">Generate suggestions in Profile to unlock this.</div>
<div class="hr"></div>
<div class="small" style="font-weight:850">Top titles</div>
<div class="chips" id="aiTopTitles" style="margin-top:10px"></div>
<div style="height:10px"></div>
<div class="small" style="font-weight:850">Alternative roles</div>
<div class="chips" id="aiAltRoles" style="margin-top:10px"></div>
<div style="height:10px"></div>
<div class="small" style="font-weight:850">Top skills</div>
<div class="chips" id="aiTopSkills" style="margin-top:10px"></div>
</div>
</div>

<div class="grid">
<section class="card cardNoPad">
<div class="sectionHeader">
<h2>Queue preview</h2>
<p class="small" id="queueHint">Use Skip to remove jobs you donâ€™t want. Use Prio to apply to these first.</p>
<div class="actions">
<button class="btn primary" id="btnRefresh" type="button">Refresh</button>
<button class="btn" id="btnFetchJobsNow" type="button">Fetch new jobs</button>
<div class="switchWrap" title="When ON: search using only AI-generated titles">
<span class="small">AI titles only</span>
<label class="switch">
<input type="checkbox" id="toggleAiOnly" />
<span class="slider"></span>
</label>
<div class="switchHint" id="aiSwitchHint" style="display:none">
<span class="lock">ðŸ”’</span>
<a href="profile.html">Generate AI suggestions to unlock</a>
<span class="small" id="fetchMeta" style="margin-left:auto;opacity:.85"></span></div>
</div>
<button class="btn" id="btnCopyToken" type="button">Copy access token</button>
<span class="small" id="fetchJobsStatus" style="margin-left:auto;opacity:.85"></span>
</div>
<div class="hr"></div>
<div class="small" id="skipGuardrail" style="display:none"></div>
</div>

<div class="sectionBody">
<div id="queueWrap"><div class="skeleton block"></div></div>
<div id="queueError"></div>

<div class="hr"></div>

<div class="sectionHeader" style="border-radius:0;border-left:0;border-right:0">
<h2 style="margin:0">Application activity log</h2>
<p class="small">Latest timeline events (queued, prioritized, skipped, appliedâ€¦).</p>
<div class="chips" id="activityFilters">
<button class="chip active" type="button" data-etype="">All</button>
<button class="chip" type="button" data-etype="queued">Queued</button>
<button class="chip" type="button" data-etype="prioritized">Prioritized</button>
<button class="chip" type="button" data-etype="applied">Applied</button>
<button class="chip" type="button" data-etype="sent">Sent</button>
<button class="chip" type="button" data-etype="rejected">Rejected</button>
<button class="chip" type="button" data-etype="skipped">Skipped</button>
</div>
</div>

<div class="hr"></div>

<div id="activityWrap"><div class="skeleton block"></div></div>
<div id="activityError"></div>
</div>
</section>

<aside class="card">
<h2>Account</h2>
<div class="badge good" id="badgeUser">Signed in</div>
<div class="hr"></div>

<div class="small">Email</div>
<div class="mono" id="meEmail">â€“</div>

<div class="hr"></div>
<div class="small">Customer ID</div>
<div class="mono" id="meCustomerId">â€“</div>

<div class="hr"></div>
<div class="small">Onboarding checks</div>
<div id="onboardingChecks"><div class="skeleton block"></div></div>

<div class="hr"></div>
<div class="small">Applications breakdown</div>
<div id="appsBreakdown"><div class="skeleton block"></div></div>

<div class="hr"></div>
<div class="small">Last refresh</div>
<div class="mono" id="lastCheck">â€“</div>

<div class="hr"></div>
<div class="actions">
<a class="btn ghost" href="profile.html" data-nav="1">Edit profile</a>
<a class="btn ghost" href="plan.html" data-nav="1">Change plan</a>
</div>

<div class="hr"></div>
<div class="small" id="errorBox"></div>
</aside>
</div>
</main>

<div class="modalBackdrop" id="skipModal" style="display:none">
<div class="modalCard">
<div class="modalTitle">Skip this job</div>

<div class="field">
<label for="skipReason">Reason</label>
<select id="skipReason">
<option value="not_relevant">Not relevant</option>
<option value="too_far">Too far</option>
<option value="wrong_industry">Wrong industry</option>
<option value="salary_too_low">Salary too low</option>
<option value="already_applied">Already applied</option>
<option value="other">Other</option>
</select>
</div>

<div class="field">
<label for="skipNote">Note</label>
<textarea id="skipNote" placeholder="Optional noteâ€¦"></textarea>
</div>

<div class="modalActions">
<button class="btn ghost" id="skipCancel" type="button">Cancel</button>
<button class="btn danger" id="skipConfirm" type="button">Skip</button>
</div>
</div>
</div>

<div class="modalBackdrop" id="descModal" style="display:none">
  <div class="modalCard" style="max-width:920px">
    <div class="modalTitle" id="descTitle">Job description</div>
    <div class="small" id="descMeta" style="margin-top:-6px"></div>
    <div class="hr" style="margin:14px 0"></div>
    <div id="descBody" class="mono" style="white-space:pre-wrap; font-size:13px; line-height:1.45; max-height:60vh; overflow:auto; background:rgba(17,19,24,.04); border:1px solid rgba(17,19,24,.14); padding:12px; border-radius:14px;">Loadingâ€¦</div>
    <div class="modalActions">
      <button class="btn ghost" id="descClose" type="button">Close</button>
      <button class="btn" id="descCopy" type="button">Copy</button>
    </div>
  </div>
</div>


<div class="modalBackdrop" id="tailorModal" style="display:none">
  <div class="modalCard" style="max-width:960px">
    <div class="modalTitle" id="tailorTitle">Tailored CV</div>
    <div class="small" id="tailorMeta" style="margin-top:-6px"></div>
    <div class="hr" style="margin:14px 0"></div>
    <div id="tailorKeywords" class="small" style="margin-bottom:10px"></div>
    <div id="tailorBody" class="mono" style="white-space:pre-wrap; font-size:13px; line-height:1.45; max-height:60vh; overflow:auto; background:rgba(17,19,24,.04); border:1px solid rgba(17,19,24,.14); padding:12px; border-radius:14px;">Generatingâ€¦</div>
    <div class="modalActions">
      <button class="btn ghost" id="tailorClose" type="button">Close</button>
      <button class="btn ghost" id="tailorRegenerate" type="button">Regenerate</button>
      <button class="btn" id="tailorCopy" type="button">Copy</button>
      <button class="btn" id="tailorPrint" type="button">Print / PDF</button>
      <button class="btn" id="tailorDownload" type="button">Download .txt</button>
    </div>
  </div>
</div>

<footer class="footer">Support: <a href="mailto:schonv2@gmail.com">schonv2@gmail.com</a></footer>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>

// Safety: some builds load helper functions later; ensure they exist before any event handlers run.
if (typeof updateFetchMetaUI !== "function") {
function updateFetchMetaUI(){ /* no-op until defined */ }
}
if (typeof updateAiSwitchState !== "function") {
function updateAiSwitchState(){ /* no-op until defined */ }

async function maybeAutoPersistAiTitles(){
  try{
    if(!lastSessionToken) await requireSession();

    // Backend profile
    const prof = await apiGet("/me/profile", lastSessionToken);
    const backendTitles = prof && Array.isArray(prof.ai_titles) ? prof.ai_titles : [];

    if(backendTitles.length){
      window.lastAiTitleSuggestions = backendTitles;
      updateAiSwitchState();
maybeAutoPersistAiTitles();
      return;
    }

    // Bridge from local AI cache once (from profile generation)
    const local = getAiTitlesForFetch();
    if(!local.length) return;

    await apiPost("/me/ai-titles/save", lastSessionToken, { ai_titles: local });

    const prof2 = await apiGet("/me/profile", lastSessionToken);
    const backendTitles2 = prof2 && Array.isArray(prof2.ai_titles) ? prof2.ai_titles : [];
    if(backendTitles2.length){
      window.lastAiTitleSuggestions = backendTitles2;
      updateAiSwitchState();
    }
  }catch(e){
    // non-blocking
  }
}
}

const API_BASE = (window.JobApplyAI && window.JobApplyAI.config && window.JobApplyAI.config.API_BASE) || "https://jobmejob.schoene-viktor.workers.dev";
const SUPABASE_URL="https://awlzvhcnjegfhjedswko.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF3bHp2aGNuamVnZmhqZWRzd2tvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2NTE2OTgsImV4cCI6MjA4MjIyNzY5OH0.-UmHiVi0_g9tKDkr6ldfROeBrOk8hm18YVPRfnb8luY";
let supabaseClient=null;

let lastSessionToken="";
let lastQueueResponse=null;
const tailorSummaryMap=new Map();
let currentPlanDaily=0;
let currentQueueCount=0;

let useEventsEndpoint=true;
let activityEventType="";

let pendingSkipJobId=null;
let pendingDescJobId=null;
let currentDescText="";
let pendingTailorJobId=null;
let currentTailorText="";
let currentTailorResult=null;

function setText(id,text){const el=document.getElementById(id); if(el) el.textContent=text;}
function setHtml(id,html){const el=document.getElementById(id); if(el) el.innerHTML=html;}
function setBadge(id,type,text){const el=document.getElementById(id); if(!el) return; el.className="badge"+(type?(" "+type):""); el.textContent=text;}
function showTopError(msg){const el=document.getElementById("errorTop"); if(!el) return; el.style.display="block"; el.textContent=msg;}
function clearTopError(){const el=document.getElementById("errorTop"); if(!el) return; el.style.display="none"; el.textContent="";}
function escapeHtml(s){return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");}
function nowStamp(){return new Date().toISOString().replace("T"," ").slice(0,19)+" UTC";}
function animateNumber(el,to){
const prefersReduced=window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches;
if(!el) return;
if(prefersReduced){el.textContent=String(to);return;}
const from=Number(String(el.textContent||"").replace(/[^\d.-]/g,""))||0;
const start=performance.now();
const dur=420;
function tick(t){
const p=Math.min(1,(t-start)/dur);
const eased=1-Math.pow(1-p,3);
const v=Math.round(from+(to-from)*eased);
el.textContent=String(v);
if(p<1) requestAnimationFrame(tick);
}
requestAnimationFrame(tick);
}
function renderSkeleton(){return '<div class="skeleton block"></div>'; }

function go(url){
document.body.classList.add("leaving");
setTimeout(()=>{window.location.href=url;},180);
}
document.addEventListener("click",(e)=>{
const a=e.target.closest("a[data-nav='1']");
if(!a) return;
const url=a.getAttribute("href");
if(!url || url.startsWith("#")) return;
e.preventDefault();
go(url);
});

function openDescModal(jobId){
pendingDescJobId=jobId;
currentDescText="";
document.getElementById("descTitle").textContent="Job description";
document.getElementById("descMeta").textContent="";
document.getElementById("descBody").textContent="Loadingâ€¦";
document.getElementById("descModal").style.display="flex";
loadDesc(jobId);
}
function closeDescModal(){
pendingDescJobId=null;
document.getElementById("descModal").style.display="none";
}
async function loadDesc(jobId){
try{
const session=await requireSession();
if(!session) return;
const resp=await apiGet("/me/jobs/description?job_id="+encodeURIComponent(jobId), session.access_token);
const job=resp && resp.job ? resp.job : null;
const title=(job && job.title) ? job.title : "Job description";
const company=(job && job.company_name) ? job.company_name : "";
const source=(job && job.description_full_source) ? job.description_full_source : "";
const fetchedAt=(job && job.description_full_fetched_at) ? job.description_full_fetched_at : "";
document.getElementById("descTitle").textContent=title;
document.getElementById("descMeta").textContent=[company ? ("Company: "+company) : "", source ? ("Source: "+source) : "", fetchedAt ? ("Fetched: "+fetchedAt) : ""].filter(Boolean).join(" Â· ");
const text=(job && job.description_full) ? String(job.description_full) : "";
currentDescText=text;
if(text){
document.getElementById("descBody").textContent=text;
}else if(job && job.description_full_error){
document.getElementById("descBody").textContent="No description yet. Last error: "+job.description_full_error;
}else{
document.getElementById("descBody").textContent="No description found.";
}
}catch(e){
document.getElementById("descBody").textContent="Failed to load description: "+(e.message||e);
}
}
async function copyDesc(){
try{
const t=currentDescText||"";
if(!t){alert("Nothing to copy yet.");return;}
await navigator.clipboard.writeText(t);
alert("Description copied.");
}catch(e){
window.prompt("Copy description:", currentDescText||"");
}
}


// Tailored CV modal
function openTailorModal(jobId, force){
  pendingTailorJobId=jobId;
  currentTailorText="";
  currentTailorResult=null;
  document.getElementById("tailorTitle").textContent="Tailored CV";
  document.getElementById("tailorMeta").textContent="";
  document.getElementById("tailorKeywords").textContent="";
  document.getElementById("tailorBody").textContent=force ? "Regeneratingâ€¦" : "Generatingâ€¦";
  document.getElementById("tailorModal").style.display="flex";
  generateTailoredCv(jobId, !!force);
}
function closeTailorModal(){
  pendingTailorJobId=null;
  document.getElementById("tailorModal").style.display="none";
}


function computeAtsMatchPercent(usedArr, missingArr){
  const used=Array.isArray(usedArr)?usedArr.filter(Boolean).length:0;
  const miss=Array.isArray(missingArr)?missingArr.filter(Boolean).length:0;
  const total=used+miss;
  if(total<=0) return null;
  return Math.round((used/total)*100);
}

async function loadTailorSummariesForJobs(jobIds){
  tailorSummaryMap.clear();
  const ids=Array.isArray(jobIds)?jobIds.filter(Boolean):[];
  if(!ids.length) return;
  if(!lastSessionToken) return;
  const slice=ids.slice(0,50);
  try{
    const resp=await apiGet("/me/cv/tailored?job_ids="+encodeURIComponent(slice.join(",")), lastSessionToken);
    const rows=(resp && Array.isArray(resp.data)) ? resp.data : [];
    for(const r of rows){
      if(r && r.job_id) tailorSummaryMap.set(String(r.job_id), r);
    }
  }catch(e){
    // silent: badges are optional
  }
}

function formatKeywordLine(label, arr){
  const list=Array.isArray(arr)?arr.filter(Boolean):[];
  if(!list.length) return "";
  return label+": "+list.slice(0,24).join(", ");
}

async function generateTailoredCv(jobId, force){
  try{
    const session=await requireSession();
    if(!session) return;

    document.getElementById("tailorBody").textContent=force ? "Regeneratingâ€¦" : "Generatingâ€¦";
    document.getElementById("tailorKeywords").textContent="";

    const resp=await apiPost("/me/cv/tailor", session.access_token, { job_id: jobId, force: !!force });

    const job=resp && resp.job ? resp.job : null;
    const res=resp && resp.result ? resp.result : null;
    currentTailorResult=res;

    const title=(job && job.title) ? job.title : "Tailored CV";
    const company=(job && job.company_name) ? job.company_name : "";
    const model=(res && res.model) ? res.model : "";
    const fromCache=resp && resp.from_cache;

    const atsPct=computeAtsMatchPercent(res ? res.ats_keywords_used : null, res ? res.ats_keywords_missing : null);
    const atsLabel=(atsPct!==null)?("ATS match: "+atsPct+"%") : "";

    document.getElementById("tailorTitle").textContent=title;
    document.getElementById("tailorMeta").textContent=[
      company ? ("Company: "+company) : "",
      model ? ("Model: "+model) : "",
      fromCache ? "cached" : "",
      atsLabel
    ].filter(Boolean).join(" Â· ");

    if(!res || !res.cv_text){
      document.getElementById("tailorBody").textContent="No CV generated.";
      return;
    }

    currentTailorText=String(res.cv_text);

    // Update in-memory summaries so the queue can show an ATS badge immediately
    tailorSummaryMap.set(String(jobId), {
      job_id: jobId,
      ats_keywords_used: res.ats_keywords_used || [],
      ats_keywords_missing: res.ats_keywords_missing || [],
      confidence: res.confidence || null,
      updated_at: new Date().toISOString()
    });
    if(lastQueueResponse){
      setHtml("queueWrap", renderQueueCards(lastQueueResponse));
    }

    const usedLine=formatKeywordLine("ATS keywords used", res.ats_keywords_used);
    const missingLine=formatKeywordLine("ATS keywords missing", res.ats_keywords_missing);
    const lines=[usedLine, missingLine].filter(Boolean).join("\n");
    document.getElementById("tailorKeywords").textContent=lines;

    document.getElementById("tailorBody").textContent=currentTailorText;
  }catch(e){
    document.getElementById("tailorBody").textContent="Failed to generate CV: "+(e.message||e);
  }
}

async function copyTailor(){
  try{
    const t=currentTailorText||"";
    if(!t){alert("Nothing to copy yet.");return;}
    await navigator.clipboard.writeText(t);
    alert("CV copied.");
  }catch(e){
    window.prompt("Copy CV:", currentTailorText||"");
  }
}


function cvTextToPrintableHtml(cvText){
  const raw=String(cvText||"").replace(/\r\n?/g,"\n").replace(/\u00a0/g," ");
  const lines=raw.split("\n");

  const ALL_HEADINGS = new Set([
    "CONTACT","PROFESSIONAL SUMMARY","WORK EXPERIENCE","EDUCATION","SKILLS","CERTIFICATIONS","LANGUAGES","PROJECTS","VOLUNTEERING","INTERESTS",
    "KONTAKT","PROFIL","BERUFSERFAHRUNG","AUSBILDUNG","KENNTNISSE","ZERTIFIKATE","SPRACHEN","PROJEKTE","EHRENAMT","INTERESSEN"
  ]);

  function isHeadingLine(t){
    const s=String(t||"").trim();
    if(!s) return false;
    const base=s.replace(/:$/,'').trim();
    const up=base.toUpperCase();
    if(ALL_HEADINGS.has(up)) return true;
    if(s.endsWith(":") && s.length<=70) return true;
    if(/^[A-ZÃ„Ã–Ãœáºž0-9 &/+,\.\-]{3,60}$/.test(base) && base===base.toUpperCase() && base.length<=45) return true;
    return false;
  }

  function isBulletLine(t){
    const s=String(t||"").trim();
    if(!s) return false;
    return /^(?:[-\u2013\u2014\u2022\u2023\u25E6\u2043\u2219\u00B7])(?:\s+|$)/.test(s);
  }
  function bulletContent(t){
    const s=String(t||"").trim();
    return s.replace(/^(?:[-\u2013\u2014\u2022\u2023\u25E6\u2043\u2219\u00B7])\s*/,"").trim();
  }

  let out=[];
  let inList=false;
  let inContact=false;
  let contactNameDone=false;

  function closeList(){
    if(inList){ out.push("</ul>"); inList=false; }
  }
  function closeContact(){
    if(inContact){ closeList(); out.push("</div>"); inContact=false; contactNameDone=false; }
  }

  for(let i=0;i<lines.length;i++){
    const t=String(lines[i]||"").trim();

    if(!t){
      closeList();
      if(inContact){ closeContact(); }
      out.push("<div class=\"spacer\"></div>");
      continue;
    }

    const headBase=t.replace(/:$/,'').trim().toUpperCase();
    const isContactHeading=(headBase==="CONTACT"||headBase==="KONTAKT");
    if(isContactHeading){
      closeContact();
      closeList();
      inContact=true;
      out.push("<div class=\"cvHeader\">");
      continue;
    }

    if(isHeadingLine(t)){
      closeContact();
      closeList();
      out.push("<h2>"+escapeHtml(t.replace(/:$/,'').trim())+"</h2>");
      continue;
    }

    if(isBulletLine(t)){
      let content=bulletContent(t);
      if(!content){
        // Merge bullet-only line with the next meaningful line
        let j=i+1;
        while(j<lines.length && !String(lines[j]||"").trim()) j++;
        if(j<lines.length){
          const next=String(lines[j]||"").trim();
          if(next && !isHeadingLine(next) && !isBulletLine(next)){
            content=next;
            i=j;
          }else{
            continue;
          }
        }else{
          continue;
        }
      }
      if(!inList){ out.push("<ul>"); inList=true; }
      out.push("<li>"+escapeHtml(content)+"</li>");
      continue;
    }

    closeList();
    if(inContact){
      if(!contactNameDone){
        out.push("<h1 class=\"cvName\">"+escapeHtml(t)+"</h1>");
        contactNameDone=true;
      }else{
        out.push("<div class=\"cvContactLine\">"+escapeHtml(t)+"</div>");
      }
    }else{
      out.push("<p>"+escapeHtml(t)+"</p>");
    }
  }

  closeContact();
  closeList();
  return out.join("\n");
}

function buildPrintHtml(title, cvText){
  const safeTitle=escapeHtml(title||"CV");
  const bodyHtml=cvTextToPrintableHtml(cvText);
  return `<!doctype html><html><head><meta charset=\"utf-8\" />
<title>${safeTitle}</title>
<style>
@page{margin:18mm 14mm;}
body{font-family:-apple-system,BlinkMacSystemFont,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif;max-width:820px;margin:24px auto;padding:0 10px;color:#111;}
.cvHeader{padding-bottom:12px;border-bottom:1px solid #ddd;margin-bottom:14px;}
.cvName{margin:0 0 6px;font-size:26px;letter-spacing:.2px;}
.cvContactLine{font-size:12px;color:#444;line-height:1.35;}
h2{margin:16px 0 6px;font-size:12px;letter-spacing:.10em;text-transform:uppercase;color:#111;}
p{margin:4px 0 6px;font-size:12px;line-height:1.5;}
ul{margin:6px 0 10px 18px;padding:0;}
li{margin:3px 0;font-size:12px;line-height:1.5;}
.spacer{height:8px;}
</style></head><body>${bodyHtml}</body></html>`;
}

function printTailor(){
  if(!currentTailorText){ showTopError("No tailored CV loaded"); return; }
  const jobTitle=(document.getElementById("tailorJobTitle")?.textContent||"").trim();
  const title=jobTitle ? ("CV â€¢ " + jobTitle) : "CV";
  const html=buildPrintHtml(title, currentTailorText);
  const w=window.open("","_blank","noopener,noreferrer");
  if(!w){ showTopError("Popup blocked. Please allow popups for printing."); return; }
  w.document.open();
  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
}

function downloadTailor(){
  try{
    const t=currentTailorText||"";
    if(!t){alert("Nothing to download yet.");return;}
    const name=(document.getElementById("tailorTitle").textContent||"tailored_cv").replace(/[^a-z0-9\-_]+/gi,"_").slice(0,60);
    const blob=new Blob([t], {type:"text/plain;charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download=name+".txt";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
  }catch(e){
    alert("Download failed: "+(e.message||e));
  }
}
function openSkipModal(jobId){
pendingSkipJobId=jobId;
document.getElementById("skipNote").value="";
document.getElementById("skipReason").value="not_relevant";
document.getElementById("skipModal").style.display="flex";
}
function closeSkipModal(){
pendingSkipJobId=null;
document.getElementById("skipModal").style.display="none";
}

async function requireSession(){
const {data,error}=await supabaseClient.auth.getSession();
if(error) throw error;
if(!data||!data.session){
window.location.replace("./signup.html");
return null;
}
lastSessionToken=data.session.access_token;
return data.session;
}

async function apiGet(path,accessToken){
const res=await fetch(API_BASE+path,{method:"GET",headers:{"Authorization":"Bearer "+accessToken}});
const text=await res.text().catch(()=> "");
let json=null;
try{json=JSON.parse(text);}catch{json={raw:text};}
if(!res.ok){
const msg=(json&&(json.error||json.details))?(json.error||json.details):text;
throw new Error(path+" failed: "+res.status+" "+msg);
}
return json;
}
async function apiPost(path,accessToken,body){
const res=await fetch(API_BASE+path,{
method:"POST",
headers:{
"Authorization":"Bearer "+accessToken,
"content-type":"application/json"
},
body:JSON.stringify(body||{})
});
const text=await res.text().catch(()=> "");
let json=null;
try{json=JSON.parse(text);}catch{json={raw:text};}
if(!res.ok){
const msg=(json&&(json.error||json.details))?(json.error||json.details):text;
throw new Error(path+" failed: "+res.status+" "+msg);
}
return json;
}

function planFromState(planId){
const pid=String(planId||"").trim().toLowerCase();
if(pid==="starter") return {id:"starter",name:"Starter",daily:1,meta:"1 application/day",short:"Starter (1/day)"};
if(pid==="pro") return {id:"pro",name:"Growth",daily:5,meta:"5 applications/day",short:"Growth (5/day)"};
if(pid==="max") return {id:"max",name:"Max",daily:10,meta:"10 applications/day",short:"Max (10/day)"};
return {id:null,name:"No plan",daily:0,meta:"Select Starter / Growth / Max",short:"No plan"};
}
function planFallbackFromLocalStorage(){
const raw=(localStorage.getItem("jm_plan")||localStorage.getItem("ja_plan")||"").trim().toLowerCase();
if(raw==="starter"||raw==="pro"||raw==="max") return planFromState(raw);
return planFromState(null);
}

function computeSupply(queueCount,planDaily){
let healthLabel="Low";
let badgeType="warn";
let recommendedCap=1;
if(queueCount>=25){healthLabel="Healthy";badgeType="good";recommendedCap=10;}
else if(queueCount>=5){healthLabel="Medium";badgeType="";recommendedCap=5;}
let note="";
if(!planDaily) note="Select a plan to start.";
else if(queueCount===0) note="No jobs in your queue yet. Broaden titles or increase radius.";
else if(queueCount<planDaily) note="Your queue is below your plan. Increase titles/radius to avoid running out.";
else note="You have enough supply for today.";
let ratio=0;
if(planDaily&&planDaily>0) ratio=Math.min(1,queueCount/(planDaily*5));
else ratio=Math.min(1,queueCount/10);
return {healthLabel,badgeType,recommendedCap,note,ratio};
}
function renderHealth(queueCount,plan){
const s=computeSupply(queueCount,plan.daily);
setBadge("badgeHealth",s.badgeType,s.healthLabel);
setText("kpiHealthLabel",s.healthLabel);
setBadge("badgeHealthPlan",plan.daily?"":"warn","Plan: "+plan.short);
setBadge("badgeHealthQueue",queueCount>0?"good":"warn","Queue: "+queueCount);
setBadge("badgeHealthCap","","Today cap: "+(plan.daily?plan.daily:0)+"/day");
const meter=document.getElementById("healthMeterFill");
if(meter) meter.style.width=Math.round(s.ratio*100)+"%";
setHtml("healthNote",
'<div class="mono">Recommended cap based on supply: '+s.recommendedCap+'/day</div>'+
'<div class="mono" style="margin-top:6px">'+escapeHtml(s.note)+'</div>'
);
}

function isSingleColumn(){
return window.matchMedia && window.matchMedia("(max-width: 1100px)").matches;
}

function renderQueueCards(queue){
  const items=Array.isArray(queue?.data)?queue.data:[];
  if(items.length===0) return '<span class="badge warn">No jobs in queue</span>';
  const wrapClass=isSingleColumn() ? "list" : "listGrid";

  const cards=items.slice(0,16).map(j=>{
    const title=j.title||"Untitled";
    const company=j.company_name||"â€”";
    const loc=[j.city||"", j.region||""].filter(Boolean).join(", ") || "â€”";
    const posted=j.posted_at?String(j.posted_at).slice(0,10):"â€”";
    const link=j.apply_url?String(j.apply_url):"";
    const jobId=j.id||"";
    const prio=!!(j._application && j._application.priority);

    const titleHtml=link
      ? ('<a href="'+escapeHtml(link)+'" target="_blank" rel="noopener">'+escapeHtml(title)+'</a>')
      : escapeHtml(title);

    // Badges on the top-right (compact)
    const prioBadge=prio ? "<span class='badge prio'>prio</span>" : "<span class='badge'>new</span>";
    const tSum=tailorSummaryMap.get(String(jobId));
    let atsBadge="";
    if(tSum){
      const pct=computeAtsMatchPercent(tSum.ats_keywords_used, tSum.ats_keywords_missing);
      if(pct!==null){
        const cls=(pct>=80)?"good":(pct>=60)?"warn":"bad";
        atsBadge="<span class='badge "+cls+"'>ATS "+pct+"%</span>";
      }else{
        atsBadge="<span class='badge'>tailored</span>";
      }
    }

    const sourceBadge = (j.source_id===1) ? "<span class='badge'>BA</span>" : "";
    const descOk = j.description_full_fetched_at && !j.description_full_error;
    const descBad = !!j.description_full_error;
    const descBadge = descOk ? "<span class='badge good'>desc</span>" : (descBad ? "<span class='badge bad'>desc err</span>" : "");
    const badge="<div class='badgeGroup'>"+prioBadge+sourceBadge+descBadge+atsBadge+"</div>";

    // Tags row (small labels)
    const tags=[];
    if(j.employment_type) tags.push({t:String(j.employment_type),k:""});
    if(j.seniority) tags.push({t:String(j.seniority),k:""});
    if(j.external_job_id && (j.source_id===1)) tags.push({t:"Refnr "+String(j.external_job_id),k:""});
    const tagsHtml = tags.length
      ? ('<div class="tagRow">'+tags.map(x=>'<span class="tag '+(x.k||'')+'">'+escapeHtml(x.t)+'</span>').join('')+'</div>')
      : '';

    const prioBtn=prio
      ? "<button class='btn small ghost' type='button' data-unprio='"+escapeHtml(jobId)+"'>Unprio</button>"
      : "<button class='btn small' type='button' data-prio='"+escapeHtml(jobId)+"'>Prio</button>";

    const descBtn = "<button class='btn small ghost' type='button' data-desc='"+escapeHtml(jobId)+"'>Description</button>";
    const tailorBtn = "<button class='btn small' type='button' data-tailor='"+escapeHtml(jobId)+"'>Tailor CV</button>";

    return '<div class="item">'
      + '<div class="itemTop"><div class="itemTitle">'+titleHtml+'</div>'+badge+'</div>'
      + '<div class="itemMeta"><span>'+escapeHtml(company)+'</span><span>â€¢</span><span>'+escapeHtml(loc)+'</span><span>â€¢</span><span>Posted '+escapeHtml(posted)+'</span></div>'
      + tagsHtml
      + '<div class="itemActions">'
      + prioBtn
      + '<button class="btn small danger" type="button" data-skip="'+escapeHtml(jobId)+'">Skip</button>'
      + descBtn
      + tailorBtn
      + '</div>'
      + '</div>';
  }).join("");

  return '<div class="'+wrapClass+'">'+cards+'</div>';
}

function wireQueueClicks(){
const wrap=document.getElementById("queueWrap");
if(!wrap) return;
wrap.addEventListener("click", async (e)=>{
const skip=e.target.closest("button[data-skip]");
if(skip){
const jobId=skip.getAttribute("data-skip")||"";
if(jobId) openSkipModal(jobId);
return;
}

const desc=e.target.closest("button[data-desc]");
if(desc){
const jobId=desc.getAttribute("data-desc")||"";
if(jobId) openDescModal(jobId);
return;
}

const tl=e.target.closest("button[data-tailor]");
if(tl){
const jobId=tl.getAttribute("data-tailor")||"";
if(jobId) openTailorModal(jobId, false);
return;
}
const pr=e.target.closest("button[data-prio]");
if(pr){
const jobId=pr.getAttribute("data-prio")||"";
if(!jobId) return;
try{
await apiPost("/me/applications/prioritize", lastSessionToken, { job_id: jobId });
await refreshQueueAndActivity();
updateFetchButtonCooldownUI();
updateFetchMetaUI();
updateAiSwitchState();
}catch(err){ showTopError(err.message); }
return;
}
const un=e.target.closest("button[data-unprio]");
if(un){
const jobId=un.getAttribute("data-unprio")||"";
if(!jobId) return;
try{
await apiPost("/me/applications/unprioritize", lastSessionToken, { job_id: jobId });
await refreshQueueAndActivity();
}catch(err){ showTopError(err.message); }
}
});
}

async function submitSkip(){
if(!pendingSkipJobId) return;

const minSupply=Math.max(5, currentPlanDaily * 3);
if(currentPlanDaily > 0 && currentQueueCount <= minSupply){
const el=document.getElementById("skipGuardrail");
if(el){
el.style.display="block";
el.style.color="rgba(255,179,0,.95)";
el.textContent="Skipping is limited because your queue is getting low. Add more titles or increase radius to keep daily applications running.";
}
closeSkipModal();
return;
}

const reason_code=document.getElementById("skipReason").value;
const reason_note=document.getElementById("skipNote").value.trim();

try{
await apiPost("/me/applications/skip", lastSessionToken, {
job_id: pendingSkipJobId,
reason_code,
reason_note
});
closeSkipModal();
await refreshQueueAndActivity();
}catch(e){
closeSkipModal();
showTopError(e.message);
}
}

async function undoSkip(jobId){
try{
await apiPost("/me/applications/unskip", lastSessionToken, { job_id: jobId });
await refreshQueueAndActivity();
}catch(e){
showTopError(e.message);
}
}

function fmtDate(ts){
if(!ts) return "â€”";
try{return String(ts).replace("T"," ").slice(0,16);}catch{return String(ts).slice(0,16);}
}

function timeBucket(ts){
if(!ts) return "";
return String(ts).slice(0,16);
}
function sentKey(ev){
const jobId=ev && ev.job && ev.job.id ? String(ev.job.id) : "";
return jobId + "|" + timeBucket(ev.created_at);
}
function eventBadge(type){
const t=String(type||"").toLowerCase();
if(t==="applied"||t==="sent"||t==="replied") return {cls:"good", label:t};
if(t==="rejected") return {cls:"bad", label:t};
if(t==="skipped") return {cls:"warn", label:t};
if(t==="prioritized") return {cls:"prio", label:"prio"};
if(t==="unprioritized") return {cls:"", label:"unprio"};
if(t==="queued") return {cls:"", label:"queued"};
if(t==="unskipped") return {cls:"", label:"undo"};
return {cls:"", label:t||"event"};
}

function renderEventsTable(resp){
const items=Array.isArray(resp?.data) ? resp.data : [];
if(items.length===0) return '<span class="badge warn">No events yet</span>';

const list=items.slice(0,30);

const sentByKey=new Map();
for(const ev of list){
if(String(ev.event_type||"").toLowerCase() !== "sent") continue;
sentByKey.set(sentKey(ev), ev);
}

const appliedKeys=new Set();
for(const ev of list){
if(String(ev.event_type||"").toLowerCase() !== "applied") continue;
appliedKeys.add(sentKey(ev));
}

const visible=list.filter(ev=>{
const t=String(ev.event_type||"").toLowerCase();
if(t !== "sent") return true;
return !appliedKeys.has(sentKey(ev));
});

const rows=visible.map(ev=>{
const b=eventBadge(ev.event_type);
const job=ev.job||{};
const title=job.title||"Untitled";
const company=job.company_name||"â€”";
const loc=[job.city||"", job.region||""].filter(Boolean).join(", ") || "â€”";
const when=fmtDate(ev.created_at);
const link=job.apply_url?String(job.apply_url):"";
const titleCell=link ? ('<a href="'+escapeHtml(link)+'" target="_blank" rel="noopener">'+escapeHtml(title)+'</a>') : escapeHtml(title);

let metaTxt="â€”";
const t=String(ev.event_type||"").toLowerCase();

if(t === "applied"){
const s=sentByKey.get(sentKey(ev));
if(s && s.meta && typeof s.meta === "object"){
const ch=s.meta.channel || "email_manual";
const fe=s.meta.from_email || "";
const proofHtml="via " + escapeHtml(ch) + (fe ? "<br><span class='mono'>from " + escapeHtml(fe) + "</span>" : "");
metaTxt="<button class='btn small ghost' type='button' data-proof='1'>Show proof</button>"
+ "<div style='display:none;margin-top:8px' class='mono' data-proof-box='1'>" + proofHtml + "</div>";
}
}

if(metaTxt === "â€”" && ev.meta && typeof ev.meta === "object"){
if(t === "sent"){
const ch=ev.meta.channel || "email_manual";
const fe=ev.meta.from_email || "";
metaTxt="via " + escapeHtml(ch) + (fe ? "<br><span class='mono'>from " + escapeHtml(fe) + "</span>" : "");
} else if(t === "queued" && ev.meta && (ev.meta.fetch_mode || ev.meta.source)){
metaTxt = "fetch: " + escapeHtml(String(ev.meta.fetch_mode || ev.meta.source));
} else if(ev.meta.reason_code){
metaTxt="reason: " + escapeHtml(String(ev.meta.reason_code));
}
}

const actionBtn=(t==="skipped" && job.id)
? "<button class='btn small ghost' type='button' data-unskip='"+escapeHtml(job.id)+"'>Undo</button>"
: "â€”";

return "<tr>"
+ "<td><span class='badge "+b.cls+"'>"+escapeHtml(b.label)+"</span></td>"
+ "<td>"+titleCell+"</td>"
+ "<td>"+escapeHtml(company)+"</td>"
+ "<td>"+escapeHtml(loc)+"</td>"
+ "<td>"+escapeHtml(when)+"</td>"
+ "<td>"+metaTxt+"</td>"
+ "<td>"+actionBtn+"</td>"
+ "</tr>";
}).join("");

return '<div class="tableWrap"><table class="table">'
+ '<thead><tr><th>Event</th><th>Job</th><th>Company</th><th>Location</th><th>Time</th><th>Meta</th><th>Action</th></tr></thead>'
+ '<tbody>'+rows+'</tbody></table></div>';
}

function renderApplicationsFallback(resp){
const items=Array.isArray(resp?.data)?resp.data:[];
if(items.length===0) return '<span class="badge warn">No activity yet</span>';

const rows=items.slice(0,30).map(a=>{
const st=String(a.status||"").toLowerCase();
const cls=st==="applied" ? "good" : st==="rejected" ? "bad" : st==="skipped" ? "warn" : "";
const job=a.job||{};
const title=job.title||"Untitled";
const company=job.company_name||"â€”";
const loc=[job.city||"", job.region||""].filter(Boolean).join(", ") || "â€”";
const when=fmtDate(a.updated_at || a.created_at);
const link=job.apply_url?String(job.apply_url):"";
const titleCell=link ? ('<a href="'+escapeHtml(link)+'" target="_blank" rel="noopener">'+escapeHtml(title)+'</a>') : escapeHtml(title);
const actionBtn=(st==="skipped" && job.id) ? "<button class='btn small ghost' type='button' data-unskip='"+escapeHtml(job.id)+"'>Undo</button>" : "â€”";

return "<tr>"
+ "<td><span class='badge "+cls+"'>"+escapeHtml(st||"new")+"</span></td>"
+ "<td>"+titleCell+"</td>"
+ "<td>"+escapeHtml(company)+"</td>"
+ "<td>"+escapeHtml(loc)+"</td>"
+ "<td>"+escapeHtml(when)+"</td>"
+ "<td>"+actionBtn+"</td>"
+ "</tr>";
}).join("");

return '<div class="tableWrap"><table class="table">'
+ '<thead><tr><th>Status</th><th>Job</th><th>Company</th><th>Location</th><th>Time</th><th>Action</th></tr></thead>'
+ '<tbody>'+rows+'</tbody></table></div>';
}

async function loadActivity(accessToken){
setHtml("activityError","");
setHtml("activityWrap",renderSkeleton());

if(useEventsEndpoint){
let path="/me/application-events?limit=30";
if(activityEventType) path += "&event_type=" + encodeURIComponent(activityEventType);
try{
const resp=await apiGet(path,accessToken);
setHtml("activityWrap",renderEventsTable(resp));
return;
}catch(e){
useEventsEndpoint=false;
setHtml("activityError",'<div class="error">Timeline endpoint failed. Fallback to applications list. Details: '+escapeHtml(e.message)+'</div>');
}
}

let path="/me/applications?limit=30";
const map={ queued:"new", applied:"applied", rejected:"rejected", skipped:"skipped", prioritized:"new" };
if(activityEventType && map[activityEventType]) path += "&status=" + encodeURIComponent(map[activityEventType]);

try{
const resp=await apiGet(path,accessToken);
setHtml("activityWrap",renderApplicationsFallback(resp));
}catch(e){
setHtml("activityWrap",'<span class="badge bad">Activity failed</span>');
setHtml("activityError",'<div class="error">'+escapeHtml(e.message)+'</div>');
}
}

function wireActivityClicks(){
const wrap=document.getElementById("activityWrap");
if(!wrap) return;
wrap.addEventListener("click",(e)=>{
const unskip=e.target.closest("button[data-unskip]");
if(unskip){
const jobId=unskip.getAttribute("data-unskip")||"";
if(jobId) undoSkip(jobId);
return;
}
const proofBtn=e.target.closest("button[data-proof]");
if(proofBtn){
const cell=proofBtn.parentElement;
if(!cell) return;
const box=cell.querySelector("[data-proof-box='1']");
if(!box) return;
const isOpen=box.style.display === "block";
box.style.display=isOpen ? "none" : "block";
proofBtn.textContent=isOpen ? "Show proof" : "Hide proof";
}
});
}



const FETCH_COOLDOWN_MS = 10 * 60 * 1000;
function getNextFetchAllowedAt(){
const v = Number(localStorage.getItem("jm_last_manual_fetch_ts") || "0");
return v ? (v + FETCH_COOLDOWN_MS) : 0;
}
function updateFetchButtonCooldownUI(){
const btn=document.getElementById("btnFetchJobsNow");
const status=document.getElementById("fetchJobsStatus");
if(!btn) return;
const next = getNextFetchAllowedAt();
const now = Date.now();
if(next && now < next){
const sec = Math.ceil((next-now)/1000);
btn.disabled = true;
btn.textContent = "Fetch new jobs";
if(status && !status.textContent) status.textContent = "You can fetch again in " + sec + "s";
setTimeout(updateFetchButtonCooldownUI, 1000);
}else{
btn.disabled = false;
}

function updateFetchMetaUI(){
const meta=document.getElementById("fetchMeta");
if(!meta) return;

const lastTs = Number(localStorage.getItem("jm_last_manual_fetch_ts") || "0");
if(!lastTs){
meta.textContent = "";
return;
}

const last = new Date(lastTs).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
const next = lastTs + FETCH_COOLDOWN_MS;
const now = Date.now();

if(now < next){
const sec = Math.ceil((next-now)/1000);
const min = Math.floor(sec/60);
const s = sec % 60;
meta.textContent = "Last fetch: " + last + " Â· Next fetch in " + min + ":" + String(s).padStart(2,"0");
}else{
meta.textContent = "Last fetch: " + last + " Â· You can fetch again now";
}
}

function updateAiSwitchState(){
const toggle = document.getElementById("toggleAiOnly");
const hint = document.getElementById("aiSwitchHint");
if(!toggle || !hint) return;

const titles = Array.isArray(window.lastAiTitleSuggestions) ? window.lastAiTitleSuggestions : [];
const aiAvailable = titles.length > 0;

if(aiAvailable){
toggle.disabled = false;
hint.style.display = "none";
}else{
toggle.disabled = true;
toggle.checked = false;
hint.style.display = "inline-flex";
}
}
}

// Manual fetch (button) + AI titles toggle
function getAiTitlesForFetch(){
try{
const {p,c}=getAiJson();
const titles=[];
if(p && Array.isArray(p.job_titles)) for(const t of p.job_titles) titles.push(t);
if(c && Array.isArray(c.alternative_titles)) for(const t of c.alternative_titles) titles.push(t);
const seen=new Set();
const out=[];
for(const t of titles){
const s=String(t||"").trim();
if(!s) continue;
const k=s.toLowerCase();
if(seen.has(k)) continue;
seen.add(k);
out.push(s);
}
return out;
}catch{
return [];
}
}

async function manualFetchJobs(){
const btn=document.getElementById("btnFetchJobsNow");
const status=document.getElementById("fetchJobsStatus");
const toggle=document.getElementById("toggleAiOnly");

const setState=(loading,msg)=>{
if(btn){
btn.disabled=!!loading;
btn.textContent=loading ? "Fetching..." : "Fetch new jobs";
}
if(status) status.textContent=msg||"";
};

try{
const next = getNextFetchAllowedAt();
if(next && Date.now() < next){
const sec = Math.ceil((next-Date.now())/1000);
setState(false, "Please wait " + sec + "s before fetching again.");
updateFetchButtonCooldownUI();
updateFetchMetaUI();
return;
}
if(!lastSessionToken) await requireSession();
// start cooldown immediately to prevent double-click spamming
localStorage.setItem("jm_last_manual_fetch_ts", String(Date.now()));
updateFetchButtonCooldownUI();
updateFetchMetaUI();
const aiOnly=!!(toggle && toggle.checked);
const aiTitles=aiOnly ? getAiTitlesForFetch() : [];

setState(true, aiOnly ? "Fetching (AI titles only)..." : "Fetching...");

const resp=await apiPost("/me/jobs/fetch", lastSessionToken, {
include_ai_titles: aiOnly,
ai_titles: aiTitles,
fetch_mode: aiOnly ? "ai_only" : "profile"
});

if(resp && resp.skipped){
if(resp.reason==="queue_full"){
setState(false, "Skipped: queue has "+resp.queue_new_count+" new jobs (cap "+resp.max_queue_new+").");
} else {
setState(false, "Skipped: "+String(resp.reason||""));
}
return;
}

const added=typeof resp.jobs_added==="number" ? resp.jobs_added : 0;
const q=typeof resp.queue_new_count==="number" ? resp.queue_new_count : "â€”";
const rad=(resp.used_radius!==undefined && resp.used_radius!==null) ? resp.used_radius : "â€”";
const ml=(resp.match_level!==undefined && resp.match_level!==null) ? resp.match_level : "â€”";

setState(false, "Added "+added+" Â· Queue new: "+q+" Â· Radius "+rad+"km Â· Match "+ml);
updateFetchMetaUI();
await refreshQueueAndActivity();
}catch(e){
setState(false, e && e.message ? e.message : "Fetch failed");
showTopError(e && e.message ? e.message : "Fetch failed");
}
}

async function refreshQueueAndActivity(){
const queue=await apiGet("/me/jobs/queue", lastSessionToken);
lastQueueResponse=queue;
const qCount=(typeof queue.count==="number")?queue.count:(Array.isArray(queue.data)?queue.data.length:0);
currentQueueCount=qCount;
await loadTailorSummariesForJobs((Array.isArray(queue.data)?queue.data.map(j=>j.id):[]));
setHtml("queueWrap",renderQueueCards(queue));
await loadActivity(lastSessionToken);
}

function renderAppsBreakdown(summary){
const counts=summary&&summary.counts?summary.counts:null;
if(!counts||typeof counts!=="object") return '<span class="badge warn">Not available</span>';
const entries=Object.entries(counts);
if(entries.length===0) return '<span class="badge warn">No applications yet</span>';
entries.sort((a,b)=>String(a[0]).localeCompare(String(b[0])));
const rows=entries.map(([k,v])=>"<tr><td>"+escapeHtml(k)+"</td><td>"+escapeHtml(v)+"</td></tr>").join("");
return '<div class="tableWrap" style="margin-top:8px"><table class="table" style="min-width:520px"><thead><tr><th>Status</th><th>Count</th></tr></thead><tbody>'+rows+'</tbody></table></div>';
}

function renderOnboardingChecks(state){
const items=[];
const profileOk=!!state.profile_complete;
const planOk=!!state.plan_id;
const cvOk=!!state.cv_uploaded;
const ocrOk=(String(state.cv_ocr_status||"").toLowerCase()==="done");
items.push({label:"Profile complete",ok:profileOk,fix:"profile.html"});
items.push({label:"Plan selected",ok:planOk,fix:"plan.html"});
items.push({label:"CV uploaded",ok:cvOk,fix:"profile.html"});
items.push({label:"OCR done",ok:ocrOk,fix:"profile.html"});
return items.map(it=>{
const cls=it.ok?"badge good":"badge warn";
const right=it.ok?'OK':('<a href="'+it.fix+'" style="text-decoration:underline">Fix</a>');
return '<div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin:8px 0"><span class="'+cls+'">'+escapeHtml(it.label)+'</span><span class="small">'+right+'</span></div>';
}).join("");
}

function getAiJson(){
try{
const pRaw=localStorage.getItem("jm_ai_profile") || localStorage.getItem("ja_ai_profile");
const cRaw=localStorage.getItem("jm_ai_clusters") || localStorage.getItem("ja_ai_clusters");
return {
p: pRaw ? JSON.parse(pRaw) : null,
c: cRaw ? JSON.parse(cRaw) : null
};
}catch{
return {p:null,c:null};
}
}

function renderAiInsightsFromCache(){
try{
const {p,c}=getAiJson();
const has=!!(p && (p.job_titles || p.skills));
if(!has){
setBadge("badgeAi","warn","Locked");
setText("aiInsightsHint","Generate suggestions in Profile to unlock this.");
setHtml("aiTopTitles","");
setHtml("aiAltRoles","");
setHtml("aiTopSkills","");
return;
}

setBadge("badgeAi","good","Ready");
const created=p.created_at ? String(p.created_at).replace("T"," ").slice(0,16) : "";
setText("aiInsightsHint", created ? ("Last updated: "+created) : "Last updated: â€”");

const titles=Array.isArray(p.job_titles) ? p.job_titles.slice(0,5) : [];
setHtml("aiTopTitles", titles.map(t=>'<span class="pill mini">'+escapeHtml(t)+'</span>').join("") || '<span class="badge warn">No titles</span>');

const alt=c && Array.isArray(c.alternative_titles) ? c.alternative_titles.slice(0,5) : [];
setHtml("aiAltRoles", alt.map(t=>'<span class="pill mini">'+escapeHtml(t)+'</span>').join("") || '<span class="badge warn">No alternatives yet</span>');

const core=p.skills && Array.isArray(p.skills.core) ? p.skills.core.slice(0,6) : [];
const tools=p.skills && Array.isArray(p.skills.tools) ? p.skills.tools.slice(0,4) : [];
const skills=[];
for(const s of core) skills.push(s);
for(const s of tools) skills.push(s);
const seen=new Set();
const uniq=[];
for(const s of skills){
const k=String(s).toLowerCase();
if(!k || seen.has(k)) continue;
seen.add(k);
uniq.push(s);
}
setHtml("aiTopSkills", uniq.map(s=>'<span class="pill mini">'+escapeHtml(s)+'</span>').join("") || '<span class="badge warn">No skills</span>');
}catch{
setBadge("badgeAi","warn","Locked");
setText("aiInsightsHint","Generate suggestions in Profile to unlock this.");
}
}

async function loadDashboard(){
clearTopError();
setText("errorBox","");
setHtml("queueError","");
setText("lastCheck",nowStamp());
setBadge("badgeQueue","","Loading");
setBadge("badgeApps","","Loading");
setBadge("badgePlan","","Loading");
setBadge("badgeHealth","","Loading");
setHtml("queueWrap",renderSkeleton());
setHtml("appsBreakdown",renderSkeleton());
setHtml("onboardingChecks",renderSkeleton());
setHtml("activityWrap",renderSkeleton());
setHtml("activityError","");

const session=await requireSession();
if(!session) return;

// Load profile (for persisted AI titles)
try{
const profResp = await apiGet("/me/profile", lastSessionToken);
const p = profResp && profResp.profile ? profResp.profile : null;
window.lastAiTitleSuggestions = (p && Array.isArray(p.ai_titles)) ? p.ai_titles : [];
}catch(e){
window.lastAiTitleSuggestions = [];
}
updateAiSwitchState();

const email=session.user&&session.user.email?session.user.email:"â€”";
setText("meEmail",email);
setText("subLine","Signed in as "+email);

renderAiInsightsFromCache();

let state=null;
try{ state=await apiGet("/me/state",session.access_token); }catch{ state=null; }

// Load profile to get persisted AI titles (server source of truth)
try{
const prof = await apiGet("/me/profile", session.access_token);
const ai = prof && prof.profile && Array.isArray(prof.profile.ai_titles) ? prof.profile.ai_titles : [];
window.lastAiTitleSuggestions = ai;
localStorage.setItem("jm_ai_titles_server", JSON.stringify(ai));
}catch(e){
// fallback to cached AI titles
try{
const ai = JSON.parse(localStorage.getItem("jm_ai_titles_server") || "[]");
window.lastAiTitleSuggestions = Array.isArray(ai) ? ai : [];
}catch(_){
window.lastAiTitleSuggestions = [];
}
}

const plan=state&&state.plan_id?planFromState(state.plan_id):planFallbackFromLocalStorage();
currentPlanDaily=plan.daily;

setText("kpiPlanName",plan.name);
setText("kpiPlanMeta",plan.daily?plan.meta:"no plan selected");
setBadge("badgePlan",plan.daily?"good":"warn",plan.daily?"Selected":"Not selected");

if(state&&state.customer_id){ setText("meCustomerId",state.customer_id); }
if(state){ setHtml("onboardingChecks",renderOnboardingChecks(state)); }

try{
const queue=await apiGet("/me/jobs/queue",session.access_token);
const qCount=(typeof queue.count==="number")?queue.count:(Array.isArray(queue.data)?queue.data.length:0);
currentQueueCount=qCount;

animateNumber(document.getElementById("kpiQueue"),qCount);
setBadge("badgeQueue",qCount>0?"good":"warn",qCount>0?"OK":"Empty");

await loadTailorSummariesForJobs((Array.isArray(queue.data)?queue.data.map(j=>j.id):[]));
setHtml("queueWrap",renderQueueCards(queue));
renderHealth(qCount,plan);
}catch(e){
setText("kpiQueue","â€“");
setBadge("badgeQueue","bad","Error");
setBadge("badgeHealth","bad","Error");
setHtml("queueWrap",'<span class="badge bad">Queue failed</span>');
setHtml("queueError",'<div class="error">'+escapeHtml(e.message)+'</div>');
setText("errorBox",e.message);
showTopError(e.message);
}

try{
const apps=await apiGet("/me/applications/summary",session.access_token);
const total=(typeof apps.total==="number")?apps.total:0;
animateNumber(document.getElementById("kpiAppsTotal"),total);
setBadge("badgeApps","good","OK");
setHtml("appsBreakdown",renderAppsBreakdown(apps));
}catch{
setText("kpiAppsTotal","â€“");
setBadge("badgeApps","warn","Not ready");
setHtml("appsBreakdown",'<span class="badge warn">Not available</span>');
}

await loadActivity(session.access_token);
}

function wireActivityFilters(){
const wrap=document.getElementById("activityFilters");
if(!wrap) return;
wrap.addEventListener("click", async (e)=>{
const btn=e.target.closest("button[data-etype]");
if(!btn) return;

const et=btn.getAttribute("data-etype")||"";
activityEventType=et;

for(const b of wrap.querySelectorAll(".chip")) b.classList.remove("active");
btn.classList.add("active");

if(lastSessionToken) await loadActivity(lastSessionToken);
});
}

function wireEvents(){
document.getElementById("btnRefresh").addEventListener("click",async()=>{
try{ await loadDashboard(); }catch(e){ showTopError(e.message); setText("errorBox",e.message); }
});
document.getElementById("btnFetchJobsNow").addEventListener("click",async()=>{
await manualFetchJobs();
});

document.getElementById("btnCopyToken").addEventListener("click",async()=>{
try{
const {data}=await supabaseClient.auth.getSession();
const token=data&&data.session?data.session.access_token:"";
if(!token){ alert("No session token found. Please sign in again."); return; }

// Some browsers block clipboard access depending on context (permissions/iframes).
// Fallback: show the token in a prompt so you can copy manually.
try{
await navigator.clipboard.writeText(token);
alert("Access token copied.");
return;
}catch(_clipboardErr){
// Fallback 1: hidden textarea + execCommand
try{
const ta=document.createElement("textarea");
ta.value=token;
ta.setAttribute("readonly","true");
ta.style.position="fixed";
ta.style.left="-9999px";
ta.style.top="0";
document.body.appendChild(ta);
ta.select();
const ok=document.execCommand && document.execCommand("copy");
document.body.removeChild(ta);
if(ok){
alert("Access token copied.");
return;
}
}catch(_){ /* ignore */ }

// Fallback 2: prompt
window.prompt("Copy your access token:", token);
}
}catch(e){
showTopError(e.message || "Copy token failed");
}
});
document.getElementById("btnLogout").addEventListener("click",async()=>{
try{
await supabaseClient.auth.signOut();
Object.keys(localStorage).forEach(k=>{
if(k.startsWith("ja_") || k.startsWith("jobapplyai_") || k.startsWith("jm_") || k.startsWith("jobmejob_") || k.startsWith("sb-")){
localStorage.removeItem(k);
}
});
try{sessionStorage.removeItem("sb_access_token");}catch{}
window.location.replace("./index.html");
}catch(e){ showTopError(e.message); }
});

wireQueueClicks();
wireActivityFilters();
wireActivityClicks();

document.getElementById("skipCancel").addEventListener("click",()=>closeSkipModal());
document.getElementById("skipConfirm").addEventListener("click",()=>submitSkip());

document.getElementById("skipModal").addEventListener("click",(e)=>{
if(e.target && e.target.id==="skipModal") closeSkipModal();
});

// Job description modal
document.getElementById("descClose").addEventListener("click",()=>closeDescModal());
document.getElementById("descCopy").addEventListener("click",()=>copyDesc());
document.getElementById("descModal").addEventListener("click",(e)=>{
if(e.target && e.target.id==="descModal") closeDescModal();
});

// Tailored CV modal
document.getElementById("tailorClose").addEventListener("click",()=>closeTailorModal());
document.getElementById("tailorCopy").addEventListener("click",()=>copyTailor());
document.getElementById("tailorDownload").addEventListener("click",()=>downloadTailor());
document.getElementById("tailorPrint").addEventListener("click",()=>printTailor());
document.getElementById("tailorRegenerate").addEventListener("click",()=>regenerateTailor());
document.getElementById("tailorModal").addEventListener("click",(e)=>{
if(e.target && e.target.id==="tailorModal") closeTailorModal();
});
}

window.addEventListener("load",async()=>{
try{
if(!window.supabase) throw new Error("Supabase library did not load. Check adblockers / network.");
supabaseClient=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
wireEvents();
await loadDashboard();
}catch(e){
showTopError(e.message);
setText("errorBox",e.message);
setBadge("badgeQueue","bad","Error");
setBadge("badgeApps","bad","Error");
setBadge("badgePlan","bad","Error");
setBadge("badgeHealth","bad","Error");
}
});
</script>
</body>
</html>
