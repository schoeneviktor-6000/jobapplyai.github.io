<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>jobmejob • Dashboard</title>
<link rel="stylesheet" href="./styles.css">
<style>
.kpiBoard{display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:14px;margin:12px 0 16px 0}
@media (max-width:1100px){.kpiBoard{grid-template-columns:1fr 1fr}}
@media (max-width:620px){.kpiBoard{grid-template-columns:1fr}}
.meter{width:100%;height:10px;border-radius:999px;border:1px solid rgba(17,19,24,.14);background:rgba(17,19,24,.04);overflow:hidden;margin-top:10px}
.meter>div{height:100%;width:0%;background:linear-gradient(135deg, var(--accent), var(--accent2));transition:width .25s ease}
.item{border:1px solid rgba(17,19,24,.12);background:var(--surface3);border-radius:16px;padding:14px}
.itemTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
.itemTitle{font-weight:950;line-height:1.2}
.itemMeta{margin-top:6px;display:flex;flex-wrap:wrap;gap:8px;color:var(--muted2);font-size:12px;font-weight:750}
.itemActions{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
.gridDash{display:grid;grid-template-columns:repeat(12, minmax(0,1fr));gap:16px;align-items:start}
.gridDash>section{grid-column:span 8}
.gridDash>aside{grid-column:span 4}
@media (max-width:1100px){.gridDash{grid-template-columns:1fr}.gridDash>section,.gridDash>aside{grid-column:auto}}
</style>
</head>
<body>
<header class="topbar">
<nav class="nav">
<a class="brand" href="index.html"><span class="logo" aria-hidden="true"></span><span>jobmejob</span></a>
<div class="navlinks">
<a class="pill" href="index.html">Home</a>
<a class="pill" href="profile.html">Profile</a>
<a class="pill" href="plan.html">Plan</a>
<a class="pill active" href="dashboard.html">Dashboard</a>
<button class="pill iconOnly" id="btnLogout" type="button">Logout</button>
</div>
</nav>
</header>

<main class="main">
<h1 class="h1">Dashboard</h1>
<p class="sub" id="subLine">Loading…</p>

<div class="notice" id="noticeTop"></div>
<div class="errorTop" id="errorTop"></div>

<div class="kpiBoard">
<div class="card">
<div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
<div style="font-weight:950">Health status</div>
<span class="badge" id="badgeHealth">Loading</span>
</div>
<div class="hr"></div>
<div class="mono" id="healthNote">—</div>
<div class="meter"><div id="healthMeterFill"></div></div>
</div>

<div class="card">
<div style="font-weight:950">Queue</div>
<div class="hr"></div>
<div style="font-size:34px;font-weight:950" id="kpiQueue">–</div>
<div class="small">jobs ready</div>
</div>

<div class="card">
<div style="font-weight:950">Applications</div>
<div class="hr"></div>
<div style="font-size:34px;font-weight:950" id="kpiApps">–</div>
<div class="small">total</div>
</div>

<div class="card">
<div style="font-weight:950">Plan</div>
<div class="hr"></div>
<div style="font-size:22px;font-weight:950" id="kpiPlan">–</div>
<div class="small" id="kpiPlanMeta">—</div>
</div>
</div>

<div class="gridDash">
<section class="card cardNoPad">
<div class="sectionHeader">
<div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
<div style="font-weight:950">Queue preview</div>
<div class="actions">
<button class="btn primary" id="btnRefresh" type="button">Refresh</button>
<button class="btn cta" id="btnFetchNow" type="button">Fetch jobs now</button>
</div>
</div>
<p class="small">Use Prio to apply first. Use Skip to remove irrelevant jobs.</p>
</div>
<div class="sectionBody">
<div id="queueWrap"><span class="badge warn">Loading…</span></div>
<div id="queueError"></div>

<div class="hr"></div>

<div style="font-weight:950;margin-bottom:10px">Recent activity</div>
<div id="activityWrap"><span class="badge warn">Loading…</span></div>
</div>
</section>

<aside class="card">
<div style="font-weight:950">Account</div>
<div class="hr"></div>
<div class="small">Email</div>
<div class="mono" id="meEmail">—</div>
<div class="hr"></div>
<div class="small">Customer ID</div>
<div class="mono" id="meCustomerId">—</div>
<div class="hr"></div>
<div class="actions">
<a class="btn ghost" href="profile.html">Edit profile</a>
<a class="btn ghost" href="plan.html">Change plan</a>
</div>
</aside>
</div>
</main>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="./config.js"></script>
<script src="./app.js"></script>
<script>
"use strict";
const { requireSession, logout, ensureCustomer, apiGet, apiPostJson, getState } = window.JobMeJob.app;

let session=null;

function showErr(msg){
const el=document.getElementById("errorTop");
el.style.display = msg ? "block" : "none";
el.textContent = msg || "";
}
function showNotice(msg){
const el=document.getElementById("noticeTop");
el.style.display = msg ? "block" : "none";
el.textContent = msg || "";
}
function setHealth(queueCount, planDaily){
let label="Low"; let cls="warn";
if(queueCount>=25){label="Healthy";cls="good";}
else if(queueCount>=5){label="Medium";cls="";}
document.getElementById("badgeHealth").className="badge "+cls;
document.getElementById("badgeHealth").textContent=label;

const ratio = planDaily>0 ? Math.min(1, queueCount/(planDaily*5)) : Math.min(1, queueCount/10);
document.getElementById("healthMeterFill").style.width = Math.round(ratio*100)+"%";
document.getElementById("healthNote").textContent =
(planDaily?("Plan "+planDaily+"/day. "):"No plan selected. ") +
(queueCount?("Queue "+queueCount+". "):"Queue empty. ") +
(queueCount===0 ? "Use “Fetch jobs now” or broaden titles/radius." : "");
}

function planInfo(planId){
const p=String(planId||"").toLowerCase();
if(p==="starter") return {name:"Starter",daily:1,meta:"1/day"};
if(p==="pro") return {name:"Growth",daily:5,meta:"5/day"};
if(p==="max") return {name:"Max",daily:10,meta:"10/day"};
return {name:"No plan",daily:0,meta:"choose plan"};
}

function renderQueue(queue){
const items=Array.isArray(queue?.data)?queue.data:[];
if(!items.length) return "<span class='badge warn'>No jobs in queue</span>";
return "<div style='display:grid;gap:12px'>" + items.slice(0,16).map(j=>{
const title=j.title||"Untitled";
const comp=j.company_name||"—";
const loc=[j.city||"", j.region||""].filter(Boolean).join(", ")||"—";
const url=j.apply_url||"";
const jobId=j.id||"";
const prio=!!(j._application && j._application.priority);
return "<div class='item'>"
+ "<div class='itemTop'><div class='itemTitle'>"
+ (url?("<a target='_blank' rel='noopener' href='"+encodeURIComponent(url).replace(/%2F/g,"/").replace(/%3A/g,":")+"'>"+title+"</a>"):title)
+ "</div><span class='badge "+(prio?"prio":"")+"'>"+(prio?"prio":"new")+"</span></div>"
+ "<div class='itemMeta'><span>"+comp+"</span><span>•</span><span>"+loc+"</span></div>"
+ "<div class='itemActions'>"
+ "<button class='btn small' data-prio='"+jobId+"'>"+(prio?"Unprio":"Prio")+"</button>"
+ "<button class='btn small danger' data-skip='"+jobId+"'>Skip</button>"
+ "</div>"
+ "</div>";
}).join("") + "</div>";
}

async function load(){
showErr("");
showNotice("");
session = await requireSession("./signup.html");
if(!session) return;

const email=String(session.user.email||"").trim().toLowerCase();
document.getElementById("subLine").textContent="Signed in as "+email;
document.getElementById("meEmail").textContent=email;

await ensureCustomer(email);

const st = await getState(session.access_token);
document.getElementById("meCustomerId").textContent = st?.customer_id || "—";

const plan=planInfo(st?.plan_id);
document.getElementById("kpiPlan").textContent=plan.name;
document.getElementById("kpiPlanMeta").textContent=plan.meta;

if(!st?.profile_complete){
showNotice("Finish Profile first (CV + preferences).");
return;
}
if(!st?.plan_id){
showNotice("Choose a plan to start daily applications.");
return;
}

const queue = await apiGet("/me/jobs/queue", session.access_token);
const qCount = typeof queue.count==="number" ? queue.count : (Array.isArray(queue.data)?queue.data.length:0);
document.getElementById("kpiQueue").textContent=String(qCount);
setHealth(qCount, plan.daily);

document.getElementById("queueWrap").innerHTML = renderQueue(queue);

try{
const apps = await apiGet("/me/applications/summary", session.access_token);
document.getElementById("kpiApps").textContent=String(apps?.total||0);
}catch{
document.getElementById("kpiApps").textContent="—";
}

try{
const events = await apiGet("/me/application-events?limit=18", session.access_token);
const rows=Array.isArray(events?.data)?events.data:[];
document.getElementById("activityWrap").innerHTML =
rows.length ? ("<div class='tableWrap'><table><thead><tr><th>Event</th><th>Job</th><th>Time</th></tr></thead><tbody>"
+ rows.map(ev=>{
const t=ev.event_type||"";
const job=ev.job||{};
const title=job.title||"—";
const when=String(ev.created_at||"").replace("T"," ").slice(0,16);
return "<tr><td>"+t+"</td><td>"+title+"</td><td>"+when+"</td></tr>";
}).join("")
+ "</tbody></table></div>")
: "<span class='badge warn'>No events yet</span>";
}catch{
document.getElementById("activityWrap").innerHTML="<span class='badge warn'>Activity not available</span>";
}
}

document.getElementById("btnRefresh").onclick=()=>load();

document.getElementById("btnFetchNow").onclick=async ()=>{
try{
showErr("");
showNotice("Fetching jobs now…");
await apiPostJson("/me/jobs/fetch-now", session.access_token, {});
showNotice("Fetch started. Refreshing…");
await load();
}catch(e){
showNotice("");
showErr(e.message||String(e));
}
};

document.getElementById("btnLogout").onclick=()=>logout("./index.html");

document.addEventListener("click", async (e)=>{
const pr=e.target.closest("button[data-prio]");
const sk=e.target.closest("button[data-skip]");
if(!pr && !sk) return;
const jobId=(pr?.getAttribute("data-prio")||sk?.getAttribute("data-skip")||"").trim();
if(!jobId) return;
try{
if(pr){
const txt=pr.textContent.toLowerCase();
if(txt.includes("unprio")) await apiPostJson("/me/applications/unprioritize", session.access_token, { job_id: jobId });
else await apiPostJson("/me/applications/prioritize", session.access_token, { job_id: jobId });
}
if(sk){
await apiPostJson("/me/applications/skip", session.access_token, { job_id: jobId, reason_code:"not_relevant", reason_note:"" });
}
await load();
}catch(e){
showErr(e.message||String(e));
}
});

window.addEventListener("load", load);
</script>
</body>
</html>
