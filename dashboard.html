<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>JobApplyAI • Dashboard</title>
<style>
:root{
--bg:#0b1020;
--card:rgba(255,255,255,.08);
--card2:rgba(255,255,255,.06);
--text:#e9ecf7;
--muted:rgba(233,236,247,.72);
--muted2:rgba(233,236,247,.55);
--line:rgba(255,255,255,.12);
--accent:#7c5cff;
--accent2:#00d4ff;
--ok:#00c853;
--warn:#ffb300;
--bad:#ff3d71;
--shadow:0 12px 34px rgba(0,0,0,.35);
--shadow2:0 16px 42px rgba(0,0,0,.38);
--radius:18px;
--max:1120px;
--safeTop: env(safe-area-inset-top, 0px);
--safeBottom: env(safe-area-inset-bottom, 0px);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
margin:0;
font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
color:var(--text);
background:
radial-gradient(1200px 650px at 20% -10%, rgba(124,92,255,.35), transparent 55%),
radial-gradient(900px 500px at 90% 10%, rgba(0,212,255,.22), transparent 55%),
radial-gradient(800px 600px at 70% 110%, rgba(0,200,83,.10), transparent 55%),
var(--bg);
overflow-x:hidden;
}
a{color:inherit;text-decoration:none}
small{color:var(--muted)}

.topbar{
position:sticky;
top:0;
z-index:20;
background:rgba(11,16,32,.62);
backdrop-filter:saturate(1.2) blur(12px);
border-bottom:1px solid var(--line);
padding-top:var(--safeTop);
}
.nav{
max-width:var(--max);
margin:0 auto;
padding:12px 16px;
display:flex;
align-items:center;
justify-content:space-between;
gap:12px;
}
.brand{
display:flex;
align-items:center;
gap:10px;
font-weight:900;
letter-spacing:.2px;
min-width:0;
}
.logo{
width:34px;height:34px;border-radius:11px;
background: linear-gradient(135deg, var(--accent), var(--accent2));
box-shadow: 0 10px 30px rgba(124,92,255,.25);
flex:0 0 auto;
}
.navlinks{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
.pill{
padding:9px 12px;
border:1px solid var(--line);
border-radius:999px;
background:rgba(255,255,255,.04);
font-weight:750;
font-size:13px;
transition:.15s ease;
cursor:pointer;
white-space:nowrap;
}
.pill:hover{transform:translateY(-1px);background:rgba(255,255,255,.06)}
.pill.active{border-color:rgba(124,92,255,.6); background:rgba(124,92,255,.18)}
.pill.iconOnly{padding:9px 10px}

.main{
max-width:var(--max);
margin:0 auto;
padding:18px 16px calc(18px + var(--safeBottom));
}

.h1{
font-size:36px;
line-height:1.05;
letter-spacing:-.8px;
margin:10px 0 8px 0;
}
.sub{margin:0 0 14px 0;color:var(--muted);font-weight:650}

.card{
background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
border:1px solid var(--line);
border-radius:var(--radius);
box-shadow:var(--shadow);
padding:14px;
overflow:hidden;
}
.card h2{
margin:0 0 10px 0;
font-size:16px;
display:flex;
align-items:center;
justify-content:space-between;
gap:10px;
}
.hr{height:1px;background:var(--line);margin:12px 0}

.kpi{
display:flex;
align-items:flex-end;
justify-content:space-between;
gap:10px;
}
.kpi .value{
font-size:34px;
font-weight:950;
letter-spacing:-.6px;
line-height:1;
}
.kpi .label{
color:var(--muted2);
font-weight:750;
font-size:12px;
}

.badge{
display:inline-flex;
align-items:center;
gap:8px;
padding:7px 10px;
border-radius:999px;
border:1px solid var(--line);
background:rgba(255,255,255,.05);
color:var(--muted);
font-size:12px;
font-weight:750;
white-space:nowrap;
}
.badge.good{border-color:rgba(0,200,83,.4); background:rgba(0,200,83,.12); color:#c9ffe0}
.badge.warn{border-color:rgba(255,179,0,.5); background:rgba(255,179,0,.12); color:#fff3c4}
.badge.bad{border-color:rgba(255,61,113,.55); background:rgba(255,61,113,.12); color:#ffd1dc}

.actions{
display:flex;
gap:10px;
flex-wrap:wrap;
align-items:center;
}
.btn{
appearance:none;
border:1px solid var(--line);
background:rgba(255,255,255,.06);
color:var(--text);
padding:11px 14px;
border-radius:999px;
font-weight:900;
font-size:13px;
cursor:pointer;
transition:.15s ease;
display:inline-flex;
align-items:center;
gap:8px;
text-decoration:none;
}
.btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.08)}
.btn:disabled{opacity:.6; cursor:not-allowed; transform:none}
.btn.primary{
border-color:rgba(124,92,255,.55);
background:linear-gradient(135deg, rgba(124,92,255,.30), rgba(0,212,255,.18));
}
.btn.ghost{
border-color:rgba(255,255,255,.14);
background:rgba(0,0,0,.18);
}

.tableWrap{
overflow:auto;
-webkit-overflow-scrolling:touch;
border-radius:16px;
border:1px solid rgba(255,255,255,.12);
background:rgba(0,0,0,.14);
}
.table{
width:100%;
min-width:720px;
border-collapse:separate;
border-spacing:0;
}
.table th,.table td{
text-align:left;
padding:10px 10px;
font-size:13px;
border-bottom:1px solid rgba(255,255,255,.10);
vertical-align:top;
}
.table th{
background:rgba(255,255,255,.06);
font-weight:950;
position:sticky;
top:0;
}
.table tr:last-child td{border-bottom:0}
.table a{color:#dfe7ff;text-decoration:underline}

.small{font-size:12px;color:var(--muted2);font-weight:650}
.mono{
font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
font-size:12px;
word-break:break-all;
color:rgba(233,236,247,.72);
}

.meter{
width:100%;
height:10px;
border-radius:999px;
border:1px solid rgba(255,255,255,.14);
background:rgba(0,0,0,.16);
overflow:hidden;
margin-top:10px;
}
.meter > div{
height:100%;
width:0%;
background: linear-gradient(135deg, var(--accent), var(--accent2));
border-radius:999px;
transition:width .25s ease;
}

.errorTop{
margin:12px 0 12px 0;
padding:12px 14px;
border-radius:16px;
border:1px solid rgba(255,61,113,.25);
background:rgba(255,61,113,.08);
color:#ffd1dc;
font-weight:800;
display:none;
}
.error{
margin-top:10px;
padding:10px 12px;
border-radius:14px;
border:1px solid rgba(255,61,113,.25);
background:rgba(255,61,113,.08);
color:#ffd1dc;
font-weight:750;
font-size:13px;
}

.cards{
display:grid;
gap:14px;
margin:12px 0 16px 0;
grid-template-columns:repeat(12, minmax(0,1fr));
}
.cards > .card:nth-child(1){grid-column:span 4;}
.cards > .card:nth-child(2){grid-column:span 2;}
.cards > .card:nth-child(3){grid-column:span 2;}
.cards > .card:nth-child(4){grid-column:span 4;}

.grid{
display:grid;
grid-template-columns:repeat(12, minmax(0,1fr));
gap:16px;
align-items:start;
}
.grid > section.card{grid-column:span 8;}
.grid > aside.card{grid-column:span 4;position:sticky;top:92px;}

.skeleton{
border-radius:12px;
height:12px;
background:linear-gradient(90deg, rgba(255,255,255,.10), rgba(255,255,255,.04), rgba(255,255,255,.10));
background-size:200% 100%;
animation:shimmer 1.2s linear infinite;
}
.skeleton.big{height:32px;border-radius:14px}
.skeleton.row{height:14px}
.skeleton.block{height:140px;border-radius:16px}
@keyframes shimmer{
0%{background-position:200% 0}
100%{background-position:-200% 0}
}
@media (max-width:1100px){
.cards{grid-template-columns:repeat(2, 1fr)}
.cards > .card:nth-child(1),
.cards > .card:nth-child(2),
.cards > .card:nth-child(3),
.cards > .card:nth-child(4){grid-column:auto}
.grid{grid-template-columns:1fr}
.grid > section.card{grid-column:auto}
.grid > aside.card{grid-column:auto;position:static}
}
@media (max-width:620px){
.nav{padding:10px 12px}
.main{padding:16px 12px calc(16px + var(--safeBottom))}
.h1{font-size:30px}
.actions{flex-direction:column;align-items:stretch}
.btn{justify-content:center;width:100%}
.table{min-width:640px}
}
@media (prefers-reduced-motion: reduce){
.skeleton{animation:none}
.meter > div{transition:none}
.pill,.btn{transition:none}
}
.footer{
max-width:var(--max);
margin:0 auto;
padding:18px 16px 30px;
color:var(--muted2);
font-size:13px;
}
</style>
</head>
<body>
<header class="topbar">
<nav class="nav">
<a class="brand" href="index.html"><span class="logo" aria-hidden="true"></span><span>JobApplyAI</span></a>
<div class="navlinks">
<a class="pill" href="index.html">Home</a>
<a class="pill" href="profile.html">Profile</a>
<a class="pill" href="plan.html">Plan</a>
<a class="pill active" href="dashboard.html">Dashboard</a>
<button class="pill iconOnly" id="btnLogout" type="button" aria-label="Logout">Logout</button>
</div>
</nav>
</header>

<main class="main">
<h1 class="h1">Dashboard</h1>
<p class="sub" id="subLine">Loading…</p>
<div class="errorTop" id="errorTop"></div>

<div class="cards">
<div class="card">
<h2>Health status <span class="badge" id="badgeHealth">Loading</span></h2>
<div class="kpi">
<div>
<div class="value" id="kpiHealthLabel">–</div>
<div class="label">job supply vs your plan</div>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
<span class="badge" id="badgeHealthPlan">Plan: –</span>
<span class="badge" id="badgeHealthQueue">Queue: –</span>
<span class="badge" id="badgeHealthCap">Today cap: –</span>
</div>
</div>
<div class="meter" aria-hidden="true"><div id="healthMeterFill"></div></div>
<div style="margin-top:10px" id="healthNote"></div>
</div>

<div class="card">
<h2>Job queue</h2>
<div class="kpi">
<div>
<div class="value" id="kpiQueue">–</div>
<div class="label">jobs ready to apply</div>
</div>
<span class="badge" id="badgeQueue">Loading</span>
</div>
</div>

<div class="card">
<h2>Applications</h2>
<div class="kpi">
<div>
<div class="value" id="kpiAppsTotal">–</div>
<div class="label">total applications</div>
</div>
<span class="badge" id="badgeApps">Loading</span>
</div>
</div>

<div class="card">
<h2>Plan</h2>
<div class="kpi">
<div>
<div class="value" id="kpiPlanName">–</div>
<div class="label" id="kpiPlanMeta">selected plan</div>
</div>
<span class="badge" id="badgePlan">Loading</span>
</div>
</div>
</div>

<div class="grid">
<section class="card">
<h2>Queue preview</h2>
<p class="small">Top 15 items from /me/jobs/queue.</p>
<div class="actions">
<button class="btn primary" id="btnRefresh" type="button">Refresh</button>
<button class="btn" id="btnCopyToken" type="button">Copy access token</button>
</div>
<div class="hr"></div>
<div id="queueWrap"><div class="skeleton block"></div></div>
<div id="queueError"></div>
</section>

<aside class="card">
<h2>Account</h2>
<div class="badge good" id="badgeUser">Signed in</div>
<div class="hr"></div>

<div class="small">Email</div>
<div class="mono" id="meEmail">–</div>

<div class="hr"></div>
<div class="small">Customer ID</div>
<div class="mono" id="meCustomerId">–</div>

<div class="hr"></div>
<div class="small">Onboarding checks</div>
<div id="onboardingChecks"><div class="skeleton row" style="width:86%"></div><div style="height:8px"></div><div class="skeleton row" style="width:74%"></div><div style="height:8px"></div><div class="skeleton row" style="width:66%"></div></div>

<div class="hr"></div>
<div class="small">Applications breakdown</div>
<div id="appsBreakdown"><div class="skeleton row" style="width:80%"></div><div style="height:8px"></div><div class="skeleton row" style="width:60%"></div></div>

<div class="hr"></div>
<div class="small">Last refresh</div>
<div class="mono" id="lastCheck">–</div>

<div class="hr"></div>
<div class="actions">
<a class="btn ghost" href="profile.html">Edit profile</a>
<a class="btn ghost" href="plan.html">Change plan</a>
</div>

<div class="hr"></div>
<div class="small" id="errorBox"></div>
</aside>
</div>
</main>

<footer class="footer">Support: <a href="mailto:schonv2@gmail.com">schonv2@gmail.com</a></footer>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const API_BASE="https://jobapplyai-api.schoene-viktor.workers.dev";
const SUPABASE_URL="https://awlzvhcnjegfhjedswko.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF3bHp2aGNuamVnZmhqZWRzd2tvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2NTE2OTgsImV4cCI6MjA4MjIyNzY5OH0.-UmHiVi0_g9tKDkr6ldfROeBrOk8hm18YVPRfnb8luY";
let supabaseClient=null;

function setText(id,text){
const el=document.getElementById(id);
if(el) el.textContent=text;
}
function setHtml(id,html){
const el=document.getElementById(id);
if(el) el.innerHTML=html;
}
function setBadge(id,type,text){
const el=document.getElementById(id);
if(!el) return;
el.className="badge"+(type?(" "+type):"");
el.textContent=text;
}
function showTopError(msg){
const el=document.getElementById("errorTop");
if(!el) return;
el.style.display="block";
el.textContent=msg;
}
function clearTopError(){
const el=document.getElementById("errorTop");
if(!el) return;
el.style.display="none";
el.textContent="";
}
function escapeHtml(s){
return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function nowStamp(){
return new Date().toISOString().replace("T"," ").replace("Z"," UTC");
}
function animateNumber(el,to){
const prefersReduced=window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches;
if(!el) return;
if(prefersReduced){el.textContent=String(to);return;}
const from=Number(String(el.textContent||"").replace(/[^\d.-]/g,""))||0;
const start=performance.now();
const dur=420;
function tick(t){
const p=Math.min(1,(t-start)/dur);
const eased=1-Math.pow(1-p,3);
const v=Math.round(from+(to-from)*eased);
el.textContent=String(v);
if(p<1) requestAnimationFrame(tick);
}
requestAnimationFrame(tick);
}
function renderQueueSkeleton(){
return '<div class="skeleton big" style="width:220px"></div><div style="height:10px"></div><div class="skeleton row" style="width:96%"></div><div style="height:8px"></div><div class="skeleton row" style="width:92%"></div><div style="height:8px"></div><div class="skeleton row" style="width:88%"></div><div style="height:8px"></div><div class="skeleton row" style="width:84%"></div>';
}
function planFromState(planId){
const pid=String(planId||"").trim().toLowerCase();
if(pid==="starter") return {id:"starter",name:"Starter",daily:1,meta:"1 application/day",short:"Starter (1/day)"};
if(pid==="pro") return {id:"pro",name:"Pro",daily:5,meta:"5 applications/day",short:"Pro (5/day)"};
if(pid==="max") return {id:"max",name:"Max",daily:10,meta:"10 applications/day",short:"Max (10/day)"};
return {id:null,name:"No plan",daily:0,meta:"Select Starter / Pro / Max",short:"No plan"};
}
function planFallbackFromLocalStorage(){
const raw=(localStorage.getItem("ja_plan")||"").trim().toLowerCase();
if(raw==="starter"||raw==="pro"||raw==="max") return planFromState(raw);
return planFromState(null);
}
async function requireSession(){
if(!supabaseClient) throw new Error("Supabase client not initialized.");
const {data,error}=await supabaseClient.auth.getSession();
if(error) throw error;
if(!data||!data.session){
window.location.replace("./signup.html");
return null;
}
return data.session;
}
async function apiGet(path,accessToken){
const res=await fetch(API_BASE+path,{method:"GET",headers:{"Authorization":"Bearer "+accessToken}});
const text=await res.text().catch(()=> "");
let json=null;
try{json=JSON.parse(text);}catch{json={raw:text};}
if(!res.ok){
const msg=(json&&(json.error||json.details))?(json.error||json.details):text;
throw new Error(path+" failed: "+res.status+" "+msg);
}
return json;
}
function renderQueueTable(queue){
const items=Array.isArray(queue?.data)?queue.data:[];
if(items.length===0) return '<span class="badge warn">No jobs in queue</span>';
const rows=items.slice(0,15).map(j=>{
const title=j.title||"Untitled";
const company=j.company_name||"—";
const city=j.city||"—";
const country=j.country||"—";
const posted=j.posted_at?String(j.posted_at).slice(0,10):"—";
const link=j.apply_url?String(j.apply_url):"";
const titleCell=link?('<a href="'+escapeHtml(link)+'" target="_blank" rel="noopener">'+escapeHtml(title)+'</a>'):escapeHtml(title);
return "<tr><td>"+titleCell+"</td><td>"+escapeHtml(company)+"</td><td>"+escapeHtml(city)+"</td><td>"+escapeHtml(country)+"</td><td>"+escapeHtml(posted)+"</td></tr>";
}).join("");
return '<div class="tableWrap"><table class="table"><thead><tr><th>Title</th><th>Company</th><th>City</th><th>Country</th><th>Posted</th></tr></thead><tbody>'+rows+'</tbody></table></div><div class="small" style="margin-top:10px">Showing '+Math.min(items.length,15)+' of '+items.length+' jobs</div>';
}
function renderAppsBreakdown(summary){
const counts=summary&&summary.counts?summary.counts:null;
if(!counts||typeof counts!=="object") return '<span class="badge warn">Not available</span>';
const entries=Object.entries(counts);
if(entries.length===0) return '<span class="badge warn">No applications yet</span>';
entries.sort((a,b)=>String(a[0]).localeCompare(String(b[0])));
const rows=entries.map(([k,v])=>"<tr><td>"+escapeHtml(k)+"</td><td>"+escapeHtml(v)+"</td></tr>").join("");
return '<div class="tableWrap"><table class="table" style="min-width:320px"><thead><tr><th>Status</th><th>Count</th></tr></thead><tbody>'+rows+'</tbody></table></div>';
}
function computeSupply(queueCount,planDaily){
let healthLabel="Low";
let badgeType="warn";
let recommendedCap=1;
if(queueCount>=25){healthLabel="Healthy";badgeType="good";recommendedCap=10;}
else if(queueCount>=5){healthLabel="Medium";badgeType="";recommendedCap=5;}
let note="";
if(!planDaily) note="Select a plan to start. Without a plan, the system does not know your daily target.";
else if(queueCount===0) note="No jobs in your queue yet. Use Workplace to fetch jobs, or broaden your titles/radius.";
else if(queueCount<planDaily) note="Your queue is below your plan. Add more desired titles and/or increase radius to avoid running out of applications.";
else note="You have enough supply for today.";
let ratio=0;
if(planDaily&&planDaily>0) ratio=Math.min(1,queueCount/(planDaily*5));
else ratio=Math.min(1,queueCount/10);
return {healthLabel,badgeType,recommendedCap,note,ratio};
}
function renderHealthTop(queueCount,plan){
const s=computeSupply(queueCount,plan.daily);
setBadge("badgeHealth",s.badgeType,s.healthLabel);
setText("kpiHealthLabel",s.healthLabel);
setBadge("badgeHealthPlan",plan.daily?"":"warn","Plan: "+plan.short);
setBadge("badgeHealthQueue",queueCount>0?"good":"warn","Queue: "+queueCount);
setBadge("badgeHealthCap","","Today cap: "+(plan.daily?plan.daily:0)+"/day");
const meter=document.getElementById("healthMeterFill");
if(meter) meter.style.width=Math.round(s.ratio*100)+"%";
setHtml("healthNote",'<div class="mono">Recommended cap based on supply: '+s.recommendedCap+'/day</div><div class="mono" style="margin-top:6px">'+escapeHtml(s.note)+'</div>');
}
function renderOnboardingChecks(state){
const items=[];
const profileOk=!!state.profile_complete;
const planOk=!!state.plan_id;
const cvOk=!!state.cv_uploaded;
const ocrOk=(String(state.cv_ocr_status||"").toLowerCase()==="done");
items.push({label:"Profile complete",ok:profileOk,fix:"profile.html"});
items.push({label:"Plan selected",ok:planOk,fix:"plan.html"});
items.push({label:"CV uploaded",ok:cvOk,fix:"profile.html"});
items.push({label:"OCR done",ok:ocrOk,fix:"profile.html"});
return items.map(it=>{
const cls=it.ok?"badge good":"badge warn";
const right=it.ok?'OK':('<a href="'+it.fix+'" style="text-decoration:underline">Fix</a>');
return '<div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin:8px 0"><span class="'+cls+'">'+escapeHtml(it.label)+'</span><span class="small">'+right+'</span></div>';
}).join("");
}
async function loadDashboard(){
clearTopError();
setText("errorBox","");
setHtml("queueError","");
setText("lastCheck",nowStamp());
setBadge("badgeQueue","","Loading");
setBadge("badgeApps","","Loading");
setBadge("badgePlan","","Loading");
setBadge("badgeHealth","","Loading");
setHtml("queueWrap",renderQueueSkeleton());
setHtml("appsBreakdown",'<div class="skeleton row" style="width:80%"></div><div style="height:8px"></div><div class="skeleton row" style="width:60%"></div>');
setHtml("onboardingChecks",'<div class="skeleton row" style="width:86%"></div><div style="height:8px"></div><div class="skeleton row" style="width:74%"></div><div style="height:8px"></div><div class="skeleton row" style="width:66%"></div>');
const session=await requireSession();
if(!session) return;
const email=session.user&&session.user.email?session.user.email:"—";
setText("meEmail",email);
setText("subLine","Signed in as "+email);
let state=null;
try{
state=await apiGet("/me/state",session.access_token);
}catch(e){
state=null;
}
const plan=state&&state.plan_id?planFromState(state.plan_id):planFallbackFromLocalStorage();
setText("kpiPlanName",plan.name);
setText("kpiPlanMeta",plan.daily?plan.meta:"no plan selected");
setBadge("badgePlan",plan.daily?"good":"warn",plan.daily?"Selected":"Not selected");
if(state&&state.customer_id){
setText("meCustomerId",state.customer_id);
}
if(state){
setHtml("onboardingChecks",renderOnboardingChecks(state));
}
try{
const queue=await apiGet("/me/jobs/queue",session.access_token);
const qCount=(typeof queue.count==="number")?queue.count:(Array.isArray(queue.data)?queue.data.length:0);
animateNumber(document.getElementById("kpiQueue"),qCount);
setBadge("badgeQueue",qCount>0?"good":"warn",qCount>0?"OK":"Empty");
setHtml("queueWrap",renderQueueTable(queue));
renderHealthTop(qCount,plan);
if((!state||!state.customer_id) && queue && queue.customer_id){
setText("meCustomerId",queue.customer_id);
}
}catch(e){
setText("kpiQueue","–");
setBadge("badgeQueue","bad","Error");
setBadge("badgeHealth","bad","Error");
setHtml("queueWrap",'<span class="badge bad">Queue failed</span>');
setHtml("queueError",'<div class="error">'+escapeHtml(e.message)+'</div>');
setText("errorBox",e.message);
showTopError(e.message);
}
try{
const apps=await apiGet("/me/applications/summary",session.access_token);
const total=(typeof apps.total==="number")?apps.total:0;
animateNumber(document.getElementById("kpiAppsTotal"),total);
setBadge("badgeApps","good","OK");
setHtml("appsBreakdown",renderAppsBreakdown(apps));
}catch(e){
setText("kpiAppsTotal","–");
setBadge("badgeApps","warn","Not ready");
setHtml("appsBreakdown",'<span class="badge warn">Not available</span>');
}
}
function wireEvents(){
document.getElementById("btnRefresh").addEventListener("click",async()=>{try{await loadDashboard();}catch(e){showTopError(e.message);setText("errorBox",e.message);}});
document.getElementById("btnCopyToken").addEventListener("click",async()=>{
try{
const {data}=await supabaseClient.auth.getSession();
const token=data&&data.session?data.session.access_token:"";
if(!token){alert("No session token found. Please sign in again.");return;}
await navigator.clipboard.writeText(token);
alert("Access token copied.");
}catch(e){showTopError(e.message);}
});
document.getElementById("btnLogout").addEventListener("click",async()=>{
try{
await supabaseClient.auth.signOut();
window.location.replace("./index.html");
}catch(e){showTopError(e.message);}
});
}
window.addEventListener("load",async()=>{
try{
if(!window.supabase) throw new Error("Supabase library did not load. Check adblockers / network.");
supabaseClient=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
wireEvents();
await loadDashboard();
}catch(e){
showTopError(e.message);
setText("errorBox",e.message);
setBadge("badgeQueue","bad","Error");
setBadge("badgeApps","bad","Error");
setBadge("badgePlan","bad","Error");
setBadge("badgeHealth","bad","Error");
}
});
</script>
</body>
</html>
