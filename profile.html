<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JobApplyAI • Profile</title>
<style>
:root{
  --bg:#0b1020;
  --card:rgba(255,255,255,.08);
  --card2:rgba(255,255,255,.06);
  --text:#e9ecf7;
  --muted:rgba(233,236,247,.72);
  --line:rgba(255,255,255,.12);
  --accent:#7c5cff;
  --accent2:#00d4ff;
  --danger:#ff3d71;
  --ok:#00c853;
  --warn:#ffb300;
  --shadow:0 12px 34px rgba(0,0,0,.35);
  --shadow2:0 10px 26px rgba(0,0,0,.10);
  --green:#00a63f;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  color:var(--text);
  background:
    radial-gradient(1200px 650px at 20% -10%, rgba(124,92,255,.35), transparent 55%),
    radial-gradient(900px 500px at 90% 10%, rgba(0,212,255,.22), transparent 55%),
    radial-gradient(800px 600px at 70% 110%, rgba(0,200,83,.10), transparent 55%),
    var(--bg);
  overflow-x:hidden;
}

a{color:inherit;text-decoration:none}
small{color:var(--muted)}

.wrap{
  max-width:980px;
  margin:0 auto;
  padding:22px 16px 70px;
}

.topbar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom:18px;
}

.brand{
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:800;
  letter-spacing:.2px;
}
.logo{
  width:34px;height:34px;border-radius:11px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  box-shadow: 0 10px 30px rgba(124,92,255,.25);
}
.nav{
  display:flex; gap:10px; flex-wrap:wrap;
}
.pill{
  padding:9px 12px;
  border:1px solid var(--line);
  border-radius:999px;
  background:rgba(255,255,255,.04);
  font-weight:650;
  font-size:13px;
  transition:.15s ease;
}
.pill:hover{transform:translateY(-1px); background:rgba(255,255,255,.06)}
.pill.active{border-color:rgba(124,92,255,.6); background:rgba(124,92,255,.18)}

.grid{
  display:grid;
  grid-template-columns: 1.2fr .8fr;
  gap:14px;
}

.card{
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
  border:1px solid var(--line);
  border-radius:18px;
  box-shadow:var(--shadow);
  overflow:hidden;
}

.cardHeader{
  padding:18px 18px 14px;
  border-bottom:1px solid var(--line);
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:10px;
}

.hTitle{font-size:18px; font-weight:850; margin:0}
.hSub{margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.35}

.badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:7px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.05);
  color:var(--muted);
  font-size:12px;
  font-weight:750;
  white-space:nowrap;
}
.badge.good{border-color:rgba(0,200,83,.4); background:rgba(0,200,83,.12); color:#c9ffe0}
.badge.warn{border-color:rgba(255,179,0,.5); background:rgba(255,179,0,.12); color:#fff3c4}
.badge.bad{border-color:rgba(255,61,113,.55); background:rgba(255,61,113,.12); color:#ffd1dc}

.form{
  padding:18px;
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:12px;
}

.field{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.field.full{grid-column:1/-1}

label{font-size:12px; color:var(--muted); font-weight:750}
input,select,textarea{
  background:rgba(0,0,0,.18);
  border:1px solid rgba(255,255,255,.14);
  color:var(--text);
  padding:11px 12px;
  border-radius:12px;
  outline:none;
  transition:.15s ease;
  font-size:14px;
}
input:focus,select:focus,textarea:focus{
  border-color:rgba(124,92,255,.65);
  box-shadow:0 0 0 3px rgba(124,92,255,.18);
}
textarea{min-height:88px; resize:vertical}
.help{font-size:12px; color:var(--muted); line-height:1.4}

.actions{
  padding:0 18px 18px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
}

.btn{
  appearance:none;
  border:1px solid var(--line);
  background:rgba(255,255,255,.06);
  color:var(--text);
  padding:11px 14px;
  border-radius:12px;
  font-weight:850;
  cursor:pointer;
  transition:.15s ease;
  display:inline-flex;
  align-items:center;
  gap:10px;
}
.btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.08)}
.btn:disabled{opacity:.6; cursor:not-allowed; transform:none}
.btn.primary{
  border-color:rgba(124,92,255,.55);
  background:linear-gradient(135deg, rgba(124,92,255,.30), rgba(0,212,255,.18));
}
.btn.green{
  border-color:rgba(0,200,83,.45);
  background:linear-gradient(135deg, rgba(0,200,83,.20), rgba(0,212,255,.12));
}
.btn.danger{
  border-color:rgba(255,61,113,.55);
  background:linear-gradient(135deg, rgba(255,61,113,.20), rgba(124,92,255,.14));
}

.side{
  display:flex;
  flex-direction:column;
  gap:14px;
}

.side .card{box-shadow:var(--shadow2)}
.side .cardHeader{align-items:center}

.kpi{
  padding:16px 18px 18px;
  display:grid;
  grid-template-columns:1fr;
  gap:10px;
}
.kpiRow{
  display:flex;justify-content:space-between;align-items:center;
  padding:10px 12px;
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.10);
  border-radius:14px;
}
.kpiName{color:var(--muted); font-size:12px; font-weight:800}
.kpiVal{font-weight:900; letter-spacing:.3px}
.kpiVal.ok{color:#c9ffe0}
.kpiVal.bad{color:#ffd1dc}

.hr{height:1px;background:var(--line); margin:12px 0}

.cvBox{
  padding:16px 18px 18px;
}
.cvRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
.cvMeta{color:var(--muted); font-size:12px; line-height:1.35}
.file{
  padding:11px 12px;
  border-radius:12px;
  border:1px dashed rgba(255,255,255,.18);
  background:rgba(0,0,0,.16);
  width:100%;
}
.cvActions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
.progressLine{
  margin-top:10px;
  font-size:12px;
  color:var(--muted);
  line-height:1.35;
}
.pulse{
  display:inline-block; width:8px; height:8px; border-radius:50%;
  background:var(--accent2);
  box-shadow:0 0 0 0 rgba(0,212,255,.6);
  animation:pulse 1.2s infinite;
  margin-right:8px;
}
@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(0,212,255,.6)}
  70%{box-shadow:0 0 0 10px rgba(0,212,255,0)}
  100%{box-shadow:0 0 0 0 rgba(0,212,255,0)}
}

.leaving{opacity:.45; filter:blur(.3px); transition:.2s}
.helper{font-size:12px; color:var(--muted)}
.helper strong{color:var(--text)}

@media (max-width: 900px){
  .grid{grid-template-columns:1fr}
}
</style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div style="font-size:14px;opacity:.85">JobApplyAI</div>
        <div style="font-size:12px;color:var(--muted);font-weight:700">Customer profile</div>
      </div>
    </div>
    <div class="nav">
      <a class="pill" href="./index.html" data-nav="1">Home</a>
      <a class="pill active" href="./profile.html" data-nav="1">Profile</a>
      <a class="pill" href="./plan.html" data-nav="1">Plan</a>
      <a class="pill" href="./dashboard.html" data-nav="1">Dashboard</a>
    </div>
  </div>

  <div class="grid">
    <section class="card">
      <div class="cardHeader">
        <div>
          <h2 class="hTitle">Your preferences</h2>
          <p class="hSub">These settings decide which jobs we fetch for you. Save after updating.</p>
        </div>
        <span class="badge" id="saveStatus">Not saved yet</span>
      </div>

      <form class="form" id="profileForm" autocomplete="off">
        <div class="field full">
          <label for="jobTitles">Desired job titles (comma separated)</label>
          <textarea id="jobTitles" placeholder="Receptionist, Front Desk Agent, Rezeption"></textarea>
          <div class="help">Tip: add 3–5 variations to avoid “0 jobs found”.</div>
        </div>

        <div class="field full">
          <label for="industry">Industries (comma separated)</label>
          <input id="industry" placeholder="Healthtech, Hospitality, Wellness">
          <div class="help">Optional. Can be used later for better matching.</div>
        </div>

        <div class="field">
          <label for="country">Country</label>
          <select id="country">
            <option value="DE">Germany (DE)</option>
            <option value="UK">United Kingdom (UK)</option>
          </select>
        </div>

        <div class="field">
          <label for="city">Main location(s) (comma separated)</label>
          <input id="city" placeholder="Berlin, Potsdam">
        </div>

        <div class="field">
          <label for="radius">Radius (km)</label>
          <input id="radius" placeholder="20" inputmode="numeric">
        </div>

        <div class="field full">
          <div class="help">
            Your plan sets the daily application cap. Profile data is used for job matching and later for email drafting.
          </div>
        </div>

        <div class="field full">
          <button class="btn primary" type="button" id="saveBtn">Save profile</button>
          <button class="btn green" type="button" id="toNext">Continue</button>
        </div>
      </form>

      <div class="helper" id="fatalHint" style="margin-top:10px"></div>
    </section>

    <aside class="side">
      <section class="card">
        <div class="cardHeader">
          <div>
            <div class="hTitle" style="font-size:16px">Account status</div>
            <div class="hSub" style="margin-top:4px">Quick checks before we fetch jobs</div>
          </div>
          <span class="badge" id="signedInBadge">Checking…</span>
        </div>

        <div class="kpi">
          <div class="kpiRow">
            <div class="kpiName">Signed in</div>
            <div class="kpiVal" id="kSigned">…</div>
          </div>
          <div class="kpiRow">
            <div class="kpiName">Profile saved</div>
            <div class="kpiVal" id="kProfile">…</div>
          </div>
          <div class="kpiRow">
            <div class="kpiName">Plan selected</div>
            <div class="kpiVal" id="kPlan">…</div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="cardHeader">
          <div>
            <div class="hTitle" style="font-size:16px">CV upload & OCR</div>
            <div class="hSub" style="margin-top:4px">Upload your CV and extract text for better matching.</div>
          </div>
          <span class="badge" id="ocrBadge">OCR idle</span>
        </div>

        <div class="cvBox">
          <input class="file" type="file" id="cvFile" accept=".pdf,.doc,.docx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
          <div class="progressLine" id="cvHint">No file uploaded yet.</div>
          <div class="progressLine" id="ocrMeta"></div>

          <div class="cvActions">
            <button class="btn" type="button" id="uploadCvBtn">Upload CV</button>
            <button class="btn primary" type="button" id="startOcrBtn">Start OCR (PDF)</button>
            <button class="btn" type="button" id="pollOcrBtn">Refresh OCR status</button>
          </div>

          <div class="hr"></div>

          <div class="help">
            OCR will store extracted text in your profile so we can suggest job titles and tailor future applications.
          </div>
        </div>
      </section>
    </aside>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
"use strict";

/* =========================
CONFIG
========================= */
// Your Worker base URL
const API_BASE_DEFAULT = "https://jobapplyai-api.schoene-viktor.workers.dev";
const API_BASE = API_BASE_DEFAULT.replace(/\/+$/,"");

// Your Supabase public info (OK to be in frontend)
const SUPABASE_URL_DEFAULT = "https://awlzvhcnjegfhjedswko.supabase.co";

// Prefer localStorage if you keep it there; fallback if missing.
// If you want to hardcode the anon key too, put it below.
const SUPABASE_ANON_DEFAULT = localStorage.getItem("sb_anon") || "";

// Ensure localStorage keys exist to avoid “Missing sb_url / sb_anon”
if(!localStorage.getItem("sb_url")) localStorage.setItem("sb_url", SUPABASE_URL_DEFAULT);
if(!localStorage.getItem("sb_anon") && SUPABASE_ANON_DEFAULT) localStorage.setItem("sb_anon", SUPABASE_ANON_DEFAULT);

const SUPABASE_URL = localStorage.getItem("sb_url") || SUPABASE_URL_DEFAULT;
const SUPABASE_ANON_KEY = localStorage.getItem("sb_anon") || SUPABASE_ANON_DEFAULT;

let supabaseClient = null;

/* =========================
UI helpers
========================= */
function $(id){ return document.getElementById(id); }
function setCvHint(t){ const el=$("cvHint"); if(el) el.textContent=t; }
function setFatal(t){ const el=$("fatalHint"); if(el) el.textContent=t||""; }

function setOcrBadge(kind,text){
  const b=$("ocrBadge");
  if(!b) return;
  b.className="badge"+(kind?(" "+kind):"");
  b.textContent=text;
}
function setOcrMeta(t){ const el=$("ocrMeta"); if(el) el.textContent=t||""; }

function hasPlan(){
  const p = (localStorage.getItem("ja_plan")||"").trim();
  return !!p;
}
function setNextButton(){
  const btn=$("toNext");
  if(!btn) return;
  btn.textContent = hasPlan() ? "Continue to dashboard" : "Continue to plan";
}
function go(url){
  document.body.classList.add("leaving");
  setTimeout(()=>{ window.location.href=url; },180);
}

/* OCR local state (resume after reload) */
function getOcrState(){
  return {
    op: (localStorage.getItem("ja_ocr_op")||"").trim(),
    out: (localStorage.getItem("ja_ocr_out")||"").trim(),
    text: (localStorage.getItem("ja_ocr_text")||""),
    doneAt: (localStorage.getItem("ja_ocr_done_at")||"").trim()
  };
}
function setOcrState(patch){
  const st=getOcrState();
  const merged={...st, ...patch};
  localStorage.setItem("ja_ocr_op", merged.op || "");
  localStorage.setItem("ja_ocr_out", merged.out || "");
  localStorage.setItem("ja_ocr_text", merged.text || "");
  localStorage.setItem("ja_ocr_done_at", merged.doneAt || "");
  return merged;
}

/* =========================
Auth / backend
========================= */
async function getSession(){
  const { data } = await supabaseClient.auth.getSession();
  return data && data.session ? data.session : null;
}

async function upsertCustomerByEmail(email){
  const res = await fetch(`${API_BASE}/customers/upsert`,{
    method:"POST",
    headers:{ "content-type":"application/json" },
    body: JSON.stringify({ email })
  });
  const text = await res.text().catch(()=> "");
  if(!res.ok) throw new Error(`Customer upsert failed: ${res.status} ${text}`);
  return JSON.parse(text);
}

async function requireAuthAndCustomer(){
  const session = await getSession();
  if(!session || !session.user || !session.user.email){
    window.location.replace("./signup.html");
    return null;
  }
  const email = session.user.email.trim().toLowerCase();
  localStorage.setItem("ja_user_email", email);

  const existingId = (localStorage.getItem("ja_customer_id")||"").trim();
  if(existingId) return { session, email, customerId: existingId };

  const data = await upsertCustomerByEmail(email);
  if(data && data.customer_id){
    localStorage.setItem("ja_customer_id", data.customer_id);
    return { session, email, customerId: data.customer_id };
  }
  throw new Error("Signed in, but could not create customer (missing customer_id).");
}

async function fetchCvMeta(session){
  const res = await fetch(`${API_BASE}/me/cv`,{
    method:"GET",
    headers:{ "Authorization": `Bearer ${session.access_token}` }
  });
  const text = await res.text().catch(()=> "");
  if(!res.ok) throw new Error(`CV meta failed: ${res.status} ${text}`);
  return JSON.parse(text);
}

async function uploadCv(session, file){
  const fd = new FormData();
  fd.append("cv", file);

  const res = await fetch(`${API_BASE}/me/cv`,{
    method:"POST",
    headers:{ "Authorization": `Bearer ${session.access_token}` },
    body: fd
  });
  const text = await res.text().catch(()=> "");
  if(!res.ok) throw new Error(`CV upload failed: ${res.status} ${text}`);
  return JSON.parse(text);
}

async function startOcr(session){
  const res = await fetch(`${API_BASE}/me/cv/ocr`,{
    method:"POST",
    headers:{ "Authorization": `Bearer ${session.access_token}` }
  });
  const text = await res.text().catch(()=> "");
  if(!res.ok) throw new Error(`OCR start failed: ${res.status} ${text}`);
  return JSON.parse(text);
}

async function pollOcr(session, op, out){
  const u = new URL(`${API_BASE}/me/cv/ocr/status`);
  if(op) u.searchParams.set("operation", op);
  if(out) u.searchParams.set("out", out);

  const res = await fetch(u.toString(),{
    method:"GET",
    headers:{ "Authorization": `Bearer ${session.access_token}` }
  });
  const text = await res.text().catch(()=> "");
  if(!res.ok) throw new Error(`OCR status failed: ${res.status} ${text}`);
  return JSON.parse(text);
}

/* NEW: authenticated profile save */
async function upsertMeProfile(session,payload){
  const token = session && session.access_token ? session.access_token : "";
  if(!token) throw new Error("Missing access token. Please sign in again.");

  const res=await fetch(`${API_BASE}/me/profile`,{
    method:"POST",
    headers:{
      "content-type":"application/json",
      "Authorization":`Bearer ${token}`
    },
    body: JSON.stringify(payload)
  });
  const text=await res.text().catch(()=> "");
  if(!res.ok) throw new Error(`Profile upsert failed: ${res.status} ${text}`);
  return JSON.parse(text);
}

/* =========================
Parsing helpers
========================= */
function parseCsvList(s){
  return String(s||"")
    .split(",")
    .map(x=>x.trim())
    .filter(Boolean)
    .slice(0,30);
}

/* =========================
Main actions
========================= */
async function saveProfileNow(auth){
  const st=$("saveStatus");
  const saveBtn=$("saveBtn");
  saveBtn.disabled=true;
  st.className="badge warn";
  st.textContent="Saving...";

  try{
    // Always store local
    const profileLocal={
      jobTitles: $("jobTitles").value.trim(),
      industry: $("industry").value.trim(),
      country: $("country").value.trim(),
      city: $("city").value.trim(),
      radius: $("radius").value.trim()
    };
    localStorage.setItem("ja_profile", JSON.stringify(profileLocal));

    const desired_titles = parseCsvList(profileLocal.jobTitles);
    if(desired_titles.length === 0){
      throw new Error("Please enter at least 1 desired job title.");
    }
    const industries = parseCsvList(profileLocal.industry);

    const countries_allowed = [ (profileLocal.country || "DE").trim() ].filter(Boolean);
    const locations = parseCsvList(profileLocal.city);

    if(locations.length === 0){
      throw new Error("Please enter at least 1 location (city).");
    }

    let radius_km = profileLocal.radius ? Number(profileLocal.radius) : 30;
    if(!Number.isFinite(radius_km)) radius_km = 30;

    await upsertMeProfile(auth.session,{ desired_titles, industries, countries_allowed, locations, radius_km });

    localStorage.setItem("ja_profile_complete","true");
    st.className="badge good";
    st.textContent="Saved";
    $("kProfile").textContent="Yes";
    $("kProfile").className="kpiVal ok";
    setNextButton();
  }catch(e){
    st.className="badge bad";
    st.textContent="Save failed";
    setFatal(e && e.message ? e.message : String(e));
  }finally{
    saveBtn.disabled=false;
  }
}

function loadLocalProfile(){
  try{
    const raw = localStorage.getItem("ja_profile");
    if(!raw) return;
    const p = JSON.parse(raw);
    if(p.jobTitles) $("jobTitles").value = p.jobTitles;
    if(p.industry) $("industry").value = p.industry;
    if(p.country) $("country").value = p.country;
    if(p.city) $("city").value = p.city;
    if(p.radius) $("radius").value = p.radius;
  }catch{}
}

async function refreshCvUi(session){
  try{
    const data = await fetchCvMeta(session);
    const cv = data && data.cv ? data.cv : null;

    if(cv && cv.cv_path){
      setCvHint(`Uploaded: ${cv.cv_filename || cv.cv_path} (${cv.cv_size || 0} bytes)`);
      const ocrStatus = (cv.cv_ocr_status || "").toLowerCase();
      if(ocrStatus === "processing"){
        setOcrBadge("warn","OCR processing");
        setOcrMeta("You can refresh status anytime.");
      }else if(ocrStatus === "done"){
        setOcrBadge("good","OCR done");
        setOcrMeta("Extracted text is stored in your profile.");
      }else if(ocrStatus === "failed"){
        setOcrBadge("bad","OCR failed");
        setOcrMeta(cv.cv_ocr_error || "Unknown OCR error");
      }else{
        setOcrBadge("","OCR idle");
        setOcrMeta("");
      }
    }else{
      setCvHint("No file uploaded yet.");
      setOcrBadge("","OCR idle");
      setOcrMeta("");
    }
  }catch(e){
    setCvHint("Could not load CV status.");
  }
}

/* =========================
Boot
========================= */
(async function boot(){
  try{
    if(!SUPABASE_URL || !SUPABASE_ANON_KEY){
      setFatal("Missing Supabase config. Set sb_url and sb_anon in localStorage or hardcode SUPABASE_ANON_DEFAULT.");
      return;
    }

    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Smooth nav
    document.addEventListener("click",(e)=>{
      const a=e.target.closest("a[data-nav='1']");
      if(!a) return;
      const url=a.getAttribute("href");
      if(!url || url.startsWith("#")) return;
      e.preventDefault();
      go(url);
    });

    loadLocalProfile();
    setNextButton();

    const auth = await requireAuthAndCustomer();
    if(!auth) return;

    $("signedInBadge").className="badge good";
    $("signedInBadge").textContent="Signed in";
    $("kSigned").textContent="Yes";
    $("kSigned").className="kpiVal ok";

    const profComplete = (localStorage.getItem("ja_profile_complete")||"").trim()==="true";
    $("kProfile").textContent = profComplete ? "Yes" : "No";
    $("kProfile").className = "kpiVal " + (profComplete ? "ok" : "bad");

    $("kPlan").textContent = hasPlan() ? "Yes" : "No";
    $("kPlan").className = "kpiVal " + (hasPlan() ? "ok" : "bad");

    await refreshCvUi(auth.session);

    $("saveBtn").addEventListener("click", ()=> saveProfileNow(auth));

    $("toNext").addEventListener("click", ()=>{
      if(hasPlan()) go("./dashboard.html");
      else go("./plan.html");
    });

    $("uploadCvBtn").addEventListener("click", async ()=>{
      setFatal("");
      const file = $("cvFile").files && $("cvFile").files[0] ? $("cvFile").files[0] : null;
      if(!file){ setFatal("Please choose a CV file first."); return; }
      try{
        setCvHint("Uploading...");
        const r = await uploadCv(auth.session, file);
        setCvHint(`Uploaded: ${r.cv_filename || r.cv_path}`);
        await refreshCvUi(auth.session);
      }catch(e){
        setFatal(e && e.message ? e.message : String(e));
      }
    });

    $("startOcrBtn").addEventListener("click", async ()=>{
      setFatal("");
      try{
        setOcrBadge("warn","Starting OCR…");
        setOcrMeta("This can take 1–3 minutes for longer PDFs.");
        const r = await startOcr(auth.session);
        const op = (r.operation || "").trim();
        const out = (r.gcs && r.gcs.output) ? String(r.gcs.output) : "";
        setOcrState({ op, out, text:"", doneAt:"" });
        setOcrBadge("warn","OCR processing");
        setOcrMeta("OCR started. Click refresh to check status.");
      }catch(e){
        setOcrBadge("bad","OCR failed");
        setOcrMeta("");
        setFatal(e && e.message ? e.message : String(e));
      }
    });

    $("pollOcrBtn").addEventListener("click", async ()=>{
      setFatal("");
      try{
        const st = getOcrState();
        if(!st.op){
          setFatal("No OCR operation found. Start OCR first.");
          return;
        }
        setOcrBadge("warn","Checking…");
        const r = await pollOcr(auth.session, st.op, st.out);
        if(r.status === "processing"){
          setOcrBadge("warn","OCR processing");
          setOcrMeta("Still running… try again in a moment.");
        }else if(r.status === "done"){
          setOcrBadge("good","OCR done");
          setOcrMeta(`Saved text (${r.text_length || 0} chars).`);
          setOcrState({ doneAt: new Date().toISOString() });
        }else{
          setOcrBadge("bad","OCR failed");
          setOcrMeta(r.error || "Unknown error");
        }
        await refreshCvUi(auth.session);
      }catch(e){
        setOcrBadge("bad","OCR failed");
        setFatal(e && e.message ? e.message : String(e));
      }
    });

  }catch(e){
    setFatal(e && e.message ? e.message : String(e));
  }
})();
</script>
</body>
</html>
