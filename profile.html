<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>jobmejob • Profile</title>
<link rel="stylesheet" href="./styles.css">
<style>
.progressWrap{margin-top:12px;border:1px solid rgba(17,19,24,.12);background:rgba(17,19,24,.03);border-radius:16px;padding:12px;display:none}
.progressBar{height:10px;border-radius:999px;background:rgba(17,19,24,.10);overflow:hidden;margin-top:8px}
.progressBar>div{height:100%;width:0%;background:linear-gradient(135deg, rgba(34,197,94,.85), rgba(22,163,74,.75));transition:width .25s ease}
.helpBox{border:1px solid rgba(17,19,24,.12);background:rgba(17,19,24,.03);padding:12px;border-radius:16px}
</style>
</head>

<body>
<header class="topbar">
<nav class="nav">
<a class="brand" href="index.html"><span class="logo" aria-hidden="true"></span><span>jobmejob</span></a>
<div class="navlinks">
<a class="pill" href="index.html">Home</a>
<a class="pill active" href="profile.html">Profile</a>
<a class="pill" href="plan.html">Plan</a>
<a class="pill" href="dashboard.html">Dashboard</a>
<button class="pill iconOnly" id="btnLogout" type="button">Logout</button>
</div>
</nav>
</header>

<main class="main">
<h1 class="h1">Profile</h1>
<p class="sub" id="subLine">Loading…</p>
<div class="notice" id="noticeTop"></div>
<div class="errorTop" id="errorTop"></div>

<div class="grid2">
<section class="card cardNoPad">
<div class="sectionHeader">
<div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
<div style="font-weight:950">Step 1: Upload your CV</div>
<span class="badge" id="cvStatusBadge">Loading</span>
</div>
<p class="small">Upload PDF for best OCR + AI title suggestions.</p>
</div>
<div class="sectionBody">

<label class="small" for="cvFile" style="font-weight:850">CV file (PDF/DOC/DOCX)</label>
<input type="file" id="cvFile" accept=".pdf,.doc,.docx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document">

<div class="progressWrap" id="cvProgressWrap">
<div class="small" id="cvProgressText">Preparing…</div>
<div class="progressBar"><div id="cvProgressFill"></div></div>
<div class="small" id="cvProgressHint" style="margin-top:8px"></div>
</div>

<div class="helpBox" style="margin-top:12px">
<div class="small" id="cvHint">No CV uploaded yet.</div>
<div class="small" id="ocrHint" style="margin-top:6px"></div>
</div>

<div class="hr"></div>

<div class="card" style="background:rgba(34,197,94,.06);border-color:rgba(34,197,94,.22)">
<div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
<div style="font-weight:950">AI job title suggestions</div>
<span class="badge warn" id="aiStatusBadge">Locked</span>
</div>
<div class="small" id="aiHint" style="margin-top:8px">Upload a PDF CV and wait for OCR to finish.</div>
<div class="actions" style="margin-top:12px">
<button class="btn cta" id="aiGenerateBtn" type="button" disabled>Generate suggestions</button>
<button class="btn" id="aiApplyBtn" type="button" disabled>Apply selected titles</button>
</div>
<div id="aiTitlesWrap" style="margin-top:12px;display:none"></div>
</div>

</div>
</section>

<aside class="card cardNoPad">
<div class="sectionHeader">
<div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
<div style="font-weight:950">Step 2: Preferences</div>
<span class="badge" id="saveStatusBadge">Not saved</span>
</div>
<p class="small">Save at least 1 job title + 1 location.</p>
</div>
<div class="sectionBody">
<label class="small" for="jobTitles" style="font-weight:850">Desired job titles (comma separated)</label>
<textarea id="jobTitles" placeholder="Business Analyst, Product Analyst, Operations Manager"></textarea>

<div class="hr"></div>

<label class="small" for="locations" style="font-weight:850">Main location(s) (comma separated)</label>
<input id="locations" type="text" placeholder="Berlin, Potsdam">

<div class="hr"></div>

<label class="small" for="radiusKm" style="font-weight:850">Radius (km)</label>
<input id="radiusKm" type="text" placeholder="20" inputmode="numeric">

<div class="hr"></div>

<div class="actions">
<button class="btn primary" id="saveProfileBtn" type="button">Save preferences</button>
<button class="btn" id="continueBtn" type="button">Continue</button>
</div>

<div class="small" id="continueHint" style="margin-top:10px"></div>
</div>
</aside>
</div>
</main>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="./config.js"></script>
<script src="./app.js"></script>
<script>
"use strict";
const { requireSession, logout, ensureCustomer, apiGet, apiPostJson, apiPostForm, getState } = window.JobMeJob.app;

let session=null;
let poll=null;

function show(id,msg){
const el=document.getElementById(id);
if(!el) return;
el.style.display = msg ? "block" : "none";
el.textContent = msg || "";
}
function setBadge(id, cls, text){
const el=document.getElementById(id);
if(!el) return;
el.className="badge"+(cls?(" "+cls):"");
el.textContent=text;
}
function setProgress(showIt, pct, text, hint){
document.getElementById("cvProgressWrap").style.display = showIt ? "block" : "none";
document.getElementById("cvProgressFill").style.width = Math.max(0, Math.min(100, Number(pct)||0)) + "%";
document.getElementById("cvProgressText").textContent = text||"";
document.getElementById("cvProgressHint").textContent = hint||"";
}
function isPdf(file){
const n=String(file?.name||"").toLowerCase();
const t=String(file?.type||"").toLowerCase();
return n.endsWith(".pdf") || t==="application/pdf";
}
function stopPoll(){ if(poll){ clearInterval(poll); poll=null; } }

async function refreshCv(){
const res = await apiGet("/me/cv", session.access_token);
const cv = res?.cv || null;
if(!cv || !cv.cv_path){
setBadge("cvStatusBadge","warn","No CV");
document.getElementById("cvHint").textContent="No CV uploaded yet.";
document.getElementById("ocrHint").textContent="";
setBadge("aiStatusBadge","warn","Locked");
document.getElementById("aiHint").textContent="Upload a PDF CV and wait for OCR to finish.";
document.getElementById("aiGenerateBtn").disabled=true;
return;
}
document.getElementById("cvHint").textContent="Uploaded: " + (cv.cv_filename || cv.cv_path);
const st=String(cv.cv_ocr_status||"").toLowerCase();
if(st==="processing"){
setBadge("cvStatusBadge","warn","OCR running");
document.getElementById("ocrHint").textContent="OCR is running…";
setBadge("aiStatusBadge","warn","Locked");
document.getElementById("aiHint").textContent="OCR still running. We will unlock when done.";
document.getElementById("aiGenerateBtn").disabled=true;
setProgress(true, 65, "OCR in progress…", "Keep this page open.");
return;
}
if(st==="done"){
setBadge("cvStatusBadge","good","CV ready");
document.getElementById("ocrHint").textContent="OCR done.";
setBadge("aiStatusBadge","good","Ready");
document.getElementById("aiHint").textContent="Generate suggestions now.";
document.getElementById("aiGenerateBtn").disabled=false;
setProgress(false,100,"","");
return;
}
if(st==="failed"){
setBadge("cvStatusBadge","bad","OCR failed");
document.getElementById("ocrHint").textContent="OCR failed: " + (cv.cv_ocr_error||"");
setBadge("aiStatusBadge","warn","Locked");
document.getElementById("aiHint").textContent="OCR failed. Upload a different PDF.";
document.getElementById("aiGenerateBtn").disabled=true;
setProgress(false,0,"","");
return;
}
setBadge("cvStatusBadge","warn","OCR idle");
document.getElementById("ocrHint").textContent="OCR status: idle";
document.getElementById("aiGenerateBtn").disabled=true;
}

async function uploadCv(file){
stopPoll();
show("errorTop","");
show("noticeTop","");
document.getElementById("cvHint").textContent="Selected: " + file.name;
setBadge("cvStatusBadge","warn","Uploading…");
setProgress(true, 20, "Uploading…", "Do not close this tab.");

const fd=new FormData();
fd.append("cv", file);
await apiPostForm("/me/cv", session.access_token, fd);

document.getElementById("cvHint").textContent="Uploaded: " + file.name;

if(!isPdf(file)){
setBadge("cvStatusBadge","warn","Uploaded");
setProgress(false,0,"","");
document.getElementById("ocrHint").textContent="For OCR and AI suggestions, please upload a PDF.";
return;
}

setBadge("cvStatusBadge","warn","Starting OCR…");
setProgress(true, 45, "Starting OCR…", "Extracting text from PDF.");
await apiPostJson("/me/cv/ocr", session.access_token, {});
document.getElementById("ocrHint").textContent="OCR is running…";

poll=setInterval(async ()=>{
try{
await apiGet("/me/cv/ocr/status", session.access_token);
await refreshCv();
const cv2=(await apiGet("/me/cv", session.access_token))?.cv;
const s=String(cv2?.cv_ocr_status||"").toLowerCase();
if(s==="done" || s==="failed") stopPoll();
}catch(e){
stopPoll();
show("errorTop", e.message||String(e));
}
}, 3500);
}

async function generateAi(){
show("errorTop","");
setBadge("aiStatusBadge","warn","Generating…");
document.getElementById("aiGenerateBtn").disabled=true;
try{
const res=await apiPostJson("/me/ai/profile-from-cv", session.access_token, {});
const r=res?.result || null;
const titles=(r?.job_titles||[]).map(x=>String(x).trim()).filter(Boolean).slice(0,20);
if(!titles.length) throw new Error("No suggestions returned.");
document.getElementById("aiTitlesWrap").style.display="block";
document.getElementById("aiTitlesWrap").innerHTML =
"<div class='small' style='font-weight:850'>Suggested titles (click to select)</div>" +
"<div style='margin-top:10px;display:flex;flex-wrap:wrap;gap:8px' id='chips'></div>";

const chips=document.getElementById("chips");
const selected=new Set(titles);

for(const t of titles){
const b=document.createElement("button");
b.type="button";
b.className="pill";
b.textContent=t;
b.onclick=()=>{
if(selected.has(t)) { selected.delete(t); b.classList.remove("active"); }
else { selected.add(t); b.classList.add("active"); }
document.getElementById("aiApplyBtn").disabled = selected.size===0;
};
b.classList.add("active");
chips.appendChild(b);
}

document.getElementById("aiApplyBtn").disabled=false;
document.getElementById("aiApplyBtn").onclick=()=>{
const existing=String(document.getElementById("jobTitles").value||"").split(",").map(s=>s.trim()).filter(Boolean);
const merged=[...new Set([...selected, ...existing])].slice(0,30);
document.getElementById("jobTitles").value=merged.join(", ");
setBadge("aiStatusBadge","good","Applied");
};
setBadge("aiStatusBadge","good","Ready");
}catch(e){
setBadge("aiStatusBadge","bad","Failed");
show("errorTop", e.message||String(e));
document.getElementById("aiGenerateBtn").disabled=false;
}
}

async function savePrefs(){
show("errorTop","");
setBadge("saveStatusBadge","warn","Saving…");
const titles=String(document.getElementById("jobTitles").value||"").split(",").map(s=>s.trim()).filter(Boolean);
const locs=String(document.getElementById("locations").value||"").split(",").map(s=>s.trim()).filter(Boolean);
let radius=null;
if(document.getElementById("radiusKm").value.trim()){
const n=Number(document.getElementById("radiusKm").value);
radius = Number.isFinite(n) ? n : null;
}
if(!titles.length) { show("errorTop","Please enter at least 1 job title."); setBadge("saveStatusBadge","bad","Save failed"); return; }
if(!locs.length) { show("errorTop","Please enter at least 1 location."); setBadge("saveStatusBadge","bad","Save failed"); return; }

try{
await apiPostJson("/me/profile", session.access_token, {
desired_titles: titles.slice(0,30),
industries: [],
locations: locs.slice(0,20),
countries_allowed: ["DE"],
radius_km: radius
});
setBadge("saveStatusBadge","good","Saved");
}catch(e){
setBadge("saveStatusBadge","bad","Save failed");
show("errorTop", e.message||String(e));
}
}

async function boot(){
try{
session = await requireSession("./signup.html");
if(!session) return;
const email=String(session.user.email||"").trim().toLowerCase();
document.getElementById("subLine").textContent="Signed in as "+email;

await ensureCustomer(email);
await getState(session.access_token);
await refreshCv();

document.getElementById("cvFile").addEventListener("change", async ()=>{
const f=document.getElementById("cvFile").files?.[0];
if(f) await uploadCv(f);
});

document.getElementById("aiGenerateBtn").addEventListener("click", generateAi);
document.getElementById("saveProfileBtn").addEventListener("click", savePrefs);
document.getElementById("continueBtn").addEventListener("click", async ()=>{
const st=await getState(session.access_token);
window.location.href = (st?.plan_id ? "./dashboard.html" : "./plan.html");
});
document.getElementById("btnLogout").addEventListener("click", ()=>logout("./index.html"));

}catch(e){
show("errorTop", e.message||String(e));
}
}
window.addEventListener("load", boot);
</script>
</body>
</html>
